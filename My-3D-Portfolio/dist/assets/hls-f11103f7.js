import{g as je}from"./index-a66ed3f1.js";function Ve(De,Ae){for(var ue=0;ue<Ae.length;ue++){const Te=Ae[ue];if(typeof Te!="string"&&!Array.isArray(Te)){for(const j in Te)if(j!=="default"&&!(j in De)){const M=Object.getOwnPropertyDescriptor(Te,j);M&&Object.defineProperty(De,j,M.get?M:{enumerable:!0,get:()=>Te[j]})}}}return Object.freeze(Object.defineProperty(De,Symbol.toStringTag,{value:"Module"}))}var xe,Me={exports:{}};typeof window<"u"&&(xe=()=>(()=>{var De={"./src/config.ts":(j,M,b)=>{b.r(M),b.d(M,{enableStreamingMode:()=>s,hlsDefaultConfig:()=>l,mergeConfig:()=>a});var w=b("./src/controller/abr-controller.ts"),D=b("./src/controller/audio-stream-controller.ts"),P=b("./src/controller/audio-track-controller.ts"),k=b("./src/controller/subtitle-stream-controller.ts"),I=b("./src/controller/subtitle-track-controller.ts"),T=b("./src/controller/buffer-controller.ts"),y=b("./src/controller/timeline-controller.ts"),p=b("./src/controller/cap-level-controller.ts"),S=b("./src/controller/fps-controller.ts"),m=b("./src/controller/eme-controller.ts"),v=b("./src/controller/cmcd-controller.ts"),d=b("./src/utils/xhr-loader.ts"),o=b("./src/utils/fetch-loader.ts"),t=b("./src/utils/cues.ts"),n=b("./src/utils/mediakeys-helper.ts"),u=b("./src/utils/logger.ts");function f(){return f=Object.assign?Object.assign.bind():function(e){for(var r=1;r<arguments.length;r++){var g=arguments[r];for(var E in g)Object.prototype.hasOwnProperty.call(g,E)&&(e[E]=g[E])}return e},f.apply(this,arguments)}function h(e,r){var g=Object.keys(e);if(Object.getOwnPropertySymbols){var E=Object.getOwnPropertySymbols(e);r&&(E=E.filter(function(A){return Object.getOwnPropertyDescriptor(e,A).enumerable})),g.push.apply(g,E)}return g}function i(e){for(var r=1;r<arguments.length;r++){var g=arguments[r]!=null?arguments[r]:{};r%2?h(Object(g),!0).forEach(function(E){c(e,E,g[E])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(g)):h(Object(g)).forEach(function(E){Object.defineProperty(e,E,Object.getOwnPropertyDescriptor(g,E))})}return e}function c(e,r,g){return(r=function(E){var A=function(L,_){if(typeof L!="object"||L===null)return L;var R=L[Symbol.toPrimitive];if(R!==void 0){var x=R.call(L,_||"default");if(typeof x!="object")return x;throw new TypeError("@@toPrimitive must return a primitive value.")}return(_==="string"?String:Number)(L)}(E,"string");return typeof A=="symbol"?A:String(A)}(r))in e?Object.defineProperty(e,r,{value:g,enumerable:!0,configurable:!0,writable:!0}):e[r]=g,e}var l=i(i({autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,debug:!1,capLevelOnFPSDrop:!1,capLevelToPlayerSize:!1,ignoreDevicePixelRatio:!1,initialLiveManifestSize:1,maxBufferLength:30,backBufferLength:1/0,maxBufferSize:6e7,maxBufferHole:.1,highBufferWatchdogPeriod:2,nudgeOffset:.1,nudgeMaxRetry:3,maxFragLookUpTolerance:.25,liveSyncDurationCount:3,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,maxLiveSyncPlaybackRate:1,liveDurationInfinity:!1,liveBackBufferLength:null,maxMaxBufferLength:600,enableWorker:!0,enableSoftwareAES:!0,manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,startLevel:void 0,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3,startFragPrefetch:!1,fpsDroppedMonitoringPeriod:5e3,fpsDroppedMonitoringThreshold:.2,appendErrorMaxRetry:3,loader:d.default,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,licenseXhrSetup:void 0,licenseResponseCallback:void 0,abrController:w.default,bufferController:T.default,capLevelController:p.default,fpsController:S.default,stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,emeEnabled:!1,widevineLicenseUrl:void 0,drmSystems:{},drmSystemOptions:{},requestMediaKeySystemAccessFunc:n.requestMediaKeySystemAccess,testBandwidth:!0,progressive:!1,lowLatencyMode:!0,cmcd:void 0,enableDateRangeMetadataCues:!0,enableEmsgMetadataCues:!0,enableID3MetadataCues:!0},{cueHandler:t.default,enableWebVTT:!0,enableIMSC1:!0,enableCEA708Captions:!0,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",captionsTextTrack3Label:"Unknown CC",captionsTextTrack3LanguageCode:"",captionsTextTrack4Label:"Unknown CC",captionsTextTrack4LanguageCode:"",renderTextTracksNatively:!0}),{},{subtitleStreamController:k.SubtitleStreamController,subtitleTrackController:I.default,timelineController:y.TimelineController,audioStreamController:D.default,audioTrackController:P.default,emeController:m.default,cmcdController:v.default});function a(e,r){if((r.liveSyncDurationCount||r.liveMaxLatencyDurationCount)&&(r.liveSyncDuration||r.liveMaxLatencyDuration))throw new Error("Illegal hls.js config: don't mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration");if(r.liveMaxLatencyDurationCount!==void 0&&(r.liveSyncDurationCount===void 0||r.liveMaxLatencyDurationCount<=r.liveSyncDurationCount))throw new Error('Illegal hls.js config: "liveMaxLatencyDurationCount" must be greater than "liveSyncDurationCount"');if(r.liveMaxLatencyDuration!==void 0&&(r.liveSyncDuration===void 0||r.liveMaxLatencyDuration<=r.liveSyncDuration))throw new Error('Illegal hls.js config: "liveMaxLatencyDuration" must be greater than "liveSyncDuration"');return f({},e,r)}function s(e){var r=e.loader;r!==o.default&&r!==d.default?(u.logger.log("[config]: Custom loader detected, cannot enable progressive streaming"),e.progressive=!1):(0,o.fetchSupported)()&&(e.loader=o.default,e.progressive=!0,e.enableSoftwareAES=!0,u.logger.log("[config]: Progressive streaming enabled, using FetchLoader"))}},"./src/controller/abr-controller.ts":(j,M,b)=>{b.r(M),b.d(M,{default:()=>S});var w=b("./src/polyfills/number.ts"),D=b("./src/utils/ewma-bandwidth-estimator.ts"),P=b("./src/events.ts"),k=b("./src/errors.ts"),I=b("./src/types/loader.ts"),T=b("./src/utils/logger.ts");function y(m,v){for(var d=0;d<v.length;d++){var o=v[d];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(m,(t=o.key,n=void 0,typeof(n=function(u,f){if(typeof u!="object"||u===null)return u;var h=u[Symbol.toPrimitive];if(h!==void 0){var i=h.call(u,f||"default");if(typeof i!="object")return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return(f==="string"?String:Number)(u)}(t,"string"))=="symbol"?n:String(n)),o)}var t,n}var p=function(){function m(n){this.hls=void 0,this.lastLoadedFragLevel=0,this._nextAutoLevel=-1,this.timer=void 0,this.onCheck=this._abandonRulesCheck.bind(this),this.fragCurrent=null,this.partCurrent=null,this.bitrateTestDelay=0,this.bwEstimator=void 0,this.hls=n;var u=n.config;this.bwEstimator=new D.default(u.abrEwmaSlowVoD,u.abrEwmaFastVoD,u.abrEwmaDefaultEstimate),this.registerListeners()}var v,d,o,t=m.prototype;return t.registerListeners=function(){var n=this.hls;n.on(P.Events.FRAG_LOADING,this.onFragLoading,this),n.on(P.Events.FRAG_LOADED,this.onFragLoaded,this),n.on(P.Events.FRAG_BUFFERED,this.onFragBuffered,this),n.on(P.Events.LEVEL_LOADED,this.onLevelLoaded,this),n.on(P.Events.ERROR,this.onError,this)},t.unregisterListeners=function(){var n=this.hls;n.off(P.Events.FRAG_LOADING,this.onFragLoading,this),n.off(P.Events.FRAG_LOADED,this.onFragLoaded,this),n.off(P.Events.FRAG_BUFFERED,this.onFragBuffered,this),n.off(P.Events.LEVEL_LOADED,this.onLevelLoaded,this),n.off(P.Events.ERROR,this.onError,this)},t.destroy=function(){this.unregisterListeners(),this.clearTimer(),this.hls=this.onCheck=null,this.fragCurrent=this.partCurrent=null},t.onFragLoading=function(n,u){var f,h=u.frag;h.type===I.PlaylistLevelType.MAIN&&(this.timer||(this.fragCurrent=h,this.partCurrent=(f=u.part)!=null?f:null,this.timer=self.setInterval(this.onCheck,100)))},t.onLevelLoaded=function(n,u){var f=this.hls.config;u.details.live?this.bwEstimator.update(f.abrEwmaSlowLive,f.abrEwmaFastLive):this.bwEstimator.update(f.abrEwmaSlowVoD,f.abrEwmaFastVoD)},t._abandonRulesCheck=function(){var n=this.fragCurrent,u=this.partCurrent,f=this.hls,h=f.autoLevelEnabled,i=f.media;if(n&&i){var c=u?u.stats:n.stats,l=u?u.duration:n.duration;if(c.aborted||c.loaded&&c.loaded===c.total||n.level===0)return this.clearTimer(),void(this._nextAutoLevel=-1);if(h&&!i.paused&&i.playbackRate&&i.readyState){var a=f.mainForwardBufferInfo;if(a!==null){var s=performance.now()-c.loading.start,e=Math.abs(i.playbackRate);if(!(s<=500*l/e)){var r=c.loaded&&c.loading.first,g=this.bwEstimator.getEstimate(),E=f.levels,A=f.minAutoLevel,L=E[n.level],_=c.total||Math.max(c.loaded,Math.round(l*L.maxBitrate/8)),R=r?1e3*c.loaded/s:0,x=R?(_-c.loaded)/R:8*_/g,C=a.len/e;if(!(x<=C)){var F,O=Number.POSITIVE_INFINITY;for(F=n.level-1;F>A;F--){var N=E[F].maxBitrate;if((O=R?l*N/(6.4*R):l*N/g)<C)break}O>=x||(T.logger.warn("Fragment "+n.sn+(u?" part "+u.index:"")+" of level "+n.level+" is loading too slowly and will cause an underbuffer; aborting and switching to level "+F+`
      Current BW estimate: `+((0,w.isFiniteNumber)(g)?(g/1024).toFixed(3):"Unknown")+` Kb/s
      Estimated load time for current fragment: `+x.toFixed(3)+` s
      Estimated load time for the next fragment: `+O.toFixed(3)+` s
      Time to underbuffer: `+C.toFixed(3)+" s"),f.nextLoadLevel=F,r&&this.bwEstimator.sample(s,c.loaded),this.clearTimer(),(n.loader||n.keyLoader)&&(this.fragCurrent=this.partCurrent=null,n.abortRequests()),f.trigger(P.Events.FRAG_LOAD_EMERGENCY_ABORTED,{frag:n,part:u,stats:c}))}}}}}},t.onFragLoaded=function(n,u){var f=u.frag,h=u.part;if(f.type===I.PlaylistLevelType.MAIN&&(0,w.isFiniteNumber)(f.sn)){var i=h?h.stats:f.stats,c=h?h.duration:f.duration;if(this.clearTimer(),this.lastLoadedFragLevel=f.level,this._nextAutoLevel=-1,this.hls.config.abrMaxWithRealBitrate){var l=this.hls.levels[f.level],a=(l.loaded?l.loaded.bytes:0)+i.loaded,s=(l.loaded?l.loaded.duration:0)+c;l.loaded={bytes:a,duration:s},l.realBitrate=Math.round(8*a/s)}if(f.bitrateTest){var e={stats:i,frag:f,part:h,id:f.type};this.onFragBuffered(P.Events.FRAG_BUFFERED,e)}}},t.onFragBuffered=function(n,u){var f=u.frag,h=u.part,i=h?h.stats:f.stats;if(!i.aborted&&f.type===I.PlaylistLevelType.MAIN&&f.sn!=="initSegment"){var c=i.parsing.end-i.loading.start;this.bwEstimator.sample(c,i.loaded),i.bwEstimate=this.bwEstimator.getEstimate(),f.bitrateTest?this.bitrateTestDelay=c/1e3:this.bitrateTestDelay=0}},t.onError=function(n,u){var f;if(((f=u.frag)===null||f===void 0?void 0:f.type)===I.PlaylistLevelType.MAIN){if(u.type===k.ErrorTypes.KEY_SYSTEM_ERROR)return void this.clearTimer();switch(u.details){case k.ErrorDetails.FRAG_LOAD_ERROR:case k.ErrorDetails.FRAG_LOAD_TIMEOUT:case k.ErrorDetails.KEY_LOAD_ERROR:case k.ErrorDetails.KEY_LOAD_TIMEOUT:this.clearTimer()}}},t.clearTimer=function(){self.clearInterval(this.timer),this.timer=void 0},t.getNextABRAutoLevel=function(){var n=this.fragCurrent,u=this.partCurrent,f=this.hls,h=f.maxAutoLevel,i=f.config,c=f.minAutoLevel,l=f.media,a=u?u.duration:n?n.duration:0,s=l&&l.playbackRate!==0?Math.abs(l.playbackRate):1,e=this.bwEstimator?this.bwEstimator.getEstimate():i.abrEwmaDefaultEstimate,r=f.mainForwardBufferInfo,g=(r?r.len:0)/s,E=this.findBestLevel(e,c,h,g,i.abrBandWidthFactor,i.abrBandWidthUpFactor);if(E>=0)return E;T.logger.trace((g?"rebuffering expected":"buffer is empty")+", finding optimal quality level");var A=a?Math.min(a,i.maxStarvationDelay):i.maxStarvationDelay,L=i.abrBandWidthFactor,_=i.abrBandWidthUpFactor;if(!g){var R=this.bitrateTestDelay;R&&(A=(a?Math.min(a,i.maxLoadingDelay):i.maxLoadingDelay)-R,T.logger.trace("bitrate test took "+Math.round(1e3*R)+"ms, set first fragment max fetchDuration to "+Math.round(1e3*A)+" ms"),L=_=1)}return E=this.findBestLevel(e,c,h,g+A,L,_),Math.max(E,0)},t.findBestLevel=function(n,u,f,h,i,c){for(var l,a=this.fragCurrent,s=this.partCurrent,e=this.lastLoadedFragLevel,r=this.hls.levels,g=r[e],E=!(g==null||(l=g.details)===null||l===void 0||!l.live),A=g==null?void 0:g.codecSet,L=s?s.duration:a?a.duration:0,_=f;_>=u;_--){var R=r[_];if(R&&(!A||R.codecSet===A)){var x=R.details,C=(s?x==null?void 0:x.partTarget:x==null?void 0:x.averagetargetduration)||L,F=void 0;F=_<=e?i*n:c*n;var O=r[_].maxBitrate,N=O*C/F;if(T.logger.trace("level/adjustedbw/bitrate/avgDuration/maxFetchDuration/fetchDuration: "+_+"/"+Math.round(F)+"/"+O+"/"+C+"/"+h+"/"+N),F>O&&(N===0||!(0,w.isFiniteNumber)(N)||E&&!this.bitrateTestDelay||N<h))return _}}return-1},v=m,(d=[{key:"nextAutoLevel",get:function(){var n=this._nextAutoLevel,u=this.bwEstimator;if(n!==-1&&!u.canEstimate())return n;var f=this.getNextABRAutoLevel();return n!==-1&&this.hls.levels[f].loadError?n:(n!==-1&&(f=Math.min(n,f)),f)},set:function(n){this._nextAutoLevel=n}}])&&y(v.prototype,d),o&&y(v,o),Object.defineProperty(v,"prototype",{writable:!1}),m}();const S=p},"./src/controller/audio-stream-controller.ts":(j,M,b)=>{b.r(M),b.d(M,{default:()=>h});var w=b("./src/polyfills/number.ts"),D=b("./src/controller/base-stream-controller.ts"),P=b("./src/events.ts"),k=b("./src/utils/buffer-helper.ts"),I=b("./src/controller/fragment-tracker.ts"),T=b("./src/types/level.ts"),y=b("./src/types/loader.ts"),p=b("./src/loader/fragment.ts"),S=b("./src/demux/chunk-cache.ts"),m=b("./src/demux/transmuxer-interface.ts"),v=b("./src/types/transmuxer.ts"),d=b("./src/controller/fragment-finders.ts"),o=b("./src/utils/discontinuities.ts"),t=b("./src/errors.ts");function n(){return n=Object.assign?Object.assign.bind():function(i){for(var c=1;c<arguments.length;c++){var l=arguments[c];for(var a in l)Object.prototype.hasOwnProperty.call(l,a)&&(i[a]=l[a])}return i},n.apply(this,arguments)}function u(i,c){return u=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(l,a){return l.__proto__=a,l},u(i,c)}var f=function(i){var c,l;function a(e,r,g){var E;return(E=i.call(this,e,r,g,"[audio-stream-controller]")||this).videoBuffer=null,E.videoTrackCC=-1,E.waitingVideoCC=-1,E.audioSwitch=!1,E.trackId=-1,E.waitingData=null,E.mainDetails=null,E.bufferFlushed=!1,E.cachedTrackLoadedData=null,E._registerListeners(),E}l=i,(c=a).prototype=Object.create(l.prototype),c.prototype.constructor=c,u(c,l);var s=a.prototype;return s.onHandlerDestroying=function(){this._unregisterListeners(),this.mainDetails=null},s._registerListeners=function(){var e=this.hls;e.on(P.Events.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(P.Events.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(P.Events.MANIFEST_LOADING,this.onManifestLoading,this),e.on(P.Events.LEVEL_LOADED,this.onLevelLoaded,this),e.on(P.Events.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.on(P.Events.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(P.Events.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(P.Events.ERROR,this.onError,this),e.on(P.Events.BUFFER_RESET,this.onBufferReset,this),e.on(P.Events.BUFFER_CREATED,this.onBufferCreated,this),e.on(P.Events.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(P.Events.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(P.Events.FRAG_BUFFERED,this.onFragBuffered,this)},s._unregisterListeners=function(){var e=this.hls;e.off(P.Events.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(P.Events.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(P.Events.MANIFEST_LOADING,this.onManifestLoading,this),e.off(P.Events.LEVEL_LOADED,this.onLevelLoaded,this),e.off(P.Events.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.off(P.Events.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(P.Events.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(P.Events.ERROR,this.onError,this),e.off(P.Events.BUFFER_RESET,this.onBufferReset,this),e.off(P.Events.BUFFER_CREATED,this.onBufferCreated,this),e.off(P.Events.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(P.Events.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(P.Events.FRAG_BUFFERED,this.onFragBuffered,this)},s.onInitPtsFound=function(e,r){var g=r.frag,E=r.id,A=r.initPTS;if(E==="main"){var L=g.cc;this.initPTS[g.cc]=A,this.log("InitPTS for cc: "+L+" found from main: "+A),this.videoTrackCC=L,this.state===D.State.WAITING_INIT_PTS&&this.tick()}},s.startLoad=function(e){if(!this.levels)return this.startPosition=e,void(this.state=D.State.STOPPED);var r=this.lastCurrentTime;this.stopLoad(),this.setInterval(100),this.fragLoadError=0,r>0&&e===-1?(this.log("Override startPosition with lastCurrentTime @"+r.toFixed(3)),e=r,this.state=D.State.IDLE):(this.loadedmetadata=!1,this.state=D.State.WAITING_TRACK),this.nextLoadPosition=this.startPosition=this.lastCurrentTime=e,this.tick()},s.doTick=function(){switch(this.state){case D.State.IDLE:this.doTickIdle();break;case D.State.WAITING_TRACK:var e,r=this.levels,g=this.trackId,E=r==null||(e=r[g])===null||e===void 0?void 0:e.details;if(E){if(this.waitForCdnTuneIn(E))break;this.state=D.State.WAITING_INIT_PTS}break;case D.State.FRAG_LOADING_WAITING_RETRY:var A,L=performance.now(),_=this.retryDate;(!_||L>=_||(A=this.media)!==null&&A!==void 0&&A.seeking)&&(this.log("RetryDate reached, switch back to IDLE state"),this.resetStartWhenNotLoaded(this.trackId),this.state=D.State.IDLE);break;case D.State.WAITING_INIT_PTS:var R=this.waitingData;if(R){var x=R.frag,C=R.part,F=R.cache,O=R.complete;if(this.initPTS[x.cc]!==void 0){this.waitingData=null,this.waitingVideoCC=-1,this.state=D.State.FRAG_LOADING;var N={frag:x,part:C,payload:F.flush(),networkDetails:null};this._handleFragmentLoadProgress(N),O&&i.prototype._handleFragmentLoadComplete.call(this,N)}else if(this.videoTrackCC!==this.waitingVideoCC)this.log("Waiting fragment cc ("+x.cc+") cancelled because video is at cc "+this.videoTrackCC),this.clearWaitingFragment();else{var U=this.getLoadPosition(),G=k.BufferHelper.bufferInfo(this.mediaBuffer,U,this.config.maxBufferHole);(0,d.fragmentWithinToleranceTest)(G.end,this.config.maxFragLookUpTolerance,x)<0&&(this.log("Waiting fragment cc ("+x.cc+") @ "+x.start+" cancelled because another fragment at "+G.end+" is needed"),this.clearWaitingFragment())}}else this.state=D.State.IDLE}this.onTickEnd()},s.clearWaitingFragment=function(){var e=this.waitingData;e&&(this.fragmentTracker.removeFragment(e.frag),this.waitingData=null,this.waitingVideoCC=-1,this.state=D.State.IDLE)},s.resetLoadingState=function(){this.clearWaitingFragment(),i.prototype.resetLoadingState.call(this)},s.onTickEnd=function(){var e=this.media;e&&e.readyState&&(this.lastCurrentTime=e.currentTime)},s.doTickIdle=function(){var e=this.hls,r=this.levels,g=this.media,E=this.trackId,A=e.config;if(r&&r[E]&&(g||!this.startFragRequested&&A.startFragPrefetch)){var L=r[E].details;if(!L||L.live&&this.levelLastLoaded!==E||this.waitForCdnTuneIn(L))this.state=D.State.WAITING_TRACK;else{var _=this.mediaBuffer?this.mediaBuffer:this.media;this.bufferFlushed&&_&&(this.bufferFlushed=!1,this.afterBufferFlushed(_,p.ElementaryStreamTypes.AUDIO,y.PlaylistLevelType.AUDIO));var R=this.getFwdBufferInfo(_,y.PlaylistLevelType.AUDIO);if(R!==null){var x=this.audioSwitch;if(!x&&this._streamEnded(R,L))return e.trigger(P.Events.BUFFER_EOS,{type:"audio"}),void(this.state=D.State.ENDED);var C=this.getFwdBufferInfo(this.videoBuffer?this.videoBuffer:this.media,y.PlaylistLevelType.MAIN);if(!(R.len>=this.getMaxBufferLength(C==null?void 0:C.len))||x){var F=L.fragments[0].start,O=R.end;if(x&&g){var N=this.getLoadPosition();O=N,L.PTSKnown&&N<F&&(R.end>F||R.nextStart)&&(this.log("Alt audio track ahead of main track, seek to start of alt audio track"),g.currentTime=F+.05)}if(!(C&&O>C.end+L.targetduration)&&(C&&C.len||!R.len)){var U=this.getNextFragment(O,L);U?this.loadFragment(U,L,O):this.bufferFlushed=!0}}}}}},s.getMaxBufferLength=function(e){var r=i.prototype.getMaxBufferLength.call(this);return e?Math.max(r,e):r},s.onMediaDetaching=function(){this.videoBuffer=null,i.prototype.onMediaDetaching.call(this)},s.onAudioTracksUpdated=function(e,r){var g=r.audioTracks;this.resetTransmuxer(),this.levels=g.map(function(E){return new T.Level(E)})},s.onAudioTrackSwitching=function(e,r){var g=!!r.url;this.trackId=r.id;var E=this.fragCurrent;E&&E.abortRequests(),this.fragCurrent=null,this.clearWaitingFragment(),g?this.setInterval(100):this.resetTransmuxer(),g?(this.audioSwitch=!0,this.state=D.State.IDLE):this.state=D.State.STOPPED,this.tick()},s.onManifestLoading=function(){this.mainDetails=null,this.fragmentTracker.removeAllFragments(),this.startPosition=this.lastCurrentTime=0,this.bufferFlushed=!1},s.onLevelLoaded=function(e,r){this.mainDetails=r.details,this.cachedTrackLoadedData!==null&&(this.hls.trigger(P.Events.AUDIO_TRACK_LOADED,this.cachedTrackLoadedData),this.cachedTrackLoadedData=null)},s.onAudioTrackLoaded=function(e,r){var g;if(this.mainDetails!=null){var E=this.levels,A=r.details,L=r.id;if(E){this.log("Track "+L+" loaded ["+A.startSN+","+A.endSN+"],duration:"+A.totalduration);var _=E[L],R=0;if(A.live||(g=_.details)!==null&&g!==void 0&&g.live){var x=this.mainDetails;if(A.fragments[0]||(A.deltaUpdateFailed=!0),A.deltaUpdateFailed||!x)return;!_.details&&A.hasProgramDateTime&&x.hasProgramDateTime?((0,o.alignMediaPlaylistByPDT)(A,x),R=A.fragments[0].start):R=this.alignPlaylists(A,_.details)}_.details=A,this.levelLastLoaded=L,this.startFragRequested||!this.mainDetails&&A.live||this.setStartPosition(_.details,R),this.state!==D.State.WAITING_TRACK||this.waitForCdnTuneIn(A)||(this.state=D.State.IDLE),this.tick()}else this.warn("Audio tracks were reset while loading level "+L)}else this.cachedTrackLoadedData=r},s._handleFragmentLoadProgress=function(e){var r,g=e.frag,E=e.part,A=e.payload,L=this.config,_=this.trackId,R=this.levels;if(R){var x=R[_];console.assert(x,"Audio track is defined on fragment load progress");var C=x.details;console.assert(C,"Audio track details are defined on fragment load progress");var F=L.defaultAudioCodec||x.audioCodec||"mp4a.40.2",O=this.transmuxer;O||(O=this.transmuxer=new m.default(this.hls,y.PlaylistLevelType.AUDIO,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)));var N=this.initPTS[g.cc],U=(r=g.initSegment)===null||r===void 0?void 0:r.data;if(N!==void 0){var G=E?E.index:-1,B=G!==-1,H=new v.ChunkMetadata(g.level,g.sn,g.stats.chunkCount,A.byteLength,G,B);O.push(A,U,F,"",g,E,C.totalduration,!1,H,N)}else this.log("Unknown video PTS for cc "+g.cc+", waiting for video PTS before demuxing audio frag "+g.sn+" of ["+C.startSN+" ,"+C.endSN+"],track "+_),(this.waitingData=this.waitingData||{frag:g,part:E,cache:new S.default,complete:!1}).cache.push(new Uint8Array(A)),this.waitingVideoCC=this.videoTrackCC,this.state=D.State.WAITING_INIT_PTS}else this.warn("Audio tracks were reset while fragment load was in progress. Fragment "+g.sn+" of level "+g.level+" will not be buffered")},s._handleFragmentLoadComplete=function(e){this.waitingData?this.waitingData.complete=!0:i.prototype._handleFragmentLoadComplete.call(this,e)},s.onBufferReset=function(){this.mediaBuffer=this.videoBuffer=null,this.loadedmetadata=!1},s.onBufferCreated=function(e,r){var g=r.tracks.audio;g&&(this.mediaBuffer=g.buffer||null),r.tracks.video&&(this.videoBuffer=r.tracks.video.buffer||null)},s.onFragBuffered=function(e,r){var g,E=r.frag,A=r.part;E.type===y.PlaylistLevelType.AUDIO?this.fragContextChanged(E)?this.warn("Fragment "+E.sn+(A?" p: "+A.index:"")+" of level "+E.level+" finished buffering, but was aborted. state: "+this.state+", audioSwitch: "+this.audioSwitch):(E.sn!=="initSegment"&&(this.fragPrevious=E,this.audioSwitch&&(this.audioSwitch=!1,this.hls.trigger(P.Events.AUDIO_TRACK_SWITCHED,{id:this.trackId}))),this.fragBufferedComplete(E,A)):this.loadedmetadata||E.type!==y.PlaylistLevelType.MAIN||(g=this.videoBuffer||this.media)!==null&&g!==void 0&&g.buffered.length&&(this.loadedmetadata=!0)},s.onError=function(e,r){if(r.type!==t.ErrorTypes.KEY_SYSTEM_ERROR)switch(r.details){case t.ErrorDetails.FRAG_LOAD_ERROR:case t.ErrorDetails.FRAG_LOAD_TIMEOUT:case t.ErrorDetails.FRAG_PARSING_ERROR:case t.ErrorDetails.KEY_LOAD_ERROR:case t.ErrorDetails.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(y.PlaylistLevelType.AUDIO,r);break;case t.ErrorDetails.AUDIO_TRACK_LOAD_ERROR:case t.ErrorDetails.AUDIO_TRACK_LOAD_TIMEOUT:this.state!==D.State.ERROR&&this.state!==D.State.STOPPED&&(this.state=r.fatal?D.State.ERROR:D.State.IDLE,this.warn(r.details+" while loading frag, switching to "+this.state+" state"));break;case t.ErrorDetails.BUFFER_FULL_ERROR:if(r.parent==="audio"&&(this.state===D.State.PARSING||this.state===D.State.PARSED)){var g=!0,E=this.getFwdBufferInfo(this.mediaBuffer,y.PlaylistLevelType.AUDIO);E&&E.len>.5&&(g=!this.reduceMaxBufferLength(E.len)),g&&(this.warn("Buffer full error also media.currentTime is not buffered, flush audio buffer"),this.fragCurrent=null,i.prototype.flushMainBuffer.call(this,0,Number.POSITIVE_INFINITY,"audio")),this.resetLoadingState()}}else this.onFragmentOrKeyLoadError(y.PlaylistLevelType.AUDIO,r)},s.onBufferFlushed=function(e,r){r.type===p.ElementaryStreamTypes.AUDIO&&(this.bufferFlushed=!0,this.state===D.State.ENDED&&(this.state=D.State.IDLE))},s._handleTransmuxComplete=function(e){var r,g="audio",E=this.hls,A=e.remuxResult,L=e.chunkMeta,_=this.getCurrentContext(L);if(!_)return this.warn("The loading context changed while buffering fragment "+L.sn+" of level "+L.level+". This chunk will not be buffered."),void this.resetStartWhenNotLoaded(L.level);var R=_.frag,x=_.part,C=_.level.details,F=A.audio,O=A.text,N=A.id3,U=A.initSegment;if(!this.fragContextChanged(R)&&C){if(this.state=D.State.PARSING,this.audioSwitch&&F&&this.completeAudioSwitch(),U!=null&&U.tracks&&(this._bufferInitSegment(U.tracks,R,L),E.trigger(P.Events.FRAG_PARSING_INIT_SEGMENT,{frag:R,id:g,tracks:U.tracks})),F){var G=F.startPTS,B=F.endPTS,H=F.startDTS,V=F.endDTS;x&&(x.elementaryStreams[p.ElementaryStreamTypes.AUDIO]={startPTS:G,endPTS:B,startDTS:H,endDTS:V}),R.setElementaryStreamInfo(p.ElementaryStreamTypes.AUDIO,G,B,H,V),this.bufferFragmentData(F,R,x,L)}if(N!=null&&(r=N.samples)!==null&&r!==void 0&&r.length){var K=n({id:g,frag:R,details:C},N);E.trigger(P.Events.FRAG_PARSING_METADATA,K)}if(O){var Y=n({id:g,frag:R,details:C},O);E.trigger(P.Events.FRAG_PARSING_USERDATA,Y)}}},s._bufferInitSegment=function(e,r,g){if(this.state===D.State.PARSING){e.video&&delete e.video;var E=e.audio;if(E){E.levelCodec=E.codec,E.id="audio",this.log("Init audio buffer, container:"+E.container+", codecs[parsed]=["+E.codec+"]"),this.hls.trigger(P.Events.BUFFER_CODECS,e);var A=E.initSegment;if(A!=null&&A.byteLength){var L={type:"audio",frag:r,part:null,chunkMeta:g,parent:r.type,data:A};this.hls.trigger(P.Events.BUFFER_APPENDING,L)}this.tick()}}},s.loadFragment=function(e,r,g){var E=this.fragmentTracker.getState(e);this.fragCurrent=e,(this.audioSwitch||E===I.FragmentState.NOT_LOADED||E===I.FragmentState.PARTIAL)&&(e.sn==="initSegment"?this._loadInitSegment(e,r):r.live&&!(0,w.isFiniteNumber)(this.initPTS[e.cc])?(this.log("Waiting for video PTS in continuity counter "+e.cc+" of live stream before loading audio fragment "+e.sn+" of level "+this.trackId),this.state=D.State.WAITING_INIT_PTS):(this.startFragRequested=!0,i.prototype.loadFragment.call(this,e,r,g)))},s.completeAudioSwitch=function(){var e=this.hls,r=this.media,g=this.trackId;r&&(this.log("Switching audio track : flushing all audio"),i.prototype.flushMainBuffer.call(this,0,Number.POSITIVE_INFINITY,"audio")),this.audioSwitch=!1,e.trigger(P.Events.AUDIO_TRACK_SWITCHED,{id:g})},a}(D.default);const h=f},"./src/controller/audio-track-controller.ts":(j,M,b)=>{b.r(M),b.d(M,{default:()=>p});var w=b("./src/events.ts"),D=b("./src/errors.ts"),P=b("./src/controller/base-playlist-controller.ts"),k=b("./src/types/loader.ts");function I(S,m){for(var v=0;v<m.length;v++){var d=m[v];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(S,(o=d.key,t=void 0,typeof(t=function(n,u){if(typeof n!="object"||n===null)return n;var f=n[Symbol.toPrimitive];if(f!==void 0){var h=f.call(n,u||"default");if(typeof h!="object")return h;throw new TypeError("@@toPrimitive must return a primitive value.")}return(u==="string"?String:Number)(n)}(o,"string"))=="symbol"?t:String(t)),d)}var o,t}function T(S,m){return T=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(v,d){return v.__proto__=d,v},T(S,m)}var y=function(S){var m,v;function d(f){var h;return(h=S.call(this,f,"[audio-track-controller]")||this).tracks=[],h.groupId=null,h.tracksInGroup=[],h.trackId=-1,h.trackName="",h.selectDefaultTrack=!0,h.registerListeners(),h}v=S,(m=d).prototype=Object.create(v.prototype),m.prototype.constructor=m,T(m,v);var o,t,n,u=d.prototype;return u.registerListeners=function(){var f=this.hls;f.on(w.Events.MANIFEST_LOADING,this.onManifestLoading,this),f.on(w.Events.MANIFEST_PARSED,this.onManifestParsed,this),f.on(w.Events.LEVEL_LOADING,this.onLevelLoading,this),f.on(w.Events.LEVEL_SWITCHING,this.onLevelSwitching,this),f.on(w.Events.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),f.on(w.Events.ERROR,this.onError,this)},u.unregisterListeners=function(){var f=this.hls;f.off(w.Events.MANIFEST_LOADING,this.onManifestLoading,this),f.off(w.Events.MANIFEST_PARSED,this.onManifestParsed,this),f.off(w.Events.LEVEL_LOADING,this.onLevelLoading,this),f.off(w.Events.LEVEL_SWITCHING,this.onLevelSwitching,this),f.off(w.Events.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),f.off(w.Events.ERROR,this.onError,this)},u.destroy=function(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,S.prototype.destroy.call(this)},u.onManifestLoading=function(){this.tracks=[],this.groupId=null,this.tracksInGroup=[],this.trackId=-1,this.trackName="",this.selectDefaultTrack=!0},u.onManifestParsed=function(f,h){this.tracks=h.audioTracks||[]},u.onAudioTrackLoaded=function(f,h){var i=h.id,c=h.details,l=this.tracksInGroup[i];if(l){var a=l.details;l.details=h.details,this.log("audioTrack "+i+" loaded ["+c.startSN+"-"+c.endSN+"]"),i===this.trackId&&(this.retryCount=0,this.playlistLoaded(i,h,a))}else this.warn("Invalid audio track id "+i)},u.onLevelLoading=function(f,h){this.switchLevel(h.level)},u.onLevelSwitching=function(f,h){this.switchLevel(h.level)},u.switchLevel=function(f){var h=this.hls.levels[f];if(h!=null&&h.audioGroupIds){var i=h.audioGroupIds[h.urlId];if(this.groupId!==i){this.groupId=i;var c=this.tracks.filter(function(a){return!i||a.groupId===i});this.selectDefaultTrack&&!c.some(function(a){return a.default})&&(this.selectDefaultTrack=!1),this.tracksInGroup=c;var l={audioTracks:c};this.log("Updating audio tracks, "+c.length+' track(s) found in "'+i+'" group-id'),this.hls.trigger(w.Events.AUDIO_TRACKS_UPDATED,l),this.selectInitialTrack()}}},u.onError=function(f,h){S.prototype.onError.call(this,f,h),!h.fatal&&h.context&&h.context.type===k.PlaylistContextType.AUDIO_TRACK&&h.context.id===this.trackId&&h.context.groupId===this.groupId&&this.retryLoadingOrFail(h)},u.setAudioTrack=function(f){var h=this.tracksInGroup;if(f<0||f>=h.length)this.warn("Invalid id passed to audio-track controller");else{this.clearTimer();var i=h[this.trackId];this.log("Now switching to audio-track index "+f);var c=h[f],l=c.id,a=c.groupId,s=a===void 0?"":a,e=c.name,r=c.type,g=c.url;if(this.trackId=f,this.trackName=e,this.selectDefaultTrack=!1,this.hls.trigger(w.Events.AUDIO_TRACK_SWITCHING,{id:l,groupId:s,name:e,type:r,url:g}),!c.details||c.details.live){var E=this.switchParams(c.url,i==null?void 0:i.details);this.loadPlaylist(E)}}},u.selectInitialTrack=function(){var f=this.tracksInGroup;console.assert(f.length,"Initial audio track should be selected when tracks are known");var h=this.trackName,i=this.findTrackId(h)||this.findTrackId();i!==-1?this.setAudioTrack(i):(this.warn("No track found for running audio group-ID: "+this.groupId),this.hls.trigger(w.Events.ERROR,{type:D.ErrorTypes.MEDIA_ERROR,details:D.ErrorDetails.AUDIO_TRACK_LOAD_ERROR,fatal:!0}))},u.findTrackId=function(f){for(var h=this.tracksInGroup,i=0;i<h.length;i++){var c=h[i];if((!this.selectDefaultTrack||c.default)&&(!f||f===c.name))return c.id}return-1},u.loadPlaylist=function(f){S.prototype.loadPlaylist.call(this);var h=this.tracksInGroup[this.trackId];if(this.shouldLoadTrack(h)){var i=h.id,c=h.groupId,l=h.url;if(f)try{l=f.addDirectives(l)}catch(a){this.warn("Could not construct new URL with HLS Delivery Directives: "+a)}this.log("loading audio-track playlist for id: "+i),this.clearTimer(),this.hls.trigger(w.Events.AUDIO_TRACK_LOADING,{url:l,id:i,groupId:c,deliveryDirectives:f||null})}},o=d,(t=[{key:"audioTracks",get:function(){return this.tracksInGroup}},{key:"audioTrack",get:function(){return this.trackId},set:function(f){this.selectDefaultTrack=!1,this.setAudioTrack(f)}}])&&I(o.prototype,t),n&&I(o,n),Object.defineProperty(o,"prototype",{writable:!1}),d}(P.default);const p=y},"./src/controller/base-playlist-controller.ts":(j,M,b)=>{b.r(M),b.d(M,{default:()=>I});var w=b("./src/types/level.ts"),D=b("./src/controller/level-helper.ts"),P=b("./src/utils/logger.ts"),k=b("./src/errors.ts"),I=function(){function T(p,S){this.hls=void 0,this.timer=-1,this.requestScheduled=-1,this.canLoad=!1,this.retryCount=0,this.log=void 0,this.warn=void 0,this.log=P.logger.log.bind(P.logger,S+":"),this.warn=P.logger.warn.bind(P.logger,S+":"),this.hls=p}var y=T.prototype;return y.destroy=function(){this.clearTimer(),this.hls=this.log=this.warn=null},y.onError=function(p,S){!S.fatal||S.type!==k.ErrorTypes.NETWORK_ERROR&&S.type!==k.ErrorTypes.KEY_SYSTEM_ERROR||this.stopLoad()},y.clearTimer=function(){clearTimeout(this.timer),this.timer=-1},y.startLoad=function(){this.canLoad=!0,this.retryCount=0,this.requestScheduled=-1,this.loadPlaylist()},y.stopLoad=function(){this.canLoad=!1,this.clearTimer()},y.switchParams=function(p,S){var m=S==null?void 0:S.renditionReports;if(m)for(var v=0;v<m.length;v++){var d=m[v],o=void 0;try{o=new self.URL(d.URI,S.url).href}catch(f){P.logger.warn("Could not construct new URL for Rendition Report: "+f),o=d.URI||""}if(o===p.slice(-o.length)){var t=parseInt(d["LAST-MSN"])||(S==null?void 0:S.lastPartSn),n=parseInt(d["LAST-PART"])||(S==null?void 0:S.lastPartIndex);if(this.hls.config.lowLatencyMode){var u=Math.min(S.age-S.partTarget,S.targetduration);n>=0&&u>S.partTarget&&(n+=1)}return new w.HlsUrlParameters(t,n>=0?n:void 0,w.HlsSkip.No)}}},y.loadPlaylist=function(p){this.requestScheduled===-1&&(this.requestScheduled=self.performance.now())},y.shouldLoadTrack=function(p){return this.canLoad&&p&&!!p.url&&(!p.details||p.details.live)},y.playlistLoaded=function(p,S,m){var v=this,d=S.details,o=S.stats,t=self.performance.now(),n=o.loading.first?Math.max(0,t-o.loading.first):0;if(d.advancedDateTime=Date.now()-n,d.live||m!=null&&m.live){if(d.reloaded(m),m&&this.log("live playlist "+p+" "+(d.advanced?"REFRESHED "+d.lastPartSn+"-"+d.lastPartIndex:"MISSED")),m&&d.fragments.length>0&&(0,D.mergeDetails)(m,d),!this.canLoad||!d.live)return;var u,f=void 0,h=void 0;if(d.canBlockReload&&d.endSN&&d.advanced){var i=this.hls.config.lowLatencyMode,c=d.lastPartSn,l=d.endSN,a=d.lastPartIndex,s=c===l;a!==-1?(f=s?l+1:c,h=s?i?0:a:a+1):f=l+1;var e=d.age,r=e+d.ageHeader,g=Math.min(r-d.partTarget,1.5*d.targetduration);if(g>0){if(m&&g>m.tuneInGoal)this.warn("CDN Tune-in goal increased from: "+m.tuneInGoal+" to: "+g+" with playlist age: "+d.age),g=0;else{var E=Math.floor(g/d.targetduration);f+=E,h!==void 0&&(h+=Math.round(g%d.targetduration/d.partTarget)),this.log("CDN Tune-in age: "+d.ageHeader+"s last advanced "+e.toFixed(2)+"s goal: "+g+" skip sn "+E+" to part "+h)}d.tuneInGoal=g}if(u=this.getDeliveryDirectives(d,S.deliveryDirectives,f,h),i||!s)return void this.loadPlaylist(u)}else u=this.getDeliveryDirectives(d,S.deliveryDirectives,f,h);var A=this.hls.mainForwardBufferInfo,L=A?A.end-A.len:0,_=1e3*(d.edge-L),R=(0,D.computeReloadInterval)(d,_);d.updated?t>this.requestScheduled+R&&(this.requestScheduled=o.loading.start):this.requestScheduled=-1,f!==void 0&&d.canBlockReload?this.requestScheduled=o.loading.first+R-(1e3*d.partTarget||1e3):this.requestScheduled=(this.requestScheduled===-1?t:this.requestScheduled)+R;var x=this.requestScheduled-t;x=Math.max(0,x),this.log("reload live playlist "+p+" in "+Math.round(x)+" ms"),this.timer=self.setTimeout(function(){return v.loadPlaylist(u)},x)}else this.clearTimer()},y.getDeliveryDirectives=function(p,S,m,v){var d=(0,w.getSkipValue)(p,m);return S!=null&&S.skip&&p.deltaUpdateFailed&&(m=S.msn,v=S.part,d=w.HlsSkip.No),new w.HlsUrlParameters(m,v,d)},y.retryLoadingOrFail=function(p){var S,m=this,v=this.hls.config,d=this.retryCount<v.levelLoadingMaxRetry;if(d)if(this.requestScheduled=-1,this.retryCount++,p.details.indexOf("LoadTimeOut")>-1&&(S=p.context)!==null&&S!==void 0&&S.deliveryDirectives)this.warn("retry playlist loading #"+this.retryCount+' after "'+p.details+'"'),this.loadPlaylist();else{var o=Math.min(Math.pow(2,this.retryCount)*v.levelLoadingRetryDelay,v.levelLoadingMaxRetryTimeout);this.timer=self.setTimeout(function(){return m.loadPlaylist()},o),this.warn("retry playlist loading #"+this.retryCount+" in "+o+' ms after "'+p.details+'"')}else this.warn('cannot recover from error "'+p.details+'"'),this.clearTimer(),p.fatal=!0;return d},T}()},"./src/controller/base-stream-controller.ts":(j,M,b)=>{b.r(M),b.d(M,{State:()=>i,default:()=>c});var w=b("./src/polyfills/number.ts"),D=b("./src/task-loop.ts"),P=b("./src/controller/fragment-tracker.ts"),k=b("./src/utils/buffer-helper.ts"),I=b("./src/utils/logger.ts"),T=b("./src/events.ts"),y=b("./src/errors.ts"),p=b("./src/types/transmuxer.ts"),S=b("./src/utils/mp4-tools.ts"),m=b("./src/utils/discontinuities.ts"),v=b("./src/controller/fragment-finders.ts"),d=b("./src/controller/level-helper.ts"),o=b("./src/loader/fragment-loader.ts"),t=b("./src/crypt/decrypter.ts"),n=b("./src/utils/time-ranges.ts"),u=b("./src/types/loader.ts");function f(l,a){for(var s=0;s<a.length;s++){var e=a[s];e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(l,(r=e.key,g=void 0,typeof(g=function(E,A){if(typeof E!="object"||E===null)return E;var L=E[Symbol.toPrimitive];if(L!==void 0){var _=L.call(E,A||"default");if(typeof _!="object")return _;throw new TypeError("@@toPrimitive must return a primitive value.")}return(A==="string"?String:Number)(E)}(r,"string"))=="symbol"?g:String(g)),e)}var r,g}function h(l,a){return h=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(s,e){return s.__proto__=e,s},h(l,a)}var i={STOPPED:"STOPPED",IDLE:"IDLE",KEY_LOADING:"KEY_LOADING",FRAG_LOADING:"FRAG_LOADING",FRAG_LOADING_WAITING_RETRY:"FRAG_LOADING_WAITING_RETRY",WAITING_TRACK:"WAITING_TRACK",PARSING:"PARSING",PARSED:"PARSED",ENDED:"ENDED",ERROR:"ERROR",WAITING_INIT_PTS:"WAITING_INIT_PTS",WAITING_LEVEL:"WAITING_LEVEL"},c=function(l){var a,s;function e(L,_,R,x){var C;return(C=l.call(this)||this).hls=void 0,C.fragPrevious=null,C.fragCurrent=null,C.fragmentTracker=void 0,C.transmuxer=null,C._state=i.STOPPED,C.media=null,C.mediaBuffer=null,C.config=void 0,C.bitrateTest=!1,C.lastCurrentTime=0,C.nextLoadPosition=0,C.startPosition=0,C.loadedmetadata=!1,C.fragLoadError=0,C.retryDate=0,C.levels=null,C.fragmentLoader=void 0,C.keyLoader=void 0,C.levelLastLoaded=null,C.startFragRequested=!1,C.decrypter=void 0,C.initPTS=[],C.onvseeking=null,C.onvended=null,C.logPrefix="",C.log=void 0,C.warn=void 0,C.logPrefix=x,C.log=I.logger.log.bind(I.logger,x+":"),C.warn=I.logger.warn.bind(I.logger,x+":"),C.hls=L,C.fragmentLoader=new o.default(L.config),C.keyLoader=R,C.fragmentTracker=_,C.config=L.config,C.decrypter=new t.default(L.config),L.on(T.Events.LEVEL_SWITCHING,C.onLevelSwitching,function(F){if(F===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return F}(C)),C}s=l,(a=e).prototype=Object.create(s.prototype),a.prototype.constructor=a,h(a,s);var r,g,E,A=e.prototype;return A.doTick=function(){this.onTickEnd()},A.onTickEnd=function(){},A.startLoad=function(L){},A.stopLoad=function(){this.fragmentLoader.abort(),this.keyLoader.abort();var L=this.fragCurrent;L&&(L.abortRequests(),this.fragmentTracker.removeFragment(L)),this.resetTransmuxer(),this.fragCurrent=null,this.fragPrevious=null,this.clearInterval(),this.clearNextTick(),this.state=i.STOPPED},A._streamEnded=function(L,_){if(_.live||L.nextStart||!L.end||!this.media)return!1;var R=_.partList;if(R!=null&&R.length){var x=R[R.length-1];return k.BufferHelper.isBuffered(this.media,x.start+x.duration/2)}var C=_.fragments[_.fragments.length-1].type;return this.fragmentTracker.isEndListAppended(C)},A.getLevelDetails=function(){var L;if(this.levels&&this.levelLastLoaded!==null)return(L=this.levels[this.levelLastLoaded])===null||L===void 0?void 0:L.details},A.onMediaAttached=function(L,_){var R=this.media=this.mediaBuffer=_.media;this.onvseeking=this.onMediaSeeking.bind(this),this.onvended=this.onMediaEnded.bind(this),R.addEventListener("seeking",this.onvseeking),R.addEventListener("ended",this.onvended);var x=this.config;this.levels&&x.autoStartLoad&&this.state===i.STOPPED&&this.startLoad(x.startPosition)},A.onMediaDetaching=function(){var L=this.media;L!=null&&L.ended&&(this.log("MSE detaching and video ended, reset startPosition"),this.startPosition=this.lastCurrentTime=0),L&&this.onvseeking&&this.onvended&&(L.removeEventListener("seeking",this.onvseeking),L.removeEventListener("ended",this.onvended),this.onvseeking=this.onvended=null),this.keyLoader&&this.keyLoader.detach(),this.media=this.mediaBuffer=null,this.loadedmetadata=!1,this.fragmentTracker.removeAllFragments(),this.stopLoad()},A.onMediaSeeking=function(){var L=this.config,_=this.fragCurrent,R=this.media,x=this.mediaBuffer,C=this.state,F=R?R.currentTime:0,O=k.BufferHelper.bufferInfo(x||R,F,L.maxBufferHole);if(this.log("media seeking to "+((0,w.isFiniteNumber)(F)?F.toFixed(3):F)+", state: "+C),this.state===i.ENDED)this.resetLoadingState();else if(_){var N=L.maxFragLookUpTolerance,U=_.start-N,G=_.start+_.duration+N;if(!O.len||G<O.start||U>O.end){var B=F>G;(F<U||B)&&(B&&_.loader&&(this.log("seeking outside of buffer while fragment load in progress, cancel fragment load"),_.abortRequests()),this.resetLoadingState())}}R&&(this.lastCurrentTime=F),this.loadedmetadata||O.len||(this.nextLoadPosition=this.startPosition=F),this.tickImmediate()},A.onMediaEnded=function(){this.startPosition=this.lastCurrentTime=0},A.onLevelSwitching=function(L,_){this.fragLoadError=0},A.onHandlerDestroying=function(){this.stopLoad(),l.prototype.onHandlerDestroying.call(this)},A.onHandlerDestroyed=function(){this.state=i.STOPPED,this.hls.off(T.Events.LEVEL_SWITCHING,this.onLevelSwitching,this),this.fragmentLoader&&this.fragmentLoader.destroy(),this.keyLoader&&this.keyLoader.destroy(),this.decrypter&&this.decrypter.destroy(),this.hls=this.log=this.warn=this.decrypter=this.keyLoader=this.fragmentLoader=this.fragmentTracker=null,l.prototype.onHandlerDestroyed.call(this)},A.loadFragment=function(L,_,R){this._loadFragForPlayback(L,_,R)},A._loadFragForPlayback=function(L,_,R){var x=this;this._doFragLoad(L,_,R,function(C){if(x.fragContextChanged(L))return x.warn("Fragment "+L.sn+(C.part?" p: "+C.part.index:"")+" of level "+L.level+" was dropped during download."),void x.fragmentTracker.removeFragment(L);L.stats.chunkCount++,x._handleFragmentLoadProgress(C)}).then(function(C){if(C){x.fragLoadError=0;var F=x.state;x.fragContextChanged(L)?(F===i.FRAG_LOADING||!x.fragCurrent&&F===i.PARSING)&&(x.fragmentTracker.removeFragment(L),x.state=i.IDLE):("payload"in C&&(x.log("Loaded fragment "+L.sn+" of level "+L.level),x.hls.trigger(T.Events.FRAG_LOADED,C)),x._handleFragmentLoadComplete(C))}}).catch(function(C){x.state!==i.STOPPED&&x.state!==i.ERROR&&(x.warn(C),x.resetFragmentLoading(L))})},A.flushMainBuffer=function(L,_,R){if(R===void 0&&(R=null),L-_){var x={startOffset:L,endOffset:_,type:R};this.fragLoadError=0,this.hls.trigger(T.Events.BUFFER_FLUSHING,x)}},A._loadInitSegment=function(L,_){var R=this;this._doFragLoad(L,_).then(function(x){if(!x||R.fragContextChanged(L)||!R.levels)throw new Error("init load aborted");return x}).then(function(x){var C=R.hls,F=x.payload,O=L.decryptdata;if(F&&F.byteLength>0&&O&&O.key&&O.iv&&O.method==="AES-128"){var N=self.performance.now();return R.decrypter.decrypt(new Uint8Array(F),O.key.buffer,O.iv.buffer).then(function(U){var G=self.performance.now();return C.trigger(T.Events.FRAG_DECRYPTED,{frag:L,payload:U,stats:{tstart:N,tdecrypt:G}}),x.payload=U,x})}return x}).then(function(x){var C=R.fragCurrent,F=R.hls,O=R.levels;if(!O)throw new Error("init load aborted, missing levels");var N=O[L.level].details;console.assert(N,"Level details are defined when init segment is loaded");var U=L.stats;R.state=i.IDLE,R.fragLoadError=0,L.data=new Uint8Array(x.payload),U.parsing.start=U.buffering.start=self.performance.now(),U.parsing.end=U.buffering.end=self.performance.now(),x.frag===C&&F.trigger(T.Events.FRAG_BUFFERED,{stats:U,frag:C,part:null,id:L.type}),R.tick()}).catch(function(x){R.state!==i.STOPPED&&R.state!==i.ERROR&&(R.warn(x),R.resetFragmentLoading(L))})},A.fragContextChanged=function(L){var _=this.fragCurrent;return!L||!_||L.level!==_.level||L.sn!==_.sn||L.urlId!==_.urlId},A.fragBufferedComplete=function(L,_){var R,x,C,F,O=this.mediaBuffer?this.mediaBuffer:this.media;this.log("Buffered "+L.type+" sn: "+L.sn+(_?" part: "+_.index:"")+" of "+(this.logPrefix==="[stream-controller]"?"level":"track")+" "+L.level+" (frag:["+((R=L.startPTS)!=null?R:NaN).toFixed(3)+"-"+((x=L.endPTS)!=null?x:NaN).toFixed(3)+"] > buffer:"+(O?n.default.toString(k.BufferHelper.getBuffered(O)):"(detached)")+")"),this.state=i.IDLE,O&&(!this.loadedmetadata&&L.type==u.PlaylistLevelType.MAIN&&O.buffered.length&&((C=this.fragCurrent)===null||C===void 0?void 0:C.sn)===((F=this.fragPrevious)===null||F===void 0?void 0:F.sn)&&(this.loadedmetadata=!0,this.seekToStartPos()),this.tick())},A.seekToStartPos=function(){},A._handleFragmentLoadComplete=function(L){var _=this.transmuxer;if(_){var R=L.frag,x=L.part,C=L.partsLoaded,F=!C||C.length===0||C.some(function(N){return!N}),O=new p.ChunkMetadata(R.level,R.sn,R.stats.chunkCount+1,0,x?x.index:-1,!F);_.flush(O)}},A._handleFragmentLoadProgress=function(L){},A._doFragLoad=function(L,_,R,x){var C,F=this;if(R===void 0&&(R=null),!this.levels)throw new Error("frag load aborted, missing levels");var O=null;if(!L.encrypted||(C=L.decryptdata)!==null&&C!==void 0&&C.key?!L.encrypted&&_.encryptedFragments.length&&this.keyLoader.loadClear(L,_.encryptedFragments):(this.log("Loading key for "+L.sn+" of ["+_.startSN+"-"+_.endSN+"], "+(this.logPrefix==="[stream-controller]"?"level":"track")+" "+L.level),this.state=i.KEY_LOADING,this.fragCurrent=L,O=this.keyLoader.load(L).then(function(H){if(!F.fragContextChanged(H.frag))return F.hls.trigger(T.Events.KEY_LOADED,H),F.state===i.KEY_LOADING&&(F.state=i.IDLE),H}),this.hls.trigger(T.Events.KEY_LOADING,{frag:L}),this.throwIfFragContextChanged("KEY_LOADING")),R=Math.max(L.start,R||0),this.config.lowLatencyMode&&_){var N=_.partList;if(N&&x){R>L.end&&_.fragmentHint&&(L=_.fragmentHint);var U=this.getNextPart(N,L,R);if(U>-1){var G=N[U];return this.log("Loading part sn: "+L.sn+" p: "+G.index+" cc: "+L.cc+" of playlist ["+_.startSN+"-"+_.endSN+"] parts [0-"+U+"-"+(N.length-1)+"] "+(this.logPrefix==="[stream-controller]"?"level":"track")+": "+L.level+", target: "+parseFloat(R.toFixed(3))),this.nextLoadPosition=G.start+G.duration,this.state=i.FRAG_LOADING,this.hls.trigger(T.Events.FRAG_LOADING,{frag:L,part:N[U],targetBufferTime:R}),this.throwIfFragContextChanged("FRAG_LOADING parts"),O?O.then(function(H){return!H||F.fragContextChanged(H.frag)?null:F.doFragPartsLoad(L,N,U,x)}).catch(function(H){return F.handleFragLoadError(H)}):this.doFragPartsLoad(L,N,U,x).catch(function(H){return F.handleFragLoadError(H)})}if(!L.url||this.loadedEndOfParts(N,R))return Promise.resolve(null)}}this.log("Loading fragment "+L.sn+" cc: "+L.cc+" "+(_?"of ["+_.startSN+"-"+_.endSN+"] ":"")+(this.logPrefix==="[stream-controller]"?"level":"track")+": "+L.level+", target: "+parseFloat(R.toFixed(3))),(0,w.isFiniteNumber)(L.sn)&&!this.bitrateTest&&(this.nextLoadPosition=L.start+L.duration),this.state=i.FRAG_LOADING,this.hls.trigger(T.Events.FRAG_LOADING,{frag:L,targetBufferTime:R}),this.throwIfFragContextChanged("FRAG_LOADING");var B=this.config.progressive;return B&&O?O.then(function(H){return!H||F.fragContextChanged(H==null?void 0:H.frag)?null:F.fragmentLoader.load(L,x)}).catch(function(H){return F.handleFragLoadError(H)}):Promise.all([this.fragmentLoader.load(L,B?x:void 0),O]).then(function(H){var V=H[0];return!B&&V&&x&&x(V),V}).catch(function(H){return F.handleFragLoadError(H)})},A.throwIfFragContextChanged=function(L){if(this.fragCurrent===null)throw new Error("frag load aborted, context changed in "+L)},A.doFragPartsLoad=function(L,_,R,x){var C=this;return new Promise(function(F,O){var N=[];(function U(G){var B=_[G];C.fragmentLoader.loadPart(L,B,x).then(function(H){N[B.index]=H;var V=H.part;C.hls.trigger(T.Events.FRAG_LOADED,H);var K=_[G+1];if(!K||K.fragment!==L)return F({frag:L,part:V,partsLoaded:N});U(G+1)}).catch(O)})(R)})},A.handleFragLoadError=function(L){if("data"in L){var _=L.data;L.data&&_.details===y.ErrorDetails.INTERNAL_ABORTED?this.handleFragLoadAborted(_.frag,_.part):this.hls.trigger(T.Events.ERROR,_)}else this.hls.trigger(T.Events.ERROR,{type:y.ErrorTypes.OTHER_ERROR,details:y.ErrorDetails.INTERNAL_EXCEPTION,err:L,fatal:!0});return null},A._handleTransmuxerFlush=function(L){var _=this.getCurrentContext(L);if(_&&this.state===i.PARSING){var R=_.frag,x=_.part,C=_.level,F=self.performance.now();R.stats.parsing.end=F,x&&(x.stats.parsing.end=F),this.updateLevelTiming(R,x,C,L.partial)}else this.fragCurrent||this.state===i.STOPPED||this.state===i.ERROR||(this.state=i.IDLE)},A.getCurrentContext=function(L){var _=this.levels,R=L.level,x=L.sn,C=L.part;if(!_||!_[R])return this.warn("Levels object was unset while buffering fragment "+x+" of level "+R+". The current chunk will not be buffered."),null;var F=_[R],O=C>-1?(0,d.getPartWith)(F,x,C):null,N=O?O.fragment:(0,d.getFragmentWithSN)(F,x,this.fragCurrent);return N?{frag:N,part:O,level:F}:null},A.bufferFragmentData=function(L,_,R,x){if(L&&this.state===i.PARSING){var C=L.data1,F=L.data2,O=C;if(C&&F&&(O=(0,S.appendUint8Array)(C,F)),O&&O.length){var N={type:L.type,frag:_,part:R,chunkMeta:x,parent:_.type,data:O};this.hls.trigger(T.Events.BUFFER_APPENDING,N),L.dropped&&L.independent&&!R&&this.flushBufferGap(_)}}},A.flushBufferGap=function(L){var _=this.media;if(_)if(k.BufferHelper.isBuffered(_,_.currentTime)){var R=_.currentTime,x=k.BufferHelper.bufferInfo(_,R,0),C=L.duration,F=Math.min(2*this.config.maxFragLookUpTolerance,.25*C),O=Math.max(Math.min(L.start-F,x.end-F),R+F);L.start-O>F&&this.flushMainBuffer(O,L.start)}else this.flushMainBuffer(0,L.start)},A.getFwdBufferInfo=function(L,_){var R=this.config,x=this.getLoadPosition();if(!(0,w.isFiniteNumber)(x))return null;var C=k.BufferHelper.bufferInfo(L,x,R.maxBufferHole);if(C.len===0&&C.nextStart!==void 0){var F=this.fragmentTracker.getBufferedFrag(x,_);if(F&&C.nextStart<F.end)return k.BufferHelper.bufferInfo(L,x,Math.max(C.nextStart,R.maxBufferHole))}return C},A.getMaxBufferLength=function(L){var _,R=this.config;return _=L?Math.max(8*R.maxBufferSize/L,R.maxBufferLength):R.maxBufferLength,Math.min(_,R.maxMaxBufferLength)},A.reduceMaxBufferLength=function(L){var _=this.config,R=L||_.maxBufferLength;return _.maxMaxBufferLength>=R&&(_.maxMaxBufferLength/=2,this.warn("Reduce max buffer length to "+_.maxMaxBufferLength+"s"),!0)},A.getNextFragment=function(L,_){var R=_.fragments,x=R.length;if(!x)return null;var C,F=this.config,O=R[0].start;if(_.live){var N=F.initialLiveManifestSize;if(x<N)return this.warn("Not enough fragments to start playback (have: "+x+", need: "+N+")"),null;_.PTSKnown||this.startFragRequested||this.startPosition!==-1||(C=this.getInitialLiveFragment(_,R),this.startPosition=C?this.hls.liveSyncPosition||C.start:L)}else L<=O&&(C=R[0]);if(!C){var U=F.lowLatencyMode?_.partEnd:_.fragmentEnd;C=this.getFragmentAtPosition(L,U,_)}return this.mapToInitFragWhenRequired(C)},A.mapToInitFragWhenRequired=function(L){return L==null||!L.initSegment||L!=null&&L.initSegment.data||this.bitrateTest?L:L.initSegment},A.getNextPart=function(L,_,R){for(var x=-1,C=!1,F=!0,O=0,N=L.length;O<N;O++){var U=L[O];if(F=F&&!U.independent,x>-1&&R<U.start)break;var G=U.loaded;G?x=-1:(C||U.independent||F)&&U.fragment===_&&(x=O),C=G}return x},A.loadedEndOfParts=function(L,_){var R=L[L.length-1];return R&&_>R.start&&R.loaded},A.getInitialLiveFragment=function(L,_){var R=this.fragPrevious,x=null;if(R){if(L.hasProgramDateTime&&(this.log("Live playlist, switching playlist, load frag with same PDT: "+R.programDateTime),x=(0,v.findFragmentByPDT)(_,R.endProgramDateTime,this.config.maxFragLookUpTolerance)),!x){var C=R.sn+1;if(C>=L.startSN&&C<=L.endSN){var F=_[C-L.startSN];R.cc===F.cc&&(x=F,this.log("Live playlist, switching playlist, load frag with next SN: "+x.sn))}x||(x=(0,v.findFragWithCC)(_,R.cc))&&this.log("Live playlist, switching playlist, load frag with same CC: "+x.sn)}}else{var O=this.hls.liveSyncPosition;O!==null&&(x=this.getFragmentAtPosition(O,this.bitrateTest?L.fragmentEnd:L.edge,L))}return x},A.getFragmentAtPosition=function(L,_,R){var x,C=this.config,F=this.fragPrevious,O=R.fragments,N=R.endSN,U=R.fragmentHint,G=C.maxFragLookUpTolerance,B=!!(C.lowLatencyMode&&R.partList&&U);if(B&&U&&!this.bitrateTest&&(O=O.concat(U),N=U.sn),L<_){var H=L>_-G?0:G;x=(0,v.findFragmentByPTS)(F,O,L,H)}else x=O[O.length-1];if(x){var V=x.sn-R.startSN;if(this.fragmentTracker.getState(x)===P.FragmentState.OK&&(F=x),F&&x.sn===F.sn&&!B&&F&&x.level===F.level){var K=O[V+1];x.sn<N&&this.fragmentTracker.getState(K)!==P.FragmentState.OK?(this.log("SN "+x.sn+" just loaded, load next one: "+K.sn),x=K):x=null}}return x},A.synchronizeToLiveEdge=function(L){var _=this.config,R=this.media;if(R){var x=this.hls.liveSyncPosition,C=R.currentTime,F=L.fragments[0].start,O=L.edge,N=C>=F-_.maxFragLookUpTolerance&&C<=O;if(x!==null&&R.duration>x&&(C<x||!N)){var U=_.liveMaxLatencyDuration!==void 0?_.liveMaxLatencyDuration:_.liveMaxLatencyDurationCount*L.targetduration;(!N&&R.readyState<4||C<O-U)&&(this.loadedmetadata||(this.nextLoadPosition=x),R.readyState&&(this.warn("Playback: "+C.toFixed(3)+" is located too far from the end of live sliding playlist: "+O+", reset currentTime to : "+x.toFixed(3)),R.currentTime=x))}}},A.alignPlaylists=function(L,_){var R=this.levels,x=this.levelLastLoaded,C=this.fragPrevious,F=x!==null?R[x]:null,O=L.fragments.length;if(!O)return this.warn("No fragments in live playlist"),0;var N=L.fragments[0].start,U=!_,G=L.alignedSliding&&(0,w.isFiniteNumber)(N);if(U||!G&&!N){(0,m.alignStream)(C,F,L);var B=L.fragments[0].start;return this.log("Live playlist sliding: "+B.toFixed(2)+" start-sn: "+(_?_.startSN:"na")+"->"+L.startSN+" prev-sn: "+(C?C.sn:"na")+" fragments: "+O),B}return N},A.waitForCdnTuneIn=function(L){return L.live&&L.canBlockReload&&L.partTarget&&L.tuneInGoal>Math.max(L.partHoldBack,3*L.partTarget)},A.setStartPosition=function(L,_){var R=this.startPosition;if(R<_&&(R=-1),R===-1||this.lastCurrentTime===-1){var x=L.startTimeOffset;(0,w.isFiniteNumber)(x)?(R=_+x,x<0&&(R+=L.totalduration),R=Math.min(Math.max(_,R),_+L.totalduration),this.log("Start time offset "+x+" found in playlist, adjust startPosition to "+R),this.startPosition=R):L.live?R=this.hls.liveSyncPosition||_:this.startPosition=R=0,this.lastCurrentTime=R}this.nextLoadPosition=R},A.getLoadPosition=function(){var L=this.media,_=0;return this.loadedmetadata&&L?_=L.currentTime:this.nextLoadPosition&&(_=this.nextLoadPosition),_},A.handleFragLoadAborted=function(L,_){this.transmuxer&&L.sn!=="initSegment"&&L.stats.aborted&&(this.warn("Fragment "+L.sn+(_?" part"+_.index:"")+" of level "+L.level+" was aborted"),this.resetFragmentLoading(L))},A.resetFragmentLoading=function(L){this.fragCurrent&&(this.fragContextChanged(L)||this.state===i.FRAG_LOADING_WAITING_RETRY)||(this.state=i.IDLE)},A.onFragmentOrKeyLoadError=function(L,_){if(_.fatal)return this.stopLoad(),void(this.state=i.ERROR);var R=this.config;if(_.chunkMeta){var x=this.getCurrentContext(_.chunkMeta);x&&(_.frag=x.frag,_.levelRetry=!0,this.fragLoadError=R.fragLoadingMaxRetry)}var C=_.frag;if(C&&C.type===L){var F=this.fragCurrent;if(console.assert(F&&C.sn===F.sn&&C.level===F.level&&C.urlId===F.urlId,"Frag load error must match current frag to retry"),this.fragLoadError+1<=R.fragLoadingMaxRetry){this.loadedmetadata||(this.startFragRequested=!1,this.nextLoadPosition=this.startPosition);var O=Math.min(Math.pow(2,this.fragLoadError)*R.fragLoadingRetryDelay,R.fragLoadingMaxRetryTimeout);this.warn("Fragment "+C.sn+" of "+L+" "+C.level+" failed to load, retrying in "+O+"ms"),this.retryDate=self.performance.now()+O,this.fragLoadError++,this.state=i.FRAG_LOADING_WAITING_RETRY}else _.levelRetry?(L===u.PlaylistLevelType.AUDIO&&(this.fragCurrent=null),this.fragLoadError=0,this.state=i.IDLE):(I.logger.error(_.details+" reaches max retry, redispatch as fatal ..."),_.fatal=!0,this.hls.stopLoad(),this.state=i.ERROR)}},A.afterBufferFlushed=function(L,_,R){if(L){var x=k.BufferHelper.getBuffered(L);this.fragmentTracker.detectEvictedFragments(_,x,R),this.state===i.ENDED&&this.resetLoadingState()}},A.resetLoadingState=function(){this.log("Reset loading state"),this.fragCurrent=null,this.fragPrevious=null,this.state=i.IDLE},A.resetStartWhenNotLoaded=function(L){if(!this.loadedmetadata){this.startFragRequested=!1;var _=this.levels?this.levels[L].details:null;_!=null&&_.live?(this.startPosition=-1,this.setStartPosition(_,0),this.resetLoadingState()):this.nextLoadPosition=this.startPosition}},A.updateLevelTiming=function(L,_,R,x){var C=this,F=R.details;console.assert(!!F,"level.details must be defined"),Object.keys(L.elementaryStreams).reduce(function(O,N){var U=L.elementaryStreams[N];if(U){var G=U.endPTS-U.startPTS;if(G<=0)return C.warn("Could not parse fragment "+L.sn+" "+N+" duration reliably ("+G+")"),O||!1;var B=x?0:(0,d.updateFragPTSDTS)(F,L,U.startPTS,U.endPTS,U.startDTS,U.endDTS);return C.hls.trigger(T.Events.LEVEL_PTS_UPDATED,{details:F,level:R,drift:B,type:N,frag:L,start:U.startPTS,end:U.endPTS}),!0}return O},!1)||(this.warn("Found no media in fragment "+L.sn+" of level "+R.id+" resetting transmuxer to fallback to playlist timing"),this.resetTransmuxer()),this.state=i.PARSED,this.hls.trigger(T.Events.FRAG_PARSED,{frag:L,part:_})},A.resetTransmuxer=function(){this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null)},r=e,(g=[{key:"state",get:function(){return this._state},set:function(L){var _=this._state;_!==L&&(this._state=L,this.log(_+"->"+L))}}])&&f(r.prototype,g),E&&f(r,E),Object.defineProperty(r,"prototype",{writable:!1}),e}(D.default)},"./src/controller/buffer-controller.ts":(j,M,b)=>{b.r(M),b.d(M,{default:()=>v});var w=b("./src/polyfills/number.ts"),D=b("./src/events.ts"),P=b("./src/utils/logger.ts"),k=b("./src/errors.ts"),I=b("./src/utils/buffer-helper.ts"),T=b("./src/utils/mediasource-helper.ts"),y=b("./src/loader/fragment.ts"),p=b("./src/controller/buffer-operation-queue.ts"),S=(0,T.getMediaSource)(),m=/([ha]vc.)(?:\.[^.,]+)+/,v=function(){function d(t){var n=this;this.details=null,this._objectUrl=null,this.operationQueue=void 0,this.listeners=void 0,this.hls=void 0,this.bufferCodecEventsExpected=0,this._bufferCodecEventsTotal=0,this.media=null,this.mediaSource=null,this.lastMpegAudioChunk=null,this.appendError=0,this.tracks={},this.pendingTracks={},this.sourceBuffer=void 0,this._onMediaSourceOpen=function(){var u=n.media,f=n.mediaSource;P.logger.log("[buffer-controller]: Media source opened"),u&&(u.removeEventListener("emptied",n._onMediaEmptied),n.updateMediaElementDuration(),n.hls.trigger(D.Events.MEDIA_ATTACHED,{media:u})),f&&f.removeEventListener("sourceopen",n._onMediaSourceOpen),n.checkPendingTracks()},this._onMediaSourceClose=function(){P.logger.log("[buffer-controller]: Media source closed")},this._onMediaSourceEnded=function(){P.logger.log("[buffer-controller]: Media source ended")},this._onMediaEmptied=function(){var u=n.media,f=n._objectUrl;u&&u.src!==f&&P.logger.error("Media element src was set while attaching MediaSource ("+f+" > "+u.src+")")},this.hls=t,this._initSourceBuffer(),this.registerListeners()}var o=d.prototype;return o.hasSourceTypes=function(){return this.getSourceBufferTypes().length>0||Object.keys(this.pendingTracks).length>0},o.destroy=function(){this.unregisterListeners(),this.details=null,this.lastMpegAudioChunk=null},o.registerListeners=function(){var t=this.hls;t.on(D.Events.MEDIA_ATTACHING,this.onMediaAttaching,this),t.on(D.Events.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(D.Events.MANIFEST_PARSED,this.onManifestParsed,this),t.on(D.Events.BUFFER_RESET,this.onBufferReset,this),t.on(D.Events.BUFFER_APPENDING,this.onBufferAppending,this),t.on(D.Events.BUFFER_CODECS,this.onBufferCodecs,this),t.on(D.Events.BUFFER_EOS,this.onBufferEos,this),t.on(D.Events.BUFFER_FLUSHING,this.onBufferFlushing,this),t.on(D.Events.LEVEL_UPDATED,this.onLevelUpdated,this),t.on(D.Events.FRAG_PARSED,this.onFragParsed,this),t.on(D.Events.FRAG_CHANGED,this.onFragChanged,this)},o.unregisterListeners=function(){var t=this.hls;t.off(D.Events.MEDIA_ATTACHING,this.onMediaAttaching,this),t.off(D.Events.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(D.Events.MANIFEST_PARSED,this.onManifestParsed,this),t.off(D.Events.BUFFER_RESET,this.onBufferReset,this),t.off(D.Events.BUFFER_APPENDING,this.onBufferAppending,this),t.off(D.Events.BUFFER_CODECS,this.onBufferCodecs,this),t.off(D.Events.BUFFER_EOS,this.onBufferEos,this),t.off(D.Events.BUFFER_FLUSHING,this.onBufferFlushing,this),t.off(D.Events.LEVEL_UPDATED,this.onLevelUpdated,this),t.off(D.Events.FRAG_PARSED,this.onFragParsed,this),t.off(D.Events.FRAG_CHANGED,this.onFragChanged,this)},o._initSourceBuffer=function(){this.sourceBuffer={},this.operationQueue=new p.default(this.sourceBuffer),this.listeners={audio:[],video:[],audiovideo:[]},this.lastMpegAudioChunk=null},o.onManifestParsed=function(t,n){var u=2;(n.audio&&!n.video||!n.altAudio)&&(u=1),this.bufferCodecEventsExpected=this._bufferCodecEventsTotal=u,this.details=null,P.logger.log(this.bufferCodecEventsExpected+" bufferCodec event(s) expected")},o.onMediaAttaching=function(t,n){var u=this.media=n.media;if(u&&S){var f=this.mediaSource=new S;f.addEventListener("sourceopen",this._onMediaSourceOpen),f.addEventListener("sourceended",this._onMediaSourceEnded),f.addEventListener("sourceclose",this._onMediaSourceClose),u.src=self.URL.createObjectURL(f),this._objectUrl=u.src,u.addEventListener("emptied",this._onMediaEmptied)}},o.onMediaDetaching=function(){var t=this.media,n=this.mediaSource,u=this._objectUrl;if(n){if(P.logger.log("[buffer-controller]: media source detaching"),n.readyState==="open")try{n.endOfStream()}catch(f){P.logger.warn("[buffer-controller]: onMediaDetaching: "+f.message+" while calling endOfStream")}this.onBufferReset(),n.removeEventListener("sourceopen",this._onMediaSourceOpen),n.removeEventListener("sourceended",this._onMediaSourceEnded),n.removeEventListener("sourceclose",this._onMediaSourceClose),t&&(t.removeEventListener("emptied",this._onMediaEmptied),u&&self.URL.revokeObjectURL(u),t.src===u?(t.removeAttribute("src"),t.load()):P.logger.warn("[buffer-controller]: media.src was changed by a third party - skip cleanup")),this.mediaSource=null,this.media=null,this._objectUrl=null,this.bufferCodecEventsExpected=this._bufferCodecEventsTotal,this.pendingTracks={},this.tracks={}}this.hls.trigger(D.Events.MEDIA_DETACHED,void 0)},o.onBufferReset=function(){var t=this;this.getSourceBufferTypes().forEach(function(n){var u=t.sourceBuffer[n];try{u&&(t.removeBufferListeners(n),t.mediaSource&&t.mediaSource.removeSourceBuffer(u),t.sourceBuffer[n]=void 0)}catch(f){P.logger.warn("[buffer-controller]: Failed to reset the "+n+" buffer",f)}}),this._initSourceBuffer()},o.onBufferCodecs=function(t,n){var u=this,f=this.getSourceBufferTypes().length;Object.keys(n).forEach(function(h){if(f){var i=u.tracks[h];if(i&&typeof i.buffer.changeType=="function"){var c=n[h],l=c.id,a=c.codec,s=c.levelCodec,e=c.container,r=c.metadata,g=(i.levelCodec||i.codec).replace(m,"$1"),E=(s||a).replace(m,"$1");if(g!==E){var A=e+";codecs="+(s||a);u.appendChangeType(h,A),P.logger.log("[buffer-controller]: switching codec "+g+" to "+E),u.tracks[h]={buffer:i.buffer,codec:a,container:e,levelCodec:s,metadata:r,id:l}}}}else u.pendingTracks[h]=n[h]}),f||(this.bufferCodecEventsExpected=Math.max(this.bufferCodecEventsExpected-1,0),this.mediaSource&&this.mediaSource.readyState==="open"&&this.checkPendingTracks())},o.appendChangeType=function(t,n){var u=this,f=this.operationQueue,h={execute:function(){var i=u.sourceBuffer[t];i&&(P.logger.log("[buffer-controller]: changing "+t+" sourceBuffer type to "+n),i.changeType(n)),f.shiftAndExecuteNext(t)},onStart:function(){},onComplete:function(){},onError:function(i){P.logger.warn("[buffer-controller]: Failed to change "+t+" SourceBuffer type",i)}};f.append(h,t)},o.onBufferAppending=function(t,n){var u=this,f=this.hls,h=this.operationQueue,i=this.tracks,c=n.data,l=n.type,a=n.frag,s=n.part,e=n.chunkMeta,r=e.buffering[l],g=self.performance.now();r.start=g;var E=a.stats.buffering,A=s?s.stats.buffering:null;E.start===0&&(E.start=g),A&&A.start===0&&(A.start=g);var L=i.audio,_=!1;l==="audio"&&(L==null?void 0:L.container)==="audio/mpeg"&&(_=!this.lastMpegAudioChunk||e.id===1||this.lastMpegAudioChunk.sn!==e.sn,this.lastMpegAudioChunk=e);var R=a.start,x={execute:function(){if(r.executeStart=self.performance.now(),_){var C=u.sourceBuffer[l];if(C){var F=R-C.timestampOffset;Math.abs(F)>=.1&&(P.logger.log("[buffer-controller]: Updating audio SourceBuffer timestampOffset to "+R+" (delta: "+F+") sn: "+a.sn+")"),C.timestampOffset=R)}}u.appendExecutor(c,l)},onStart:function(){},onComplete:function(){var C=self.performance.now();r.executeEnd=r.end=C,E.first===0&&(E.first=C),A&&A.first===0&&(A.first=C);var F=u.sourceBuffer,O={};for(var N in F)O[N]=I.BufferHelper.getBuffered(F[N]);u.appendError=0,u.hls.trigger(D.Events.BUFFER_APPENDED,{type:l,frag:a,part:s,chunkMeta:e,parent:a.type,timeRanges:O})},onError:function(C){P.logger.error("[buffer-controller]: Error encountered while trying to append to the "+l+" SourceBuffer",C);var F={type:k.ErrorTypes.MEDIA_ERROR,parent:a.type,details:k.ErrorDetails.BUFFER_APPEND_ERROR,err:C,fatal:!1};C.code===DOMException.QUOTA_EXCEEDED_ERR?F.details=k.ErrorDetails.BUFFER_FULL_ERROR:(u.appendError++,F.details=k.ErrorDetails.BUFFER_APPEND_ERROR,u.appendError>f.config.appendErrorMaxRetry&&(P.logger.error("[buffer-controller]: Failed "+f.config.appendErrorMaxRetry+" times to append segment in sourceBuffer"),F.fatal=!0,f.stopLoad())),f.trigger(D.Events.ERROR,F)}};h.append(x,l)},o.onBufferFlushing=function(t,n){var u=this,f=this.operationQueue,h=function(i){return{execute:u.removeExecutor.bind(u,i,n.startOffset,n.endOffset),onStart:function(){},onComplete:function(){u.hls.trigger(D.Events.BUFFER_FLUSHED,{type:i})},onError:function(c){P.logger.warn("[buffer-controller]: Failed to remove from "+i+" SourceBuffer",c)}}};n.type?f.append(h(n.type),n.type):this.getSourceBufferTypes().forEach(function(i){f.append(h(i),i)})},o.onFragParsed=function(t,n){var u=this,f=n.frag,h=n.part,i=[],c=h?h.elementaryStreams:f.elementaryStreams;c[y.ElementaryStreamTypes.AUDIOVIDEO]?i.push("audiovideo"):(c[y.ElementaryStreamTypes.AUDIO]&&i.push("audio"),c[y.ElementaryStreamTypes.VIDEO]&&i.push("video")),i.length===0&&P.logger.warn("Fragments must have at least one ElementaryStreamType set. type: "+f.type+" level: "+f.level+" sn: "+f.sn),this.blockBuffers(function(){var l=self.performance.now();f.stats.buffering.end=l,h&&(h.stats.buffering.end=l);var a=h?h.stats:f.stats;u.hls.trigger(D.Events.FRAG_BUFFERED,{frag:f,part:h,stats:a,id:f.type})},i)},o.onFragChanged=function(t,n){this.flushBackBuffer()},o.onBufferEos=function(t,n){var u=this;this.getSourceBufferTypes().reduce(function(f,h){var i=u.sourceBuffer[h];return!i||n.type&&n.type!==h||(i.ending=!0,i.ended||(i.ended=!0,P.logger.log("[buffer-controller]: "+h+" sourceBuffer now EOS"))),f&&!(i&&!i.ended)},!0)&&(P.logger.log("[buffer-controller]: Queueing mediaSource.endOfStream()"),this.blockBuffers(function(){u.getSourceBufferTypes().forEach(function(h){var i=u.sourceBuffer[h];i&&(i.ending=!1)});var f=u.mediaSource;f&&f.readyState==="open"?(P.logger.log("[buffer-controller]: Calling mediaSource.endOfStream()"),f.endOfStream()):f&&P.logger.info("[buffer-controller]: Could not call mediaSource.endOfStream(). mediaSource.readyState: "+f.readyState)}))},o.onLevelUpdated=function(t,n){var u=n.details;u.fragments.length&&(this.details=u,this.getSourceBufferTypes().length?this.blockBuffers(this.updateMediaElementDuration.bind(this)):this.updateMediaElementDuration())},o.flushBackBuffer=function(){var t=this.hls,n=this.details,u=this.media,f=this.sourceBuffer;if(u&&n!==null){var h=this.getSourceBufferTypes();if(h.length){var i=n.live&&t.config.liveBackBufferLength!==null?t.config.liveBackBufferLength:t.config.backBufferLength;if((0,w.isFiniteNumber)(i)&&!(i<0)){var c=u.currentTime,l=n.levelTargetDuration,a=Math.max(i,l),s=Math.floor(c/l)*l-a;h.forEach(function(e){var r=f[e];if(r){var g=I.BufferHelper.getBuffered(r);if(g.length>0&&s>g.start(0)){if(t.trigger(D.Events.BACK_BUFFER_REACHED,{bufferEnd:s}),n.live)t.trigger(D.Events.LIVE_BACK_BUFFER_REACHED,{bufferEnd:s});else if(r.ended&&g.end(g.length-1)-c<2*l)return void P.logger.info("[buffer-controller]: Cannot flush "+e+" back buffer while SourceBuffer is in ended state");t.trigger(D.Events.BUFFER_FLUSHING,{startOffset:0,endOffset:s,type:e})}}})}}}},o.updateMediaElementDuration=function(){if(this.details&&this.media&&this.mediaSource&&this.mediaSource.readyState==="open"){var t=this.details,n=this.hls,u=this.media,f=this.mediaSource,h=t.fragments[0].start+t.totalduration,i=u.duration,c=(0,w.isFiniteNumber)(f.duration)?f.duration:0;t.live&&n.config.liveDurationInfinity?(P.logger.log("[buffer-controller]: Media Source duration is set to Infinity"),f.duration=1/0,this.updateSeekableRange(t)):(h>c&&h>i||!(0,w.isFiniteNumber)(i))&&(P.logger.log("[buffer-controller]: Updating Media Source duration to "+h.toFixed(3)),f.duration=h)}},o.updateSeekableRange=function(t){var n=this.mediaSource,u=t.fragments;if(u.length&&t.live&&n!=null&&n.setLiveSeekableRange){var f=Math.max(0,u[0].start),h=Math.max(f,f+t.totalduration);n.setLiveSeekableRange(f,h)}},o.checkPendingTracks=function(){var t=this.bufferCodecEventsExpected,n=this.operationQueue,u=this.pendingTracks,f=Object.keys(u).length;if(f&&!t||f===2){this.createSourceBuffers(u),this.pendingTracks={};var h=this.getSourceBufferTypes();if(h.length===0)return void this.hls.trigger(D.Events.ERROR,{type:k.ErrorTypes.MEDIA_ERROR,details:k.ErrorDetails.BUFFER_INCOMPATIBLE_CODECS_ERROR,fatal:!0,reason:"could not create source buffer for media codec(s)"});h.forEach(function(i){n.executeNext(i)})}},o.createSourceBuffers=function(t){var n=this.sourceBuffer,u=this.mediaSource;if(!u)throw Error("createSourceBuffers called when mediaSource was null");var f=0;for(var h in t)if(!n[h]){var i=t[h];if(!i)throw Error("source buffer exists for track "+h+", however track does not");var c=i.levelCodec||i.codec,l=i.container+";codecs="+c;P.logger.log("[buffer-controller]: creating sourceBuffer("+l+")");try{var a=n[h]=u.addSourceBuffer(l),s=h;this.addBufferListener(s,"updatestart",this._onSBUpdateStart),this.addBufferListener(s,"updateend",this._onSBUpdateEnd),this.addBufferListener(s,"error",this._onSBUpdateError),this.tracks[h]={buffer:a,codec:c,container:i.container,levelCodec:i.levelCodec,metadata:i.metadata,id:i.id},f++}catch(e){P.logger.error("[buffer-controller]: error while trying to add sourceBuffer: "+e.message),this.hls.trigger(D.Events.ERROR,{type:k.ErrorTypes.MEDIA_ERROR,details:k.ErrorDetails.BUFFER_ADD_CODEC_ERROR,fatal:!1,error:e,mimeType:l})}}f&&this.hls.trigger(D.Events.BUFFER_CREATED,{tracks:this.tracks})},o._onSBUpdateStart=function(t){this.operationQueue.current(t).onStart()},o._onSBUpdateEnd=function(t){var n=this.operationQueue;n.current(t).onComplete(),n.shiftAndExecuteNext(t)},o._onSBUpdateError=function(t,n){P.logger.error("[buffer-controller]: "+t+" SourceBuffer error",n),this.hls.trigger(D.Events.ERROR,{type:k.ErrorTypes.MEDIA_ERROR,details:k.ErrorDetails.BUFFER_APPENDING_ERROR,fatal:!1});var u=this.operationQueue.current(t);u&&u.onError(n)},o.removeExecutor=function(t,n,u){var f=this.media,h=this.mediaSource,i=this.operationQueue,c=this.sourceBuffer[t];if(!f||!h||!c)return P.logger.warn("[buffer-controller]: Attempting to remove from the "+t+" SourceBuffer, but it does not exist"),void i.shiftAndExecuteNext(t);var l=(0,w.isFiniteNumber)(f.duration)?f.duration:1/0,a=(0,w.isFiniteNumber)(h.duration)?h.duration:1/0,s=Math.max(0,n),e=Math.min(u,l,a);e>s&&!c.ending?(c.ended=!1,P.logger.log("[buffer-controller]: Removing ["+s+","+e+"] from the "+t+" SourceBuffer"),console.assert(!c.updating,t+" sourceBuffer must not be updating"),c.remove(s,e)):i.shiftAndExecuteNext(t)},o.appendExecutor=function(t,n){var u=this.operationQueue,f=this.sourceBuffer[n];if(!f)return P.logger.warn("[buffer-controller]: Attempting to append to the "+n+" SourceBuffer, but it does not exist"),void u.shiftAndExecuteNext(n);f.ended=!1,console.assert(!f.updating,n+" sourceBuffer must not be updating"),f.appendBuffer(t)},o.blockBuffers=function(t,n){var u=this;if(n===void 0&&(n=this.getSourceBufferTypes()),!n.length)return P.logger.log("[buffer-controller]: Blocking operation requested, but no SourceBuffers exist"),void Promise.resolve().then(t);var f=this.operationQueue,h=n.map(function(i){return f.appendBlocker(i)});Promise.all(h).then(function(){t(),n.forEach(function(i){var c=u.sourceBuffer[i];c&&c.updating||f.shiftAndExecuteNext(i)})})},o.getSourceBufferTypes=function(){return Object.keys(this.sourceBuffer)},o.addBufferListener=function(t,n,u){var f=this.sourceBuffer[t];if(f){var h=u.bind(this,t);this.listeners[t].push({event:n,listener:h}),f.addEventListener(n,h)}},o.removeBufferListeners=function(t){var n=this.sourceBuffer[t];n&&this.listeners[t].forEach(function(u){n.removeEventListener(u.event,u.listener)})},d}()},"./src/controller/buffer-operation-queue.ts":(j,M,b)=>{b.r(M),b.d(M,{default:()=>D});var w=b("./src/utils/logger.ts"),D=function(){function P(I){this.buffers=void 0,this.queues={video:[],audio:[],audiovideo:[]},this.buffers=I}var k=P.prototype;return k.append=function(I,T){var y=this.queues[T];y.push(I),y.length===1&&this.buffers[T]&&this.executeNext(T)},k.insertAbort=function(I,T){this.queues[T].unshift(I),this.executeNext(T)},k.appendBlocker=function(I){var T,y=new Promise(function(S){T=S}),p={execute:T,onStart:function(){},onComplete:function(){},onError:function(){}};return this.append(p,I),y},k.executeNext=function(I){var T=this.buffers,y=this.queues,p=T[I],S=y[I];if(S.length){var m=S[0];try{m.execute()}catch(v){w.logger.warn("[buffer-operation-queue]: Unhandled exception executing the current operation"),m.onError(v),p&&p.updating||(S.shift(),this.executeNext(I))}}},k.shiftAndExecuteNext=function(I){this.queues[I].shift(),this.executeNext(I)},k.current=function(I){return this.queues[I][0]},P}()},"./src/controller/cap-level-controller.ts":(j,M,b)=>{b.r(M),b.d(M,{default:()=>k});var w=b("./src/events.ts");function D(I,T){for(var y=0;y<T.length;y++){var p=T[y];p.enumerable=p.enumerable||!1,p.configurable=!0,"value"in p&&(p.writable=!0),Object.defineProperty(I,(S=p.key,m=void 0,typeof(m=function(v,d){if(typeof v!="object"||v===null)return v;var o=v[Symbol.toPrimitive];if(o!==void 0){var t=o.call(v,d||"default");if(typeof t!="object")return t;throw new TypeError("@@toPrimitive must return a primitive value.")}return(d==="string"?String:Number)(v)}(S,"string"))=="symbol"?m:String(m)),p)}var S,m}var P=function(){function I(m){this.autoLevelCapping=void 0,this.firstLevel=void 0,this.media=void 0,this.restrictedLevels=void 0,this.timer=void 0,this.hls=void 0,this.streamController=void 0,this.clientRect=void 0,this.hls=m,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.registerListeners()}var T,y,p,S=I.prototype;return S.setStreamController=function(m){this.streamController=m},S.destroy=function(){this.unregisterListener(),this.hls.config.capLevelToPlayerSize&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null},S.registerListeners=function(){var m=this.hls;m.on(w.Events.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),m.on(w.Events.MEDIA_ATTACHING,this.onMediaAttaching,this),m.on(w.Events.MANIFEST_PARSED,this.onManifestParsed,this),m.on(w.Events.BUFFER_CODECS,this.onBufferCodecs,this),m.on(w.Events.MEDIA_DETACHING,this.onMediaDetaching,this)},S.unregisterListener=function(){var m=this.hls;m.off(w.Events.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),m.off(w.Events.MEDIA_ATTACHING,this.onMediaAttaching,this),m.off(w.Events.MANIFEST_PARSED,this.onManifestParsed,this),m.off(w.Events.BUFFER_CODECS,this.onBufferCodecs,this),m.off(w.Events.MEDIA_DETACHING,this.onMediaDetaching,this)},S.onFpsDropLevelCapping=function(m,v){I.isLevelAllowed(v.droppedLevel,this.restrictedLevels)&&this.restrictedLevels.push(v.droppedLevel)},S.onMediaAttaching=function(m,v){this.media=v.media instanceof HTMLVideoElement?v.media:null,this.clientRect=null},S.onManifestParsed=function(m,v){var d=this.hls;this.restrictedLevels=[],this.firstLevel=v.firstLevel,d.config.capLevelToPlayerSize&&v.video&&this.startCapping()},S.onBufferCodecs=function(m,v){this.hls.config.capLevelToPlayerSize&&v.video&&this.startCapping()},S.onMediaDetaching=function(){this.stopCapping()},S.detectPlayerSize=function(){if(this.media&&this.mediaHeight>0&&this.mediaWidth>0){var m=this.hls.levels;if(m.length){var v=this.hls;v.autoLevelCapping=this.getMaxLevel(m.length-1),v.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=v.autoLevelCapping}}},S.getMaxLevel=function(m){var v=this,d=this.hls.levels;if(!d.length)return-1;var o=d.filter(function(t,n){return I.isLevelAllowed(n,v.restrictedLevels)&&n<=m});return this.clientRect=null,I.getMaxLevelByMediaSize(o,this.mediaWidth,this.mediaHeight)},S.startCapping=function(){this.timer||(this.autoLevelCapping=Number.POSITIVE_INFINITY,this.hls.firstLevel=this.getMaxLevel(this.firstLevel),self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e3),this.detectPlayerSize())},S.stopCapping=function(){this.restrictedLevels=[],this.firstLevel=-1,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.timer&&(self.clearInterval(this.timer),this.timer=void 0)},S.getDimensions=function(){if(this.clientRect)return this.clientRect;var m=this.media,v={width:0,height:0};if(m){var d=m.getBoundingClientRect();v.width=d.width,v.height=d.height,v.width||v.height||(v.width=d.right-d.left||m.width||0,v.height=d.bottom-d.top||m.height||0)}return this.clientRect=v,v},I.isLevelAllowed=function(m,v){return v===void 0&&(v=[]),v.indexOf(m)===-1},I.getMaxLevelByMediaSize=function(m,v,d){if(!m||!m.length)return-1;for(var o,t,n=m.length-1,u=0;u<m.length;u+=1){var f=m[u];if((f.width>=v||f.height>=d)&&(o=f,!(t=m[u+1])||o.width!==t.width||o.height!==t.height)){n=u;break}}return n},T=I,(y=[{key:"mediaWidth",get:function(){return this.getDimensions().width*this.contentScaleFactor}},{key:"mediaHeight",get:function(){return this.getDimensions().height*this.contentScaleFactor}},{key:"contentScaleFactor",get:function(){var m=1;if(!this.hls.config.ignoreDevicePixelRatio)try{m=self.devicePixelRatio}catch{}return m}}])&&D(T.prototype,y),p&&D(T,p),Object.defineProperty(T,"prototype",{writable:!1}),I}();const k=P},"./src/controller/cmcd-controller.ts":(j,M,b)=>{b.r(M),b.d(M,{default:()=>m});var w=b("./src/events.ts"),D=b("./src/types/cmcd.ts"),P=b("./src/utils/buffer-helper.ts"),k=b("./src/utils/logger.ts");function I(v,d){for(var o=0;o<d.length;o++){var t=d[o];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(v,(n=t.key,u=void 0,typeof(u=function(f,h){if(typeof f!="object"||f===null)return f;var i=f[Symbol.toPrimitive];if(i!==void 0){var c=i.call(f,h||"default");if(typeof c!="object")return c;throw new TypeError("@@toPrimitive must return a primitive value.")}return(h==="string"?String:Number)(f)}(n,"string"))=="symbol"?u:String(u)),t)}var n,u}function T(v,d,o){return d&&I(v.prototype,d),o&&I(v,o),Object.defineProperty(v,"prototype",{writable:!1}),v}function y(v,d){var o=typeof Symbol<"u"&&v[Symbol.iterator]||v["@@iterator"];if(o)return(o=o.call(v)).next.bind(o);if(Array.isArray(v)||(o=function(n,u){if(n){if(typeof n=="string")return p(n,u);var f=Object.prototype.toString.call(n).slice(8,-1);return f==="Object"&&n.constructor&&(f=n.constructor.name),f==="Map"||f==="Set"?Array.from(n):f==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(f)?p(n,u):void 0}}(v))||d&&v&&typeof v.length=="number"){o&&(v=o);var t=0;return function(){return t>=v.length?{done:!0}:{done:!1,value:v[t++]}}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function p(v,d){(d==null||d>v.length)&&(d=v.length);for(var o=0,t=new Array(d);o<d;o++)t[o]=v[o];return t}function S(){return S=Object.assign?Object.assign.bind():function(v){for(var d=1;d<arguments.length;d++){var o=arguments[d];for(var t in o)Object.prototype.hasOwnProperty.call(o,t)&&(v[t]=o[t])}return v},S.apply(this,arguments)}var m=function(){function v(o){var t=this;this.hls=void 0,this.config=void 0,this.media=void 0,this.sid=void 0,this.cid=void 0,this.useHeaders=!1,this.initialized=!1,this.starved=!1,this.buffering=!0,this.audioBuffer=void 0,this.videoBuffer=void 0,this.onWaiting=function(){t.initialized&&(t.starved=!0),t.buffering=!0},this.onPlaying=function(){t.initialized||(t.initialized=!0),t.buffering=!1},this.applyPlaylistData=function(f){try{t.apply(f,{ot:D.CMCDObjectType.MANIFEST,su:!t.initialized})}catch(h){k.logger.warn("Could not generate manifest CMCD data.",h)}},this.applyFragmentData=function(f){try{var h=f.frag,i=t.hls.levels[h.level],c=t.getObjectType(h),l={d:1e3*h.duration,ot:c};c!==D.CMCDObjectType.VIDEO&&c!==D.CMCDObjectType.AUDIO&&c!=D.CMCDObjectType.MUXED||(l.br=i.bitrate/1e3,l.tb=t.getTopBandwidth(c)/1e3,l.bl=t.getBufferLength(c)),t.apply(f,l)}catch(a){k.logger.warn("Could not generate segment CMCD data.",a)}},this.hls=o;var n=this.config=o.config,u=n.cmcd;u!=null&&(n.pLoader=this.createPlaylistLoader(),n.fLoader=this.createFragmentLoader(),this.sid=u.sessionId||v.uuid(),this.cid=u.contentId,this.useHeaders=u.useHeaders===!0,this.registerListeners())}var d=v.prototype;return d.registerListeners=function(){var o=this.hls;o.on(w.Events.MEDIA_ATTACHED,this.onMediaAttached,this),o.on(w.Events.MEDIA_DETACHED,this.onMediaDetached,this),o.on(w.Events.BUFFER_CREATED,this.onBufferCreated,this)},d.unregisterListeners=function(){var o=this.hls;o.off(w.Events.MEDIA_ATTACHED,this.onMediaAttached,this),o.off(w.Events.MEDIA_DETACHED,this.onMediaDetached,this),o.off(w.Events.BUFFER_CREATED,this.onBufferCreated,this),this.onMediaDetached()},d.destroy=function(){this.unregisterListeners(),this.hls=this.config=this.audioBuffer=this.videoBuffer=null},d.onMediaAttached=function(o,t){this.media=t.media,this.media.addEventListener("waiting",this.onWaiting),this.media.addEventListener("playing",this.onPlaying)},d.onMediaDetached=function(){this.media&&(this.media.removeEventListener("waiting",this.onWaiting),this.media.removeEventListener("playing",this.onPlaying),this.media=null)},d.onBufferCreated=function(o,t){var n,u;this.audioBuffer=(n=t.tracks.audio)===null||n===void 0?void 0:n.buffer,this.videoBuffer=(u=t.tracks.video)===null||u===void 0?void 0:u.buffer},d.createData=function(){var o;return{v:D.CMCDVersion,sf:D.CMCDStreamingFormat.HLS,sid:this.sid,cid:this.cid,pr:(o=this.media)===null||o===void 0?void 0:o.playbackRate,mtp:this.hls.bandwidthEstimate/1e3}},d.apply=function(o,t){t===void 0&&(t={}),S(t,this.createData());var n=t.ot===D.CMCDObjectType.INIT||t.ot===D.CMCDObjectType.VIDEO||t.ot===D.CMCDObjectType.MUXED;if(this.starved&&n&&(t.bs=!0,t.su=!0,this.starved=!1),t.su==null&&(t.su=this.buffering),this.useHeaders){var u=v.toHeaders(t);if(!Object.keys(u).length)return;o.headers||(o.headers={}),S(o.headers,u)}else{var f=v.toQuery(t);if(!f)return;o.url=v.appendQueryToUri(o.url,f)}},d.getObjectType=function(o){var t=o.type;return t==="subtitle"?D.CMCDObjectType.TIMED_TEXT:o.sn==="initSegment"?D.CMCDObjectType.INIT:t==="audio"?D.CMCDObjectType.AUDIO:t==="main"?this.hls.audioTracks.length?D.CMCDObjectType.VIDEO:D.CMCDObjectType.MUXED:void 0},d.getTopBandwidth=function(o){var t,n=0,u=this.hls;if(o===D.CMCDObjectType.AUDIO)t=u.audioTracks;else{var f=u.maxAutoLevel,h=f>-1?f+1:u.levels.length;t=u.levels.slice(0,h)}for(var i,c=y(t);!(i=c()).done;){var l=i.value;l.bitrate>n&&(n=l.bitrate)}return n>0?n:NaN},d.getBufferLength=function(o){var t=this.hls.media,n=o===D.CMCDObjectType.AUDIO?this.audioBuffer:this.videoBuffer;return n&&t?1e3*P.BufferHelper.bufferInfo(n,t.currentTime,this.config.maxBufferHole).len:NaN},d.createPlaylistLoader=function(){var o=this.config.pLoader,t=this.applyPlaylistData,n=o||this.config.loader;return function(){function u(h){this.loader=void 0,this.loader=new n(h)}var f=u.prototype;return f.destroy=function(){this.loader.destroy()},f.abort=function(){this.loader.abort()},f.load=function(h,i,c){t(h),this.loader.load(h,i,c)},T(u,[{key:"stats",get:function(){return this.loader.stats}},{key:"context",get:function(){return this.loader.context}}]),u}()},d.createFragmentLoader=function(){var o=this.config.fLoader,t=this.applyFragmentData,n=o||this.config.loader;return function(){function u(h){this.loader=void 0,this.loader=new n(h)}var f=u.prototype;return f.destroy=function(){this.loader.destroy()},f.abort=function(){this.loader.abort()},f.load=function(h,i,c){t(h),this.loader.load(h,i,c)},T(u,[{key:"stats",get:function(){return this.loader.stats}},{key:"context",get:function(){return this.loader.context}}]),u}()},v.uuid=function(){var o=URL.createObjectURL(new Blob),t=o.toString();return URL.revokeObjectURL(o),t.slice(t.lastIndexOf("/")+1)},v.serialize=function(o){for(var t,n=[],u=function(g){return!Number.isNaN(g)&&g!=null&&g!==""&&g!==!1},f=function(g){return Math.round(g)},h=function(g){return 100*f(g/100)},i={br:f,d:f,bl:h,dl:h,mtp:h,nor:function(g){return encodeURIComponent(g)},rtp:h,tb:f},c=y(Object.keys(o||{}).sort());!(t=c()).done;){var l=t.value,a=o[l];if(u(a)&&!(l==="v"&&a===1||l=="pr"&&a===1)){var s=i[l];s&&(a=s(a));var e=typeof a,r=void 0;r=l==="ot"||l==="sf"||l==="st"?l+"="+a:e==="boolean"?l:e==="number"?l+"="+a:l+"="+JSON.stringify(a),n.push(r)}}return n.join(",")},v.toHeaders=function(o){for(var t={},n=["Object","Request","Session","Status"],u=[{},{},{},{}],f={br:0,d:0,ot:0,tb:0,bl:1,dl:1,mtp:1,nor:1,nrr:1,su:1,cid:2,pr:2,sf:2,sid:2,st:2,v:2,bs:3,rtp:3},h=0,i=Object.keys(o);h<i.length;h++){var c=i[h];u[f[c]!=null?f[c]:1][c]=o[c]}for(var l=0;l<u.length;l++){var a=v.serialize(u[l]);a&&(t["CMCD-"+n[l]]=a)}return t},v.toQuery=function(o){return"CMCD="+encodeURIComponent(v.serialize(o))},v.appendQueryToUri=function(o,t){if(!t)return o;var n=o.includes("?")?"&":"?";return""+o+n+t},v}()},"./src/controller/eme-controller.ts":(j,M,b)=>{b.r(M),b.d(M,{default:()=>i});var w=b("./src/events.ts"),D=b("./src/errors.ts"),P=b("./src/utils/logger.ts"),k=b("./src/utils/mediakeys-helper.ts"),I=b("./src/utils/keysystem-util.ts"),T=b("./src/utils/numeric-encoding-utils.ts"),y=b("./src/loader/level-key.ts"),p=b("./src/utils/hex.ts"),S=b("./src/utils/mp4-tools.ts"),m=b("./node_modules/eventemitter3/index.js"),v=b.n(m);function d(c){var l=typeof Map=="function"?new Map:void 0;return d=function(a){if(a===null||(s=a,Function.toString.call(s).indexOf("[native code]")===-1))return a;var s;if(typeof a!="function")throw new TypeError("Super expression must either be null or a function");if(l!==void 0){if(l.has(a))return l.get(a);l.set(a,e)}function e(){return o(a,arguments,n(this).constructor)}return e.prototype=Object.create(a.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t(e,a)},d(c)}function o(c,l,a){return o=function(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}()?Reflect.construct.bind():function(s,e,r){var g=[null];g.push.apply(g,e);var E=new(Function.bind.apply(s,g));return r&&t(E,r.prototype),E},o.apply(null,arguments)}function t(c,l){return t=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(a,s){return a.__proto__=s,a},t(c,l)}function n(c){return n=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(l){return l.__proto__||Object.getPrototypeOf(l)},n(c)}var u="[eme]",f=function(){function c(a){this.hls=void 0,this.config=void 0,this.media=null,this.keyFormatPromise=null,this.keySystemAccessPromises={},this._requestLicenseFailureCount=0,this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},this.setMediaKeysQueue=c.CDMCleanupPromise?[c.CDMCleanupPromise]:[],this.onMediaEncrypted=this._onMediaEncrypted.bind(this),this.onWaitingForKey=this._onWaitingForKey.bind(this),this.debug=P.logger.debug.bind(P.logger,u),this.log=P.logger.log.bind(P.logger,u),this.warn=P.logger.warn.bind(P.logger,u),this.error=P.logger.error.bind(P.logger,u),this.hls=a,this.config=a.config,this.registerListeners()}var l=c.prototype;return l.destroy=function(){this.unregisterListeners(),this.onMediaDetached(),this.hls=this.onMediaEncrypted=this.onWaitingForKey=this.keyIdToKeySessionPromise=null},l.registerListeners=function(){this.hls.on(w.Events.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(w.Events.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.on(w.Events.MANIFEST_LOADED,this.onManifestLoaded,this)},l.unregisterListeners=function(){this.hls.off(w.Events.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(w.Events.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.off(w.Events.MANIFEST_LOADED,this.onManifestLoaded,this)},l.getLicenseServerUrl=function(a){var s=this.config,e=s.drmSystems,r=s.widevineLicenseUrl,g=e[a];if(g)return g.licenseUrl;if(a===k.KeySystems.WIDEVINE&&r)return r;throw new Error('no license server URL configured for key-system "'+a+'"')},l.getServerCertificateUrl=function(a){var s=this.config.drmSystems[a];if(s)return s.serverCertificateUrl;this.log('No Server Certificate in config.drmSystems["'+a+'"]')},l.attemptKeySystemAccess=function(a){var s=this,e=this.hls.levels,r=function(A,L,_){return!!A&&_.indexOf(A)===L},g=e.map(function(A){return A.audioCodec}).filter(r),E=e.map(function(A){return A.videoCodec}).filter(r);return g.length+E.length===0&&E.push("avc1.42e01e"),new Promise(function(A,L){(function _(R){var x=R.shift();s.getMediaKeysPromise(x,g,E).then(function(C){return A({keySystem:x,mediaKeys:C})}).catch(function(C){R.length?_(R):L(C instanceof h?C:new h({type:D.ErrorTypes.KEY_SYSTEM_ERROR,details:D.ErrorDetails.KEY_SYSTEM_NO_ACCESS,error:C,fatal:!0},C.message))})})(a)})},l.requestMediaKeySystemAccess=function(a,s){var e=this.config.requestMediaKeySystemAccessFunc;if(typeof e!="function"){var r="Configured requestMediaKeySystemAccess is not a function "+e;return k.requestMediaKeySystemAccess===null&&self.location.protocol==="http:"&&(r="navigator.requestMediaKeySystemAccess is not available over insecure protocol "+location.protocol),Promise.reject(new Error(r))}return e(a,s)},l.getMediaKeysPromise=function(a,s,e){var r=this,g=(0,k.getSupportedMediaKeySystemConfigurations)(a,s,e,this.config.drmSystemOptions),E=this.keySystemAccessPromises[a],A=E==null?void 0:E.keySystemAccess;if(!A){this.log('Requesting encrypted media "'+a+'" key-system access with config: '+JSON.stringify(g)),A=this.requestMediaKeySystemAccess(a,g);var L=this.keySystemAccessPromises[a]={keySystemAccess:A};return A.catch(function(_){r.log('Failed to obtain access to key-system "'+a+'": '+_)}),A.then(function(_){r.log('Access for key-system "'+_.keySystem+'" obtained');var R=r.fetchServerCertificate(a);return r.log('Create media-keys for "'+a+'"'),L.mediaKeys=_.createMediaKeys().then(function(x){return r.log('Media-keys created for "'+a+'"'),R.then(function(C){return C?r.setMediaKeysServerCertificate(x,a,C):x})}),L.mediaKeys.catch(function(x){r.error('Failed to create media-keys for "'+a+'"}: '+x)}),L.mediaKeys})}return A.then(function(){return E.mediaKeys})},l.createMediaKeySessionContext=function(a){var s=a.decryptdata,e=a.keySystem,r=a.mediaKeys;console.assert(!!r,"mediaKeys is defined"),this.log('Creating key-system session "'+e+'" keyId: '+p.default.hexDump(s.keyId||[]));var g=r.createSession(),E={decryptdata:s,keySystem:e,mediaKeys:r,mediaKeysSession:g,keyStatus:"status-pending"};return this.mediaKeySessions.push(E),E},l.renewKeySession=function(a){var s=a.decryptdata;if(s.pssh){var e=this.createMediaKeySessionContext(a),r=this.getKeyIdString(s);this.keyIdToKeySessionPromise[r]=this.generateRequestWithPreferredKeySession(e,"cenc",s.pssh,"expired")}else this.warn("Could not renew expired session. Missing pssh initData.");this.removeSession(a)},l.getKeyIdString=function(a){if(!a)throw new Error("Could not read keyId of undefined decryptdata");if(a.keyId===null)throw new Error("keyId is null");return p.default.hexDump(a.keyId)},l.updateKeySession=function(a,s){var e,r=a.mediaKeysSession;return this.log('Updating key-session "'+r.sessionId+'" for keyID '+p.default.hexDump(((e=a.decryptdata)===null||e===void 0?void 0:e.keyId)||[])+`
      } (data length: `+(s&&s.byteLength)+")"),r.update(s)},l.selectKeySystemFormat=function(a){var s=Object.keys(a.levelkeys||{});return this.keyFormatPromise||(this.log("Selecting key-system from fragment (sn: "+a.sn+" "+a.type+": "+a.level+") key formats "+s.join(", ")),this.keyFormatPromise=this.getKeyFormatPromise(s)),this.keyFormatPromise},l.getKeyFormatPromise=function(a){var s=this;return new Promise(function(e,r){var g=(0,k.getKeySystemsForConfig)(s.config),E=a.map(k.keySystemFormatToKeySystemDomain).filter(function(A){return!!A&&g.indexOf(A)!==-1});return s.getKeySystemSelectionPromise(E).then(function(A){var L=A.keySystem,_=(0,k.keySystemDomainToKeySystemFormat)(L);_?e(_):r(new Error('Unable to find format for key-system "'+L+'"'))}).catch(r)})},l.loadKey=function(a){var s=this,e=a.keyInfo.decryptdata,r=this.getKeyIdString(e),g="(keyId: "+r+' format: "'+e.keyFormat+'" method: '+e.method+" uri: "+e.uri+")";this.log("Starting session for key "+g);var E=this.keyIdToKeySessionPromise[r];return E||(E=this.keyIdToKeySessionPromise[r]=this.getKeySystemForKeyPromise(e).then(function(A){var L=A.keySystem,_=A.mediaKeys;return s.throwIfDestroyed(),s.log("Handle encrypted media sn: "+a.frag.sn+" "+a.frag.type+": "+a.frag.level+" using key "+g),s.attemptSetMediaKeys(L,_).then(function(){s.throwIfDestroyed();var R=s.createMediaKeySessionContext({keySystem:L,mediaKeys:_,decryptdata:e});return s.generateRequestWithPreferredKeySession(R,"cenc",e.pssh,"playlist-key")})})).catch(function(A){return s.handleError(A)}),E},l.throwIfDestroyed=function(a){if(!this.hls)throw new Error("invalid state")},l.handleError=function(a){this.hls&&(this.error(a.message),a instanceof h?this.hls.trigger(w.Events.ERROR,a.data):this.hls.trigger(w.Events.ERROR,{type:D.ErrorTypes.KEY_SYSTEM_ERROR,details:D.ErrorDetails.KEY_SYSTEM_NO_KEYS,error:a,fatal:!0}))},l.getKeySystemForKeyPromise=function(a){var s=this.getKeyIdString(a),e=this.keyIdToKeySessionPromise[s];if(!e){var r=(0,k.keySystemFormatToKeySystemDomain)(a.keyFormat),g=r?[r]:(0,k.getKeySystemsForConfig)(this.config);return this.attemptKeySystemAccess(g)}return e},l.getKeySystemSelectionPromise=function(a){if(a.length||(a=(0,k.getKeySystemsForConfig)(this.config)),a.length===0)throw new h({type:D.ErrorTypes.KEY_SYSTEM_ERROR,details:D.ErrorDetails.KEY_SYSTEM_NO_CONFIGURED_LICENSE,fatal:!0},"Missing key-system license configuration options "+JSON.stringify({drmSystems:this.config.drmSystems}));return this.attemptKeySystemAccess(a)},l._onMediaEncrypted=function(a){var s=this,e=a.initDataType,r=a.initData;if(this.debug('"'+a.type+'" event: init data type: "'+e+'"'),r!==null){var g,E;if(e==="sinf"&&this.config.drmSystems[k.KeySystems.FAIRPLAY]){var A=(0,S.bin2str)(new Uint8Array(r));try{var L=(0,T.base64Decode)(JSON.parse(A).sinf),_=(0,S.parseSinf)(new Uint8Array(L));if(!_)return;g=_.subarray(8,24),E=k.KeySystems.FAIRPLAY}catch{return void this.warn('Failed to parse sinf "encrypted" event message initData')}}else{var R=(0,S.parsePssh)(r);if(R===null)return;R.version===0&&R.systemId===k.KeySystemIds.WIDEVINE&&R.data&&(g=R.data.subarray(8,24)),E=(0,k.keySystemIdToKeySystemDomain)(R.systemId)}if(E&&g){for(var x=p.default.hexDump(g),C=this.keyIdToKeySessionPromise,F=this.mediaKeySessions,O=C[x],N=function(B){var H=F[B],V=H.decryptdata;if(V.pssh||!V.keyId)return"continue";var K=p.default.hexDump(V.keyId);return x===K||V.uri.replace(/-/g,"").indexOf(x)!==-1?(O=C[K],delete C[K],V.pssh=new Uint8Array(r),V.keyId=g,O=C[x]=O.then(function(){return s.generateRequestWithPreferredKeySession(H,e,r,"encrypted-event-key-match")}),"break"):void 0},U=0;U<F.length;U++){var G=N(U);if(G!=="continue"&&G==="break")break}O||(O=C[x]=this.getKeySystemSelectionPromise([E]).then(function(B){var H,V=B.keySystem,K=B.mediaKeys;s.throwIfDestroyed();var Y=new y.LevelKey("ISO-23001-7",x,(H=(0,k.keySystemDomainToKeySystemFormat)(V))!=null?H:"");return Y.pssh=new Uint8Array(r),Y.keyId=g,s.attemptSetMediaKeys(V,K).then(function(){s.throwIfDestroyed();var q=s.createMediaKeySessionContext({decryptdata:Y,keySystem:V,mediaKeys:K});return s.generateRequestWithPreferredKeySession(q,e,r,"encrypted-event-no-match")})})),O.catch(function(B){return s.handleError(B)})}}},l._onWaitingForKey=function(a){this.log('"'+a.type+'" event')},l.attemptSetMediaKeys=function(a,s){var e=this,r=this.setMediaKeysQueue.slice();this.log('Setting media-keys for "'+a+'"');var g=Promise.all(r).then(function(){if(!e.media)throw new Error("Attempted to set mediaKeys without media element attached");return e.media.setMediaKeys(s)});return this.setMediaKeysQueue.push(g),g.then(function(){e.log('Media-keys set for "'+a+'"'),r.push(g),e.setMediaKeysQueue=e.setMediaKeysQueue.filter(function(E){return r.indexOf(E)===-1})})},l.generateRequestWithPreferredKeySession=function(a,s,e,r){var g,E,A=this,L=(g=this.config.drmSystems)===null||g===void 0||(E=g[a.keySystem])===null||E===void 0?void 0:E.generateRequest;if(L)try{var _=L.call(this.hls,s,e,a);if(!_)throw new Error("Invalid response from configured generateRequest filter");s=_.initDataType,e=a.decryptdata.pssh=_.initData?new Uint8Array(_.initData):null}catch(O){var R;if(this.warn(O.message),(R=this.hls)!==null&&R!==void 0&&R.config.debug)throw O}if(e===null)return this.log('Skipping key-session request for "'+r+'" (no initData)'),Promise.resolve(a);var x=this.getKeyIdString(a.decryptdata);this.log('Generating key-session request for "'+r+'": '+x+" (init data type: "+s+" length: "+(e?e.byteLength:null)+")");var C=new(v());a.mediaKeysSession.onmessage=function(O){var N=a.mediaKeysSession;if(N){var U=O.messageType,G=O.message;A.log('"'+U+'" message event for session "'+N.sessionId+'" message size: '+G.byteLength),U==="license-request"||U==="license-renewal"?A.renewLicense(a,G).catch(function(B){A.handleError(B),C.emit("error",B)}):U==="license-release"?a.keySystem===k.KeySystems.FAIRPLAY&&(A.updateKeySession(a,(0,I.strToUtf8array)("acknowledged")),A.removeSession(a)):A.warn('unhandled media key message type "'+U+'"')}else C.emit("error",new Error("invalid state"))},a.mediaKeysSession.onkeystatuseschange=function(O){if(a.mediaKeysSession){A.onKeyStatusChange(a);var N=a.keyStatus;C.emit("keyStatus",N),N==="expired"&&(A.warn(a.keySystem+" expired for key "+x),A.renewKeySession(a))}else C.emit("error",new Error("invalid state"))};var F=new Promise(function(O,N){C.on("error",N),C.on("keyStatus",function(U){U.startsWith("usable")?O():U==="output-restricted"?N(new h({type:D.ErrorTypes.KEY_SYSTEM_ERROR,details:D.ErrorDetails.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED,fatal:!1},"HDCP level output restricted")):U==="internal-error"?N(new h({type:D.ErrorTypes.KEY_SYSTEM_ERROR,details:D.ErrorDetails.KEY_SYSTEM_STATUS_INTERNAL_ERROR,fatal:!0},'key status changed to "'+U+'"')):U==="expired"?N(new Error("key expired while generating request")):A.warn('unhandled key status change "'+U+'"')})});return a.mediaKeysSession.generateRequest(s,e).then(function(){var O;A.log('Request generated for key-session "'+((O=a.mediaKeysSession)===null||O===void 0?void 0:O.sessionId)+'" keyId: '+x)}).catch(function(O){throw new h({type:D.ErrorTypes.KEY_SYSTEM_ERROR,details:D.ErrorDetails.KEY_SYSTEM_NO_SESSION,error:O,fatal:!1},"Error generating key-session request: "+O)}).then(function(){return F}).catch(function(O){throw C.removeAllListeners(),A.removeSession(a),O}).then(function(){return C.removeAllListeners(),a})},l.onKeyStatusChange=function(a){var s=this;a.mediaKeysSession.keyStatuses.forEach(function(e,r){s.log('key status change "'+e+'" for keyStatuses keyId: '+p.default.hexDump("buffer"in r?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):new Uint8Array(r))+" session keyId: "+p.default.hexDump(new Uint8Array(a.decryptdata.keyId||[]))+" uri: "+a.decryptdata.uri),a.keyStatus=e})},l.fetchServerCertificate=function(a){var s=this;return new Promise(function(e,r){var g=s.getServerCertificateUrl(a);if(!g)return e();s.log('Fetching serverCertificate for "'+a+'"');var E=new XMLHttpRequest;E.open("GET",g,!0),E.responseType="arraybuffer",E.onreadystatechange=function(){E.readyState===XMLHttpRequest.DONE&&(E.status===200?e(E.response):r(new h({type:D.ErrorTypes.KEY_SYSTEM_ERROR,details:D.ErrorDetails.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:E},'"'+a+'" certificate request XHR failed ('+g+"). Status: "+E.status+" ("+E.statusText+")")))},E.send()})},l.setMediaKeysServerCertificate=function(a,s,e){var r=this;return new Promise(function(g,E){a.setServerCertificate(e).then(function(A){r.log("setServerCertificate "+(A?"success":"not supported by CDM")+" ("+(e==null?void 0:e.byteLength)+') on "'+s+'"'),g(a)}).catch(function(A){E(new h({type:D.ErrorTypes.KEY_SYSTEM_ERROR,details:D.ErrorDetails.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED,error:A,fatal:!0},A.message))})})},l.renewLicense=function(a,s){var e=this;return this.requestLicense(a,new Uint8Array(s)).then(function(r){return e.updateKeySession(a,new Uint8Array(r)).catch(function(g){throw new h({type:D.ErrorTypes.KEY_SYSTEM_ERROR,details:D.ErrorDetails.KEY_SYSTEM_SESSION_UPDATE_FAILED,error:g,fatal:!0},g.message)})})},l.setupLicenseXHR=function(a,s,e,r){var g=this,E=this.config.licenseXhrSetup;return E?Promise.resolve().then(function(){if(!e.decryptdata)throw new Error("Key removed");return E.call(g.hls,a,s,e,r)}).catch(function(A){if(!e.decryptdata)throw A;return a.open("POST",s,!0),E.call(g.hls,a,s,e,r)}).then(function(A){return a.readyState||a.open("POST",s,!0),{xhr:a,licenseChallenge:A||r}}):(a.open("POST",s,!0),Promise.resolve({xhr:a,licenseChallenge:r}))},l.requestLicense=function(a,s){var e=this;return new Promise(function(r,g){var E=e.getLicenseServerUrl(a.keySystem);e.log("Sending license request to URL: "+E);var A=new XMLHttpRequest;A.responseType="arraybuffer",A.onreadystatechange=function(){if(!e.hls||!a.mediaKeysSession)return g(new Error("invalid state"));if(A.readyState===4)if(A.status===200){e._requestLicenseFailureCount=0;var L=A.response;e.log("License received "+(L instanceof ArrayBuffer?L.byteLength:L));var _=e.config.licenseResponseCallback;if(_)try{L=_.call(e.hls,A,E,a)}catch(x){e.error(x)}r(L)}else if(e._requestLicenseFailureCount++,e._requestLicenseFailureCount>3||A.status>=400&&A.status<500)g(new h({type:D.ErrorTypes.KEY_SYSTEM_ERROR,details:D.ErrorDetails.KEY_SYSTEM_LICENSE_REQUEST_FAILED,fatal:!0,networkDetails:A},"License Request XHR failed ("+E+"). Status: "+A.status+" ("+A.statusText+")"));else{var R=3-e._requestLicenseFailureCount+1;e.warn("Retrying license request, "+R+" attempts left"),e.requestLicense(a,s).then(r,g)}},a.licenseXhr&&a.licenseXhr.readyState!==XMLHttpRequest.DONE&&a.licenseXhr.abort(),a.licenseXhr=A,e.setupLicenseXHR(A,E,a,s).then(function(L){var _=L.xhr,R=L.licenseChallenge;_.send(R)})})},l.onMediaAttached=function(a,s){if(this.config.emeEnabled){var e=s.media;this.media=e,e.addEventListener("encrypted",this.onMediaEncrypted),e.addEventListener("waitingforkey",this.onWaitingForKey)}},l.onMediaDetached=function(){var a=this,s=this.media,e=this.mediaKeySessions;s&&(s.removeEventListener("encrypted",this.onMediaEncrypted),s.removeEventListener("waitingforkey",this.onWaitingForKey),this.media=null),this._requestLicenseFailureCount=0,this.setMediaKeysQueue=[],this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},y.LevelKey.clearKeyUriToKeyIdMap();var r=e.length;c.CDMCleanupPromise=Promise.all(e.map(function(g){return a.removeSession(g)}).concat(s==null?void 0:s.setMediaKeys(null).catch(function(g){a.log("Could not clear media keys: "+g+". media.src: "+(s==null?void 0:s.src))}))).then(function(){r&&(a.log("finished closing key sessions and clearing media keys"),e.length=0)}).catch(function(g){a.log("Could not close sessions and clear media keys: "+g+". media.src: "+(s==null?void 0:s.src))})},l.onManifestLoaded=function(a,s){var e=s.sessionKeys;if(e&&this.config.emeEnabled&&!this.keyFormatPromise){var r=e.reduce(function(g,E){return g.indexOf(E.keyFormat)===-1&&g.push(E.keyFormat),g},[]);this.log("Selecting key-system from session-keys "+r.join(", ")),this.keyFormatPromise=this.getKeyFormatPromise(r)}},l.removeSession=function(a){var s=this,e=a.mediaKeysSession,r=a.licenseXhr;if(e){this.log("Remove licenses and keys and close session "+e.sessionId),e.onmessage=null,e.onkeystatuseschange=null,r&&r.readyState!==XMLHttpRequest.DONE&&r.abort(),a.mediaKeysSession=a.decryptdata=a.licenseXhr=void 0;var g=this.mediaKeySessions.indexOf(a);return g>-1&&this.mediaKeySessions.splice(g,1),e.remove().catch(function(E){s.log("Could not remove session: "+E)}).then(function(){return e.close()}).catch(function(E){s.log("Could not close session: "+E)})}},c}();f.CDMCleanupPromise=void 0;var h=function(c){var l,a;function s(e,r){var g;return(g=c.call(this,r)||this).data=void 0,g.data=e,e.err=e.error,g}return a=c,(l=s).prototype=Object.create(a.prototype),l.prototype.constructor=l,t(l,a),s}(d(Error));const i=f},"./src/controller/fps-controller.ts":(j,M,b)=>{b.r(M),b.d(M,{default:()=>k});var w=b("./src/events.ts"),D=b("./src/utils/logger.ts"),P=function(){function I(y){this.hls=void 0,this.isVideoPlaybackQualityAvailable=!1,this.timer=void 0,this.media=null,this.lastTime=void 0,this.lastDroppedFrames=0,this.lastDecodedFrames=0,this.streamController=void 0,this.hls=y,this.registerListeners()}var T=I.prototype;return T.setStreamController=function(y){this.streamController=y},T.registerListeners=function(){this.hls.on(w.Events.MEDIA_ATTACHING,this.onMediaAttaching,this)},T.unregisterListeners=function(){this.hls.off(w.Events.MEDIA_ATTACHING,this.onMediaAttaching)},T.destroy=function(){this.timer&&clearInterval(this.timer),this.unregisterListeners(),this.isVideoPlaybackQualityAvailable=!1,this.media=null},T.onMediaAttaching=function(y,p){var S=this.hls.config;if(S.capLevelOnFPSDrop){var m=p.media instanceof self.HTMLVideoElement?p.media:null;this.media=m,m&&typeof m.getVideoPlaybackQuality=="function"&&(this.isVideoPlaybackQualityAvailable=!0),self.clearInterval(this.timer),this.timer=self.setInterval(this.checkFPSInterval.bind(this),S.fpsDroppedMonitoringPeriod)}},T.checkFPS=function(y,p,S){var m=performance.now();if(p){if(this.lastTime){var v=m-this.lastTime,d=S-this.lastDroppedFrames,o=p-this.lastDecodedFrames,t=1e3*d/v,n=this.hls;if(n.trigger(w.Events.FPS_DROP,{currentDropped:d,currentDecoded:o,totalDroppedFrames:S}),t>0&&d>n.config.fpsDroppedMonitoringThreshold*o){var u=n.currentLevel;D.logger.warn("drop FPS ratio greater than max allowed value for currentLevel: "+u),u>0&&(n.autoLevelCapping===-1||n.autoLevelCapping>=u)&&(u-=1,n.trigger(w.Events.FPS_DROP_LEVEL_CAPPING,{level:u,droppedLevel:n.currentLevel}),n.autoLevelCapping=u,this.streamController.nextLevelSwitch())}}this.lastTime=m,this.lastDroppedFrames=S,this.lastDecodedFrames=p}},T.checkFPSInterval=function(){var y=this.media;if(y)if(this.isVideoPlaybackQualityAvailable){var p=y.getVideoPlaybackQuality();this.checkFPS(y,p.totalVideoFrames,p.droppedVideoFrames)}else this.checkFPS(y,y.webkitDecodedFrameCount,y.webkitDroppedFrameCount)},I}();const k=P},"./src/controller/fragment-finders.ts":(j,M,b)=>{b.r(M),b.d(M,{findFragWithCC:()=>y,findFragmentByPDT:()=>P,findFragmentByPTS:()=>k,fragmentWithinToleranceTest:()=>I,pdtWithinToleranceTest:()=>T});var w=b("./src/polyfills/number.ts"),D=b("./src/utils/binary-search.ts");function P(p,S,m){if(S===null||!Array.isArray(p)||!p.length||!(0,w.isFiniteNumber)(S)||S<(p[0].programDateTime||0)||S>=(p[p.length-1].endProgramDateTime||0))return null;m=m||0;for(var v=0;v<p.length;++v){var d=p[v];if(T(S,m,d))return d}return null}function k(p,S,m,v){m===void 0&&(m=0),v===void 0&&(v=0);var d=null;if(p?d=S[p.sn-S[0].sn+1]||null:m===0&&S[0].start===0&&(d=S[0]),d&&I(m,v,d)===0)return d;var o=D.default.search(S,I.bind(null,m,v));return!o||o===p&&d?d:o}function I(p,S,m){if(p===void 0&&(p=0),S===void 0&&(S=0),m.start<=p&&m.start+m.duration>p)return 0;var v=Math.min(S,m.duration+(m.deltaPTS?m.deltaPTS:0));return m.start+m.duration-v<=p?1:m.start-v>p&&m.start?-1:0}function T(p,S,m){var v=1e3*Math.min(S,m.duration+(m.deltaPTS?m.deltaPTS:0));return(m.endProgramDateTime||0)-v>p}function y(p,S){return D.default.search(p,function(m){return m.cc<S?1:m.cc>S?-1:0})}},"./src/controller/fragment-tracker.ts":(j,M,b)=>{b.r(M),b.d(M,{FragmentState:()=>w,FragmentTracker:()=>k});var w,D=b("./src/events.ts"),P=b("./src/types/loader.ts");(function(y){y.NOT_LOADED="NOT_LOADED",y.APPENDING="APPENDING",y.PARTIAL="PARTIAL",y.OK="OK"})(w||(w={}));var k=function(){function y(S){this.activeFragment=null,this.activeParts=null,this.endListFragments=Object.create(null),this.fragments=Object.create(null),this.timeRanges=Object.create(null),this.bufferPadding=.2,this.hls=void 0,this.hls=S,this._registerListeners()}var p=y.prototype;return p._registerListeners=function(){var S=this.hls;S.on(D.Events.BUFFER_APPENDED,this.onBufferAppended,this),S.on(D.Events.FRAG_BUFFERED,this.onFragBuffered,this),S.on(D.Events.FRAG_LOADED,this.onFragLoaded,this)},p._unregisterListeners=function(){var S=this.hls;S.off(D.Events.BUFFER_APPENDED,this.onBufferAppended,this),S.off(D.Events.FRAG_BUFFERED,this.onFragBuffered,this),S.off(D.Events.FRAG_LOADED,this.onFragLoaded,this)},p.destroy=function(){this._unregisterListeners(),this.fragments=this.endListFragments=this.timeRanges=this.activeFragment=this.activeParts=null},p.getAppendedFrag=function(S,m){if(m===P.PlaylistLevelType.MAIN){var v=this.activeFragment,d=this.activeParts;if(!v)return null;if(d)for(var o=d.length;o--;){var t=d[o],n=t?t.end:v.appendedPTS;if(t.start<=S&&n!==void 0&&S<=n)return o>9&&(this.activeParts=d.slice(o-9)),t}else if(v.start<=S&&v.appendedPTS!==void 0&&S<=v.appendedPTS)return v}return this.getBufferedFrag(S,m)},p.getBufferedFrag=function(S,m){for(var v=this.fragments,d=Object.keys(v),o=d.length;o--;){var t=v[d[o]];if((t==null?void 0:t.body.type)===m&&t.buffered){var n=t.body;if(n.start<=S&&S<=n.end)return n}}return null},p.detectEvictedFragments=function(S,m,v){var d=this;this.timeRanges&&(this.timeRanges[S]=m),Object.keys(this.fragments).forEach(function(o){var t=d.fragments[o];if(t)if(t.buffered||t.loaded){var n=t.range[S];n&&n.time.some(function(u){var f=!d.isTimeBuffered(u.startPTS,u.endPTS,m);return f&&d.removeFragment(t.body),f})}else t.body.type===v&&d.removeFragment(t.body)})},p.detectPartialFragments=function(S){var m=this,v=this.timeRanges,d=S.frag,o=S.part;if(v&&d.sn!=="initSegment"){var t=T(d),n=this.fragments[t];n&&(Object.keys(v).forEach(function(u){var f=d.elementaryStreams[u];if(f){var h=v[u],i=o!==null||f.partial===!0;n.range[u]=m.getBufferedTimes(d,o,i,h)}}),n.loaded=null,Object.keys(n.range).length?(n.buffered=!0,n.body.endList&&(this.endListFragments[n.body.type]=n)):this.removeFragment(n.body))}},p.fragBuffered=function(S){var m=T(S),v=this.fragments[m];v&&(v.loaded=null,v.buffered=!0)},p.getBufferedTimes=function(S,m,v,d){for(var o={time:[],partial:v},t=m?m.start:S.start,n=m?m.end:S.end,u=S.minEndPTS||n,f=S.maxStartPTS||t,h=0;h<d.length;h++){var i=d.start(h)-this.bufferPadding,c=d.end(h)+this.bufferPadding;if(f>=i&&u<=c){o.time.push({startPTS:Math.max(t,d.start(h)),endPTS:Math.min(n,d.end(h))});break}if(t<c&&n>i)o.partial=!0,o.time.push({startPTS:Math.max(t,d.start(h)),endPTS:Math.min(n,d.end(h))});else if(n<=i)break}return o},p.getPartialFragment=function(S){var m,v,d,o=null,t=0,n=this.bufferPadding,u=this.fragments;return Object.keys(u).forEach(function(f){var h=u[f];h&&I(h)&&(v=h.body.start-n,d=h.body.end+n,S>=v&&S<=d&&(m=Math.min(S-v,d-S),t<=m&&(o=h.body,t=m)))}),o},p.isEndListAppended=function(S){var m=this.endListFragments[S];return m!==void 0&&(m.buffered||I(m))},p.getState=function(S){var m=T(S),v=this.fragments[m];return v?v.buffered?I(v)?w.PARTIAL:w.OK:w.APPENDING:w.NOT_LOADED},p.isTimeBuffered=function(S,m,v){for(var d,o,t=0;t<v.length;t++){if(d=v.start(t)-this.bufferPadding,o=v.end(t)+this.bufferPadding,S>=d&&m<=o)return!0;if(m<=d)return!1}return!1},p.onFragLoaded=function(S,m){var v=m.frag,d=m.part;if(v.sn!=="initSegment"&&!v.bitrateTest&&!d){var o=T(v);this.fragments[o]={body:v,loaded:m,buffered:!1,range:Object.create(null)}}},p.onBufferAppended=function(S,m){var v=this,d=m.frag,o=m.part,t=m.timeRanges;if(d.type===P.PlaylistLevelType.MAIN)if(this.activeFragment!==d&&(this.activeFragment=d,d.appendedPTS=void 0),o){var n=this.activeParts;n||(this.activeParts=n=[]),n.push(o)}else this.activeParts=null;this.timeRanges=t,Object.keys(t).forEach(function(u){var f=t[u];if(v.detectEvictedFragments(u,f),!o&&d.type===P.PlaylistLevelType.MAIN){var h=d.elementaryStreams[u];if(!h)return;for(var i=0;i<f.length;i++){var c=f.end(i);c<=h.endPTS&&c>h.startPTS?d.appendedPTS=Math.max(c,d.appendedPTS||0):d.appendedPTS=h.endPTS}}})},p.onFragBuffered=function(S,m){this.detectPartialFragments(m)},p.hasFragment=function(S){var m=T(S);return!!this.fragments[m]},p.removeFragmentsInRange=function(S,m,v){var d=this;Object.keys(this.fragments).forEach(function(o){var t=d.fragments[o];if(t&&t.buffered){var n=t.body;n.type===v&&n.start<m&&n.end>S&&d.removeFragment(n)}})},p.removeFragment=function(S){var m=T(S);S.stats.loaded=0,S.clearElementaryStreamInfo(),S.appendedPTS=void 0,delete this.fragments[m],S.endList&&delete this.endListFragments[S.type]},p.removeAllFragments=function(){this.fragments=Object.create(null),this.endListFragments=Object.create(null),this.activeFragment=null,this.activeParts=null},y}();function I(y){var p,S;return y.buffered&&(((p=y.range.video)===null||p===void 0?void 0:p.partial)||((S=y.range.audio)===null||S===void 0?void 0:S.partial))}function T(y){return y.type+"_"+y.level+"_"+y.urlId+"_"+y.sn}},"./src/controller/gap-controller.ts":(j,M,b)=>{b.r(M),b.d(M,{MAX_START_GAP_JUMP:()=>T,SKIP_BUFFER_HOLE_STEP_SECONDS:()=>y,SKIP_BUFFER_RANGE_START:()=>p,STALL_MINIMUM_DURATION_MS:()=>I,default:()=>S});var w=b("./src/utils/buffer-helper.ts"),D=b("./src/errors.ts"),P=b("./src/events.ts"),k=b("./src/utils/logger.ts"),I=250,T=2,y=.1,p=.05,S=function(){function m(d,o,t,n){this.config=void 0,this.media=null,this.fragmentTracker=void 0,this.hls=void 0,this.nudgeRetry=0,this.stallReported=!1,this.stalled=null,this.moved=!1,this.seeking=!1,this.config=d,this.media=o,this.fragmentTracker=t,this.hls=n}var v=m.prototype;return v.destroy=function(){this.media=null,this.hls=this.fragmentTracker=null},v.poll=function(d,o){var t=this.config,n=this.media,u=this.stalled;if(n!==null){var f=n.currentTime,h=n.seeking,i=this.seeking&&!h,c=!this.seeking&&h;if(this.seeking=h,f===d){if((c||i)&&(this.stalled=null),!(n.paused&&!h||n.ended||n.playbackRate===0)&&w.BufferHelper.getBuffered(n).length){var l=w.BufferHelper.bufferInfo(n,f,0),a=l.len>0,s=l.nextStart||0;if(a||s){if(h){var e=l.len>T,r=!s||o&&o.start<=f||s-f>T&&!this.fragmentTracker.getPartialFragment(f);if(e||r)return;this.moved=!1}if(!this.moved&&this.stalled!==null){var g,E=Math.max(s,l.start||0)-f,A=this.hls.levels?this.hls.levels[this.hls.currentLevel]:null,L=!(A==null||(g=A.details)===null||g===void 0)&&g.live?2*A.details.targetduration:T;if(E>0&&E<=L)return void this._trySkipBufferHole(null)}var _=self.performance.now();if(u!==null){var R=_-u;if(h||!(R>=I)||(this._reportStall(l),this.media)){var x=w.BufferHelper.bufferInfo(n,f,t.maxBufferHole);this._tryFixBufferStall(x,R)}}else this.stalled=_}}}else if(this.moved=!0,u!==null){if(this.stallReported){var C=self.performance.now()-u;k.logger.warn("playback not stuck anymore @"+f+", after "+Math.round(C)+"ms"),this.stallReported=!1}this.stalled=null,this.nudgeRetry=0}}},v._tryFixBufferStall=function(d,o){var t=this.config,n=this.fragmentTracker,u=this.media;if(u!==null){var f=u.currentTime,h=n.getPartialFragment(f);if(h&&(this._trySkipBufferHole(h)||!this.media))return;d.len>t.maxBufferHole&&o>1e3*t.highBufferWatchdogPeriod&&(k.logger.warn("Trying to nudge playhead over buffer-hole"),this.stalled=null,this._tryNudgeBuffer())}},v._reportStall=function(d){var o=this.hls,t=this.media;!this.stallReported&&t&&(this.stallReported=!0,k.logger.warn("Playback stalling at @"+t.currentTime+" due to low buffer ("+JSON.stringify(d)+")"),o.trigger(P.Events.ERROR,{type:D.ErrorTypes.MEDIA_ERROR,details:D.ErrorDetails.BUFFER_STALLED_ERROR,fatal:!1,buffer:d.len}))},v._trySkipBufferHole=function(d){var o=this.config,t=this.hls,n=this.media;if(n===null)return 0;for(var u=n.currentTime,f=0,h=w.BufferHelper.getBuffered(n),i=0;i<h.length;i++){var c=h.start(i);if(u+o.maxBufferHole>=f&&u<c){var l=Math.max(c+p,n.currentTime+y);return k.logger.warn("skipping hole, adjusting currentTime from "+u+" to "+l),this.moved=!0,this.stalled=null,n.currentTime=l,d&&t.trigger(P.Events.ERROR,{type:D.ErrorTypes.MEDIA_ERROR,details:D.ErrorDetails.BUFFER_SEEK_OVER_HOLE,fatal:!1,reason:"fragment loaded with buffer holes, seeking from "+u+" to "+l,frag:d}),l}f=h.end(i)}return 0},v._tryNudgeBuffer=function(){var d=this.config,o=this.hls,t=this.media,n=this.nudgeRetry;if(t!==null){var u=t.currentTime;if(this.nudgeRetry++,n<d.nudgeMaxRetry){var f=u+(n+1)*d.nudgeOffset;k.logger.warn("Nudging 'currentTime' from "+u+" to "+f),t.currentTime=f,o.trigger(P.Events.ERROR,{type:D.ErrorTypes.MEDIA_ERROR,details:D.ErrorDetails.BUFFER_NUDGE_ON_STALL,fatal:!1})}else k.logger.error("Playhead still not moving while enough data buffered @"+u+" after "+d.nudgeMaxRetry+" nudges"),o.trigger(P.Events.ERROR,{type:D.ErrorTypes.MEDIA_ERROR,details:D.ErrorDetails.BUFFER_STALLED_ERROR,fatal:!0})}},m}()},"./src/controller/id3-track-controller.ts":(j,M,b)=>{b.r(M),b.d(M,{default:()=>v});var w=b("./src/polyfills/number.ts"),D=b("./src/events.ts"),P=b("./src/utils/texttrack-utils.ts"),k=b("./src/demux/id3.ts"),I=b("./src/loader/date-range.ts"),T=b("./src/types/demuxer.ts");function y(){return self.WebKitDataCue||self.VTTCue||self.TextTrackCue}var p=function(){var d=y();try{new d(0,Number.POSITIVE_INFINITY,"")}catch{return Number.MAX_VALUE}return Number.POSITIVE_INFINITY}();function S(d,o){return d.getTime()/1e3-o}var m=function(){function d(t){this.hls=void 0,this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=t,this._registerListeners()}var o=d.prototype;return o.destroy=function(){this._unregisterListeners(),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=null},o._registerListeners=function(){var t=this.hls;t.on(D.Events.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(D.Events.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(D.Events.MANIFEST_LOADING,this.onManifestLoading,this),t.on(D.Events.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),t.on(D.Events.BUFFER_FLUSHING,this.onBufferFlushing,this),t.on(D.Events.LEVEL_UPDATED,this.onLevelUpdated,this)},o._unregisterListeners=function(){var t=this.hls;t.off(D.Events.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(D.Events.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(D.Events.MANIFEST_LOADING,this.onManifestLoading,this),t.off(D.Events.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),t.off(D.Events.BUFFER_FLUSHING,this.onBufferFlushing,this),t.off(D.Events.LEVEL_UPDATED,this.onLevelUpdated,this)},o.onMediaAttached=function(t,n){this.media=n.media},o.onMediaDetaching=function(){this.id3Track&&((0,P.clearCurrentCues)(this.id3Track),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={})},o.onManifestLoading=function(){this.dateRangeCuesAppended={}},o.createTrack=function(t){var n=this.getID3Track(t.textTracks);return n.mode="hidden",n},o.getID3Track=function(t){if(this.media){for(var n=0;n<t.length;n++){var u=t[n];if(u.kind==="metadata"&&u.label==="id3")return(0,P.sendAddTrackEvent)(u,this.media),u}return this.media.addTextTrack("metadata","id3")}},o.onFragParsingMetadata=function(t,n){if(this.media){var u=this.hls.config,f=u.enableEmsgMetadataCues,h=u.enableID3MetadataCues;if(f||h){var i=n.samples;this.id3Track||(this.id3Track=this.createTrack(this.media));for(var c=y(),l=0;l<i.length;l++){var a=i[l].type;if((a!==T.MetadataSchema.emsg||f)&&h){var s=k.getID3Frames(i[l].data);if(s){var e=i[l].pts,r=e+i[l].duration;r>p&&(r=p),r-e<=0&&(r=e+.25);for(var g=0;g<s.length;g++){var E=s[g];if(!k.isTimeStampFrame(E)){this.updateId3CueEnds(e);var A=new c(e,r,"");A.value=E,a&&(A.type=a),this.id3Track.addCue(A)}}}}}}}},o.updateId3CueEnds=function(t){var n,u=(n=this.id3Track)===null||n===void 0?void 0:n.cues;if(u)for(var f=u.length;f--;){var h=u[f];h.startTime<t&&h.endTime===p&&(h.endTime=t)}},o.onBufferFlushing=function(t,n){var u=n.startOffset,f=n.endOffset,h=n.type,i=this.id3Track,c=this.hls;if(c){var l,a=c.config,s=a.enableEmsgMetadataCues,e=a.enableID3MetadataCues;i&&(s||e)&&(l=h==="audio"?function(r){return r.type===T.MetadataSchema.audioId3&&e}:h==="video"?function(r){return r.type===T.MetadataSchema.emsg&&s}:function(r){return r.type===T.MetadataSchema.audioId3&&e||r.type===T.MetadataSchema.emsg&&s},(0,P.removeCuesInRange)(i,u,f,l))}},o.onLevelUpdated=function(t,n){var u=this,f=n.details;if(this.media&&f.hasProgramDateTime&&this.hls.config.enableDateRangeMetadataCues){var h=this.dateRangeCuesAppended,i=this.id3Track,c=f.dateRanges,l=Object.keys(c);if(i)for(var a=Object.keys(h).filter(function(_){return!l.includes(_)}),s=function(_){var R=a[_];Object.keys(h[R].cues).forEach(function(x){i.removeCue(h[R].cues[x])}),delete h[R]},e=a.length;e--;)s(e);var r=f.fragments[f.fragments.length-1];if(l.length!==0&&(0,w.isFiniteNumber)(r==null?void 0:r.programDateTime)){this.id3Track||(this.id3Track=this.createTrack(this.media));for(var g=r.programDateTime/1e3-r.start,E=y(),A=function(_){var R=l[_],x=c[R],C=h[R],F=(C==null?void 0:C.cues)||{},O=(C==null?void 0:C.durationKnown)||!1,N=S(x.startDate,g),U=p,G=x.endDate;if(G)U=S(G,g),O=!0;else if(x.endOnNext&&!O){var B=l.reduce(function(W,Q){var z=c[Q];return z.class===x.class&&z.id!==Q&&z.startDate>x.startDate&&W.push(z),W},[]).sort(function(W,Q){return W.startDate.getTime()-Q.startDate.getTime()})[0];B&&(U=S(B.startDate,g),O=!0)}for(var H,V=Object.keys(x.attr),K=0;K<V.length;K++){var Y=V[K];if(Y!==I.DateRangeAttribute.ID&&Y!==I.DateRangeAttribute.CLASS&&Y!==I.DateRangeAttribute.START_DATE&&Y!==I.DateRangeAttribute.DURATION&&Y!==I.DateRangeAttribute.END_DATE&&Y!==I.DateRangeAttribute.END_ON_NEXT){var q=F[Y];if(q)O&&!C.durationKnown&&(q.endTime=U);else{var X=x.attr[Y];q=new E(N,U,""),Y!==I.DateRangeAttribute.SCTE35_OUT&&Y!==I.DateRangeAttribute.SCTE35_IN||(H=X,X=Uint8Array.from(H.replace(/^0x/,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ")).buffer),q.value={key:Y,data:X},q.type=T.MetadataSchema.dateRange,u.id3Track.addCue(q),F[Y]=q}}}h[R]={cues:F,dateRange:x,durationKnown:O}},L=0;L<l.length;L++)A(L)}}},d}();const v=m},"./src/controller/latency-controller.ts":(j,M,b)=>{b.r(M),b.d(M,{default:()=>I});var w=b("./src/errors.ts"),D=b("./src/events.ts"),P=b("./src/utils/logger.ts");function k(T,y){for(var p=0;p<y.length;p++){var S=y[p];S.enumerable=S.enumerable||!1,S.configurable=!0,"value"in S&&(S.writable=!0),Object.defineProperty(T,(m=S.key,v=void 0,typeof(v=function(d,o){if(typeof d!="object"||d===null)return d;var t=d[Symbol.toPrimitive];if(t!==void 0){var n=t.call(d,o||"default");if(typeof n!="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return(o==="string"?String:Number)(d)}(m,"string"))=="symbol"?v:String(v)),S)}var m,v}var I=function(){function T(v){var d=this;this.hls=void 0,this.config=void 0,this.media=null,this.levelDetails=null,this.currentTime=0,this.stallCount=0,this._latency=null,this.timeupdateHandler=function(){return d.timeupdate()},this.hls=v,this.config=v.config,this.registerListeners()}var y,p,S,m=T.prototype;return m.destroy=function(){this.unregisterListeners(),this.onMediaDetaching(),this.levelDetails=null,this.hls=this.timeupdateHandler=null},m.registerListeners=function(){this.hls.on(D.Events.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(D.Events.MEDIA_DETACHING,this.onMediaDetaching,this),this.hls.on(D.Events.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(D.Events.LEVEL_UPDATED,this.onLevelUpdated,this),this.hls.on(D.Events.ERROR,this.onError,this)},m.unregisterListeners=function(){this.hls.off(D.Events.MEDIA_ATTACHED,this.onMediaAttached),this.hls.off(D.Events.MEDIA_DETACHING,this.onMediaDetaching),this.hls.off(D.Events.MANIFEST_LOADING,this.onManifestLoading),this.hls.off(D.Events.LEVEL_UPDATED,this.onLevelUpdated),this.hls.off(D.Events.ERROR,this.onError)},m.onMediaAttached=function(v,d){this.media=d.media,this.media.addEventListener("timeupdate",this.timeupdateHandler)},m.onMediaDetaching=function(){this.media&&(this.media.removeEventListener("timeupdate",this.timeupdateHandler),this.media=null)},m.onManifestLoading=function(){this.levelDetails=null,this._latency=null,this.stallCount=0},m.onLevelUpdated=function(v,d){var o=d.details;this.levelDetails=o,o.advanced&&this.timeupdate(),!o.live&&this.media&&this.media.removeEventListener("timeupdate",this.timeupdateHandler)},m.onError=function(v,d){d.details===w.ErrorDetails.BUFFER_STALLED_ERROR&&(this.stallCount++,P.logger.warn("[playback-rate-controller]: Stall detected, adjusting target latency"))},m.timeupdate=function(){var v=this.media,d=this.levelDetails;if(v&&d){this.currentTime=v.currentTime;var o=this.computeLatency();if(o!==null){this._latency=o;var t=this.config,n=t.lowLatencyMode,u=t.maxLiveSyncPlaybackRate;if(n&&u!==1){var f=this.targetLatency;if(f!==null){var h=o-f,i=h<Math.min(this.maxLatency,f+d.targetduration);if(d.live&&i&&h>.05&&this.forwardBufferLength>1){var c=Math.min(2,Math.max(1,u)),l=Math.round(2/(1+Math.exp(-.75*h-this.edgeStalled))*20)/20;v.playbackRate=Math.min(c,Math.max(1,l))}else v.playbackRate!==1&&v.playbackRate!==0&&(v.playbackRate=1)}}}}},m.estimateLiveEdge=function(){var v=this.levelDetails;return v===null?null:v.edge+v.age},m.computeLatency=function(){var v=this.estimateLiveEdge();return v===null?null:v-this.currentTime},y=T,(p=[{key:"latency",get:function(){return this._latency||0}},{key:"maxLatency",get:function(){var v=this.config,d=this.levelDetails;return v.liveMaxLatencyDuration!==void 0?v.liveMaxLatencyDuration:d?v.liveMaxLatencyDurationCount*d.targetduration:0}},{key:"targetLatency",get:function(){var v=this.levelDetails;if(v===null)return null;var d=v.holdBack,o=v.partHoldBack,t=v.targetduration,n=this.config,u=n.liveSyncDuration,f=n.liveSyncDurationCount,h=n.lowLatencyMode,i=this.hls.userConfig,c=h&&o||d;(i.liveSyncDuration||i.liveSyncDurationCount||c===0)&&(c=u!==void 0?u:f*t);var l=t;return c+Math.min(1*this.stallCount,l)}},{key:"liveSyncPosition",get:function(){var v=this.estimateLiveEdge(),d=this.targetLatency,o=this.levelDetails;if(v===null||d===null||o===null)return null;var t=o.edge,n=v-d-this.edgeStalled,u=t-o.totalduration,f=t-(this.config.lowLatencyMode&&o.partTarget||o.targetduration);return Math.min(Math.max(u,n),f)}},{key:"drift",get:function(){var v=this.levelDetails;return v===null?1:v.drift}},{key:"edgeStalled",get:function(){var v=this.levelDetails;if(v===null)return 0;var d=3*(this.config.lowLatencyMode&&v.partTarget||v.targetduration);return Math.max(v.age-d,0)}},{key:"forwardBufferLength",get:function(){var v=this.media,d=this.levelDetails;if(!v||!d)return 0;var o=v.buffered.length;return(o?v.buffered.end(o-1):d.edge)-this.currentTime}}])&&k(y.prototype,p),S&&k(y,S),Object.defineProperty(y,"prototype",{writable:!1}),T}()},"./src/controller/level-controller.ts":(j,M,b)=>{b.r(M),b.d(M,{default:()=>d});var w=b("./src/types/level.ts"),D=b("./src/events.ts"),P=b("./src/errors.ts"),k=b("./src/utils/codecs.ts"),I=b("./src/controller/level-helper.ts"),T=b("./src/controller/base-playlist-controller.ts"),y=b("./src/types/loader.ts");function p(){return p=Object.assign?Object.assign.bind():function(o){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var u in n)Object.prototype.hasOwnProperty.call(n,u)&&(o[u]=n[u])}return o},p.apply(this,arguments)}function S(o,t){for(var n=0;n<t.length;n++){var u=t[n];u.enumerable=u.enumerable||!1,u.configurable=!0,"value"in u&&(u.writable=!0),Object.defineProperty(o,(f=u.key,h=void 0,typeof(h=function(i,c){if(typeof i!="object"||i===null)return i;var l=i[Symbol.toPrimitive];if(l!==void 0){var a=l.call(i,c||"default");if(typeof a!="object")return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return(c==="string"?String:Number)(i)}(f,"string"))=="symbol"?h:String(h)),u)}var f,h}function m(o,t){return m=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(n,u){return n.__proto__=u,n},m(o,t)}var v=/chrome|firefox/.test(navigator.userAgent.toLowerCase()),d=function(o){var t,n;function u(l){var a;return(a=o.call(this,l,"[level-controller]")||this)._levels=[],a._firstLevel=-1,a._startLevel=void 0,a.currentLevelIndex=-1,a.manualLevelIndex=-1,a.onParsedComplete=void 0,a._registerListeners(),a}n=o,(t=u).prototype=Object.create(n.prototype),t.prototype.constructor=t,m(t,n);var f,h,i,c=u.prototype;return c._registerListeners=function(){var l=this.hls;l.on(D.Events.MANIFEST_LOADED,this.onManifestLoaded,this),l.on(D.Events.LEVEL_LOADED,this.onLevelLoaded,this),l.on(D.Events.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),l.on(D.Events.FRAG_LOADED,this.onFragLoaded,this),l.on(D.Events.ERROR,this.onError,this)},c._unregisterListeners=function(){var l=this.hls;l.off(D.Events.MANIFEST_LOADED,this.onManifestLoaded,this),l.off(D.Events.LEVEL_LOADED,this.onLevelLoaded,this),l.off(D.Events.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),l.off(D.Events.FRAG_LOADED,this.onFragLoaded,this),l.off(D.Events.ERROR,this.onError,this)},c.destroy=function(){this._unregisterListeners(),this.manualLevelIndex=-1,this._levels.length=0,o.prototype.destroy.call(this)},c.startLoad=function(){this._levels.forEach(function(l){l.loadError=0}),o.prototype.startLoad.call(this)},c.onManifestLoaded=function(l,a){var s,e,r=[],g=[],E=[],A={},L=!1,_=!1,R=!1;if(a.levels.forEach(function(O){var N=O.attrs;L=L||!(!O.width||!O.height),_=_||!!O.videoCodec,R=R||!!O.audioCodec,v&&O.audioCodec&&O.audioCodec.indexOf("mp4a.40.34")!==-1&&(O.audioCodec=void 0);var U=O.bitrate+"-"+O.attrs.RESOLUTION+"-"+O.attrs.CODECS;(e=A[U])?e.url.push(O.url):(e=new w.Level(O),A[U]=e,r.push(e)),N&&(N.AUDIO&&(0,I.addGroupId)(e,"audio",N.AUDIO),N.SUBTITLES&&(0,I.addGroupId)(e,"text",N.SUBTITLES))}),(L||_)&&R&&(r=r.filter(function(O){var N=O.videoCodec,U=O.width,G=O.height;return!!N||!(!U||!G)})),r=r.filter(function(O){var N=O.audioCodec,U=O.videoCodec;return(!N||(0,k.isCodecSupportedInMp4)(N,"audio"))&&(!U||(0,k.isCodecSupportedInMp4)(U,"video"))}),a.audioTracks&&(g=a.audioTracks.filter(function(O){return!O.audioCodec||(0,k.isCodecSupportedInMp4)(O.audioCodec,"audio")}),(0,I.assignTrackIdsByGroup)(g)),a.subtitles&&(E=a.subtitles,(0,I.assignTrackIdsByGroup)(E)),r.length>0){s=r[0].bitrate,r.sort(function(O,N){return O.attrs["HDCP-LEVEL"]!==N.attrs["HDCP-LEVEL"]?(O.attrs["HDCP-LEVEL"]||"")>(N.attrs["HDCP-LEVEL"]||"")?1:-1:O.bitrate!==N.bitrate?O.bitrate-N.bitrate:O.attrs.SCORE!==N.attrs.SCORE?O.attrs.decimalFloatingPoint("SCORE")-N.attrs.decimalFloatingPoint("SCORE"):L&&O.height!==N.height?O.height-N.height:0}),this._levels=r;for(var x=0;x<r.length;x++)if(r[x].bitrate===s){this._firstLevel=x,this.log("manifest loaded, "+r.length+" level(s) found, first bitrate: "+s);break}var C=R&&!_,F={levels:r,audioTracks:g,subtitleTracks:E,sessionData:a.sessionData,sessionKeys:a.sessionKeys,firstLevel:this._firstLevel,stats:a.stats,audio:R,video:_,altAudio:!C&&g.some(function(O){return!!O.url})};this.hls.trigger(D.Events.MANIFEST_PARSED,F),(this.hls.config.autoStartLoad||this.hls.forceStartLoad)&&this.hls.startLoad(this.hls.config.startPosition)}else this.hls.trigger(D.Events.ERROR,{type:P.ErrorTypes.MEDIA_ERROR,details:P.ErrorDetails.MANIFEST_INCOMPATIBLE_CODECS_ERROR,fatal:!0,url:a.url,reason:"no level with compatible codecs found in manifest"})},c.onError=function(l,a){var s,e;if(o.prototype.onError.call(this,l,a),!a.fatal){var r=a.context,g=this._levels[this.currentLevelIndex];if(r&&(r.type===y.PlaylistContextType.AUDIO_TRACK&&g.audioGroupIds&&r.groupId===g.audioGroupIds[g.urlId]||r.type===y.PlaylistContextType.SUBTITLE_TRACK&&g.textGroupIds&&r.groupId===g.textGroupIds[g.urlId]))this.redundantFailover(this.currentLevelIndex);else{var E,A=!1,L=!0;switch(a.details){case P.ErrorDetails.FRAG_LOAD_ERROR:case P.ErrorDetails.FRAG_LOAD_TIMEOUT:case P.ErrorDetails.KEY_LOAD_ERROR:case P.ErrorDetails.KEY_LOAD_TIMEOUT:if(a.frag){var _=a.frag.type===y.PlaylistLevelType.MAIN?a.frag.level:this.currentLevelIndex,R=this._levels[_];R?(R.fragmentError++,R.fragmentError>this.hls.config.fragLoadingMaxRetry&&(E=_)):E=_}break;case P.ErrorDetails.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED:var x=g.attrs["HDCP-LEVEL"];x&&(this.hls.maxHdcpLevel=w.HdcpLevels[w.HdcpLevels.indexOf(x)-1],this.warn('Restricting playback to HDCP-LEVEL of "'+this.hls.maxHdcpLevel+'" or lower'));case P.ErrorDetails.FRAG_PARSING_ERROR:case P.ErrorDetails.KEY_SYSTEM_NO_SESSION:E=((s=a.frag)===null||s===void 0?void 0:s.type)===y.PlaylistLevelType.MAIN?a.frag.level:this.currentLevelIndex,a.levelRetry=!1;break;case P.ErrorDetails.LEVEL_LOAD_ERROR:case P.ErrorDetails.LEVEL_LOAD_TIMEOUT:r&&(r.deliveryDirectives&&(L=!1),E=r.level),A=!0;break;case P.ErrorDetails.REMUX_ALLOC_ERROR:E=(e=a.level)!=null?e:this.currentLevelIndex,A=!0}E!==void 0&&this.recoverLevel(a,E,A,L)}}},c.recoverLevel=function(l,a,s,e){var r=l.details,g=this._levels[a];if(g.loadError++,s){if(!this.retryLoadingOrFail(l))return void(this.currentLevelIndex=-1);l.levelRetry=!0}if(e){var E=g.url.length;if(E>1&&g.loadError<E)l.levelRetry=!0,this.redundantFailover(a);else if(this.manualLevelIndex===-1){for(var A=-1,L=this._levels,_=L.length;_--;){var R=(_+this.currentLevelIndex)%L.length;if(R!==this.currentLevelIndex&&L[R].loadError===0){A=R;break}}A>-1&&this.currentLevelIndex!==A?(this.warn(r+": switch to "+A),l.levelRetry=!0,this.hls.nextAutoLevel=A):l.levelRetry===!1&&(l.fatal=!0)}}},c.redundantFailover=function(l){var a=this._levels[l],s=a.url.length;if(s>1){var e=(a.urlId+1)%s;this.warn("Switching to redundant URL-id "+e),this._levels.forEach(function(r){r.urlId=e}),this.level=l}},c.onFragLoaded=function(l,a){var s=a.frag;if(s!==void 0&&s.type===y.PlaylistLevelType.MAIN){var e=this._levels[s.level];e!==void 0&&(e.fragmentError=0,e.loadError=0)}},c.onLevelLoaded=function(l,a){var s,e,r=a.level,g=a.details,E=this._levels[r];if(!E)return this.warn("Invalid level index "+r),void((e=a.deliveryDirectives)!==null&&e!==void 0&&e.skip&&(g.deltaUpdateFailed=!0));r===this.currentLevelIndex?(E.fragmentError===0&&(E.loadError=0,this.retryCount=0),this.playlistLoaded(r,a,E.details)):(s=a.deliveryDirectives)!==null&&s!==void 0&&s.skip&&(g.deltaUpdateFailed=!0)},c.onAudioTrackSwitched=function(l,a){var s=this.hls.levels[this.currentLevelIndex];if(s&&s.audioGroupIds){for(var e=-1,r=this.hls.audioTracks[a.id].groupId,g=0;g<s.audioGroupIds.length;g++)if(s.audioGroupIds[g]===r){e=g;break}e!==s.urlId&&(s.urlId=e,this.startLoad())}},c.loadPlaylist=function(l){o.prototype.loadPlaylist.call(this);var a=this.currentLevelIndex,s=this._levels[a];if(this.canLoad&&s&&s.url.length>0){var e=s.urlId,r=s.url[e];if(l)try{r=l.addDirectives(r)}catch(g){this.warn("Could not construct new URL with HLS Delivery Directives: "+g)}this.log("Attempt loading level index "+a+((l==null?void 0:l.msn)!==void 0?" at sn "+l.msn+" part "+l.part:"")+" with URL-id "+e+" "+r),this.clearTimer(),this.hls.trigger(D.Events.LEVEL_LOADING,{url:r,level:a,id:e,deliveryDirectives:l||null})}},c.removeLevel=function(l,a){var s=function(r,g){return g!==a},e=this._levels.filter(function(r,g){return g!==l||r.url.length>1&&a!==void 0&&(r.url=r.url.filter(s),r.audioGroupIds&&(r.audioGroupIds=r.audioGroupIds.filter(s)),r.textGroupIds&&(r.textGroupIds=r.textGroupIds.filter(s)),r.urlId=0,!0)}).map(function(r,g){var E=r.details;return E!=null&&E.fragments&&E.fragments.forEach(function(A){A.level=g}),r});this._levels=e,this.hls.trigger(D.Events.LEVELS_UPDATED,{levels:e})},f=u,(h=[{key:"levels",get:function(){return this._levels.length===0?null:this._levels}},{key:"level",get:function(){return this.currentLevelIndex},set:function(l){var a,s=this._levels;if(s.length!==0&&(this.currentLevelIndex!==l||(a=s[l])===null||a===void 0||!a.details)){if(l<0||l>=s.length){var e=l<0;if(this.hls.trigger(D.Events.ERROR,{type:P.ErrorTypes.OTHER_ERROR,details:P.ErrorDetails.LEVEL_SWITCH_ERROR,level:l,fatal:e,reason:"invalid level idx"}),e)return;l=Math.min(l,s.length-1)}this.clearTimer();var r=this.currentLevelIndex,g=s[r],E=s[l];this.log("switching to level "+l+" from "+r),this.currentLevelIndex=l;var A=p({},E,{level:l,maxBitrate:E.maxBitrate,uri:E.uri,urlId:E.urlId});delete A._urlId,this.hls.trigger(D.Events.LEVEL_SWITCHING,A);var L=E.details;if(!L||L.live){var _=this.switchParams(E.uri,g==null?void 0:g.details);this.loadPlaylist(_)}}}},{key:"manualLevel",get:function(){return this.manualLevelIndex},set:function(l){this.manualLevelIndex=l,this._startLevel===void 0&&(this._startLevel=l),l!==-1&&(this.level=l)}},{key:"firstLevel",get:function(){return this._firstLevel},set:function(l){this._firstLevel=l}},{key:"startLevel",get:function(){if(this._startLevel===void 0){var l=this.hls.config.startLevel;return l!==void 0?l:this._firstLevel}return this._startLevel},set:function(l){this._startLevel=l}},{key:"nextLoadLevel",get:function(){return this.manualLevelIndex!==-1?this.manualLevelIndex:this.hls.nextAutoLevel},set:function(l){this.level=l,this.manualLevelIndex===-1&&(this.hls.nextAutoLevel=l)}}])&&S(f.prototype,h),i&&S(f,i),Object.defineProperty(f,"prototype",{writable:!1}),u}(T.default)},"./src/controller/level-helper.ts":(j,M,b)=>{b.r(M),b.d(M,{addGroupId:()=>I,addSliding:()=>t,adjustSliding:()=>o,assignTrackIdsByGroup:()=>T,computeReloadInterval:()=>n,getFragmentWithSN:()=>u,getPartWith:()=>f,mapFragmentIntersection:()=>d,mapPartIntersection:()=>v,mergeDetails:()=>m,updateFragPTSDTS:()=>S,updatePTS:()=>y});var w=b("./src/polyfills/number.ts"),D=b("./src/utils/logger.ts"),P=b("./src/loader/date-range.ts");function k(){return k=Object.assign?Object.assign.bind():function(h){for(var i=1;i<arguments.length;i++){var c=arguments[i];for(var l in c)Object.prototype.hasOwnProperty.call(c,l)&&(h[l]=c[l])}return h},k.apply(this,arguments)}function I(h,i,c){switch(i){case"audio":h.audioGroupIds||(h.audioGroupIds=[]),h.audioGroupIds.push(c);break;case"text":h.textGroupIds||(h.textGroupIds=[]),h.textGroupIds.push(c)}}function T(h){var i={};h.forEach(function(c){var l=c.groupId||"";c.id=i[l]=i[l]||0,i[l]++})}function y(h,i,c){p(h[i],h[c])}function p(h,i){var c=i.startPTS;if((0,w.isFiniteNumber)(c)){var l,a=0;i.sn>h.sn?(a=c-h.start,l=h):(a=h.start-c,l=i),l.duration!==a&&(l.duration=a)}else i.sn>h.sn?h.cc===i.cc&&h.minEndPTS?i.start=h.start+(h.minEndPTS-h.start):i.start=h.start+h.duration:i.start=Math.max(h.start-i.duration,0)}function S(h,i,c,l,a,s){l-c<=0&&(D.logger.warn("Fragment should have a positive duration",i),l=c+i.duration,s=a+i.duration);var e=c,r=l,g=i.startPTS,E=i.endPTS;if((0,w.isFiniteNumber)(g)){var A=Math.abs(g-c);(0,w.isFiniteNumber)(i.deltaPTS)?i.deltaPTS=Math.max(A,i.deltaPTS):i.deltaPTS=A,e=Math.max(c,g),c=Math.min(c,g),a=Math.min(a,i.startDTS),r=Math.min(l,E),l=Math.max(l,E),s=Math.max(s,i.endDTS)}i.duration=l-c;var L=c-i.start;i.start=i.startPTS=c,i.maxStartPTS=e,i.startDTS=a,i.endPTS=l,i.minEndPTS=r,i.endDTS=s;var _,R=i.sn;if(!h||R<h.startSN||R>h.endSN)return 0;var x=R-h.startSN,C=h.fragments;for(C[x]=i,_=x;_>0;_--)p(C[_],C[_-1]);for(_=x;_<C.length-1;_++)p(C[_],C[_+1]);return h.fragmentHint&&p(C[C.length-1],h.fragmentHint),h.PTSKnown=h.alignedSliding=!0,L}function m(h,i){for(var c=null,l=h.fragments,a=l.length-1;a>=0;a--){var s=l[a].initSegment;if(s){c=s;break}}h.fragmentHint&&delete h.fragmentHint.endPTS;var e,r,g,E,A,L=0;if(d(h,i,function(O,N){O.relurl&&(L=O.cc-N.cc),(0,w.isFiniteNumber)(O.startPTS)&&(0,w.isFiniteNumber)(O.endPTS)&&(N.start=N.startPTS=O.startPTS,N.startDTS=O.startDTS,N.appendedPTS=O.appendedPTS,N.maxStartPTS=O.maxStartPTS,N.endPTS=O.endPTS,N.endDTS=O.endDTS,N.minEndPTS=O.minEndPTS,N.duration=O.endPTS-O.startPTS,N.duration&&(e=N),i.PTSKnown=i.alignedSliding=!0),N.elementaryStreams=O.elementaryStreams,N.loader=O.loader,N.stats=O.stats,N.urlId=O.urlId,O.initSegment&&(N.initSegment=O.initSegment,c=O.initSegment)}),c&&(i.fragmentHint?i.fragments.concat(i.fragmentHint):i.fragments).forEach(function(O){var N;O.initSegment&&O.initSegment.relurl!==((N=c)===null||N===void 0?void 0:N.relurl)||(O.initSegment=c)}),i.skippedSegments)if(i.deltaUpdateFailed=i.fragments.some(function(O){return!O}),i.deltaUpdateFailed){D.logger.warn("[level-helper] Previous playlist missing segments skipped in delta playlist");for(var _=i.skippedSegments;_--;)i.fragments.shift();i.startSN=i.fragments[0].sn,i.startCC=i.fragments[0].cc}else i.canSkipDateRanges&&(i.dateRanges=(r=h.dateRanges,g=i.dateRanges,E=i.recentlyRemovedDateranges,A=k({},r),E&&E.forEach(function(O){delete A[O]}),Object.keys(g).forEach(function(O){var N=new P.DateRange(g[O].attr,A[O]);N.isValid?A[O]=N:D.logger.warn('Ignoring invalid Playlist Delta Update DATERANGE tag: "'+JSON.stringify(g[O].attr)+'"')}),A));var R=i.fragments;if(L){D.logger.warn("discontinuity sliding from playlist, take drift into account");for(var x=0;x<R.length;x++)R[x].cc+=L}i.skippedSegments&&(i.startCC=i.fragments[0].cc),v(h.partList,i.partList,function(O,N){N.elementaryStreams=O.elementaryStreams,N.stats=O.stats}),e?S(i,e,e.startPTS,e.endPTS,e.startDTS,e.endDTS):o(h,i),R.length&&(i.totalduration=i.edge-R[0].start),i.driftStartTime=h.driftStartTime,i.driftStart=h.driftStart;var C=i.advancedDateTime;if(i.advanced&&C){var F=i.edge;i.driftStart||(i.driftStartTime=C,i.driftStart=F),i.driftEndTime=C,i.driftEnd=F}else i.driftEndTime=h.driftEndTime,i.driftEnd=h.driftEnd,i.advancedDateTime=h.advancedDateTime}function v(h,i,c){if(h&&i)for(var l=0,a=0,s=h.length;a<=s;a++){var e=h[a],r=i[a+l];e&&r&&e.index===r.index&&e.fragment.sn===r.fragment.sn?c(e,r):l--}}function d(h,i,c){for(var l=i.skippedSegments,a=Math.max(h.startSN,i.startSN)-i.startSN,s=(h.fragmentHint?1:0)+(l?i.endSN:Math.min(h.endSN,i.endSN))-i.startSN,e=i.startSN-h.startSN,r=i.fragmentHint?i.fragments.concat(i.fragmentHint):i.fragments,g=h.fragmentHint?h.fragments.concat(h.fragmentHint):h.fragments,E=a;E<=s;E++){var A=g[e+E],L=r[E];l&&!L&&E<l&&(L=i.fragments[E]=A),A&&L&&c(A,L)}}function o(h,i){var c=i.startSN+i.skippedSegments-h.startSN,l=h.fragments;c<0||c>=l.length||t(i,l[c].start)}function t(h,i){if(i){for(var c=h.fragments,l=h.skippedSegments;l<c.length;l++)c[l].start+=i;h.fragmentHint&&(h.fragmentHint.start+=i)}}function n(h,i){i===void 0&&(i=1/0);var c=1e3*h.targetduration;if(h.updated){var l=h.fragments;if(l.length&&4*c>i){var a=1e3*l[l.length-1].duration;a<c&&(c=a)}}else c/=2;return Math.round(c)}function u(h,i,c){if(!h||!h.details)return null;var l=h.details,a=l.fragments[i-l.startSN];return a||((a=l.fragmentHint)&&a.sn===i?a:i<l.startSN&&c&&c.sn===i?c:null)}function f(h,i,c){if(!h||!h.details)return null;var l=h.details.partList;if(l)for(var a=l.length;a--;){var s=l[a];if(s.index===c&&s.fragment.sn===i)return s}return null}},"./src/controller/stream-controller.ts":(j,M,b)=>{b.r(M),b.d(M,{default:()=>n});var w=b("./src/polyfills/number.ts"),D=b("./src/controller/base-stream-controller.ts"),P=b("./src/is-supported.ts"),k=b("./src/events.ts"),I=b("./src/utils/buffer-helper.ts"),T=b("./src/controller/fragment-tracker.ts"),y=b("./src/types/loader.ts"),p=b("./src/loader/fragment.ts"),S=b("./src/demux/transmuxer-interface.ts"),m=b("./src/types/transmuxer.ts"),v=b("./src/controller/gap-controller.ts"),d=b("./src/errors.ts");function o(u,f){for(var h=0;h<f.length;h++){var i=f[h];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(u,(c=i.key,l=void 0,typeof(l=function(a,s){if(typeof a!="object"||a===null)return a;var e=a[Symbol.toPrimitive];if(e!==void 0){var r=e.call(a,s||"default");if(typeof r!="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return(s==="string"?String:Number)(a)}(c,"string"))=="symbol"?l:String(l)),i)}var c,l}function t(u,f){return t=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(h,i){return h.__proto__=i,h},t(u,f)}var n=function(u){var f,h;function i(e,r,g){var E;return(E=u.call(this,e,r,g,"[stream-controller]")||this).audioCodecSwap=!1,E.gapController=null,E.level=-1,E._forceStartLoad=!1,E.altAudio=!1,E.audioOnly=!1,E.fragPlaying=null,E.onvplaying=null,E.onvseeked=null,E.fragLastKbps=0,E.couldBacktrack=!1,E.backtrackFragment=null,E.audioCodecSwitch=!1,E.videoBuffer=null,E._registerListeners(),E}h=u,(f=i).prototype=Object.create(h.prototype),f.prototype.constructor=f,t(f,h);var c,l,a,s=i.prototype;return s._registerListeners=function(){var e=this.hls;e.on(k.Events.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(k.Events.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(k.Events.MANIFEST_LOADING,this.onManifestLoading,this),e.on(k.Events.MANIFEST_PARSED,this.onManifestParsed,this),e.on(k.Events.LEVEL_LOADING,this.onLevelLoading,this),e.on(k.Events.LEVEL_LOADED,this.onLevelLoaded,this),e.on(k.Events.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.on(k.Events.ERROR,this.onError,this),e.on(k.Events.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(k.Events.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.on(k.Events.BUFFER_CREATED,this.onBufferCreated,this),e.on(k.Events.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(k.Events.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(k.Events.FRAG_BUFFERED,this.onFragBuffered,this)},s._unregisterListeners=function(){var e=this.hls;e.off(k.Events.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(k.Events.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(k.Events.MANIFEST_LOADING,this.onManifestLoading,this),e.off(k.Events.MANIFEST_PARSED,this.onManifestParsed,this),e.off(k.Events.LEVEL_LOADED,this.onLevelLoaded,this),e.off(k.Events.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.off(k.Events.ERROR,this.onError,this),e.off(k.Events.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(k.Events.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.off(k.Events.BUFFER_CREATED,this.onBufferCreated,this),e.off(k.Events.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(k.Events.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(k.Events.FRAG_BUFFERED,this.onFragBuffered,this)},s.onHandlerDestroying=function(){this._unregisterListeners(),this.onMediaDetaching()},s.startLoad=function(e){if(this.levels){var r=this.lastCurrentTime,g=this.hls;if(this.stopLoad(),this.setInterval(100),this.level=-1,this.fragLoadError=0,!this.startFragRequested){var E=g.startLevel;E===-1&&(g.config.testBandwidth&&this.levels.length>1?(E=0,this.bitrateTest=!0):E=g.nextAutoLevel),this.level=g.nextLoadLevel=E,this.loadedmetadata=!1}r>0&&e===-1&&(this.log("Override startPosition with lastCurrentTime @"+r.toFixed(3)),e=r),this.state=D.State.IDLE,this.nextLoadPosition=this.startPosition=this.lastCurrentTime=e,this.tick()}else this._forceStartLoad=!0,this.state=D.State.STOPPED},s.stopLoad=function(){this._forceStartLoad=!1,u.prototype.stopLoad.call(this)},s.doTick=function(){switch(this.state){case D.State.IDLE:this.doTickIdle();break;case D.State.WAITING_LEVEL:var e,r=this.levels,g=this.level,E=r==null||(e=r[g])===null||e===void 0?void 0:e.details;if(E&&(!E.live||this.levelLastLoaded===this.level)){if(this.waitForCdnTuneIn(E))break;this.state=D.State.IDLE;break}break;case D.State.FRAG_LOADING_WAITING_RETRY:var A,L=self.performance.now(),_=this.retryDate;(!_||L>=_||(A=this.media)!==null&&A!==void 0&&A.seeking)&&(this.log("retryDate reached, switch back to IDLE state"),this.resetStartWhenNotLoaded(this.level),this.state=D.State.IDLE)}this.onTickEnd()},s.onTickEnd=function(){u.prototype.onTickEnd.call(this),this.checkBuffer(),this.checkFragmentChanged()},s.doTickIdle=function(){var e=this.hls,r=this.levelLastLoaded,g=this.levels,E=this.media,A=e.config,L=e.nextLoadLevel;if(r!==null&&(E||!this.startFragRequested&&A.startFragPrefetch)&&(!this.altAudio||!this.audioOnly)&&g&&g[L]){var _=g[L],R=this.getMainFwdBufferInfo();if(R!==null){var x=this.getLevelDetails();if(x&&this._streamEnded(R,x)){var C={};return this.altAudio&&(C.type="video"),this.hls.trigger(k.Events.BUFFER_EOS,C),void(this.state=D.State.ENDED)}this.level=e.nextLoadLevel=L;var F=_.details;if(!F||this.state===D.State.WAITING_LEVEL||F.live&&this.levelLastLoaded!==L)return this.level=L,void(this.state=D.State.WAITING_LEVEL);if(!(R.len>=this.getMaxBufferLength(_.maxBitrate))){this.backtrackFragment&&this.backtrackFragment.start>R.end&&(this.backtrackFragment=null);var O=this.backtrackFragment?this.backtrackFragment.start:R.end,N=this.getNextFragment(O,F);if(this.couldBacktrack&&!this.fragPrevious&&N&&N.sn!=="initSegment"&&this.fragmentTracker.getState(N)!==T.FragmentState.OK){var U,G=((U=this.backtrackFragment)!=null?U:N).sn-F.startSN,B=F.fragments[G-1];B&&N.cc===B.cc&&(N=B,this.fragmentTracker.removeFragment(B))}else this.backtrackFragment&&R.len&&(this.backtrackFragment=null);if(N&&this.fragmentTracker.getState(N)===T.FragmentState.OK&&this.nextLoadPosition>O){var H=this.audioOnly&&!this.altAudio?p.ElementaryStreamTypes.AUDIO:p.ElementaryStreamTypes.VIDEO,V=(H===p.ElementaryStreamTypes.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;V&&this.afterBufferFlushed(V,H,y.PlaylistLevelType.MAIN),N=this.getNextFragment(this.nextLoadPosition,F)}N&&(!N.initSegment||N.initSegment.data||this.bitrateTest||(N=N.initSegment),this.loadFragment(N,F,O))}}}},s.loadFragment=function(e,r,g){var E,A=this.fragmentTracker.getState(e);this.fragCurrent=e,A===T.FragmentState.NOT_LOADED?e.sn==="initSegment"?this._loadInitSegment(e,r):this.bitrateTest?(this.log("Fragment "+e.sn+" of level "+e.level+" is being downloaded to test bitrate and will not be buffered"),this._loadBitrateTestFrag(e,r)):(this.startFragRequested=!0,u.prototype.loadFragment.call(this,e,r,g)):A===T.FragmentState.APPENDING?this.reduceMaxBufferLength(e.duration)&&this.fragmentTracker.removeFragment(e):((E=this.media)===null||E===void 0?void 0:E.buffered.length)===0&&this.fragmentTracker.removeAllFragments()},s.getAppendedFrag=function(e){var r=this.fragmentTracker.getAppendedFrag(e,y.PlaylistLevelType.MAIN);return r&&"fragment"in r?r.fragment:r},s.getBufferedFrag=function(e){return this.fragmentTracker.getBufferedFrag(e,y.PlaylistLevelType.MAIN)},s.followingBufferedFrag=function(e){return e?this.getBufferedFrag(e.end+.5):null},s.immediateLevelSwitch=function(){this.abortCurrentFrag(),this.flushMainBuffer(0,Number.POSITIVE_INFINITY)},s.nextLevelSwitch=function(){var e=this.levels,r=this.media;if(r!=null&&r.readyState){var g,E=this.getAppendedFrag(r.currentTime);if(E&&E.start>1&&this.flushMainBuffer(0,E.start-1),!r.paused&&e){var A=e[this.hls.nextLoadLevel],L=this.fragLastKbps;g=L&&this.fragCurrent?this.fragCurrent.duration*A.maxBitrate/(1e3*L)+1:0}else g=0;var _=this.getBufferedFrag(r.currentTime+g);if(_){var R=this.followingBufferedFrag(_);if(R){this.abortCurrentFrag();var x=R.maxStartPTS?R.maxStartPTS:R.start,C=R.duration,F=Math.max(_.end,x+Math.min(Math.max(C-this.config.maxFragLookUpTolerance,.5*C),.75*C));this.flushMainBuffer(F,Number.POSITIVE_INFINITY)}}}},s.abortCurrentFrag=function(){var e=this.fragCurrent;switch(this.fragCurrent=null,this.backtrackFragment=null,e&&e.abortRequests(),this.state){case D.State.KEY_LOADING:case D.State.FRAG_LOADING:case D.State.FRAG_LOADING_WAITING_RETRY:case D.State.PARSING:case D.State.PARSED:this.state=D.State.IDLE}this.nextLoadPosition=this.getLoadPosition()},s.flushMainBuffer=function(e,r){u.prototype.flushMainBuffer.call(this,e,r,this.altAudio?"video":null)},s.onMediaAttached=function(e,r){u.prototype.onMediaAttached.call(this,e,r);var g=r.media;this.onvplaying=this.onMediaPlaying.bind(this),this.onvseeked=this.onMediaSeeked.bind(this),g.addEventListener("playing",this.onvplaying),g.addEventListener("seeked",this.onvseeked),this.gapController=new v.default(this.config,g,this.fragmentTracker,this.hls)},s.onMediaDetaching=function(){var e=this.media;e&&this.onvplaying&&this.onvseeked&&(e.removeEventListener("playing",this.onvplaying),e.removeEventListener("seeked",this.onvseeked),this.onvplaying=this.onvseeked=null,this.videoBuffer=null),this.fragPlaying=null,this.gapController&&(this.gapController.destroy(),this.gapController=null),u.prototype.onMediaDetaching.call(this)},s.onMediaPlaying=function(){this.tick()},s.onMediaSeeked=function(){var e=this.media,r=e?e.currentTime:null;(0,w.isFiniteNumber)(r)&&this.log("Media seeked to "+r.toFixed(3)),this.tick()},s.onManifestLoading=function(){this.log("Trigger BUFFER_RESET"),this.hls.trigger(k.Events.BUFFER_RESET,void 0),this.fragmentTracker.removeAllFragments(),this.couldBacktrack=!1,this.startPosition=this.lastCurrentTime=0,this.fragPlaying=null,this.backtrackFragment=null},s.onManifestParsed=function(e,r){var g,E=!1,A=!1;r.levels.forEach(function(L){(g=L.audioCodec)&&(g.indexOf("mp4a.40.2")!==-1&&(E=!0),g.indexOf("mp4a.40.5")!==-1&&(A=!0))}),this.audioCodecSwitch=E&&A&&!(0,P.changeTypeSupported)(),this.audioCodecSwitch&&this.log("Both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC"),this.levels=r.levels,this.startFragRequested=!1},s.onLevelLoading=function(e,r){var g=this.levels;if(g&&this.state===D.State.IDLE){var E=g[r.level];(!E.details||E.details.live&&this.levelLastLoaded!==r.level||this.waitForCdnTuneIn(E.details))&&(this.state=D.State.WAITING_LEVEL)}},s.onLevelLoaded=function(e,r){var g,E=this.levels,A=r.level,L=r.details,_=L.totalduration;if(E){this.log("Level "+A+" loaded ["+L.startSN+","+L.endSN+"], cc ["+L.startCC+", "+L.endCC+"] duration:"+_);var R=this.fragCurrent;!R||this.state!==D.State.FRAG_LOADING&&this.state!==D.State.FRAG_LOADING_WAITING_RETRY||R.level!==r.level&&R.loader&&(this.state=D.State.IDLE,this.backtrackFragment=null,R.abortRequests());var x=E[A],C=0;if(L.live||(g=x.details)!==null&&g!==void 0&&g.live){if(L.fragments[0]||(L.deltaUpdateFailed=!0),L.deltaUpdateFailed)return;C=this.alignPlaylists(L,x.details)}if(x.details=L,this.levelLastLoaded=A,this.hls.trigger(k.Events.LEVEL_UPDATED,{details:L,level:A}),this.state===D.State.WAITING_LEVEL){if(this.waitForCdnTuneIn(L))return;this.state=D.State.IDLE}this.startFragRequested?L.live&&this.synchronizeToLiveEdge(L):this.setStartPosition(L,C),this.tick()}else this.warn("Levels were reset while loading level "+A)},s._handleFragmentLoadProgress=function(e){var r,g=e.frag,E=e.part,A=e.payload,L=this.levels;if(L){var _=L[g.level],R=_.details;if(R){var x=_.videoCodec,C=R.PTSKnown||!R.live,F=(r=g.initSegment)===null||r===void 0?void 0:r.data,O=this._getAudioCodec(_),N=this.transmuxer=this.transmuxer||new S.default(this.hls,y.PlaylistLevelType.MAIN,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)),U=E?E.index:-1,G=U!==-1,B=new m.ChunkMetadata(g.level,g.sn,g.stats.chunkCount,A.byteLength,U,G),H=this.initPTS[g.cc];N.push(A,F,O,x,g,E,R.totalduration,C,B,H)}else this.warn("Dropping fragment "+g.sn+" of level "+g.level+" after level details were reset")}else this.warn("Levels were reset while fragment load was in progress. Fragment "+g.sn+" of level "+g.level+" will not be buffered")},s.onAudioTrackSwitching=function(e,r){var g=this.altAudio,E=!!r.url,A=r.id;if(!E){if(this.mediaBuffer!==this.media){this.log("Switching on main audio, use media.buffered to schedule main fragment loading"),this.mediaBuffer=this.media;var L=this.fragCurrent;L&&(this.log("Switching to main audio track, cancel main fragment load"),L.abortRequests()),this.resetTransmuxer(),this.resetLoadingState()}else this.audioOnly&&this.resetTransmuxer();var _=this.hls;g&&_.trigger(k.Events.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:"audio"}),_.trigger(k.Events.AUDIO_TRACK_SWITCHED,{id:A})}},s.onAudioTrackSwitched=function(e,r){var g=r.id,E=!!this.hls.audioTracks[g].url;if(E){var A=this.videoBuffer;A&&this.mediaBuffer!==A&&(this.log("Switching on alternate audio, use video.buffered to schedule main fragment loading"),this.mediaBuffer=A)}this.altAudio=E,this.tick()},s.onBufferCreated=function(e,r){var g,E,A=r.tracks,L=!1;for(var _ in A){var R=A[_];if(R.id==="main"){if(E=_,g=R,_==="video"){var x=A[_];x&&(this.videoBuffer=x.buffer)}}else L=!0}L&&g?(this.log("Alternate track found, use "+E+".buffered to schedule main fragment loading"),this.mediaBuffer=g.buffer):this.mediaBuffer=this.media},s.onFragBuffered=function(e,r){var g=r.frag,E=r.part;if(!g||g.type===y.PlaylistLevelType.MAIN){if(this.fragContextChanged(g))return this.warn("Fragment "+g.sn+(E?" p: "+E.index:"")+" of level "+g.level+" finished buffering, but was aborted. state: "+this.state),void(this.state===D.State.PARSED&&(this.state=D.State.IDLE));var A=E?E.stats:g.stats;this.fragLastKbps=Math.round(8*A.total/(A.buffering.end-A.loading.first)),g.sn!=="initSegment"&&(this.fragPrevious=g),this.fragBufferedComplete(g,E)}},s.onError=function(e,r){if(r.type!==d.ErrorTypes.KEY_SYSTEM_ERROR)switch(r.details){case d.ErrorDetails.FRAG_LOAD_ERROR:case d.ErrorDetails.FRAG_LOAD_TIMEOUT:case d.ErrorDetails.FRAG_PARSING_ERROR:case d.ErrorDetails.KEY_LOAD_ERROR:case d.ErrorDetails.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(y.PlaylistLevelType.MAIN,r);break;case d.ErrorDetails.LEVEL_LOAD_ERROR:case d.ErrorDetails.LEVEL_LOAD_TIMEOUT:this.state!==D.State.ERROR&&(r.fatal?(this.warn(""+r.details),this.state=D.State.ERROR):r.levelRetry||this.state!==D.State.WAITING_LEVEL||(this.state=D.State.IDLE));break;case d.ErrorDetails.BUFFER_FULL_ERROR:if(r.parent==="main"&&(this.state===D.State.PARSING||this.state===D.State.PARSED)){var g=!0,E=this.getFwdBufferInfo(this.media,y.PlaylistLevelType.MAIN);E&&E.len>.5&&(g=!this.reduceMaxBufferLength(E.len)),g&&(this.warn("buffer full error also media.currentTime is not buffered, flush main"),this.immediateLevelSwitch()),this.resetLoadingState()}}else this.onFragmentOrKeyLoadError(y.PlaylistLevelType.MAIN,r)},s.checkBuffer=function(){var e=this.media,r=this.gapController;if(e&&r&&e.readyState){if(this.loadedmetadata||!I.BufferHelper.getBuffered(e).length){var g=this.state!==D.State.IDLE?this.fragCurrent:null;r.poll(this.lastCurrentTime,g)}this.lastCurrentTime=e.currentTime}},s.onFragLoadEmergencyAborted=function(){this.state=D.State.IDLE,this.loadedmetadata||(this.startFragRequested=!1,this.nextLoadPosition=this.startPosition),this.tickImmediate()},s.onBufferFlushed=function(e,r){var g=r.type;if(g!==p.ElementaryStreamTypes.AUDIO||this.audioOnly&&!this.altAudio){var E=(g===p.ElementaryStreamTypes.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;this.afterBufferFlushed(E,g,y.PlaylistLevelType.MAIN)}},s.onLevelsUpdated=function(e,r){this.levels=r.levels},s.swapAudioCodec=function(){this.audioCodecSwap=!this.audioCodecSwap},s.seekToStartPos=function(){var e=this.media;if(e){var r=e.currentTime,g=this.startPosition;if(g>=0&&r<g){if(e.seeking)return void this.log("could not seek to "+g+", already seeking at "+r);var E=I.BufferHelper.getBuffered(e),A=(E.length?E.start(0):0)-g;A>0&&(A<this.config.maxBufferHole||A<this.config.maxFragLookUpTolerance)&&(this.log("adjusting start position by "+A+" to match buffer start"),g+=A,this.startPosition=g),this.log("seek to target start position "+g+" from current time "+r),e.currentTime=g}}},s._getAudioCodec=function(e){var r=this.config.defaultAudioCodec||e.audioCodec;return this.audioCodecSwap&&r&&(this.log("Swapping audio codec"),r=r.indexOf("mp4a.40.5")!==-1?"mp4a.40.2":"mp4a.40.5"),r},s._loadBitrateTestFrag=function(e,r){var g=this;e.bitrateTest=!0,this._doFragLoad(e,r).then(function(E){var A=g.hls;if(E&&!g.fragContextChanged(e)){g.fragLoadError=0,g.state=D.State.IDLE,g.startFragRequested=!1,g.bitrateTest=!1;var L=e.stats;L.parsing.start=L.parsing.end=L.buffering.start=L.buffering.end=self.performance.now(),A.trigger(k.Events.FRAG_LOADED,E),e.bitrateTest=!1}})},s._handleTransmuxComplete=function(e){var r,g="main",E=this.hls,A=e.remuxResult,L=e.chunkMeta,_=this.getCurrentContext(L);if(!_)return this.warn("The loading context changed while buffering fragment "+L.sn+" of level "+L.level+". This chunk will not be buffered."),void this.resetStartWhenNotLoaded(L.level);var R=_.frag,x=_.part,C=_.level,F=A.video,O=A.text,N=A.id3,U=A.initSegment,G=C.details,B=this.altAudio?void 0:A.audio;if(!this.fragContextChanged(R)){if(this.state=D.State.PARSING,U){U.tracks&&(this._bufferInitSegment(C,U.tracks,R,L),E.trigger(k.Events.FRAG_PARSING_INIT_SEGMENT,{frag:R,id:g,tracks:U.tracks}));var H=U.initPTS,V=U.timescale;(0,w.isFiniteNumber)(H)&&(this.initPTS[R.cc]=H,E.trigger(k.Events.INIT_PTS_FOUND,{frag:R,id:g,initPTS:H,timescale:V}))}if(F&&A.independent!==!1){if(G){var K=F.startPTS,Y=F.endPTS,q=F.startDTS,X=F.endDTS;if(x)x.elementaryStreams[F.type]={startPTS:K,endPTS:Y,startDTS:q,endDTS:X};else if(F.firstKeyFrame&&F.independent&&L.id===1&&(this.couldBacktrack=!0),F.dropped&&F.independent){var W=this.getMainFwdBufferInfo();if((W?W.end:this.getLoadPosition())+this.config.maxBufferHole<(F.firstKeyFramePTS?F.firstKeyFramePTS:K)-this.config.maxBufferHole)return void this.backtrack(R);R.setElementaryStreamInfo(F.type,R.start,Y,R.start,X,!0)}R.setElementaryStreamInfo(F.type,K,Y,q,X),this.backtrackFragment&&(this.backtrackFragment=R),this.bufferFragmentData(F,R,x,L)}}else if(A.independent===!1)return void this.backtrack(R);if(B){var Q=B.startPTS,z=B.endPTS,$=B.startDTS,re=B.endDTS;x&&(x.elementaryStreams[p.ElementaryStreamTypes.AUDIO]={startPTS:Q,endPTS:z,startDTS:$,endDTS:re}),R.setElementaryStreamInfo(p.ElementaryStreamTypes.AUDIO,Q,z,$,re),this.bufferFragmentData(B,R,x,L)}if(G&&N!=null&&(r=N.samples)!==null&&r!==void 0&&r.length){var Z={id:g,frag:R,details:G,samples:N.samples};E.trigger(k.Events.FRAG_PARSING_METADATA,Z)}if(G&&O){var J={id:g,frag:R,details:G,samples:O.samples};E.trigger(k.Events.FRAG_PARSING_USERDATA,J)}}},s._bufferInitSegment=function(e,r,g,E){var A=this;if(this.state===D.State.PARSING){this.audioOnly=!!r.audio&&!r.video,this.altAudio&&!this.audioOnly&&delete r.audio;var L=r.audio,_=r.video,R=r.audiovideo;if(L){var x=e.audioCodec,C=navigator.userAgent.toLowerCase();this.audioCodecSwitch&&(x&&(x=x.indexOf("mp4a.40.5")!==-1?"mp4a.40.2":"mp4a.40.5"),L.metadata.channelCount!==1&&C.indexOf("firefox")===-1&&(x="mp4a.40.5")),C.indexOf("android")!==-1&&L.container!=="audio/mpeg"&&(x="mp4a.40.2",this.log("Android: force audio codec to "+x)),e.audioCodec&&e.audioCodec!==x&&this.log('Swapping manifest audio codec "'+e.audioCodec+'" for "'+x+'"'),L.levelCodec=x,L.id="main",this.log("Init audio buffer, container:"+L.container+", codecs[selected/level/parsed]=["+(x||"")+"/"+(e.audioCodec||"")+"/"+L.codec+"]")}_&&(_.levelCodec=e.videoCodec,_.id="main",this.log("Init video buffer, container:"+_.container+", codecs[level/parsed]=["+(e.videoCodec||"")+"/"+_.codec+"]")),R&&this.log("Init audiovideo buffer, container:"+R.container+", codecs[level/parsed]=["+(e.attrs.CODECS||"")+"/"+R.codec+"]"),this.hls.trigger(k.Events.BUFFER_CODECS,r),Object.keys(r).forEach(function(F){var O=r[F].initSegment;O!=null&&O.byteLength&&A.hls.trigger(k.Events.BUFFER_APPENDING,{type:F,data:O,frag:g,part:null,chunkMeta:E,parent:g.type})}),this.tick()}},s.getMainFwdBufferInfo=function(){return this.getFwdBufferInfo(this.mediaBuffer?this.mediaBuffer:this.media,y.PlaylistLevelType.MAIN)},s.backtrack=function(e){this.couldBacktrack=!0,this.backtrackFragment=e,this.resetTransmuxer(),this.flushBufferGap(e),this.fragmentTracker.removeFragment(e),this.fragPrevious=null,this.nextLoadPosition=e.start,this.state=D.State.IDLE},s.checkFragmentChanged=function(){var e=this.media,r=null;if(e&&e.readyState>1&&e.seeking===!1){var g=e.currentTime;if(I.BufferHelper.isBuffered(e,g)?r=this.getAppendedFrag(g):I.BufferHelper.isBuffered(e,g+.1)&&(r=this.getAppendedFrag(g+.1)),r){this.backtrackFragment=null;var E=this.fragPlaying,A=r.level;E&&r.sn===E.sn&&E.level===A&&r.urlId===E.urlId||(this.fragPlaying=r,this.hls.trigger(k.Events.FRAG_CHANGED,{frag:r}),E&&E.level===A||this.hls.trigger(k.Events.LEVEL_SWITCHED,{level:A}))}}},c=i,(l=[{key:"nextLevel",get:function(){var e=this.nextBufferedFrag;return e?e.level:-1}},{key:"currentFrag",get:function(){var e=this.media;return e?this.fragPlaying||this.getAppendedFrag(e.currentTime):null}},{key:"currentProgramDateTime",get:function(){var e=this.media;if(e){var r=e.currentTime,g=this.currentFrag;if(g&&(0,w.isFiniteNumber)(r)&&(0,w.isFiniteNumber)(g.programDateTime)){var E=g.programDateTime+1e3*(r-g.start);return new Date(E)}}return null}},{key:"currentLevel",get:function(){var e=this.currentFrag;return e?e.level:-1}},{key:"nextBufferedFrag",get:function(){var e=this.currentFrag;return e?this.followingBufferedFrag(e):null}},{key:"forceStartLoad",get:function(){return this._forceStartLoad}}])&&o(c.prototype,l),a&&o(c,a),Object.defineProperty(c,"prototype",{writable:!1}),i}(D.default)},"./src/controller/subtitle-stream-controller.ts":(j,M,b)=>{b.r(M),b.d(M,{SubtitleStreamController:()=>d});var w=b("./src/events.ts"),D=b("./src/utils/buffer-helper.ts"),P=b("./src/controller/fragment-finders.ts"),k=b("./src/utils/discontinuities.ts"),I=b("./src/controller/level-helper.ts"),T=b("./src/controller/fragment-tracker.ts"),y=b("./src/controller/base-stream-controller.ts"),p=b("./src/types/loader.ts"),S=b("./src/types/level.ts");function m(t,n){for(var u=0;u<n.length;u++){var f=n[u];f.enumerable=f.enumerable||!1,f.configurable=!0,"value"in f&&(f.writable=!0),Object.defineProperty(t,(h=f.key,i=void 0,typeof(i=function(c,l){if(typeof c!="object"||c===null)return c;var a=c[Symbol.toPrimitive];if(a!==void 0){var s=a.call(c,l||"default");if(typeof s!="object")return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return(l==="string"?String:Number)(c)}(h,"string"))=="symbol"?i:String(i)),f)}var h,i}function v(t,n){return v=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(u,f){return u.__proto__=f,u},v(t,n)}var d=function(t){var n,u;function f(a,s,e){var r;return(r=t.call(this,a,s,e,"[subtitle-stream-controller]")||this).levels=[],r.currentTrackId=-1,r.tracksBuffered=[],r.mainDetails=null,r._registerListeners(),r}u=t,(n=f).prototype=Object.create(u.prototype),n.prototype.constructor=n,v(n,u);var h,i,c,l=f.prototype;return l.onHandlerDestroying=function(){this._unregisterListeners(),this.mainDetails=null},l._registerListeners=function(){var a=this.hls;a.on(w.Events.MEDIA_ATTACHED,this.onMediaAttached,this),a.on(w.Events.MEDIA_DETACHING,this.onMediaDetaching,this),a.on(w.Events.MANIFEST_LOADING,this.onManifestLoading,this),a.on(w.Events.LEVEL_LOADED,this.onLevelLoaded,this),a.on(w.Events.ERROR,this.onError,this),a.on(w.Events.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),a.on(w.Events.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),a.on(w.Events.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),a.on(w.Events.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),a.on(w.Events.BUFFER_FLUSHING,this.onBufferFlushing,this),a.on(w.Events.FRAG_BUFFERED,this.onFragBuffered,this)},l._unregisterListeners=function(){var a=this.hls;a.off(w.Events.MEDIA_ATTACHED,this.onMediaAttached,this),a.off(w.Events.MEDIA_DETACHING,this.onMediaDetaching,this),a.off(w.Events.MANIFEST_LOADING,this.onManifestLoading,this),a.off(w.Events.LEVEL_LOADED,this.onLevelLoaded,this),a.off(w.Events.ERROR,this.onError,this),a.off(w.Events.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),a.off(w.Events.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),a.off(w.Events.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),a.off(w.Events.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),a.off(w.Events.BUFFER_FLUSHING,this.onBufferFlushing,this),a.off(w.Events.FRAG_BUFFERED,this.onFragBuffered,this)},l.startLoad=function(a){this.stopLoad(),this.state=y.State.IDLE,this.setInterval(500),this.nextLoadPosition=this.startPosition=this.lastCurrentTime=a,this.tick()},l.onManifestLoading=function(){this.mainDetails=null,this.fragmentTracker.removeAllFragments()},l.onLevelLoaded=function(a,s){this.mainDetails=s.details},l.onSubtitleFragProcessed=function(a,s){var e=s.frag,r=s.success;if(this.fragPrevious=e,this.state=y.State.IDLE,r){var g=this.tracksBuffered[this.currentTrackId];if(g){for(var E,A=e.start,L=0;L<g.length;L++)if(A>=g[L].start&&A<=g[L].end){E=g[L];break}var _=e.start+e.duration;E?E.end=_:(E={start:A,end:_},g.push(E)),this.fragmentTracker.fragBuffered(e)}}},l.onBufferFlushing=function(a,s){var e=s.startOffset,r=s.endOffset;if(e===0&&r!==Number.POSITIVE_INFINITY){var g=this.currentTrackId,E=this.levels;if(!E.length||!E[g]||!E[g].details)return;var A=r-E[g].details.targetduration;if(A<=0)return;s.endOffsetSubtitles=Math.max(0,A),this.tracksBuffered.forEach(function(L){for(var _=0;_<L.length;)if(L[_].end<=A)L.shift();else{if(!(L[_].start<A))break;L[_].start=A,_++}}),this.fragmentTracker.removeFragmentsInRange(e,A,p.PlaylistLevelType.SUBTITLE)}},l.onFragBuffered=function(a,s){var e;this.loadedmetadata||s.frag.type!==p.PlaylistLevelType.MAIN||(e=this.media)!==null&&e!==void 0&&e.buffered.length&&(this.loadedmetadata=!0)},l.onError=function(a,s){var e=s.frag;e&&e.type===p.PlaylistLevelType.SUBTITLE&&(this.fragCurrent&&this.fragCurrent.abortRequests(),this.state=y.State.IDLE)},l.onSubtitleTracksUpdated=function(a,s){var e=this,r=s.subtitleTracks;this.tracksBuffered=[],this.levels=r.map(function(g){return new S.Level(g)}),this.fragmentTracker.removeAllFragments(),this.fragPrevious=null,this.levels.forEach(function(g){e.tracksBuffered[g.id]=[]}),this.mediaBuffer=null},l.onSubtitleTrackSwitch=function(a,s){if(this.currentTrackId=s.id,this.levels.length&&this.currentTrackId!==-1){var e=this.levels[this.currentTrackId];e!=null&&e.details?this.mediaBuffer=this.mediaBufferTimeRanges:this.mediaBuffer=null,e&&this.setInterval(500)}else this.clearInterval()},l.onSubtitleTrackLoaded=function(a,s){var e,r=s.details,g=s.id,E=this.currentTrackId,A=this.levels;if(A.length){var L=A[E];if(!(g>=A.length||g!==E)&&L){this.mediaBuffer=this.mediaBufferTimeRanges;var _=0;if(r.live||(e=L.details)!==null&&e!==void 0&&e.live){var R=this.mainDetails;if(r.deltaUpdateFailed||!R)return;var x=R.fragments[0];L.details?(_=this.alignPlaylists(r,L.details))===0&&x&&(_=x.start,(0,I.addSliding)(r,_)):r.hasProgramDateTime&&R.hasProgramDateTime?((0,k.alignMediaPlaylistByPDT)(r,R),_=r.fragments[0].start):x&&(_=x.start,(0,I.addSliding)(r,_))}L.details=r,this.levelLastLoaded=g,this.startFragRequested||!this.mainDetails&&r.live||this.setStartPosition(L.details,_),this.tick(),r.live&&!this.fragCurrent&&this.media&&this.state===y.State.IDLE&&((0,P.findFragmentByPTS)(null,r.fragments,this.media.currentTime,0)||(this.warn("Subtitle playlist not aligned with playback"),L.details=void 0))}}},l._handleFragmentLoadComplete=function(a){var s=this,e=a.frag,r=a.payload,g=e.decryptdata,E=this.hls;if(!this.fragContextChanged(e)&&r&&r.byteLength>0&&g&&g.key&&g.iv&&g.method==="AES-128"){var A=performance.now();this.decrypter.decrypt(new Uint8Array(r),g.key.buffer,g.iv.buffer).then(function(L){var _=performance.now();E.trigger(w.Events.FRAG_DECRYPTED,{frag:e,payload:L,stats:{tstart:A,tdecrypt:_}})}).catch(function(L){s.warn(L.name+": "+L.message),s.state=y.State.IDLE})}},l.doTick=function(){if(this.media){if(this.state===y.State.IDLE){var a=this.currentTrackId,s=this.levels;if(!s.length||!s[a]||!s[a].details)return;var e=s[a].details,r=e.targetduration,g=this.config,E=this.getLoadPosition(),A=D.BufferHelper.bufferedInfo(this.tracksBuffered[this.currentTrackId]||[],E-r,g.maxBufferHole),L=A.end,_=A.len,R=this.getFwdBufferInfo(this.media,p.PlaylistLevelType.MAIN);if(_>this.getMaxBufferLength(R==null?void 0:R.len)+r)return;console.assert(e,"Subtitle track details are defined on idle subtitle stream controller tick");var x=e.fragments,C=x.length,F=e.edge,O=null,N=this.fragPrevious;if(L<F){var U=g.maxFragLookUpTolerance;!(O=(0,P.findFragmentByPTS)(N,x,Math.max(x[0].start,L),U))&&N&&N.start<x[0].start&&(O=x[0])}else O=x[C-1];if(!O)return;O=this.mapToInitFragWhenRequired(O),this.fragmentTracker.getState(O)===T.FragmentState.NOT_LOADED&&this.loadFragment(O,e,L)}}else this.state=y.State.IDLE},l.getMaxBufferLength=function(a){var s=t.prototype.getMaxBufferLength.call(this);return a?Math.max(s,a):s},l.loadFragment=function(a,s,e){this.fragCurrent=a,a.sn==="initSegment"?this._loadInitSegment(a,s):(this.startFragRequested=!0,t.prototype.loadFragment.call(this,a,s,e))},h=f,(i=[{key:"mediaBufferTimeRanges",get:function(){return new o(this.tracksBuffered[this.currentTrackId]||[])}}])&&m(h.prototype,i),c&&m(h,c),Object.defineProperty(h,"prototype",{writable:!1}),f}(y.default),o=function(t){this.buffered=void 0;var n=function(u,f,h){if((f>>>=0)>h-1)throw new DOMException("Failed to execute '"+u+"' on 'TimeRanges': The index provided ("+f+") is greater than the maximum bound ("+h+")");return t[f][u]};this.buffered={get length(){return t.length},end:function(u){return n("end",u,t.length)},start:function(u){return n("start",u,t.length)}}}},"./src/controller/subtitle-track-controller.ts":(j,M,b)=>{b.r(M),b.d(M,{default:()=>S});var w=b("./src/events.ts"),D=b("./src/utils/texttrack-utils.ts"),P=b("./src/controller/base-playlist-controller.ts"),k=b("./src/types/loader.ts");function I(m,v){for(var d=0;d<v.length;d++){var o=v[d];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(m,(t=o.key,n=void 0,typeof(n=function(u,f){if(typeof u!="object"||u===null)return u;var h=u[Symbol.toPrimitive];if(h!==void 0){var i=h.call(u,f||"default");if(typeof i!="object")return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return(f==="string"?String:Number)(u)}(t,"string"))=="symbol"?n:String(n)),o)}var t,n}function T(m,v){return T=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(d,o){return d.__proto__=o,d},T(m,v)}var y=function(m){var v,d;function o(h){var i;return(i=m.call(this,h,"[subtitle-track-controller]")||this).media=null,i.tracks=[],i.groupId=null,i.tracksInGroup=[],i.trackId=-1,i.selectDefaultTrack=!0,i.queuedDefaultTrack=-1,i.trackChangeListener=function(){return i.onTextTracksChanged()},i.asyncPollTrackChange=function(){return i.pollTrackChange(0)},i.useTextTrackPolling=!1,i.subtitlePollingInterval=-1,i._subtitleDisplay=!0,i.registerListeners(),i}d=m,(v=o).prototype=Object.create(d.prototype),v.prototype.constructor=v,T(v,d);var t,n,u,f=o.prototype;return f.destroy=function(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.trackChangeListener=this.asyncPollTrackChange=null,m.prototype.destroy.call(this)},f.registerListeners=function(){var h=this.hls;h.on(w.Events.MEDIA_ATTACHED,this.onMediaAttached,this),h.on(w.Events.MEDIA_DETACHING,this.onMediaDetaching,this),h.on(w.Events.MANIFEST_LOADING,this.onManifestLoading,this),h.on(w.Events.MANIFEST_PARSED,this.onManifestParsed,this),h.on(w.Events.LEVEL_LOADING,this.onLevelLoading,this),h.on(w.Events.LEVEL_SWITCHING,this.onLevelSwitching,this),h.on(w.Events.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),h.on(w.Events.ERROR,this.onError,this)},f.unregisterListeners=function(){var h=this.hls;h.off(w.Events.MEDIA_ATTACHED,this.onMediaAttached,this),h.off(w.Events.MEDIA_DETACHING,this.onMediaDetaching,this),h.off(w.Events.MANIFEST_LOADING,this.onManifestLoading,this),h.off(w.Events.MANIFEST_PARSED,this.onManifestParsed,this),h.off(w.Events.LEVEL_LOADING,this.onLevelLoading,this),h.off(w.Events.LEVEL_SWITCHING,this.onLevelSwitching,this),h.off(w.Events.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),h.off(w.Events.ERROR,this.onError,this)},f.onMediaAttached=function(h,i){this.media=i.media,this.media&&(this.queuedDefaultTrack>-1&&(this.subtitleTrack=this.queuedDefaultTrack,this.queuedDefaultTrack=-1),this.useTextTrackPolling=!(this.media.textTracks&&"onchange"in this.media.textTracks),this.useTextTrackPolling?this.pollTrackChange(500):this.media.textTracks.addEventListener("change",this.asyncPollTrackChange))},f.pollTrackChange=function(h){self.clearInterval(this.subtitlePollingInterval),this.subtitlePollingInterval=self.setInterval(this.trackChangeListener,h)},f.onMediaDetaching=function(){this.media&&(self.clearInterval(this.subtitlePollingInterval),this.useTextTrackPolling||this.media.textTracks.removeEventListener("change",this.asyncPollTrackChange),this.trackId>-1&&(this.queuedDefaultTrack=this.trackId),p(this.media.textTracks).forEach(function(h){(0,D.clearCurrentCues)(h)}),this.subtitleTrack=-1,this.media=null)},f.onManifestLoading=function(){this.tracks=[],this.groupId=null,this.tracksInGroup=[],this.trackId=-1,this.selectDefaultTrack=!0},f.onManifestParsed=function(h,i){this.tracks=i.subtitleTracks},f.onSubtitleTrackLoaded=function(h,i){var c=i.id,l=i.details,a=this.trackId,s=this.tracksInGroup[a];if(s){var e=s.details;s.details=i.details,this.log("subtitle track "+c+" loaded ["+l.startSN+"-"+l.endSN+"]"),c===this.trackId&&(this.retryCount=0,this.playlistLoaded(c,i,e))}else this.warn("Invalid subtitle track id "+c)},f.onLevelLoading=function(h,i){this.switchLevel(i.level)},f.onLevelSwitching=function(h,i){this.switchLevel(i.level)},f.switchLevel=function(h){var i=this.hls.levels[h];if(i!=null&&i.textGroupIds){var c=i.textGroupIds[i.urlId];if(this.groupId!==c){var l=this.tracksInGroup?this.tracksInGroup[this.trackId]:void 0,a=this.tracks.filter(function(r){return!c||r.groupId===c});this.tracksInGroup=a;var s=this.findTrackId(l==null?void 0:l.name)||this.findTrackId();this.groupId=c;var e={subtitleTracks:a};this.log("Updating subtitle tracks, "+a.length+' track(s) found in "'+c+'" group-id'),this.hls.trigger(w.Events.SUBTITLE_TRACKS_UPDATED,e),s!==-1&&this.setSubtitleTrack(s,l)}}},f.findTrackId=function(h){for(var i=this.tracksInGroup,c=0;c<i.length;c++){var l=i[c];if((!this.selectDefaultTrack||l.default)&&(!h||h===l.name))return l.id}return-1},f.onError=function(h,i){m.prototype.onError.call(this,h,i),!i.fatal&&i.context&&i.context.type===k.PlaylistContextType.SUBTITLE_TRACK&&i.context.id===this.trackId&&i.context.groupId===this.groupId&&this.retryLoadingOrFail(i)},f.loadPlaylist=function(h){m.prototype.loadPlaylist.call(this);var i=this.tracksInGroup[this.trackId];if(this.shouldLoadTrack(i)){var c=i.id,l=i.groupId,a=i.url;if(h)try{a=h.addDirectives(a)}catch(s){this.warn("Could not construct new URL with HLS Delivery Directives: "+s)}this.log("Loading subtitle playlist for id "+c),this.hls.trigger(w.Events.SUBTITLE_TRACK_LOADING,{url:a,id:c,groupId:l,deliveryDirectives:h||null})}},f.toggleTrackModes=function(h){var i=this,c=this.media,l=this.trackId;if(c){var a=p(c.textTracks),s=a.filter(function(g){return g.groupId===i.groupId});if(h===-1)[].slice.call(a).forEach(function(g){g.mode="disabled"});else{var e=s[l];e&&(e.mode="disabled")}var r=s[h];r&&(r.mode=this.subtitleDisplay?"showing":"hidden")}},f.setSubtitleTrack=function(h,i){var c,l=this.tracksInGroup;if(this.media){if(this.trackId!==h&&this.toggleTrackModes(h),!(this.trackId===h&&(h===-1||(c=l[h])!==null&&c!==void 0&&c.details)||h<-1||h>=l.length)){this.clearTimer();var a=l[h];if(this.log("Switching to subtitle track "+h),this.trackId=h,a){var s=a.id,e=a.groupId,r=e===void 0?"":e,g=a.name,E=a.type,A=a.url;this.hls.trigger(w.Events.SUBTITLE_TRACK_SWITCH,{id:s,groupId:r,name:g,type:E,url:A});var L=this.switchParams(a.url,i==null?void 0:i.details);this.loadPlaylist(L)}else this.hls.trigger(w.Events.SUBTITLE_TRACK_SWITCH,{id:h})}}else this.queuedDefaultTrack=h},f.onTextTracksChanged=function(){if(this.useTextTrackPolling||self.clearInterval(this.subtitlePollingInterval),this.media&&this.hls.config.renderTextTracksNatively){for(var h=-1,i=p(this.media.textTracks),c=0;c<i.length;c++)if(i[c].mode==="hidden")h=c;else if(i[c].mode==="showing"){h=c;break}this.subtitleTrack!==h&&(this.subtitleTrack=h)}},t=o,(n=[{key:"subtitleDisplay",get:function(){return this._subtitleDisplay},set:function(h){this._subtitleDisplay=h,this.trackId>-1&&this.toggleTrackModes(this.trackId)}},{key:"subtitleTracks",get:function(){return this.tracksInGroup}},{key:"subtitleTrack",get:function(){return this.trackId},set:function(h){this.selectDefaultTrack=!1;var i=this.tracksInGroup?this.tracksInGroup[this.trackId]:void 0;this.setSubtitleTrack(h,i)}}])&&I(t.prototype,n),u&&I(t,u),Object.defineProperty(t,"prototype",{writable:!1}),o}(P.default);function p(m){for(var v=[],d=0;d<m.length;d++){var o=m[d];o.kind!=="subtitles"&&o.kind!=="captions"||!o.label||v.push(m[d])}return v}const S=y},"./src/controller/timeline-controller.ts":(j,M,b)=>{b.r(M),b.d(M,{TimelineController:()=>v});var w=b("./src/polyfills/number.ts"),D=b("./src/events.ts"),P=b("./src/utils/cea-608-parser.ts"),k=b("./src/utils/output-filter.ts"),I=b("./src/utils/webvtt-parser.ts"),T=b("./src/utils/texttrack-utils.ts"),y=b("./src/utils/imsc1-ttml-parser.ts"),p=b("./src/utils/mp4-tools.ts"),S=b("./src/types/loader.ts"),m=b("./src/utils/logger.ts"),v=function(){function o(n){if(this.hls=void 0,this.media=null,this.config=void 0,this.enabled=!0,this.Cues=void 0,this.textTracks=[],this.tracks=[],this.initPTS=[],this.timescale=[],this.unparsedVttFrags=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.cea608Parser1=void 0,this.cea608Parser2=void 0,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs={ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}},this.captionsProperties=void 0,this.hls=n,this.config=n.config,this.Cues=n.config.cueHandler,this.captionsProperties={textTrack1:{label:this.config.captionsTextTrack1Label,languageCode:this.config.captionsTextTrack1LanguageCode},textTrack2:{label:this.config.captionsTextTrack2Label,languageCode:this.config.captionsTextTrack2LanguageCode},textTrack3:{label:this.config.captionsTextTrack3Label,languageCode:this.config.captionsTextTrack3LanguageCode},textTrack4:{label:this.config.captionsTextTrack4Label,languageCode:this.config.captionsTextTrack4LanguageCode}},this.config.enableCEA708Captions){var u=new k.default(this,"textTrack1"),f=new k.default(this,"textTrack2"),h=new k.default(this,"textTrack3"),i=new k.default(this,"textTrack4");this.cea608Parser1=new P.default(1,u,f),this.cea608Parser2=new P.default(3,h,i)}n.on(D.Events.MEDIA_ATTACHING,this.onMediaAttaching,this),n.on(D.Events.MEDIA_DETACHING,this.onMediaDetaching,this),n.on(D.Events.MANIFEST_LOADING,this.onManifestLoading,this),n.on(D.Events.MANIFEST_LOADED,this.onManifestLoaded,this),n.on(D.Events.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),n.on(D.Events.FRAG_LOADING,this.onFragLoading,this),n.on(D.Events.FRAG_LOADED,this.onFragLoaded,this),n.on(D.Events.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),n.on(D.Events.FRAG_DECRYPTED,this.onFragDecrypted,this),n.on(D.Events.INIT_PTS_FOUND,this.onInitPtsFound,this),n.on(D.Events.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),n.on(D.Events.BUFFER_FLUSHING,this.onBufferFlushing,this)}var t=o.prototype;return t.destroy=function(){var n=this.hls;n.off(D.Events.MEDIA_ATTACHING,this.onMediaAttaching,this),n.off(D.Events.MEDIA_DETACHING,this.onMediaDetaching,this),n.off(D.Events.MANIFEST_LOADING,this.onManifestLoading,this),n.off(D.Events.MANIFEST_LOADED,this.onManifestLoaded,this),n.off(D.Events.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),n.off(D.Events.FRAG_LOADING,this.onFragLoading,this),n.off(D.Events.FRAG_LOADED,this.onFragLoaded,this),n.off(D.Events.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),n.off(D.Events.FRAG_DECRYPTED,this.onFragDecrypted,this),n.off(D.Events.INIT_PTS_FOUND,this.onInitPtsFound,this),n.off(D.Events.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),n.off(D.Events.BUFFER_FLUSHING,this.onBufferFlushing,this),this.hls=this.config=this.cea608Parser1=this.cea608Parser2=null},t.addCues=function(n,u,f,h,i){for(var c,l,a,s,e=!1,r=i.length;r--;){var g=i[r],E=(c=g[0],l=g[1],a=u,s=f,Math.min(l,s)-Math.max(c,a));if(E>=0&&(g[0]=Math.min(g[0],u),g[1]=Math.max(g[1],f),e=!0,E/(f-u)>.5))return}if(e||i.push([u,f]),this.config.renderTextTracksNatively){var A=this.captionsTracks[n];this.Cues.newCue(A,u,f,h)}else{var L=this.Cues.newCue(null,u,f,h);this.hls.trigger(D.Events.CUES_PARSED,{type:"captions",cues:L,track:n})}},t.onInitPtsFound=function(n,u){var f=this,h=u.frag,i=u.id,c=u.initPTS,l=u.timescale,a=this.unparsedVttFrags;i==="main"&&(this.initPTS[h.cc]=c,this.timescale[h.cc]=l),a.length&&(this.unparsedVttFrags=[],a.forEach(function(s){f.onFragLoaded(D.Events.FRAG_LOADED,s)}))},t.getExistingTrack=function(n){var u=this.media;if(u)for(var f=0;f<u.textTracks.length;f++){var h=u.textTracks[f];if(h[n])return h}return null},t.createCaptionsTrack=function(n){this.config.renderTextTracksNatively?this.createNativeTrack(n):this.createNonNativeTrack(n)},t.createNativeTrack=function(n){if(!this.captionsTracks[n]){var u=this.captionsProperties,f=this.captionsTracks,h=this.media,i=u[n],c=i.label,l=i.languageCode,a=this.getExistingTrack(n);if(a)f[n]=a,(0,T.clearCurrentCues)(f[n]),(0,T.sendAddTrackEvent)(f[n],h);else{var s=this.createTextTrack("captions",c,l);s&&(s[n]=!0,f[n]=s)}}},t.createNonNativeTrack=function(n){if(!this.nonNativeCaptionsTracks[n]){var u=this.captionsProperties[n];if(u){var f={_id:n,label:u.label,kind:"captions",default:!!u.media&&!!u.media.default,closedCaptions:u.media};this.nonNativeCaptionsTracks[n]=f,this.hls.trigger(D.Events.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:[f]})}}},t.createTextTrack=function(n,u,f){var h=this.media;if(h)return h.addTextTrack(n,u,f)},t.onMediaAttaching=function(n,u){this.media=u.media,this._cleanTracks()},t.onMediaDetaching=function(){var n=this.captionsTracks;Object.keys(n).forEach(function(u){(0,T.clearCurrentCues)(n[u]),delete n[u]}),this.nonNativeCaptionsTracks={}},t.onManifestLoading=function(){this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs={ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}},this._cleanTracks(),this.tracks=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.textTracks=[],this.unparsedVttFrags=this.unparsedVttFrags||[],this.initPTS=[],this.timescale=[],this.cea608Parser1&&this.cea608Parser2&&(this.cea608Parser1.reset(),this.cea608Parser2.reset())},t._cleanTracks=function(){var n=this.media;if(n){var u=n.textTracks;if(u)for(var f=0;f<u.length;f++)(0,T.clearCurrentCues)(u[f])}},t.onSubtitleTracksUpdated=function(n,u){var f=this;this.textTracks=[];var h=u.subtitleTracks||[],i=h.some(function(s){return s.textCodec===y.IMSC1_CODEC});if(this.config.enableWebVTT||i&&this.config.enableIMSC1){var c=this.tracks&&h&&this.tracks.length===h.length;if(this.tracks=h||[],this.config.renderTextTracksNatively){var l=this.media?this.media.textTracks:[];this.tracks.forEach(function(s,e){var r;if(e<l.length){for(var g=null,E=0;E<l.length;E++)if(d(l[E],s)){g=l[E];break}g&&(r=g)}if(r)(0,T.clearCurrentCues)(r);else{var A=f._captionsOrSubtitlesFromCharacteristics(s);(r=f.createTextTrack(A,s.name,s.lang))&&(r.mode="disabled")}r&&(r.groupId=s.groupId,f.textTracks.push(r))})}else if(!c&&this.tracks&&this.tracks.length){var a=this.tracks.map(function(s){return{label:s.name,kind:s.type.toLowerCase(),default:s.default,subtitleTrack:s}});this.hls.trigger(D.Events.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:a})}}},t._captionsOrSubtitlesFromCharacteristics=function(n){var u;if((u=n.attrs)!==null&&u!==void 0&&u.CHARACTERISTICS){var f=/transcribes-spoken-dialog/gi.test(n.attrs.CHARACTERISTICS),h=/describes-music-and-sound/gi.test(n.attrs.CHARACTERISTICS);if(f&&h)return"captions"}return"subtitles"},t.onManifestLoaded=function(n,u){var f=this;this.config.enableCEA708Captions&&u.captions&&u.captions.forEach(function(h){var i=/(?:CC|SERVICE)([1-4])/.exec(h.instreamId);if(i){var c="textTrack"+i[1],l=f.captionsProperties[c];l&&(l.label=h.name,h.lang&&(l.languageCode=h.lang),l.media=h)}})},t.closedCaptionsForLevel=function(n){var u=this.hls.levels[n.level];return u==null?void 0:u.attrs["CLOSED-CAPTIONS"]},t.onFragLoading=function(n,u){var f=this.cea608Parser1,h=this.cea608Parser2,i=this.lastSn,c=this.lastPartIndex;if(this.enabled&&f&&h&&u.frag.type===S.PlaylistLevelType.MAIN){var l,a,s=u.frag.sn,e=(l=u==null||(a=u.part)===null||a===void 0?void 0:a.index)!=null?l:-1;s===i+1||s===i&&e===c+1||(f.reset(),h.reset()),this.lastSn=s,this.lastPartIndex=e}},t.onFragLoaded=function(n,u){var f=u.frag,h=u.payload,i=this.initPTS,c=this.unparsedVttFrags;if(f.type===S.PlaylistLevelType.SUBTITLE)if(h.byteLength){if(!(0,w.isFiniteNumber)(i[f.cc]))return c.push(u),void(i.length&&this.hls.trigger(D.Events.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:f,error:new Error("Missing initial subtitle PTS")}));var l=f.decryptdata,a="stats"in u;if(l==null||!l.encrypted||a){var s=this.tracks[f.level],e=this.vttCCs;e[f.cc]||(e[f.cc]={start:f.start,prevCC:this.prevCC,new:!0},this.prevCC=f.cc),s&&s.textCodec===y.IMSC1_CODEC?this._parseIMSC1(f,h):this._parseVTTs(f,h,e)}}else this.hls.trigger(D.Events.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:f,error:new Error("Empty subtitle payload")})},t._parseIMSC1=function(n,u){var f=this,h=this.hls;(0,y.parseIMSC1)(u,this.initPTS[n.cc],this.timescale[n.cc],function(i){f._appendCues(i,n.level),h.trigger(D.Events.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:n})},function(i){m.logger.log("Failed to parse IMSC1: "+i),h.trigger(D.Events.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:n,error:i})})},t._parseVTTs=function(n,u,f){var h,i=this,c=this.hls,l=(h=n.initSegment)!==null&&h!==void 0&&h.data?(0,p.appendUint8Array)(n.initSegment.data,new Uint8Array(u)):u;(0,I.parseWebVTT)(l,this.initPTS[n.cc],this.timescale[n.cc],f,n.cc,n.start,function(a){i._appendCues(a,n.level),c.trigger(D.Events.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:n})},function(a){i._fallbackToIMSC1(n,u),m.logger.log("Failed to parse VTT cue: "+a),c.trigger(D.Events.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:n,error:a})})},t._fallbackToIMSC1=function(n,u){var f=this,h=this.tracks[n.level];h.textCodec||(0,y.parseIMSC1)(u,this.initPTS[n.cc],this.timescale[n.cc],function(){h.textCodec=y.IMSC1_CODEC,f._parseIMSC1(n,u)},function(){h.textCodec="wvtt"})},t._appendCues=function(n,u){var f=this.hls;if(this.config.renderTextTracksNatively){var h=this.textTracks[u];if(!h||h.mode==="disabled")return;n.forEach(function(l){return(0,T.addCueToTrack)(h,l)})}else{var i=this.tracks[u];if(!i)return;var c=i.default?"default":"subtitles"+u;f.trigger(D.Events.CUES_PARSED,{type:"subtitles",cues:n,track:c})}},t.onFragDecrypted=function(n,u){var f=u.frag;if(f.type===S.PlaylistLevelType.SUBTITLE){if(!(0,w.isFiniteNumber)(this.initPTS[f.cc]))return void this.unparsedVttFrags.push(u);this.onFragLoaded(D.Events.FRAG_LOADED,u)}},t.onSubtitleTracksCleared=function(){this.tracks=[],this.captionsTracks={}},t.onFragParsingUserdata=function(n,u){var f=this.cea608Parser1,h=this.cea608Parser2;if(this.enabled&&f&&h){var i=u.frag,c=u.samples;if(i.type!==S.PlaylistLevelType.MAIN||this.closedCaptionsForLevel(i)!=="NONE")for(var l=0;l<c.length;l++){var a=c[l].bytes;if(a){var s=this.extractCea608Data(a);f.addData(c[l].pts,s[0]),h.addData(c[l].pts,s[1])}}}},t.onBufferFlushing=function(n,u){var f=u.startOffset,h=u.endOffset,i=u.endOffsetSubtitles,c=u.type,l=this.media;if(l&&!(l.currentTime<h)){if(!c||c==="video"){var a=this.captionsTracks;Object.keys(a).forEach(function(e){return(0,T.removeCuesInRange)(a[e],f,h)})}if(this.config.renderTextTracksNatively&&f===0&&i!==void 0){var s=this.textTracks;Object.keys(s).forEach(function(e){return(0,T.removeCuesInRange)(s[e],f,i)})}}},t.extractCea608Data=function(n){for(var u=[[],[]],f=31&n[0],h=2,i=0;i<f;i++){var c=n[h++],l=127&n[h++],a=127&n[h++];if((l!==0||a!==0)&&4&c){var s=3&c;s!==0&&s!==1||(u[s].push(l),u[s].push(a))}}return u},o}();function d(o,t){return o&&o.label===t.name&&!(o.textTrack1||o.textTrack2)}},"./src/crypt/aes-crypto.ts":(j,M,b)=>{b.r(M),b.d(M,{default:()=>w});var w=function(){function D(P,k){this.subtle=void 0,this.aesIV=void 0,this.subtle=P,this.aesIV=k}return D.prototype.decrypt=function(P,k){return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},k,P)},D}()},"./src/crypt/aes-decryptor.ts":(j,M,b)=>{b.r(M),b.d(M,{default:()=>P,removePadding:()=>D});var w=b("./src/utils/typed-array.ts");function D(k){var I=k.byteLength,T=I&&new DataView(k.buffer).getUint8(I-1);return T?(0,w.sliceUint8)(k,0,I-T):k}var P=function(){function k(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.ksRows=0,this.keySize=0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.initTable()}var I=k.prototype;return I.uint8ArrayToUint32Array_=function(T){for(var y=new DataView(T),p=new Uint32Array(4),S=0;S<4;S++)p[S]=y.getUint32(4*S);return p},I.initTable=function(){var T=this.sBox,y=this.invSBox,p=this.subMix,S=p[0],m=p[1],v=p[2],d=p[3],o=this.invSubMix,t=o[0],n=o[1],u=o[2],f=o[3],h=new Uint32Array(256),i=0,c=0,l=0;for(l=0;l<256;l++)h[l]=l<128?l<<1:l<<1^283;for(l=0;l<256;l++){var a=c^c<<1^c<<2^c<<3^c<<4;a=a>>>8^255&a^99,T[i]=a,y[a]=i;var s=h[i],e=h[s],r=h[e],g=257*h[a]^16843008*a;S[i]=g<<24|g>>>8,m[i]=g<<16|g>>>16,v[i]=g<<8|g>>>24,d[i]=g,g=16843009*r^65537*e^257*s^16843008*i,t[a]=g<<24|g>>>8,n[a]=g<<16|g>>>16,u[a]=g<<8|g>>>24,f[a]=g,i?(i=s^h[h[h[r^s]]],c^=h[h[c]]):i=c=1}},I.expandKey=function(T){for(var y=this.uint8ArrayToUint32Array_(T),p=!0,S=0;S<y.length&&p;)p=y[S]===this.key[S],S++;if(!p){this.key=y;var m=this.keySize=y.length;if(m!==4&&m!==6&&m!==8)throw new Error("Invalid aes key size="+m);var v,d,o,t,n=this.ksRows=4*(m+6+1),u=this.keySchedule=new Uint32Array(n),f=this.invKeySchedule=new Uint32Array(n),h=this.sBox,i=this.rcon,c=this.invSubMix,l=c[0],a=c[1],s=c[2],e=c[3];for(v=0;v<n;v++)v<m?o=u[v]=y[v]:(t=o,v%m==0?(t=h[(t=t<<8|t>>>24)>>>24]<<24|h[t>>>16&255]<<16|h[t>>>8&255]<<8|h[255&t],t^=i[v/m|0]<<24):m>6&&v%m==4&&(t=h[t>>>24]<<24|h[t>>>16&255]<<16|h[t>>>8&255]<<8|h[255&t]),u[v]=o=(u[v-m]^t)>>>0);for(d=0;d<n;d++)v=n-d,t=3&d?u[v]:u[v-4],f[d]=d<4||v<=4?t:l[h[t>>>24]]^a[h[t>>>16&255]]^s[h[t>>>8&255]]^e[h[255&t]],f[d]=f[d]>>>0}},I.networkToHostOrderSwap=function(T){return T<<24|(65280&T)<<8|(16711680&T)>>8|T>>>24},I.decrypt=function(T,y,p){for(var S,m,v,d,o,t,n,u,f,h,i,c,l,a,s=this.keySize+6,e=this.invKeySchedule,r=this.invSBox,g=this.invSubMix,E=g[0],A=g[1],L=g[2],_=g[3],R=this.uint8ArrayToUint32Array_(p),x=R[0],C=R[1],F=R[2],O=R[3],N=new Int32Array(T),U=new Int32Array(N.length),G=this.networkToHostOrderSwap;y<N.length;){for(f=G(N[y]),h=G(N[y+1]),i=G(N[y+2]),c=G(N[y+3]),o=f^e[0],t=c^e[1],n=i^e[2],u=h^e[3],l=4,a=1;a<s;a++)S=E[o>>>24]^A[t>>16&255]^L[n>>8&255]^_[255&u]^e[l],m=E[t>>>24]^A[n>>16&255]^L[u>>8&255]^_[255&o]^e[l+1],v=E[n>>>24]^A[u>>16&255]^L[o>>8&255]^_[255&t]^e[l+2],d=E[u>>>24]^A[o>>16&255]^L[t>>8&255]^_[255&n]^e[l+3],o=S,t=m,n=v,u=d,l+=4;S=r[o>>>24]<<24^r[t>>16&255]<<16^r[n>>8&255]<<8^r[255&u]^e[l],m=r[t>>>24]<<24^r[n>>16&255]<<16^r[u>>8&255]<<8^r[255&o]^e[l+1],v=r[n>>>24]<<24^r[u>>16&255]<<16^r[o>>8&255]<<8^r[255&t]^e[l+2],d=r[u>>>24]<<24^r[o>>16&255]<<16^r[t>>8&255]<<8^r[255&n]^e[l+3],U[y]=G(S^x),U[y+1]=G(d^C),U[y+2]=G(v^F),U[y+3]=G(m^O),x=f,C=h,F=i,O=c,y+=4}return U.buffer},k}()},"./src/crypt/decrypter.ts":(j,M,b)=>{b.r(M),b.d(M,{default:()=>y});var w=b("./src/crypt/aes-crypto.ts"),D=b("./src/crypt/fast-aes-key.ts"),P=b("./src/crypt/aes-decryptor.ts"),k=b("./src/utils/logger.ts"),I=b("./src/utils/mp4-tools.ts"),T=b("./src/utils/typed-array.ts"),y=function(){function p(m,v){var d=(v===void 0?{}:v).removePKCS7Padding,o=d===void 0||d;if(this.logEnabled=!0,this.removePKCS7Padding=void 0,this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null,this.useSoftware=void 0,this.useSoftware=m.enableSoftwareAES,this.removePKCS7Padding=o,o)try{var t=self.crypto;t&&(this.subtle=t.subtle||t.webkitSubtle)}catch{}this.subtle===null&&(this.useSoftware=!0)}var S=p.prototype;return S.destroy=function(){this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null},S.isSync=function(){return this.useSoftware},S.flush=function(){var m=this.currentResult,v=this.remainderData;if(!m||v)return this.reset(),null;var d=new Uint8Array(m);return this.reset(),this.removePKCS7Padding?(0,P.removePadding)(d):d},S.reset=function(){this.currentResult=null,this.currentIV=null,this.remainderData=null,this.softwareDecrypter&&(this.softwareDecrypter=null)},S.decrypt=function(m,v,d){var o=this;return this.useSoftware?new Promise(function(t,n){o.softwareDecrypt(new Uint8Array(m),v,d);var u=o.flush();u?t(u.buffer):n(new Error("[softwareDecrypt] Failed to decrypt data"))}):this.webCryptoDecrypt(new Uint8Array(m),v,d)},S.softwareDecrypt=function(m,v,d){var o=this.currentIV,t=this.currentResult,n=this.remainderData;this.logOnce("JS AES decrypt"),n&&(m=(0,I.appendUint8Array)(n,m),this.remainderData=null);var u=this.getValidChunk(m);if(!u.length)return null;o&&(d=o);var f=this.softwareDecrypter;f||(f=this.softwareDecrypter=new P.default),f.expandKey(v);var h=t;return this.currentResult=f.decrypt(u.buffer,0,d),this.currentIV=(0,T.sliceUint8)(u,-16).buffer,h||null},S.webCryptoDecrypt=function(m,v,d){var o=this,t=this.subtle;return this.key===v&&this.fastAesKey||(this.key=v,this.fastAesKey=new D.default(t,v)),this.fastAesKey.expandKey().then(function(n){return t?(o.logOnce("WebCrypto AES decrypt"),new w.default(t,new Uint8Array(d)).decrypt(m.buffer,n)):Promise.reject(new Error("web crypto not initialized"))}).catch(function(n){return k.logger.warn("[decrypter]: WebCrypto Error, disable WebCrypto API, "+n.name+": "+n.message),o.onWebCryptoError(m,v,d)})},S.onWebCryptoError=function(m,v,d){this.useSoftware=!0,this.logEnabled=!0,this.softwareDecrypt(m,v,d);var o=this.flush();if(o)return o.buffer;throw new Error("WebCrypto and softwareDecrypt: failed to decrypt data")},S.getValidChunk=function(m){var v=m,d=m.length-m.length%16;return d!==m.length&&(v=(0,T.sliceUint8)(m,0,d),this.remainderData=(0,T.sliceUint8)(m,d)),v},S.logOnce=function(m){this.logEnabled&&(k.logger.log("[decrypter]: "+m),this.logEnabled=!1)},p}()},"./src/crypt/fast-aes-key.ts":(j,M,b)=>{b.r(M),b.d(M,{default:()=>w});var w=function(){function D(P,k){this.subtle=void 0,this.key=void 0,this.subtle=P,this.key=k}return D.prototype.expandKey=function(){return this.subtle.importKey("raw",this.key,{name:"AES-CBC"},!1,["encrypt","decrypt"])},D}()},"./src/demux/aacdemuxer.ts":(j,M,b)=>{b.r(M),b.d(M,{default:()=>T});var w=b("./src/demux/base-audio-demuxer.ts"),D=b("./src/demux/adts.ts"),P=b("./src/utils/logger.ts"),k=b("./src/demux/id3.ts");function I(y,p){return I=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(S,m){return S.__proto__=m,S},I(y,p)}const T=function(y){var p,S;function m(d,o){var t;return(t=y.call(this)||this).observer=void 0,t.config=void 0,t.observer=d,t.config=o,t}S=y,(p=m).prototype=Object.create(S.prototype),p.prototype.constructor=p,I(p,S);var v=m.prototype;return v.resetInitSegment=function(d,o,t,n){y.prototype.resetInitSegment.call(this,d,o,t,n),this._audioTrack={container:"audio/adts",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"aac",samples:[],manifestCodec:o,duration:n,inputTimeScale:9e4,dropped:0}},m.probe=function(d){if(!d)return!1;for(var o=(k.getID3Data(d,0)||[]).length,t=d.length;o<t;o++)if(D.probe(d,o))return P.logger.log("ADTS sync word found !"),!0;return!1},v.canParse=function(d,o){return D.canParse(d,o)},v.appendFrame=function(d,o,t){D.initTrackConfig(d,this.observer,o,t,d.manifestCodec);var n=D.appendFrame(d,o,t,this.basePTS,this.frameIndex);if(n&&n.missing===0)return n},m}(w.default)},"./src/demux/adts.ts":(j,M,b)=>{b.r(M),b.d(M,{appendFrame:()=>n,canGetFrameLength:()=>p,canParse:()=>m,getAudioConfig:()=>k,getFrameDuration:()=>o,getFullFrameLength:()=>y,getHeaderLength:()=>T,initTrackConfig:()=>d,isHeader:()=>S,isHeaderPattern:()=>I,parseFrameHeader:()=>t,probe:()=>v});var w=b("./src/utils/logger.ts"),D=b("./src/errors.ts"),P=b("./src/events.ts");function k(u,f,h,i){var c,l,a,s,e=navigator.userAgent.toLowerCase(),r=i,g=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];c=1+((192&f[h+2])>>>6);var E=(60&f[h+2])>>>2;if(!(E>g.length-1))return a=(1&f[h+2])<<2,a|=(192&f[h+3])>>>6,w.logger.log("manifest codec:"+i+", ADTS type:"+c+", samplingIndex:"+E),/firefox/i.test(e)?E>=6?(c=5,s=new Array(4),l=E-3):(c=2,s=new Array(2),l=E):e.indexOf("android")!==-1?(c=2,s=new Array(2),l=E):(c=5,s=new Array(4),i&&(i.indexOf("mp4a.40.29")!==-1||i.indexOf("mp4a.40.5")!==-1)||!i&&E>=6?l=E-3:((i&&i.indexOf("mp4a.40.2")!==-1&&(E>=6&&a===1||/vivaldi/i.test(e))||!i&&a===1)&&(c=2,s=new Array(2)),l=E)),s[0]=c<<3,s[0]|=(14&E)>>1,s[1]|=(1&E)<<7,s[1]|=a<<3,c===5&&(s[1]|=(14&l)>>1,s[2]=(1&l)<<7,s[2]|=8,s[3]=0),{config:s,samplerate:g[E],channelCount:a,codec:"mp4a.40."+c,manifestCodec:r};u.trigger(P.Events.ERROR,{type:D.ErrorTypes.MEDIA_ERROR,details:D.ErrorDetails.FRAG_PARSING_ERROR,fatal:!0,reason:"invalid ADTS sampling index:"+E})}function I(u,f){return u[f]===255&&(246&u[f+1])==240}function T(u,f){return 1&u[f+1]?7:9}function y(u,f){return(3&u[f+3])<<11|u[f+4]<<3|(224&u[f+5])>>>5}function p(u,f){return f+5<u.length}function S(u,f){return f+1<u.length&&I(u,f)}function m(u,f){return p(u,f)&&I(u,f)&&y(u,f)<=u.length-f}function v(u,f){if(S(u,f)){var h=T(u,f);if(f+h>=u.length)return!1;var i=y(u,f);if(i<=h)return!1;var c=f+i;return c===u.length||S(u,c)}return!1}function d(u,f,h,i,c){if(!u.samplerate){var l=k(f,h,i,c);if(!l)return;u.config=l.config,u.samplerate=l.samplerate,u.channelCount=l.channelCount,u.codec=l.codec,u.manifestCodec=l.manifestCodec,w.logger.log("parsed codec:"+u.codec+", rate:"+l.samplerate+", channels:"+l.channelCount)}}function o(u){return 9216e4/u}function t(u,f){var h=T(u,f);if(f+h<=u.length){var i=y(u,f)-h;if(i>0)return{headerLength:h,frameLength:i}}}function n(u,f,h,i,c){var l,a=i+c*o(u.samplerate),s=t(f,h);if(s){var e=s.frameLength,r=s.headerLength,g=r+e,E=Math.max(0,h+g-f.length);E?(l=new Uint8Array(g-r)).set(f.subarray(h+r,f.length),0):l=f.subarray(h+r,h+g);var A={unit:l,pts:a};return E||u.samples.push(A),{sample:A,length:g,missing:E}}var L=f.length-h;return(l=new Uint8Array(L)).set(f.subarray(h,f.length),0),{sample:{unit:l,pts:a},length:L,missing:-1}}},"./src/demux/base-audio-demuxer.ts":(j,M,b)=>{b.r(M),b.d(M,{default:()=>S,initPTSFn:()=>p});var w=b("./src/polyfills/number.ts"),D=b("./src/demux/id3.ts"),P=b("./src/types/demuxer.ts"),k=b("./src/demux/dummy-demuxed-track.ts"),I=b("./src/utils/mp4-tools.ts"),T=b("./src/utils/typed-array.ts"),y=function(){function m(){this._audioTrack=void 0,this._id3Track=void 0,this.frameIndex=0,this.cachedData=null,this.basePTS=null,this.initPTS=null,this.lastPTS=null}var v=m.prototype;return v.resetInitSegment=function(d,o,t,n){this._id3Track={type:"id3",id:3,pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0}},v.resetTimeStamp=function(d){this.initPTS=d,this.resetContiguity()},v.resetContiguity=function(){this.basePTS=null,this.lastPTS=null,this.frameIndex=0},v.canParse=function(d,o){return!1},v.appendFrame=function(d,o,t){},v.demux=function(d,o){this.cachedData&&(d=(0,I.appendUint8Array)(this.cachedData,d),this.cachedData=null);var t,n=D.getID3Data(d,0),u=n?n.length:0,f=this._audioTrack,h=this._id3Track,i=n?D.getTimeStamp(n):void 0,c=d.length;for((this.basePTS===null||this.frameIndex===0&&(0,w.isFiniteNumber)(i))&&(this.basePTS=p(i,o,this.initPTS),this.lastPTS=this.basePTS),this.lastPTS===null&&(this.lastPTS=this.basePTS),n&&n.length>0&&h.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:n,type:P.MetadataSchema.audioId3,duration:Number.POSITIVE_INFINITY});u<c;){if(this.canParse(d,u)){var l=this.appendFrame(f,d,u);l?(this.frameIndex++,this.lastPTS=l.sample.pts,t=u+=l.length):u=c}else D.canParse(d,u)?(n=D.getID3Data(d,u),h.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:n,type:P.MetadataSchema.audioId3,duration:Number.POSITIVE_INFINITY}),t=u+=n.length):u++;if(u===c&&t!==c){var a=(0,T.sliceUint8)(d,t);this.cachedData?this.cachedData=(0,I.appendUint8Array)(this.cachedData,a):this.cachedData=a}}return{audioTrack:f,videoTrack:(0,k.dummyTrack)(),id3Track:h,textTrack:(0,k.dummyTrack)()}},v.demuxSampleAes=function(d,o,t){return Promise.reject(new Error("["+this+"] This demuxer does not support Sample-AES decryption"))},v.flush=function(d){var o=this.cachedData;return o&&(this.cachedData=null,this.demux(o,0)),{audioTrack:this._audioTrack,videoTrack:(0,k.dummyTrack)(),id3Track:this._id3Track,textTrack:(0,k.dummyTrack)()}},v.destroy=function(){},m}(),p=function(m,v,d){return(0,w.isFiniteNumber)(m)?90*m:9e4*v+(d||0)};const S=y},"./src/demux/chunk-cache.ts":(j,M,b)=>{b.r(M),b.d(M,{default:()=>w});var w=function(){function D(){this.chunks=[],this.dataLength=0}var P=D.prototype;return P.push=function(k){this.chunks.push(k),this.dataLength+=k.length},P.flush=function(){var k,I=this.chunks,T=this.dataLength;return I.length?(k=I.length===1?I[0]:function(y,p){for(var S=new Uint8Array(p),m=0,v=0;v<y.length;v++){var d=y[v];S.set(d,m),m+=d.length}return S}(I,T),this.reset(),k):new Uint8Array(0)},P.reset=function(){this.chunks.length=0,this.dataLength=0},D}()},"./src/demux/dummy-demuxed-track.ts":(j,M,b)=>{function w(D,P){return D===void 0&&(D=""),P===void 0&&(P=9e4),{type:D,id:-1,pid:-1,inputTimeScale:P,sequenceNumber:-1,samples:[],dropped:0}}b.r(M),b.d(M,{dummyTrack:()=>w})},"./src/demux/exp-golomb.ts":(j,M,b)=>{b.r(M),b.d(M,{default:()=>D});var w=b("./src/utils/logger.ts");const D=function(){function P(I){this.data=void 0,this.bytesAvailable=void 0,this.word=void 0,this.bitsAvailable=void 0,this.data=I,this.bytesAvailable=I.byteLength,this.word=0,this.bitsAvailable=0}var k=P.prototype;return k.loadWord=function(){var I=this.data,T=this.bytesAvailable,y=I.byteLength-T,p=new Uint8Array(4),S=Math.min(4,T);if(S===0)throw new Error("no bytes available");p.set(I.subarray(y,y+S)),this.word=new DataView(p.buffer).getUint32(0),this.bitsAvailable=8*S,this.bytesAvailable-=S},k.skipBits=function(I){var T;I=Math.min(I,8*this.bytesAvailable+this.bitsAvailable),this.bitsAvailable>I?(this.word<<=I,this.bitsAvailable-=I):(I-=this.bitsAvailable,I-=(T=I>>3)<<3,this.bytesAvailable-=T,this.loadWord(),this.word<<=I,this.bitsAvailable-=I)},k.readBits=function(I){var T=Math.min(this.bitsAvailable,I),y=this.word>>>32-T;if(I>32&&w.logger.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=T,this.bitsAvailable>0)this.word<<=T;else{if(!(this.bytesAvailable>0))throw new Error("no bits available");this.loadWord()}return(T=I-T)>0&&this.bitsAvailable?y<<T|this.readBits(T):y},k.skipLZ=function(){var I;for(I=0;I<this.bitsAvailable;++I)if(this.word&2147483648>>>I)return this.word<<=I,this.bitsAvailable-=I,I;return this.loadWord(),I+this.skipLZ()},k.skipUEG=function(){this.skipBits(1+this.skipLZ())},k.skipEG=function(){this.skipBits(1+this.skipLZ())},k.readUEG=function(){var I=this.skipLZ();return this.readBits(I+1)-1},k.readEG=function(){var I=this.readUEG();return 1&I?1+I>>>1:-1*(I>>>1)},k.readBoolean=function(){return this.readBits(1)===1},k.readUByte=function(){return this.readBits(8)},k.readUShort=function(){return this.readBits(16)},k.readUInt=function(){return this.readBits(32)},k.skipScalingList=function(I){for(var T=8,y=8,p=0;p<I;p++)y!==0&&(y=(T+this.readEG()+256)%256),T=y===0?T:y},k.readSPS=function(){var I,T,y,p=0,S=0,m=0,v=0,d=this.readUByte.bind(this),o=this.readBits.bind(this),t=this.readUEG.bind(this),n=this.readBoolean.bind(this),u=this.skipBits.bind(this),f=this.skipEG.bind(this),h=this.skipUEG.bind(this),i=this.skipScalingList.bind(this);d();var c=d();if(o(5),u(3),d(),h(),c===100||c===110||c===122||c===244||c===44||c===83||c===86||c===118||c===128){var l=t();if(l===3&&u(1),h(),h(),u(1),n())for(T=l!==3?8:12,y=0;y<T;y++)n()&&i(y<6?16:64)}h();var a=t();if(a===0)t();else if(a===1)for(u(1),f(),f(),I=t(),y=0;y<I;y++)f();h(),u(1);var s=t(),e=t(),r=o(1);r===0&&u(1),u(1),n()&&(p=t(),S=t(),m=t(),v=t());var g=[1,1];if(n()&&n())switch(d()){case 1:g=[1,1];break;case 2:g=[12,11];break;case 3:g=[10,11];break;case 4:g=[16,11];break;case 5:g=[40,33];break;case 6:g=[24,11];break;case 7:g=[20,11];break;case 8:g=[32,11];break;case 9:g=[80,33];break;case 10:g=[18,11];break;case 11:g=[15,11];break;case 12:g=[64,33];break;case 13:g=[160,99];break;case 14:g=[4,3];break;case 15:g=[3,2];break;case 16:g=[2,1];break;case 255:g=[d()<<8|d(),d()<<8|d()]}return{width:Math.ceil(16*(s+1)-2*p-2*S),height:(2-r)*(e+1)*16-(r?2:4)*(m+v),pixelRatio:g}},k.readSliceType=function(){return this.readUByte(),this.readUEG(),this.readUEG()},P}()},"./src/demux/id3.ts":(j,M,b)=>{b.r(M),b.d(M,{canParse:()=>T,decodeFrame:()=>v,getID3Data:()=>k,getID3Frames:()=>m,getTimeStamp:()=>y,isFooter:()=>P,isHeader:()=>D,isTimeStampFrame:()=>p,testables:()=>f,utf8ArrayToStr:()=>u});var w,D=function(i,c){return c+10<=i.length&&i[c]===73&&i[c+1]===68&&i[c+2]===51&&i[c+3]<255&&i[c+4]<255&&i[c+6]<128&&i[c+7]<128&&i[c+8]<128&&i[c+9]<128},P=function(i,c){return c+10<=i.length&&i[c]===51&&i[c+1]===68&&i[c+2]===73&&i[c+3]<255&&i[c+4]<255&&i[c+6]<128&&i[c+7]<128&&i[c+8]<128&&i[c+9]<128},k=function(i,c){for(var l=c,a=0;D(i,c);)a+=10,a+=I(i,c+6),P(i,c+10)&&(a+=10),c+=a;if(a>0)return i.subarray(l,l+a)},I=function(i,c){var l=0;return l=(127&i[c])<<21,l|=(127&i[c+1])<<14,l|=(127&i[c+2])<<7,l|=127&i[c+3]},T=function(i,c){return D(i,c)&&I(i,c+6)+10<=i.length-c},y=function(i){for(var c=m(i),l=0;l<c.length;l++){var a=c[l];if(p(a))return n(a)}},p=function(i){return i&&i.key==="PRIV"&&i.info==="com.apple.streaming.transportStreamTimestamp"},S=function(i){var c=String.fromCharCode(i[0],i[1],i[2],i[3]),l=I(i,4);return{type:c,size:l,data:i.subarray(10,10+l)}},m=function(i){for(var c=0,l=[];D(i,c);){for(var a=I(i,c+6),s=(c+=10)+a;c+8<s;){var e=S(i.subarray(c)),r=v(e);r&&l.push(r),c+=e.size+10}P(i,c)&&(c+=10)}return l},v=function(i){return i.type==="PRIV"?d(i):i.type[0]==="W"?t(i):o(i)},d=function(i){if(!(i.size<2)){var c=u(i.data,!0),l=new Uint8Array(i.data.subarray(c.length+1));return{key:i.type,info:c,data:l.buffer}}},o=function(i){if(!(i.size<2)){if(i.type==="TXXX"){var c=1,l=u(i.data.subarray(c),!0);c+=l.length+1;var a=u(i.data.subarray(c));return{key:i.type,info:l,data:a}}var s=u(i.data.subarray(1));return{key:i.type,data:s}}},t=function(i){if(i.type==="WXXX"){if(i.size<2)return;var c=1,l=u(i.data.subarray(c),!0);c+=l.length+1;var a=u(i.data.subarray(c));return{key:i.type,info:l,data:a}}var s=u(i.data);return{key:i.type,data:s}},n=function(i){if(i.data.byteLength===8){var c=new Uint8Array(i.data),l=1&c[3],a=(c[4]<<23)+(c[5]<<15)+(c[6]<<7)+c[7];return a/=45,l&&(a+=4772185884e-2),Math.round(a)}},u=function(i,c){c===void 0&&(c=!1);var l=h();if(l){var a=l.decode(i);if(c){var s=a.indexOf("\0");return s!==-1?a.substring(0,s):a}return a.replace(/\0/g,"")}for(var e,r,g,E=i.length,A="",L=0;L<E;){if((e=i[L++])===0&&c)return A;if(e!==0&&e!==3)switch(e>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:A+=String.fromCharCode(e);break;case 12:case 13:r=i[L++],A+=String.fromCharCode((31&e)<<6|63&r);break;case 14:r=i[L++],g=i[L++],A+=String.fromCharCode((15&e)<<12|(63&r)<<6|63&g)}}return A},f={decodeTextFrame:o};function h(){return w||self.TextDecoder===void 0||(w=new self.TextDecoder("utf-8")),w}},"./src/demux/mp3demuxer.ts":(j,M,b)=>{b.r(M),b.d(M,{default:()=>y});var w=b("./src/demux/base-audio-demuxer.ts"),D=b("./src/demux/id3.ts"),P=b("./src/utils/logger.ts"),k=b("./src/demux/mpegaudio.ts");function I(p,S){return I=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(m,v){return m.__proto__=v,m},I(p,S)}var T=function(p){var S,m;function v(){return p.apply(this,arguments)||this}m=p,(S=v).prototype=Object.create(m.prototype),S.prototype.constructor=S,I(S,m);var d=v.prototype;return d.resetInitSegment=function(o,t,n,u){p.prototype.resetInitSegment.call(this,o,t,n,u),this._audioTrack={container:"audio/mpeg",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"mp3",samples:[],manifestCodec:t,duration:u,inputTimeScale:9e4,dropped:0}},v.probe=function(o){if(!o)return!1;for(var t=(D.getID3Data(o,0)||[]).length,n=o.length;t<n;t++)if(k.probe(o,t))return P.logger.log("MPEG Audio sync word found !"),!0;return!1},d.canParse=function(o,t){return k.canParse(o,t)},d.appendFrame=function(o,t,n){if(this.basePTS!==null)return k.appendFrame(o,t,n,this.basePTS,this.frameIndex)},v}(w.default);const y=T},"./src/demux/mp4demuxer.ts":(j,M,b)=>{b.r(M),b.d(M,{default:()=>T});var w=b("./src/polyfills/number.ts"),D=b("./src/types/demuxer.ts"),P=b("./src/utils/mp4-tools.ts"),k=b("./src/demux/dummy-demuxed-track.ts"),I=/\/emsg[-/]ID3/i;const T=function(){function y(S,m){this.remainderData=null,this.timeOffset=0,this.config=void 0,this.videoTrack=void 0,this.audioTrack=void 0,this.id3Track=void 0,this.txtTrack=void 0,this.config=m}var p=y.prototype;return p.resetTimeStamp=function(){},p.resetInitSegment=function(S,m,v,d){var o=this.videoTrack=(0,k.dummyTrack)("video",1),t=this.audioTrack=(0,k.dummyTrack)("audio",1),n=this.txtTrack=(0,k.dummyTrack)("text",1);if(this.id3Track=(0,k.dummyTrack)("id3",1),this.timeOffset=0,S&&S.byteLength){var u=(0,P.parseInitSegment)(S);if(u.video){var f=u.video,h=f.id,i=f.timescale,c=f.codec;o.id=h,o.timescale=n.timescale=i,o.codec=c}if(u.audio){var l=u.audio,a=l.id,s=l.timescale,e=l.codec;t.id=a,t.timescale=s,t.codec=e}n.id=P.RemuxerTrackIdConfig.text,o.sampleDuration=0,o.duration=t.duration=d}},p.resetContiguity=function(){},y.probe=function(S){return S=S.length>16384?S.subarray(0,16384):S,(0,P.findBox)(S,["moof"]).length>0},p.demux=function(S,m){this.timeOffset=m;var v=S,d=this.videoTrack,o=this.txtTrack;if(this.config.progressive){this.remainderData&&(v=(0,P.appendUint8Array)(this.remainderData,S));var t=(0,P.segmentValidRange)(v);this.remainderData=t.remainder,d.samples=t.valid||new Uint8Array}else d.samples=v;var n=this.extractID3Track(d,m);return o.samples=(0,P.parseSamples)(m,d),{videoTrack:d,audioTrack:this.audioTrack,id3Track:n,textTrack:this.txtTrack}},p.flush=function(){var S=this.timeOffset,m=this.videoTrack,v=this.txtTrack;m.samples=this.remainderData||new Uint8Array,this.remainderData=null;var d=this.extractID3Track(m,this.timeOffset);return v.samples=(0,P.parseSamples)(S,m),{videoTrack:m,audioTrack:(0,k.dummyTrack)(),id3Track:d,textTrack:(0,k.dummyTrack)()}},p.extractID3Track=function(S,m){var v=this.id3Track;if(S.samples.length){var d=(0,P.findBox)(S.samples,["emsg"]);d&&d.forEach(function(o){var t=(0,P.parseEmsg)(o);if(I.test(t.schemeIdUri)){var n=(0,w.isFiniteNumber)(t.presentationTime)?t.presentationTime/t.timeScale:m+t.presentationTimeDelta/t.timeScale,u=t.eventDuration===4294967295?Number.POSITIVE_INFINITY:t.eventDuration/t.timeScale;u<=.001&&(u=Number.POSITIVE_INFINITY);var f=t.payload;v.samples.push({data:f,len:f.byteLength,dts:n,pts:n,type:D.MetadataSchema.emsg,duration:u})}})}return v},p.demuxSampleAes=function(S,m,v){return Promise.reject(new Error("The MP4 demuxer does not support SAMPLE-AES decryption"))},p.destroy=function(){},y}()},"./src/demux/mpegaudio.ts":(j,M,b)=>{b.r(M),b.d(M,{appendFrame:()=>T,canParse:()=>m,isHeader:()=>S,isHeaderPattern:()=>p,parseHeader:()=>y,probe:()=>v});var w=null,D=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],P=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],k=[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],I=[0,1,1,4];function T(d,o,t,n,u){if(!(t+24>o.length)){var f=y(o,t);if(f&&t+f.frameLength<=o.length){var h=n+u*(9e4*f.samplesPerFrame/f.sampleRate),i={unit:o.subarray(t,t+f.frameLength),pts:h,dts:h};return d.config=[],d.channelCount=f.channelCount,d.samplerate=f.sampleRate,d.samples.push(i),{sample:i,length:f.frameLength,missing:0}}}}function y(d,o){var t=d[o+1]>>3&3,n=d[o+1]>>1&3,u=d[o+2]>>4&15,f=d[o+2]>>2&3;if(t!==1&&u!==0&&u!==15&&f!==3){var h=d[o+2]>>1&1,i=d[o+3]>>6,c=1e3*D[14*(t===3?3-n:n===3?3:4)+u-1],l=P[3*(t===3?0:t===2?1:2)+f],a=i===3?1:2,s=k[t][n],e=I[n],r=8*s*e,g=Math.floor(s*c/l+h)*e;if(w===null){var E=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);w=E?parseInt(E[1]):0}return w&&w<=87&&n===2&&c>=224e3&&i===0&&(d[o+3]=128|d[o+3]),{sampleRate:l,channelCount:a,frameLength:g,samplesPerFrame:r}}}function p(d,o){return!(d[o]!==255||224&~d[o+1]||!(6&d[o+1]))}function S(d,o){return o+1<d.length&&p(d,o)}function m(d,o){return p(d,o)&&4<=d.length-o}function v(d,o){if(o+1<d.length&&p(d,o)){var t=y(d,o),n=4;t!=null&&t.frameLength&&(n=t.frameLength);var u=o+n;return u===d.length||S(d,u)}return!1}},"./src/demux/sample-aes.ts":(j,M,b)=>{b.r(M),b.d(M,{default:()=>P});var w=b("./src/crypt/decrypter.ts"),D=b("./src/utils/mp4-tools.ts");const P=function(){function k(T,y,p){this.keyData=void 0,this.decrypter=void 0,this.keyData=p,this.decrypter=new w.default(y,{removePKCS7Padding:!1})}var I=k.prototype;return I.decryptBuffer=function(T){return this.decrypter.decrypt(T,this.keyData.key.buffer,this.keyData.iv.buffer)},I.decryptAacSample=function(T,y,p){var S=this,m=T[y].unit;if(!(m.length<=16)){var v=m.subarray(16,m.length-m.length%16),d=v.buffer.slice(v.byteOffset,v.byteOffset+v.length);this.decryptBuffer(d).then(function(o){var t=new Uint8Array(o);m.set(t,16),S.decrypter.isSync()||S.decryptAacSamples(T,y+1,p)})}},I.decryptAacSamples=function(T,y,p){for(;;y++){if(y>=T.length)return void p();if(!(T[y].unit.length<32||(this.decryptAacSample(T,y,p),this.decrypter.isSync())))return}},I.getAvcEncryptedData=function(T){for(var y=16*Math.floor((T.length-48)/160)+16,p=new Int8Array(y),S=0,m=32;m<T.length-16;m+=160,S+=16)p.set(T.subarray(m,m+16),S);return p},I.getAvcDecryptedUnit=function(T,y){for(var p=new Uint8Array(y),S=0,m=32;m<T.length-16;m+=160,S+=16)T.set(p.subarray(S,S+16),m);return T},I.decryptAvcSample=function(T,y,p,S,m){var v=this,d=(0,D.discardEPB)(m.data),o=this.getAvcEncryptedData(d);this.decryptBuffer(o.buffer).then(function(t){m.data=v.getAvcDecryptedUnit(d,t),v.decrypter.isSync()||v.decryptAvcSamples(T,y,p+1,S)})},I.decryptAvcSamples=function(T,y,p,S){if(T instanceof Uint8Array)throw new Error("Cannot decrypt samples of type Uint8Array");for(;;y++,p=0){if(y>=T.length)return void S();for(var m=T[y].units;!(p>=m.length);p++){var v=m[p];if(!(v.data.length<=48||v.type!==1&&v.type!==5||(this.decryptAvcSample(T,y,p,S,v),this.decrypter.isSync())))return}}},k}()},"./src/demux/transmuxer-interface.ts":(j,M,b)=>{b.r(M),b.d(M,{default:()=>S});var w=b("./src/demux/webworkify-webpack.js"),D=b("./src/events.ts"),P=b("./src/demux/transmuxer.ts"),k=b("./src/utils/logger.ts"),I=b("./src/errors.ts"),T=b("./src/utils/mediasource-helper.ts"),y=b("./node_modules/eventemitter3/index.js"),p=(0,T.getMediaSource)()||{isTypeSupported:function(){return!1}},S=function(){function m(d,o,t,n){var u=this;this.hls=void 0,this.id=void 0,this.observer=void 0,this.frag=null,this.part=null,this.useWorker=void 0,this.worker=void 0,this.onwmsg=void 0,this.transmuxer=null,this.onTransmuxComplete=void 0,this.onFlush=void 0;var f=d.config;this.hls=d,this.id=o,this.useWorker=!!f.enableWorker,this.onTransmuxComplete=t,this.onFlush=n;var h=function(a,s){(s=s||{}).frag=u.frag,s.id=u.id,u.hls.trigger(a,s)};this.observer=new y.EventEmitter,this.observer.on(D.Events.FRAG_DECRYPTED,h),this.observer.on(D.Events.ERROR,h);var i={mp4:p.isTypeSupported("video/mp4"),mpeg:p.isTypeSupported("audio/mpeg"),mp3:p.isTypeSupported('audio/mp4; codecs="mp3"')},c=navigator.vendor;if(this.useWorker&&typeof Worker<"u"){var l;k.logger.log("demuxing in webworker");try{l=this.worker=(0,w.default)("./src/demux/transmuxer-worker.ts"),this.onwmsg=this.onWorkerMessage.bind(this),l.addEventListener("message",this.onwmsg),l.onerror=function(a){u.useWorker=!1,k.logger.warn("Exception in webworker, fallback to inline"),u.hls.trigger(D.Events.ERROR,{type:I.ErrorTypes.OTHER_ERROR,details:I.ErrorDetails.INTERNAL_EXCEPTION,fatal:!1,event:"demuxerWorker",error:new Error(a.message+"  ("+a.filename+":"+a.lineno+")")})},l.postMessage({cmd:"init",typeSupported:i,vendor:c,id:o,config:JSON.stringify(f)})}catch(a){k.logger.warn("Error in worker:",a),k.logger.error("Error while initializing DemuxerWorker, fallback to inline"),l&&self.URL.revokeObjectURL(l.objectURL),this.transmuxer=new P.default(this.observer,i,f,c,o),this.worker=null}}else this.transmuxer=new P.default(this.observer,i,f,c,o)}var v=m.prototype;return v.destroy=function(){var d=this.worker;if(d)d.removeEventListener("message",this.onwmsg),d.terminate(),this.worker=null,this.onwmsg=void 0;else{var o=this.transmuxer;o&&(o.destroy(),this.transmuxer=null)}var t=this.observer;t&&t.removeAllListeners(),this.frag=null,this.observer=null,this.hls=null},v.push=function(d,o,t,n,u,f,h,i,c,l){var a,s,e=this;c.transmuxing.start=self.performance.now();var r=this.transmuxer,g=this.worker,E=f?f.start:u.start,A=u.decryptdata,L=this.frag,_=!(L&&u.cc===L.cc),R=!(L&&c.level===L.level),x=L?c.sn-L.sn:-1,C=this.part?c.part-this.part.index:-1,F=x===0&&c.id>1&&c.id===(L==null?void 0:L.stats.chunkCount),O=!R&&(x===1||x===0&&(C===1||F&&C<=0)),N=self.performance.now();(R||x||u.stats.parsing.start===0)&&(u.stats.parsing.start=N),!f||!C&&O||(f.stats.parsing.start=N);var U=!(L&&((a=u.initSegment)===null||a===void 0?void 0:a.url)===((s=L.initSegment)===null||s===void 0?void 0:s.url)),G=new P.TransmuxState(_,O,i,R,E,U);if(!O||_||U){k.logger.log("[transmuxer-interface, "+u.type+"]: Starting new transmux session for sn: "+c.sn+" p: "+c.part+" level: "+c.level+" id: "+c.id+`
        discontinuity: `+_+`
        trackSwitch: `+R+`
        contiguous: `+O+`
        accurateTimeOffset: `+i+`
        timeOffset: `+E+`
        initSegmentChange: `+U);var B=new P.TransmuxConfig(t,n,o,h,l);this.configureTransmuxer(B)}if(this.frag=u,this.part=f,g)g.postMessage({cmd:"demux",data:d,decryptdata:A,chunkMeta:c,state:G},d instanceof ArrayBuffer?[d]:[]);else if(r){var H=r.push(d,A,c,G);(0,P.isPromise)(H)?(r.async=!0,H.then(function(V){e.handleTransmuxComplete(V)}).catch(function(V){e.transmuxerError(V,c,"transmuxer-interface push error")})):(r.async=!1,this.handleTransmuxComplete(H))}},v.flush=function(d){var o=this;d.transmuxing.start=self.performance.now();var t=this.transmuxer,n=this.worker;if(n)n.postMessage({cmd:"flush",chunkMeta:d});else if(t){var u=t.flush(d);(0,P.isPromise)(u)||t.async?((0,P.isPromise)(u)||(u=Promise.resolve(u)),u.then(function(f){o.handleFlushResult(f,d)}).catch(function(f){o.transmuxerError(f,d,"transmuxer-interface flush error")})):this.handleFlushResult(u,d)}},v.transmuxerError=function(d,o,t){this.hls&&this.hls.trigger(D.Events.ERROR,{type:I.ErrorTypes.MEDIA_ERROR,details:I.ErrorDetails.FRAG_PARSING_ERROR,chunkMeta:o,fatal:!1,error:d,err:d,reason:t})},v.handleFlushResult=function(d,o){var t=this;d.forEach(function(n){t.handleTransmuxComplete(n)}),this.onFlush(o)},v.onWorkerMessage=function(d){var o=d.data,t=this.hls;switch(o.event){case"init":self.URL.revokeObjectURL(this.worker.objectURL);break;case"transmuxComplete":this.handleTransmuxComplete(o.data);break;case"flush":this.onFlush(o.data);break;case"workerLog":k.logger[o.data.logType]&&k.logger[o.data.logType](o.data.message);break;default:o.data=o.data||{},o.data.frag=this.frag,o.data.id=this.id,t.trigger(o.event,o.data)}},v.configureTransmuxer=function(d){var o=this.worker,t=this.transmuxer;o?o.postMessage({cmd:"configure",config:d}):t&&t.configure(d)},v.handleTransmuxComplete=function(d){d.chunkMeta.transmuxing.end=self.performance.now(),this.onTransmuxComplete(d)},m}()},"./src/demux/transmuxer-worker.ts":(j,M,b)=>{b.r(M),b.d(M,{default:()=>T});var w=b("./src/demux/transmuxer.ts"),D=b("./src/events.ts"),P=b("./src/utils/logger.ts"),k=b("./node_modules/eventemitter3/index.js"),I=b("./src/errors.ts");function T(m){var v=new k.EventEmitter,d=function(o,t){m.postMessage({event:o,data:t})};v.on(D.Events.FRAG_DECRYPTED,d),v.on(D.Events.ERROR,d),m.addEventListener("message",function(o){var t=o.data;switch(t.cmd){case"init":var n=JSON.parse(t.config);m.transmuxer=new w.default(v,t.typeSupported,n,t.vendor,t.id),(0,P.enableLogs)(n.debug,t.id),function(){var i=function(l){P.logger[l]=function(a){d("workerLog",{logType:l,message:a})}};for(var c in P.logger)i(c)}(),d("init",null);break;case"configure":m.transmuxer.configure(t.config);break;case"demux":var u=m.transmuxer.push(t.data,t.decryptdata,t.chunkMeta,t.state);(0,w.isPromise)(u)?(m.transmuxer.async=!0,u.then(function(i){y(m,i)}).catch(function(i){d(D.Events.ERROR,{type:I.ErrorTypes.MEDIA_ERROR,details:I.ErrorDetails.FRAG_PARSING_ERROR,chunkMeta:t.chunkMeta,fatal:!1,error:i,err:i,reason:"transmuxer-worker push error"})})):(m.transmuxer.async=!1,y(m,u));break;case"flush":var f=t.chunkMeta,h=m.transmuxer.flush(f);(0,w.isPromise)(h)||m.transmuxer.async?((0,w.isPromise)(h)||(h=Promise.resolve(h)),h.then(function(i){S(m,i,f)}).catch(function(i){d(D.Events.ERROR,{type:I.ErrorTypes.MEDIA_ERROR,details:I.ErrorDetails.FRAG_PARSING_ERROR,chunkMeta:t.chunkMeta,fatal:!1,error:i,err:i,reason:"transmuxer-worker flush error"})})):S(m,h,f)}})}function y(m,v){if(!((d=v.remuxResult).audio||d.video||d.text||d.id3||d.initSegment))return!1;var d,o=[],t=v.remuxResult,n=t.audio,u=t.video;return n&&p(o,n),u&&p(o,u),m.postMessage({event:"transmuxComplete",data:v},o),!0}function p(m,v){v.data1&&m.push(v.data1.buffer),v.data2&&m.push(v.data2.buffer)}function S(m,v,d){v.reduce(function(o,t){return y(m,t)||o},!1)||m.postMessage({event:"transmuxComplete",data:v[0]}),m.postMessage({event:"flush",data:d})}},"./src/demux/transmuxer.ts":(j,M,b)=>{b.r(M),b.d(M,{TransmuxConfig:()=>u,TransmuxState:()=>f,default:()=>o,isPromise:()=>n});var w,D=b("./src/events.ts"),P=b("./src/errors.ts"),k=b("./src/crypt/decrypter.ts"),I=b("./src/demux/aacdemuxer.ts"),T=b("./src/demux/mp4demuxer.ts"),y=b("./src/demux/tsdemuxer.ts"),p=b("./src/demux/mp3demuxer.ts"),S=b("./src/remux/mp4-remuxer.ts"),m=b("./src/remux/passthrough-remuxer.ts"),v=b("./src/utils/logger.ts");try{w=self.performance.now.bind(self.performance)}catch{v.logger.debug("Unable to use Performance API on this environment"),w=self.Date.now}var d=[{demux:T.default,remux:m.default},{demux:y.default,remux:S.default},{demux:I.default,remux:S.default},{demux:p.default,remux:S.default}],o=function(){function h(c,l,a,s,e){this.async=!1,this.observer=void 0,this.typeSupported=void 0,this.config=void 0,this.vendor=void 0,this.id=void 0,this.demuxer=void 0,this.remuxer=void 0,this.decrypter=void 0,this.probe=void 0,this.decryptionPromise=null,this.transmuxConfig=void 0,this.currentTransmuxState=void 0,this.observer=c,this.typeSupported=l,this.config=a,this.vendor=s,this.id=e}var i=h.prototype;return i.configure=function(c){this.transmuxConfig=c,this.decrypter&&this.decrypter.reset()},i.push=function(c,l,a,s){var e=this,r=a.transmuxing;r.executeStart=w();var g=new Uint8Array(c),E=this.currentTransmuxState,A=this.transmuxConfig;s&&(this.currentTransmuxState=s);var L=s||E,_=L.contiguous,R=L.discontinuity,x=L.trackSwitch,C=L.accurateTimeOffset,F=L.timeOffset,O=L.initSegmentChange,N=A.audioCodec,U=A.videoCodec,G=A.defaultInitPts,B=A.duration,H=A.initSegmentData,V=function(Q,z){var $=null;return Q.byteLength>0&&z!=null&&z.key!=null&&z.iv!==null&&z.method!=null&&($=z),$}(g,l);if(V&&V.method==="AES-128"){var K=this.getDecrypter();if(!K.isSync())return this.decryptionPromise=K.webCryptoDecrypt(g,V.key.buffer,V.iv.buffer).then(function(Q){var z=e.push(Q,null,a);return e.decryptionPromise=null,z}),this.decryptionPromise;var Y=K.softwareDecrypt(g,V.key.buffer,V.iv.buffer);if(a.part>-1&&(Y=K.flush()),!Y)return r.executeEnd=w(),t(a);g=new Uint8Array(Y)}var q=this.needsProbing(R,x);q&&this.configureTransmuxer(g),(R||x||O||q)&&this.resetInitSegment(H,N,U,B,l),(R||O||q)&&this.resetInitialTimestamp(G),_||this.resetContiguity();var X=this.transmux(g,V,F,C,a),W=this.currentTransmuxState;return W.contiguous=!0,W.discontinuity=!1,W.trackSwitch=!1,r.executeEnd=w(),X},i.flush=function(c){var l=this,a=c.transmuxing;a.executeStart=w();var s=this.decrypter,e=this.currentTransmuxState,r=this.decryptionPromise;if(r)return r.then(function(){return l.flush(c)});var g=[],E=e.timeOffset;if(s){var A=s.flush();A&&g.push(this.push(A,null,c))}var L=this.demuxer,_=this.remuxer;if(!L||!_)return this.observer.emit(D.Events.ERROR,D.Events.ERROR,{type:P.ErrorTypes.MEDIA_ERROR,details:P.ErrorDetails.FRAG_PARSING_ERROR,fatal:!0,reason:"no demux matching with content found"}),a.executeEnd=w(),[t(c)];var R=L.flush(E);return n(R)?R.then(function(x){return l.flushRemux(g,x,c),g}):(this.flushRemux(g,R,c),g)},i.flushRemux=function(c,l,a){var s=l.audioTrack,e=l.videoTrack,r=l.id3Track,g=l.textTrack,E=this.currentTransmuxState,A=E.accurateTimeOffset,L=E.timeOffset;v.logger.log("[transmuxer.ts]: Flushed fragment "+a.sn+(a.part>-1?" p: "+a.part:"")+" of level "+a.level);var _=this.remuxer.remux(s,e,r,g,L,A,!0,this.id);c.push({remuxResult:_,chunkMeta:a}),a.transmuxing.executeEnd=w()},i.resetInitialTimestamp=function(c){var l=this.demuxer,a=this.remuxer;l&&a&&(l.resetTimeStamp(c),a.resetTimeStamp(c))},i.resetContiguity=function(){var c=this.demuxer,l=this.remuxer;c&&l&&(c.resetContiguity(),l.resetNextTimestamp())},i.resetInitSegment=function(c,l,a,s,e){var r=this.demuxer,g=this.remuxer;r&&g&&(r.resetInitSegment(c,l,a,s),g.resetInitSegment(c,l,a,e))},i.destroy=function(){this.demuxer&&(this.demuxer.destroy(),this.demuxer=void 0),this.remuxer&&(this.remuxer.destroy(),this.remuxer=void 0)},i.transmux=function(c,l,a,s,e){return l&&l.method==="SAMPLE-AES"?this.transmuxSampleAes(c,l,a,s,e):this.transmuxUnencrypted(c,a,s,e)},i.transmuxUnencrypted=function(c,l,a,s){var e=this.demuxer.demux(c,l,!1,!this.config.progressive),r=e.audioTrack,g=e.videoTrack,E=e.id3Track,A=e.textTrack;return{remuxResult:this.remuxer.remux(r,g,E,A,l,a,!1,this.id),chunkMeta:s}},i.transmuxSampleAes=function(c,l,a,s,e){var r=this;return this.demuxer.demuxSampleAes(c,l,a).then(function(g){return{remuxResult:r.remuxer.remux(g.audioTrack,g.videoTrack,g.id3Track,g.textTrack,a,s,!1,r.id),chunkMeta:e}})},i.configureTransmuxer=function(c){for(var l,a=this.config,s=this.observer,e=this.typeSupported,r=this.vendor,g=0,E=d.length;g<E;g++)if(d[g].demux.probe(c)){l=d[g];break}l||(v.logger.warn("Failed to find demuxer by probing frag, treating as mp4 passthrough"),l={demux:T.default,remux:m.default});var A=this.demuxer,L=this.remuxer,_=l.remux,R=l.demux;L&&L instanceof _||(this.remuxer=new _(s,a,e,r)),A&&A instanceof R||(this.demuxer=new R(s,a,e),this.probe=R.probe)},i.needsProbing=function(c,l){return!this.demuxer||!this.remuxer||c||l},i.getDecrypter=function(){var c=this.decrypter;return c||(c=this.decrypter=new k.default(this.config)),c},h}(),t=function(h){return{remuxResult:{},chunkMeta:h}};function n(h){return"then"in h&&h.then instanceof Function}var u=function(h,i,c,l,a){this.audioCodec=void 0,this.videoCodec=void 0,this.initSegmentData=void 0,this.duration=void 0,this.defaultInitPts=void 0,this.audioCodec=h,this.videoCodec=i,this.initSegmentData=c,this.duration=l,this.defaultInitPts=a},f=function(h,i,c,l,a,s){this.discontinuity=void 0,this.contiguous=void 0,this.accurateTimeOffset=void 0,this.trackSwitch=void 0,this.timeOffset=void 0,this.initSegmentChange=void 0,this.discontinuity=h,this.contiguous=i,this.accurateTimeOffset=c,this.trackSwitch=l,this.timeOffset=a,this.initSegmentChange=s}},"./src/demux/tsdemuxer.ts":(j,M,b)=>{b.r(M),b.d(M,{default:()=>h});var w=b("./src/demux/adts.ts"),D=b("./src/demux/mpegaudio.ts"),P=b("./src/demux/exp-golomb.ts"),k=b("./src/demux/sample-aes.ts"),I=b("./src/events.ts"),T=b("./src/utils/mp4-tools.ts"),y=b("./src/utils/logger.ts"),p=b("./src/errors.ts"),S=b("./src/types/demuxer.ts");function m(){return m=Object.assign?Object.assign.bind():function(i){for(var c=1;c<arguments.length;c++){var l=arguments[c];for(var a in l)Object.prototype.hasOwnProperty.call(l,a)&&(i[a]=l[a])}return i},m.apply(this,arguments)}var v=188;function d(i,c,l,a){return{key:i,frame:!1,pts:c,dts:l,units:[],debug:a,length:0}}function o(i,c){return((31&i[c+1])<<8)+i[c+2]}function t(i,c){return(31&i[c+10])<<8|i[c+11]}function n(i,c,l,a){var s={audio:-1,avc:-1,id3:-1,segmentCodec:"aac"},e=c+3+((15&i[c+1])<<8|i[c+2])-4;for(c+=12+((15&i[c+10])<<8|i[c+11]);c<e;){var r=o(i,c);switch(i[c]){case 207:if(!a){y.logger.log("ADTS AAC with AES-128-CBC frame encryption found in unencrypted stream");break}case 15:s.audio===-1&&(s.audio=r);break;case 21:s.id3===-1&&(s.id3=r);break;case 219:if(!a){y.logger.log("H.264 with AES-128-CBC slice encryption found in unencrypted stream");break}case 27:s.avc===-1&&(s.avc=r);break;case 3:case 4:l.mpeg!==!0&&l.mp3!==!0?y.logger.log("MPEG audio found, not supported in this browser"):s.audio===-1&&(s.audio=r,s.segmentCodec="mp3");break;case 36:y.logger.warn("Unsupported HEVC stream type found")}c+=5+((15&i[c+3])<<8|i[c+4])}return s}function u(i){var c,l,a,s,e,r=0,g=i.data;if(!i||i.size===0)return null;for(;g[0].length<19&&g.length>1;){var E=new Uint8Array(g[0].length+g[1].length);E.set(g[0]),E.set(g[1],g[0].length),g[0]=E,g.splice(1,1)}if(((c=g[0])[0]<<16)+(c[1]<<8)+c[2]===1){if((l=(c[4]<<8)+c[5])&&l>i.size-6)return null;var A=c[7];192&A&&(s=536870912*(14&c[9])+4194304*(255&c[10])+16384*(254&c[11])+128*(255&c[12])+(254&c[13])/2,64&A?s-(e=536870912*(14&c[14])+4194304*(255&c[15])+16384*(254&c[16])+128*(255&c[17])+(254&c[18])/2)>54e5&&(y.logger.warn(Math.round((s-e)/9e4)+"s delta between PTS and DTS, align them"),s=e):e=s);var L=(a=c[8])+9;if(i.size<=L)return null;i.size-=L;for(var _=new Uint8Array(i.size),R=0,x=g.length;R<x;R++){var C=(c=g[R]).byteLength;if(L){if(L>C){L-=C;continue}c=c.subarray(L),C-=L,L=0}_.set(c,r),r+=C}return l&&(l-=a+3),{data:_,pts:s,dts:e,len:l}}return null}function f(i,c){if(i.units.length&&i.frame){if(i.pts===void 0){var l=c.samples,a=l.length;if(!a)return void c.dropped++;var s=l[a-1];i.pts=s.pts,i.dts=s.dts}c.samples.push(i)}i.debug.length&&y.logger.log(i.pts+"/"+i.dts+":"+i.debug)}const h=function(){function i(l,a,s){this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.sampleAes=null,this.pmtParsed=!1,this.audioCodec=void 0,this.videoCodec=void 0,this._duration=0,this._pmtId=-1,this._avcTrack=void 0,this._audioTrack=void 0,this._id3Track=void 0,this._txtTrack=void 0,this.aacOverFlow=null,this.avcSample=null,this.remainderData=null,this.observer=l,this.config=a,this.typeSupported=s}i.probe=function(l){var a=i.syncOffset(l);return a>0&&y.logger.warn("MPEG2-TS detected but first sync word found @ offset "+a),a!==-1},i.syncOffset=function(l){for(var a=l.length,s=Math.min(940,l.length-v)+1,e=0;e<s;){for(var r=!1,g=e;g<a&&l[g]===71;g+=v)if(r||o(l,g)!==0||(r=!0),r&&g+v>s)return e;e++}return-1},i.createTrack=function(l,a){return{container:l==="video"||l==="audio"?"video/mp2t":void 0,type:l,id:T.RemuxerTrackIdConfig[l],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0,duration:l==="audio"?a:void 0}};var c=i.prototype;return c.resetInitSegment=function(l,a,s,e){this.pmtParsed=!1,this._pmtId=-1,this._avcTrack=i.createTrack("video"),this._audioTrack=i.createTrack("audio",e),this._id3Track=i.createTrack("id3"),this._txtTrack=i.createTrack("text"),this._audioTrack.segmentCodec="aac",this.aacOverFlow=null,this.avcSample=null,this.remainderData=null,this.audioCodec=a,this.videoCodec=s,this._duration=e},c.resetTimeStamp=function(){},c.resetContiguity=function(){var l=this._audioTrack,a=this._avcTrack,s=this._id3Track;l&&(l.pesData=null),a&&(a.pesData=null),s&&(s.pesData=null),this.aacOverFlow=null,this.avcSample=null,this.remainderData=null},c.demux=function(l,a,s,e){var r;s===void 0&&(s=!1),e===void 0&&(e=!1),s||(this.sampleAes=null);var g=this._avcTrack,E=this._audioTrack,A=this._id3Track,L=this._txtTrack,_=g.pid,R=g.pesData,x=E.pid,C=A.pid,F=E.pesData,O=A.pesData,N=null,U=this.pmtParsed,G=this._pmtId,B=l.length;if(this.remainderData&&(B=(l=(0,T.appendUint8Array)(this.remainderData,l)).length,this.remainderData=null),B<v&&!e)return this.remainderData=l,{audioTrack:E,videoTrack:g,id3Track:A,textTrack:L};var H=Math.max(0,i.syncOffset(l));(B-=(B-H)%v)<l.byteLength&&!e&&(this.remainderData=new Uint8Array(l.buffer,B,l.buffer.byteLength-B));for(var V=0,K=H;K<B;K+=v)if(l[K]===71){var Y=!!(64&l[K+1]),q=o(l,K),X=void 0;if((48&l[K+3])>>4>1){if((X=K+5+l[K+4])===K+v)continue}else X=K+4;switch(q){case _:Y&&(R&&(r=u(R))&&this.parseAVCPES(g,L,r,!1),R={data:[],size:0}),R&&(R.data.push(l.subarray(X,K+v)),R.size+=K+v-X);break;case x:if(Y){if(F&&(r=u(F)))switch(E.segmentCodec){case"aac":this.parseAACPES(E,r);break;case"mp3":this.parseMPEGPES(E,r)}F={data:[],size:0}}F&&(F.data.push(l.subarray(X,K+v)),F.size+=K+v-X);break;case C:Y&&(O&&(r=u(O))&&this.parseID3PES(A,r),O={data:[],size:0}),O&&(O.data.push(l.subarray(X,K+v)),O.size+=K+v-X);break;case 0:Y&&(X+=l[X]+1),G=this._pmtId=t(l,X);break;case G:Y&&(X+=l[X]+1);var W=n(l,X,this.typeSupported,s);(_=W.avc)>0&&(g.pid=_),(x=W.audio)>0&&(E.pid=x,E.segmentCodec=W.segmentCodec),(C=W.id3)>0&&(A.pid=C),N===null||U||(y.logger.warn("MPEG-TS PMT found at "+K+" after unknown PID '"+N+"'. Backtracking to sync byte @"+H+" to parse all TS packets."),N=null,K=H-188),U=this.pmtParsed=!0;break;case 17:case 8191:break;default:N=q}}else V++;V>0&&this.observer.emit(I.Events.ERROR,I.Events.ERROR,{type:p.ErrorTypes.MEDIA_ERROR,details:p.ErrorDetails.FRAG_PARSING_ERROR,fatal:!1,reason:"Found "+V+" TS packet/s that do not start with 0x47"}),g.pesData=R,E.pesData=F,A.pesData=O;var Q={audioTrack:E,videoTrack:g,id3Track:A,textTrack:L};return e&&this.extractRemainingSamples(Q),Q},c.flush=function(){var l,a=this.remainderData;return this.remainderData=null,l=a?this.demux(a,-1,!1,!0):{videoTrack:this._avcTrack,audioTrack:this._audioTrack,id3Track:this._id3Track,textTrack:this._txtTrack},this.extractRemainingSamples(l),this.sampleAes?this.decrypt(l,this.sampleAes):l},c.extractRemainingSamples=function(l){var a,s=l.audioTrack,e=l.videoTrack,r=l.id3Track,g=l.textTrack,E=e.pesData,A=s.pesData,L=r.pesData;if(E&&(a=u(E))?(this.parseAVCPES(e,g,a,!0),e.pesData=null):e.pesData=E,A&&(a=u(A))){switch(s.segmentCodec){case"aac":this.parseAACPES(s,a);break;case"mp3":this.parseMPEGPES(s,a)}s.pesData=null}else A!=null&&A.size&&y.logger.log("last AAC PES packet truncated,might overlap between fragments"),s.pesData=A;L&&(a=u(L))?(this.parseID3PES(r,a),r.pesData=null):r.pesData=L},c.demuxSampleAes=function(l,a,s){var e=this.demux(l,s,!0,!this.config.progressive),r=this.sampleAes=new k.default(this.observer,this.config,a);return this.decrypt(e,r)},c.decrypt=function(l,a){return new Promise(function(s){var e=l.audioTrack,r=l.videoTrack;e.samples&&e.segmentCodec==="aac"?a.decryptAacSamples(e.samples,0,function(){r.samples?a.decryptAvcSamples(r.samples,0,0,function(){s(l)}):s(l)}):r.samples&&a.decryptAvcSamples(r.samples,0,0,function(){s(l)})})},c.destroy=function(){this._duration=0},c.parseAVCPES=function(l,a,s,e){var r,g=this,E=this.parseAVCNALu(l,s.data),A=this.avcSample,L=!1;s.data=null,A&&E.length&&!l.audFound&&(f(A,l),A=this.avcSample=d(!1,s.pts,s.dts,"")),E.forEach(function(_){switch(_.type){case 1:r=!0,A||(A=g.avcSample=d(!0,s.pts,s.dts,"")),A.frame=!0;var R=_.data;if(L&&R.length>4){var x=new P.default(R).readSliceType();x!==2&&x!==4&&x!==7&&x!==9||(A.key=!0)}break;case 5:r=!0,A||(A=g.avcSample=d(!0,s.pts,s.dts,"")),A.key=!0,A.frame=!0;break;case 6:r=!0,(0,T.parseSEIMessageFromNALu)(_.data,1,s.pts,a.samples);break;case 7:if(r=!0,L=!0,!l.sps){var C=new P.default(_.data).readSPS();l.width=C.width,l.height=C.height,l.pixelRatio=C.pixelRatio,l.sps=[_.data],l.duration=g._duration;for(var F=_.data.subarray(1,4),O="avc1.",N=0;N<3;N++){var U=F[N].toString(16);U.length<2&&(U="0"+U),O+=U}l.codec=O}break;case 8:r=!0,l.pps||(l.pps=[_.data]);break;case 9:r=!1,l.audFound=!0,A&&f(A,l),A=g.avcSample=d(!1,s.pts,s.dts,"");break;case 12:r=!0;break;default:r=!1,A&&(A.debug+="unknown NAL "+_.type+" ")}A&&r&&A.units.push(_)}),e&&A&&(f(A,l),this.avcSample=null)},c.getLastNalUnit=function(l){var a,s,e=this.avcSample;if(e&&e.units.length!==0||(e=l[l.length-1]),(a=e)!==null&&a!==void 0&&a.units){var r=e.units;s=r[r.length-1]}return s},c.parseAVCNALu=function(l,a){var s,e,r=a.byteLength,g=l.naluState||0,E=g,A=[],L=0,_=-1,R=0;for(g===-1&&(_=0,R=31&a[0],g=0,L=1);L<r;)if(s=a[L++],g)if(g!==1)if(s)if(s===1){if(_>=0){var x={data:a.subarray(_,L-g-1),type:R};A.push(x)}else{var C=this.getLastNalUnit(l.samples);if(C&&(E&&L<=4-E&&C.state&&(C.data=C.data.subarray(0,C.data.byteLength-E)),(e=L-g-1)>0)){var F=new Uint8Array(C.data.byteLength+e);F.set(C.data,0),F.set(a.subarray(0,e),C.data.byteLength),C.data=F,C.state=0}}L<r?(_=L,R=31&a[L],g=0):g=-1}else g=0;else g=3;else g=s?0:2;else g=s?0:1;if(_>=0&&g>=0){var O={data:a.subarray(_,r),type:R,state:g};A.push(O)}if(A.length===0){var N=this.getLastNalUnit(l.samples);if(N){var U=new Uint8Array(N.data.byteLength+a.byteLength);U.set(N.data,0),U.set(a,N.data.byteLength),N.data=U}}return l.naluState=g,A},c.parseAACPES=function(l,a){var s,e,r,g,E,A=0,L=this.aacOverFlow,_=a.data;if(L){this.aacOverFlow=null;var R=L.missing,x=L.sample.unit.byteLength;if(R===-1){var C=new Uint8Array(x+_.byteLength);C.set(L.sample.unit,0),C.set(_,x),_=C}else{var F=x-R;L.sample.unit.set(_.subarray(0,R),F),l.samples.push(L.sample),A=L.missing}}for(s=A,e=_.length;s<e-1&&!w.isHeader(_,s);s++);if(s===A||(s<e-1?(r="AAC PES did not start with ADTS header,offset:"+s,g=!1):(r="no ADTS header found in AAC PES",g=!0),y.logger.warn("parsing error:"+r),this.observer.emit(I.Events.ERROR,I.Events.ERROR,{type:p.ErrorTypes.MEDIA_ERROR,details:p.ErrorDetails.FRAG_PARSING_ERROR,fatal:g,reason:r}),!g)){if(w.initTrackConfig(l,this.observer,_,s,this.audioCodec),a.pts!==void 0)E=a.pts;else{if(!L)return void y.logger.warn("[tsdemuxer]: AAC PES unknown PTS");var O=w.getFrameDuration(l.samplerate);E=L.sample.pts+O}for(var N,U=0;s<e;){if(s+=(N=w.appendFrame(l,_,s,E,U)).length,N.missing){this.aacOverFlow=N;break}for(U++;s<e-1&&!w.isHeader(_,s);s++);}}},c.parseMPEGPES=function(l,a){var s=a.data,e=s.length,r=0,g=0,E=a.pts;if(E!==void 0)for(;g<e;)if(D.isHeader(s,g)){var A=D.appendFrame(l,s,g,E,r);if(!A)break;g+=A.length,r++}else g++;else y.logger.warn("[tsdemuxer]: MPEG PES unknown PTS")},c.parseID3PES=function(l,a){if(a.pts!==void 0){var s=m({},a,{type:this._avcTrack?S.MetadataSchema.emsg:S.MetadataSchema.audioId3,duration:Number.POSITIVE_INFINITY});l.samples.push(s)}else y.logger.warn("[tsdemuxer]: ID3 PES unknown PTS")},i}()},"./src/demux/webworkify-webpack.js":(j,M,b)=>{b.r(M),b.d(M,{default:()=>p});var w=(function(){var S=ENTRY_MODULE,m={},v=function o(t){var n=m[t];if(n!==void 0)return n.exports;var u=m[t]={exports:{}};return S[t].call(u.exports,u,u.exports,o),u.exports};v.m=S,v.n=function(o){var t=o&&o.__esModule?function(){return o.default}:function(){return o};return v.d(t,{a:t}),t},v.d=function(o,t){for(var n in t)v.o(t,n)&&!v.o(o,n)&&Object.defineProperty(o,n,{enumerable:!0,get:t[n]})},v.o=function(o,t){return Object.prototype.hasOwnProperty.call(o,t)},v.r=function(o){typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(o,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(o,"__esModule",{value:!0})};var d=v(ENTRY_MODULE);return d.default||d}).toString().split("ENTRY_MODULE"),D="[\\.|\\-|\\+|\\w|/|@]+",P="\\(\\s*(/\\*.*?\\*/)?\\s*.*?("+D+").*?\\)";function k(S){return(S+"").replace(/[.?*+^$[\]\\(){}|-]/g,"\\$&")}function I(S,m,v){var d={};d[v]=[];var o=m.toString().replace(/^"[^"]+"/,"function"),t=o.match(/^function\s?\w*\(\w+,\s*\w+,\s*(\w+)\)/)||o.match(/^\(\w+,\s*\w+,\s*(\w+)\)\s?\=\s?\>/);if(!t)return d;for(var n,u=t[1],f=new RegExp("(\\\\n|\\W)"+k(u)+P,"g");n=f.exec(o);)n[3]!=="dll-reference"&&d[v].push(n[3]);for(f=new RegExp("\\("+k(u)+'\\("(dll-reference\\s('+D+'))"\\)\\)'+P,"g");n=f.exec(o);)S[n[2]]||(d[v].push(n[1]),S[n[2]]=b(n[1]).m),d[n[2]]=d[n[2]]||[],d[n[2]].push(n[4]);for(var h,i=Object.keys(d),c=0;c<i.length;c++)for(var l=0;l<d[i[c]].length;l++)h=d[i[c]][l],isNaN(1*h)||(d[i[c]][l]=1*d[i[c]][l]);return d}function T(S){return Object.keys(S).reduce(function(m,v){return m||S[v].length>0},!1)}function y(S,m,v,d){var o=S[d].map(function(t){return'"'+t+'": '+m[d][t].toString().replace(/^"[^"]+"/,"function")}).join(",");return w[0]+"{"+o+"}"+w[1]+'"'+v+'"'+w[2]}function p(S,m){m=m||{};var v={main:b.m},d=m.all?{main:Object.keys(v.main)}:function(f,h){for(var i={main:[h]},c={main:[]},l={main:{}};T(i);)for(var a=Object.keys(i),s=0;s<a.length;s++){var e=a[s],r=i[e].pop();if(l[e]=l[e]||{},!l[e][r]&&f[e][r]){l[e][r]=!0,c[e]=c[e]||[],c[e].push(r);for(var g=I(f,f[e][r],e),E=Object.keys(g),A=0;A<E.length;A++)i[E[A]]=i[E[A]]||[],i[E[A]]=i[E[A]].concat(g[E[A]])}}return c}(v,S),o="";Object.keys(d).filter(function(f){return f!=="main"}).forEach(function(f){for(var h=0;d[f][h];)h++;d[f].push(h),v[f][h]="(function(module, exports, __webpack_require__) { module.exports = __webpack_require__; })",o=o+"var "+f+" = ("+y(d,v,h,modules)+`)();
`}),o=o+"new (("+y(d,v,S,"main")+")())(self);";var t=new window.Blob([o],{type:"text/javascript"}),n=(window.URL||window.webkitURL||window.mozURL||window.msURL).createObjectURL(t),u=new window.Worker(n);return u.objectURL=n,u}},"./src/errors.ts":(j,M,b)=>{var w,D;b.r(M),b.d(M,{ErrorDetails:()=>D,ErrorTypes:()=>w}),function(P){P.NETWORK_ERROR="networkError",P.MEDIA_ERROR="mediaError",P.KEY_SYSTEM_ERROR="keySystemError",P.MUX_ERROR="muxError",P.OTHER_ERROR="otherError"}(w||(w={})),function(P){P.KEY_SYSTEM_NO_KEYS="keySystemNoKeys",P.KEY_SYSTEM_NO_ACCESS="keySystemNoAccess",P.KEY_SYSTEM_NO_SESSION="keySystemNoSession",P.KEY_SYSTEM_NO_CONFIGURED_LICENSE="keySystemNoConfiguredLicense",P.KEY_SYSTEM_LICENSE_REQUEST_FAILED="keySystemLicenseRequestFailed",P.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED="keySystemServerCertificateRequestFailed",P.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED="keySystemServerCertificateUpdateFailed",P.KEY_SYSTEM_SESSION_UPDATE_FAILED="keySystemSessionUpdateFailed",P.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED="keySystemStatusOutputRestricted",P.KEY_SYSTEM_STATUS_INTERNAL_ERROR="keySystemStatusInternalError",P.MANIFEST_LOAD_ERROR="manifestLoadError",P.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",P.MANIFEST_PARSING_ERROR="manifestParsingError",P.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",P.LEVEL_EMPTY_ERROR="levelEmptyError",P.LEVEL_LOAD_ERROR="levelLoadError",P.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",P.LEVEL_SWITCH_ERROR="levelSwitchError",P.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",P.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",P.SUBTITLE_LOAD_ERROR="subtitleTrackLoadError",P.SUBTITLE_TRACK_LOAD_TIMEOUT="subtitleTrackLoadTimeOut",P.FRAG_LOAD_ERROR="fragLoadError",P.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",P.FRAG_DECRYPT_ERROR="fragDecryptError",P.FRAG_PARSING_ERROR="fragParsingError",P.REMUX_ALLOC_ERROR="remuxAllocError",P.KEY_LOAD_ERROR="keyLoadError",P.KEY_LOAD_TIMEOUT="keyLoadTimeOut",P.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",P.BUFFER_INCOMPATIBLE_CODECS_ERROR="bufferIncompatibleCodecsError",P.BUFFER_APPEND_ERROR="bufferAppendError",P.BUFFER_APPENDING_ERROR="bufferAppendingError",P.BUFFER_STALLED_ERROR="bufferStalledError",P.BUFFER_FULL_ERROR="bufferFullError",P.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",P.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",P.INTERNAL_EXCEPTION="internalException",P.INTERNAL_ABORTED="aborted",P.UNKNOWN="unknown"}(D||(D={}))},"./src/events.ts":(j,M,b)=>{var w;b.r(M),b.d(M,{Events:()=>w}),function(D){D.MEDIA_ATTACHING="hlsMediaAttaching",D.MEDIA_ATTACHED="hlsMediaAttached",D.MEDIA_DETACHING="hlsMediaDetaching",D.MEDIA_DETACHED="hlsMediaDetached",D.BUFFER_RESET="hlsBufferReset",D.BUFFER_CODECS="hlsBufferCodecs",D.BUFFER_CREATED="hlsBufferCreated",D.BUFFER_APPENDING="hlsBufferAppending",D.BUFFER_APPENDED="hlsBufferAppended",D.BUFFER_EOS="hlsBufferEos",D.BUFFER_FLUSHING="hlsBufferFlushing",D.BUFFER_FLUSHED="hlsBufferFlushed",D.MANIFEST_LOADING="hlsManifestLoading",D.MANIFEST_LOADED="hlsManifestLoaded",D.MANIFEST_PARSED="hlsManifestParsed",D.LEVEL_SWITCHING="hlsLevelSwitching",D.LEVEL_SWITCHED="hlsLevelSwitched",D.LEVEL_LOADING="hlsLevelLoading",D.LEVEL_LOADED="hlsLevelLoaded",D.LEVEL_UPDATED="hlsLevelUpdated",D.LEVEL_PTS_UPDATED="hlsLevelPtsUpdated",D.LEVELS_UPDATED="hlsLevelsUpdated",D.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",D.AUDIO_TRACK_SWITCHING="hlsAudioTrackSwitching",D.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",D.AUDIO_TRACK_LOADING="hlsAudioTrackLoading",D.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",D.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",D.SUBTITLE_TRACKS_CLEARED="hlsSubtitleTracksCleared",D.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",D.SUBTITLE_TRACK_LOADING="hlsSubtitleTrackLoading",D.SUBTITLE_TRACK_LOADED="hlsSubtitleTrackLoaded",D.SUBTITLE_FRAG_PROCESSED="hlsSubtitleFragProcessed",D.CUES_PARSED="hlsCuesParsed",D.NON_NATIVE_TEXT_TRACKS_FOUND="hlsNonNativeTextTracksFound",D.INIT_PTS_FOUND="hlsInitPtsFound",D.FRAG_LOADING="hlsFragLoading",D.FRAG_LOAD_EMERGENCY_ABORTED="hlsFragLoadEmergencyAborted",D.FRAG_LOADED="hlsFragLoaded",D.FRAG_DECRYPTED="hlsFragDecrypted",D.FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",D.FRAG_PARSING_USERDATA="hlsFragParsingUserdata",D.FRAG_PARSING_METADATA="hlsFragParsingMetadata",D.FRAG_PARSED="hlsFragParsed",D.FRAG_BUFFERED="hlsFragBuffered",D.FRAG_CHANGED="hlsFragChanged",D.FPS_DROP="hlsFpsDrop",D.FPS_DROP_LEVEL_CAPPING="hlsFpsDropLevelCapping",D.ERROR="hlsError",D.DESTROYING="hlsDestroying",D.KEY_LOADING="hlsKeyLoading",D.KEY_LOADED="hlsKeyLoaded",D.LIVE_BACK_BUFFER_REACHED="hlsLiveBackBufferReached",D.BACK_BUFFER_REACHED="hlsBackBufferReached"}(w||(w={}))},"./src/hls.ts":(j,M,b)=>{b.r(M),b.d(M,{default:()=>f});var w=b("./node_modules/url-toolkit/src/url-toolkit.js"),D=b("./src/loader/playlist-loader.ts"),P=b("./src/controller/id3-track-controller.ts"),k=b("./src/controller/latency-controller.ts"),I=b("./src/controller/level-controller.ts"),T=b("./src/controller/fragment-tracker.ts"),y=b("./src/loader/key-loader.ts"),p=b("./src/controller/stream-controller.ts"),S=b("./src/is-supported.ts"),m=b("./src/utils/logger.ts"),v=b("./src/config.ts"),d=b("./node_modules/eventemitter3/index.js"),o=b("./src/events.ts"),t=b("./src/errors.ts"),n=b("./src/types/level.ts");function u(h,i){for(var c=0;c<i.length;c++){var l=i[c];l.enumerable=l.enumerable||!1,l.configurable=!0,"value"in l&&(l.writable=!0),Object.defineProperty(h,(a=l.key,s=void 0,typeof(s=function(e,r){if(typeof e!="object"||e===null)return e;var g=e[Symbol.toPrimitive];if(g!==void 0){var E=g.call(e,r||"default");if(typeof E!="object")return E;throw new TypeError("@@toPrimitive must return a primitive value.")}return(r==="string"?String:Number)(e)}(a,"string"))=="symbol"?s:String(s)),l)}var a,s}var f=function(){function h(s){s===void 0&&(s={}),this.config=void 0,this.userConfig=void 0,this.coreComponents=void 0,this.networkControllers=void 0,this._emitter=new d.EventEmitter,this._autoLevelCapping=void 0,this._maxHdcpLevel=null,this.abrController=void 0,this.bufferController=void 0,this.capLevelController=void 0,this.latencyController=void 0,this.levelController=void 0,this.streamController=void 0,this.audioTrackController=void 0,this.subtitleTrackController=void 0,this.emeController=void 0,this.cmcdController=void 0,this._media=null,this.url=null;var e=this.config=(0,v.mergeConfig)(h.DefaultConfig,s);this.userConfig=s,(0,m.enableLogs)(e.debug,"Hls instance"),this._autoLevelCapping=-1,e.progressive&&(0,v.enableStreamingMode)(e);var r=e.abrController,g=e.bufferController,E=e.capLevelController,A=e.fpsController,L=this.abrController=new r(this),_=this.bufferController=new g(this),R=this.capLevelController=new E(this),x=new A(this),C=new D.default(this),F=new P.default(this),O=this.levelController=new I.default(this),N=new T.FragmentTracker(this),U=new y.default(this.config),G=this.streamController=new p.default(this,N,U);R.setStreamController(G),x.setStreamController(G);var B=[C,O,G];this.networkControllers=B;var H=[L,_,R,x,F,N];this.audioTrackController=this.createController(e.audioTrackController,B);var V=e.audioStreamController;V&&B.push(new V(this,N,U)),this.subtitleTrackController=this.createController(e.subtitleTrackController,B);var K=e.subtitleStreamController;K&&B.push(new K(this,N,U)),this.createController(e.timelineController,H),U.emeController=this.emeController=this.createController(e.emeController,H),this.cmcdController=this.createController(e.cmcdController,H),this.latencyController=this.createController(k.default,H),this.coreComponents=H}h.isSupported=function(){return(0,S.isSupported)()};var i,c,l,a=h.prototype;return a.createController=function(s,e){if(s){var r=new s(this);return e&&e.push(r),r}return null},a.on=function(s,e,r){r===void 0&&(r=this),this._emitter.on(s,e,r)},a.once=function(s,e,r){r===void 0&&(r=this),this._emitter.once(s,e,r)},a.removeAllListeners=function(s){this._emitter.removeAllListeners(s)},a.off=function(s,e,r,g){r===void 0&&(r=this),this._emitter.off(s,e,r,g)},a.listeners=function(s){return this._emitter.listeners(s)},a.emit=function(s,e,r){return this._emitter.emit(s,e,r)},a.trigger=function(s,e){if(this.config.debug)return this.emit(s,s,e);try{return this.emit(s,s,e)}catch(r){m.logger.error("An internal error happened while handling event "+s+'. Error message: "'+r.message+'". Here is a stacktrace:',r),this.trigger(o.Events.ERROR,{type:t.ErrorTypes.OTHER_ERROR,details:t.ErrorDetails.INTERNAL_EXCEPTION,fatal:!1,event:s,error:r})}return!1},a.listenerCount=function(s){return this._emitter.listenerCount(s)},a.destroy=function(){m.logger.log("destroy"),this.trigger(o.Events.DESTROYING,void 0),this.detachMedia(),this.removeAllListeners(),this._autoLevelCapping=-1,this.url=null,this.networkControllers.forEach(function(s){return s.destroy()}),this.networkControllers.length=0,this.coreComponents.forEach(function(s){return s.destroy()}),this.coreComponents.length=0},a.attachMedia=function(s){m.logger.log("attachMedia"),this._media=s,this.trigger(o.Events.MEDIA_ATTACHING,{media:s})},a.detachMedia=function(){m.logger.log("detachMedia"),this.trigger(o.Events.MEDIA_DETACHING,void 0),this._media=null},a.loadSource=function(s){this.stopLoad();var e=this.media,r=this.url,g=this.url=w.buildAbsoluteURL(self.location.href,s,{alwaysNormalize:!0});m.logger.log("loadSource:"+g),e&&r&&r!==g&&this.bufferController.hasSourceTypes()&&(this.detachMedia(),this.attachMedia(e)),this.trigger(o.Events.MANIFEST_LOADING,{url:s})},a.startLoad=function(s){s===void 0&&(s=-1),m.logger.log("startLoad("+s+")"),this.networkControllers.forEach(function(e){e.startLoad(s)})},a.stopLoad=function(){m.logger.log("stopLoad"),this.networkControllers.forEach(function(s){s.stopLoad()})},a.swapAudioCodec=function(){m.logger.log("swapAudioCodec"),this.streamController.swapAudioCodec()},a.recoverMediaError=function(){m.logger.log("recoverMediaError");var s=this._media;this.detachMedia(),s&&this.attachMedia(s)},a.removeLevel=function(s,e){e===void 0&&(e=0),this.levelController.removeLevel(s,e)},i=h,l=[{key:"version",get:function(){return"1.3.5"}},{key:"Events",get:function(){return o.Events}},{key:"ErrorTypes",get:function(){return t.ErrorTypes}},{key:"ErrorDetails",get:function(){return t.ErrorDetails}},{key:"DefaultConfig",get:function(){return h.defaultConfig?h.defaultConfig:v.hlsDefaultConfig},set:function(s){h.defaultConfig=s}}],(c=[{key:"levels",get:function(){var s=this.levelController.levels;return s||[]}},{key:"currentLevel",get:function(){return this.streamController.currentLevel},set:function(s){m.logger.log("set currentLevel:"+s),this.loadLevel=s,this.abrController.clearTimer(),this.streamController.immediateLevelSwitch()}},{key:"nextLevel",get:function(){return this.streamController.nextLevel},set:function(s){m.logger.log("set nextLevel:"+s),this.levelController.manualLevel=s,this.streamController.nextLevelSwitch()}},{key:"loadLevel",get:function(){return this.levelController.level},set:function(s){m.logger.log("set loadLevel:"+s),this.levelController.manualLevel=s}},{key:"nextLoadLevel",get:function(){return this.levelController.nextLoadLevel},set:function(s){this.levelController.nextLoadLevel=s}},{key:"firstLevel",get:function(){return Math.max(this.levelController.firstLevel,this.minAutoLevel)},set:function(s){m.logger.log("set firstLevel:"+s),this.levelController.firstLevel=s}},{key:"startLevel",get:function(){return this.levelController.startLevel},set:function(s){m.logger.log("set startLevel:"+s),s!==-1&&(s=Math.max(s,this.minAutoLevel)),this.levelController.startLevel=s}},{key:"capLevelToPlayerSize",get:function(){return this.config.capLevelToPlayerSize},set:function(s){var e=!!s;e!==this.config.capLevelToPlayerSize&&(e?this.capLevelController.startCapping():(this.capLevelController.stopCapping(),this.autoLevelCapping=-1,this.streamController.nextLevelSwitch()),this.config.capLevelToPlayerSize=e)}},{key:"autoLevelCapping",get:function(){return this._autoLevelCapping},set:function(s){this._autoLevelCapping!==s&&(m.logger.log("set autoLevelCapping:"+s),this._autoLevelCapping=s)}},{key:"bandwidthEstimate",get:function(){var s=this.abrController.bwEstimator;return s?s.getEstimate():NaN}},{key:"maxHdcpLevel",get:function(){return this._maxHdcpLevel},set:function(s){n.HdcpLevels.indexOf(s)>-1&&(this._maxHdcpLevel=s)}},{key:"autoLevelEnabled",get:function(){return this.levelController.manualLevel===-1}},{key:"manualLevel",get:function(){return this.levelController.manualLevel}},{key:"minAutoLevel",get:function(){var s=this.levels,e=this.config.minAutoBitrate;if(!s)return 0;for(var r=s.length,g=0;g<r;g++)if(s[g].maxBitrate>=e)return g;return 0}},{key:"maxAutoLevel",get:function(){var s,e=this.levels,r=this.autoLevelCapping,g=this.maxHdcpLevel;if(s=r===-1&&e&&e.length?e.length-1:r,g)for(var E=s;E--;){var A=e[E].attrs["HDCP-LEVEL"];if(A&&A<=g)return E}return s}},{key:"nextAutoLevel",get:function(){return Math.min(Math.max(this.abrController.nextAutoLevel,this.minAutoLevel),this.maxAutoLevel)},set:function(s){this.abrController.nextAutoLevel=Math.max(this.minAutoLevel,s)}},{key:"playingDate",get:function(){return this.streamController.currentProgramDateTime}},{key:"mainForwardBufferInfo",get:function(){return this.streamController.getMainFwdBufferInfo()}},{key:"audioTracks",get:function(){var s=this.audioTrackController;return s?s.audioTracks:[]}},{key:"audioTrack",get:function(){var s=this.audioTrackController;return s?s.audioTrack:-1},set:function(s){var e=this.audioTrackController;e&&(e.audioTrack=s)}},{key:"subtitleTracks",get:function(){var s=this.subtitleTrackController;return s?s.subtitleTracks:[]}},{key:"subtitleTrack",get:function(){var s=this.subtitleTrackController;return s?s.subtitleTrack:-1},set:function(s){var e=this.subtitleTrackController;e&&(e.subtitleTrack=s)}},{key:"media",get:function(){return this._media}},{key:"subtitleDisplay",get:function(){var s=this.subtitleTrackController;return!!s&&s.subtitleDisplay},set:function(s){var e=this.subtitleTrackController;e&&(e.subtitleDisplay=s)}},{key:"lowLatencyMode",get:function(){return this.config.lowLatencyMode},set:function(s){this.config.lowLatencyMode=s}},{key:"liveSyncPosition",get:function(){return this.latencyController.liveSyncPosition}},{key:"latency",get:function(){return this.latencyController.latency}},{key:"maxLatency",get:function(){return this.latencyController.maxLatency}},{key:"targetLatency",get:function(){return this.latencyController.targetLatency}},{key:"drift",get:function(){return this.latencyController.drift}},{key:"forceStartLoad",get:function(){return this.streamController.forceStartLoad}}])&&u(i.prototype,c),l&&u(i,l),Object.defineProperty(i,"prototype",{writable:!1}),h}();f.defaultConfig=void 0},"./src/is-supported.ts":(j,M,b)=>{b.r(M),b.d(M,{changeTypeSupported:()=>k,isSupported:()=>P});var w=b("./src/utils/mediasource-helper.ts");function D(){return self.SourceBuffer||self.WebKitSourceBuffer}function P(){var I=(0,w.getMediaSource)();if(!I)return!1;var T=D(),y=I&&typeof I.isTypeSupported=="function"&&I.isTypeSupported('video/mp4; codecs="avc1.42E01E,mp4a.40.2"'),p=!T||T.prototype&&typeof T.prototype.appendBuffer=="function"&&typeof T.prototype.remove=="function";return!!y&&!!p}function k(){var I,T=D();return typeof(T==null||(I=T.prototype)===null||I===void 0?void 0:I.changeType)=="function"}},"./src/loader/date-range.ts":(j,M,b)=>{b.r(M),b.d(M,{DateRange:()=>y,DateRangeAttribute:()=>w});var w,D=b("./src/polyfills/number.ts"),P=b("./src/utils/attr-list.ts"),k=b("./src/utils/logger.ts");function I(){return I=Object.assign?Object.assign.bind():function(p){for(var S=1;S<arguments.length;S++){var m=arguments[S];for(var v in m)Object.prototype.hasOwnProperty.call(m,v)&&(p[v]=m[v])}return p},I.apply(this,arguments)}function T(p,S){for(var m=0;m<S.length;m++){var v=S[m];v.enumerable=v.enumerable||!1,v.configurable=!0,"value"in v&&(v.writable=!0),Object.defineProperty(p,(d=v.key,o=void 0,typeof(o=function(t,n){if(typeof t!="object"||t===null)return t;var u=t[Symbol.toPrimitive];if(u!==void 0){var f=u.call(t,n||"default");if(typeof f!="object")return f;throw new TypeError("@@toPrimitive must return a primitive value.")}return(n==="string"?String:Number)(t)}(d,"string"))=="symbol"?o:String(o)),v)}var d,o}(function(p){p.ID="ID",p.CLASS="CLASS",p.START_DATE="START-DATE",p.DURATION="DURATION",p.END_DATE="END-DATE",p.END_ON_NEXT="END-ON-NEXT",p.PLANNED_DURATION="PLANNED-DURATION",p.SCTE35_OUT="SCTE35-OUT",p.SCTE35_IN="SCTE35-IN"})(w||(w={}));var y=function(){function p(d,o){if(this.attr=void 0,this._startDate=void 0,this._endDate=void 0,this._badValueForSameId=void 0,o){var t=o.attr;for(var n in t)if(Object.prototype.hasOwnProperty.call(d,n)&&d[n]!==t[n]){k.logger.warn('DATERANGE tag attribute: "'+n+'" does not match for tags with ID: "'+d.ID+'"'),this._badValueForSameId=n;break}d=I(new P.AttrList({}),t,d)}if(this.attr=d,this._startDate=new Date(d[w.START_DATE]),w.END_DATE in this.attr){var u=new Date(this.attr[w.END_DATE]);(0,D.isFiniteNumber)(u.getTime())&&(this._endDate=u)}}var S,m,v;return S=p,(m=[{key:"id",get:function(){return this.attr.ID}},{key:"class",get:function(){return this.attr.CLASS}},{key:"startDate",get:function(){return this._startDate}},{key:"endDate",get:function(){if(this._endDate)return this._endDate;var d=this.duration;return d!==null?new Date(this._startDate.getTime()+1e3*d):null}},{key:"duration",get:function(){if(w.DURATION in this.attr){var d=this.attr.decimalFloatingPoint(w.DURATION);if((0,D.isFiniteNumber)(d))return d}else if(this._endDate)return(this._endDate.getTime()-this._startDate.getTime())/1e3;return null}},{key:"plannedDuration",get:function(){return w.PLANNED_DURATION in this.attr?this.attr.decimalFloatingPoint(w.PLANNED_DURATION):null}},{key:"endOnNext",get:function(){return this.attr.bool(w.END_ON_NEXT)}},{key:"isValid",get:function(){return!!this.id&&!this._badValueForSameId&&(0,D.isFiniteNumber)(this.startDate.getTime())&&(this.duration===null||this.duration>=0)&&(!this.endOnNext||!!this.class)}}])&&T(S.prototype,m),v&&T(S,v),Object.defineProperty(S,"prototype",{writable:!1}),p}()},"./src/loader/fragment-loader.ts":(j,M,b)=>{b.r(M),b.d(M,{LoadError:()=>m,default:()=>p});var w=b("./src/polyfills/number.ts"),D=b("./src/errors.ts");function P(v){var d=typeof Map=="function"?new Map:void 0;return P=function(o){if(o===null||(t=o,Function.toString.call(t).indexOf("[native code]")===-1))return o;var t;if(typeof o!="function")throw new TypeError("Super expression must either be null or a function");if(d!==void 0){if(d.has(o))return d.get(o);d.set(o,n)}function n(){return k(o,arguments,T(this).constructor)}return n.prototype=Object.create(o.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),I(n,o)},P(v)}function k(v,d,o){return k=function(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}()?Reflect.construct.bind():function(t,n,u){var f=[null];f.push.apply(f,n);var h=new(Function.bind.apply(t,f));return u&&I(h,u.prototype),h},k.apply(null,arguments)}function I(v,d){return I=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(o,t){return o.__proto__=t,o},I(v,d)}function T(v){return T=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(d){return d.__proto__||Object.getPrototypeOf(d)},T(v)}var y=Math.pow(2,17),p=function(){function v(o){this.config=void 0,this.loader=null,this.partLoadTimeout=-1,this.config=o}var d=v.prototype;return d.destroy=function(){this.loader&&(this.loader.destroy(),this.loader=null)},d.abort=function(){this.loader&&this.loader.abort()},d.load=function(o,t){var n=this,u=o.url;if(!u)return Promise.reject(new m({type:D.ErrorTypes.NETWORK_ERROR,details:D.ErrorDetails.FRAG_LOAD_ERROR,fatal:!1,frag:o,networkDetails:null},"Fragment does not have a "+(u?"part list":"url")));this.abort();var f=this.config,h=f.fLoader,i=f.loader;return new Promise(function(c,l){n.loader&&n.loader.destroy();var a=n.loader=o.loader=h?new h(f):new i(f),s=S(o),e={timeout:f.fragLoadingTimeOut,maxRetry:0,retryDelay:0,maxRetryDelay:f.fragLoadingMaxRetryTimeout,highWaterMark:o.sn==="initSegment"?1/0:y};o.stats=a.stats,a.load(s,e,{onSuccess:function(r,g,E,A){n.resetLoader(o,a);var L=r.data;E.resetIV&&o.decryptdata&&(o.decryptdata.iv=new Uint8Array(L.slice(0,16)),L=L.slice(16)),c({frag:o,part:null,payload:L,networkDetails:A})},onError:function(r,g,E){n.resetLoader(o,a),l(new m({type:D.ErrorTypes.NETWORK_ERROR,details:D.ErrorDetails.FRAG_LOAD_ERROR,fatal:!1,frag:o,response:r,networkDetails:E}))},onAbort:function(r,g,E){n.resetLoader(o,a),l(new m({type:D.ErrorTypes.NETWORK_ERROR,details:D.ErrorDetails.INTERNAL_ABORTED,fatal:!1,frag:o,networkDetails:E}))},onTimeout:function(r,g,E){n.resetLoader(o,a),l(new m({type:D.ErrorTypes.NETWORK_ERROR,details:D.ErrorDetails.FRAG_LOAD_TIMEOUT,fatal:!1,frag:o,networkDetails:E}))},onProgress:function(r,g,E,A){t&&t({frag:o,part:null,payload:E,networkDetails:A})}})})},d.loadPart=function(o,t,n){var u=this;this.abort();var f=this.config,h=f.fLoader,i=f.loader;return new Promise(function(c,l){u.loader&&u.loader.destroy();var a=u.loader=o.loader=h?new h(f):new i(f),s=S(o,t),e={timeout:f.fragLoadingTimeOut,maxRetry:0,retryDelay:0,maxRetryDelay:f.fragLoadingMaxRetryTimeout,highWaterMark:y};t.stats=a.stats,a.load(s,e,{onSuccess:function(r,g,E,A){u.resetLoader(o,a),u.updateStatsFromPart(o,t);var L={frag:o,part:t,payload:r.data,networkDetails:A};n(L),c(L)},onError:function(r,g,E){u.resetLoader(o,a),l(new m({type:D.ErrorTypes.NETWORK_ERROR,details:D.ErrorDetails.FRAG_LOAD_ERROR,fatal:!1,frag:o,part:t,response:r,networkDetails:E}))},onAbort:function(r,g,E){o.stats.aborted=t.stats.aborted,u.resetLoader(o,a),l(new m({type:D.ErrorTypes.NETWORK_ERROR,details:D.ErrorDetails.INTERNAL_ABORTED,fatal:!1,frag:o,part:t,networkDetails:E}))},onTimeout:function(r,g,E){u.resetLoader(o,a),l(new m({type:D.ErrorTypes.NETWORK_ERROR,details:D.ErrorDetails.FRAG_LOAD_TIMEOUT,fatal:!1,frag:o,part:t,networkDetails:E}))}})})},d.updateStatsFromPart=function(o,t){var n=o.stats,u=t.stats,f=u.total;if(n.loaded+=u.loaded,f){var h=Math.round(o.duration/t.duration),i=Math.min(Math.round(n.loaded/f),h),c=(h-i)*Math.round(n.loaded/i);n.total=n.loaded+c}else n.total=Math.max(n.loaded,n.total);var l=n.loading,a=u.loading;l.start?l.first+=a.first-a.start:(l.start=a.start,l.first=a.first),l.end=a.end},d.resetLoader=function(o,t){o.loader=null,this.loader===t&&(self.clearTimeout(this.partLoadTimeout),this.loader=null),t.destroy()},v}();function S(v,d){d===void 0&&(d=null);var o=d||v,t={frag:v,part:d,responseType:"arraybuffer",url:o.url,headers:{},rangeStart:0,rangeEnd:0},n=o.byteRangeStartOffset,u=o.byteRangeEndOffset;if((0,w.isFiniteNumber)(n)&&(0,w.isFiniteNumber)(u)){var f,h=n,i=u;if(v.sn==="initSegment"&&((f=v.decryptdata)===null||f===void 0?void 0:f.method)==="AES-128"){var c=u-n;c%16&&(i=u+(16-c%16)),n!==0&&(t.resetIV=!0,h=n-16)}t.rangeStart=h,t.rangeEnd=i}return t}var m=function(v){var d,o;function t(n){for(var u,f=arguments.length,h=new Array(f>1?f-1:0),i=1;i<f;i++)h[i-1]=arguments[i];return(u=v.call.apply(v,[this].concat(h))||this).data=void 0,u.data=n,u}return o=v,(d=t).prototype=Object.create(o.prototype),d.prototype.constructor=d,I(d,o),t}(P(Error))},"./src/loader/fragment.ts":(j,M,b)=>{b.r(M),b.d(M,{BaseSegment:()=>S,ElementaryStreamTypes:()=>w,Fragment:()=>m,Part:()=>v});var w,D=b("./src/polyfills/number.ts"),P=b("./node_modules/url-toolkit/src/url-toolkit.js"),k=b("./src/loader/load-stats.ts");function I(d,o){d.prototype=Object.create(o.prototype),d.prototype.constructor=d,T(d,o)}function T(d,o){return T=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,n){return t.__proto__=n,t},T(d,o)}function y(d,o){for(var t=0;t<o.length;t++){var n=o[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(d,(u=n.key,f=void 0,typeof(f=function(h,i){if(typeof h!="object"||h===null)return h;var c=h[Symbol.toPrimitive];if(c!==void 0){var l=c.call(h,i||"default");if(typeof l!="object")return l;throw new TypeError("@@toPrimitive must return a primitive value.")}return(i==="string"?String:Number)(h)}(u,"string"))=="symbol"?f:String(f)),n)}var u,f}function p(d,o,t){return o&&y(d.prototype,o),t&&y(d,t),Object.defineProperty(d,"prototype",{writable:!1}),d}(function(d){d.AUDIO="audio",d.VIDEO="video",d.AUDIOVIDEO="audiovideo"})(w||(w={}));var S=function(){function d(o){var t;this._byteRange=null,this._url=null,this.baseurl=void 0,this.relurl=void 0,this.elementaryStreams=((t={})[w.AUDIO]=null,t[w.VIDEO]=null,t[w.AUDIOVIDEO]=null,t),this.baseurl=o}return d.prototype.setByteRange=function(o,t){var n=o.split("@",2),u=[];n.length===1?u[0]=t?t.byteRangeEndOffset:0:u[0]=parseInt(n[1]),u[1]=parseInt(n[0])+u[0],this._byteRange=u},p(d,[{key:"byteRange",get:function(){return this._byteRange?this._byteRange:[]}},{key:"byteRangeStartOffset",get:function(){return this.byteRange[0]}},{key:"byteRangeEndOffset",get:function(){return this.byteRange[1]}},{key:"url",get:function(){return!this._url&&this.baseurl&&this.relurl&&(this._url=(0,P.buildAbsoluteURL)(this.baseurl,this.relurl,{alwaysNormalize:!0})),this._url||""},set:function(o){this._url=o}}]),d}(),m=function(d){function o(n,u){var f;return(f=d.call(this,u)||this)._decryptdata=null,f.rawProgramDateTime=null,f.programDateTime=null,f.tagList=[],f.duration=0,f.sn=0,f.levelkeys=void 0,f.type=void 0,f.loader=null,f.keyLoader=null,f.level=-1,f.cc=0,f.startPTS=void 0,f.endPTS=void 0,f.appendedPTS=void 0,f.startDTS=void 0,f.endDTS=void 0,f.start=0,f.deltaPTS=void 0,f.maxStartPTS=void 0,f.minEndPTS=void 0,f.stats=new k.LoadStats,f.urlId=0,f.data=void 0,f.bitrateTest=!1,f.title=null,f.initSegment=null,f.endList=void 0,f.type=n,f}I(o,d);var t=o.prototype;return t.setKeyFormat=function(n){if(this.levelkeys){var u=this.levelkeys[n];u&&!this._decryptdata&&(this._decryptdata=u.getDecryptData(this.sn))}},t.abortRequests=function(){var n,u;(n=this.loader)===null||n===void 0||n.abort(),(u=this.keyLoader)===null||u===void 0||u.abort()},t.setElementaryStreamInfo=function(n,u,f,h,i,c){c===void 0&&(c=!1);var l=this.elementaryStreams,a=l[n];a?(a.startPTS=Math.min(a.startPTS,u),a.endPTS=Math.max(a.endPTS,f),a.startDTS=Math.min(a.startDTS,h),a.endDTS=Math.max(a.endDTS,i)):l[n]={startPTS:u,endPTS:f,startDTS:h,endDTS:i,partial:c}},t.clearElementaryStreamInfo=function(){var n=this.elementaryStreams;n[w.AUDIO]=null,n[w.VIDEO]=null,n[w.AUDIOVIDEO]=null},p(o,[{key:"decryptdata",get:function(){if(!this.levelkeys&&!this._decryptdata)return null;if(!this._decryptdata&&this.levelkeys&&!this.levelkeys.NONE){var n=this.levelkeys.identity;if(n)this._decryptdata=n.getDecryptData(this.sn);else{var u=Object.keys(this.levelkeys);if(u.length===1)return this._decryptdata=this.levelkeys[u[0]].getDecryptData(this.sn)}}return this._decryptdata}},{key:"end",get:function(){return this.start+this.duration}},{key:"endProgramDateTime",get:function(){if(this.programDateTime===null||!(0,D.isFiniteNumber)(this.programDateTime))return null;var n=(0,D.isFiniteNumber)(this.duration)?this.duration:0;return this.programDateTime+1e3*n}},{key:"encrypted",get:function(){var n;if((n=this._decryptdata)!==null&&n!==void 0&&n.encrypted)return!0;if(this.levelkeys){var u=Object.keys(this.levelkeys),f=u.length;if(f>1||f===1&&this.levelkeys[u[0]].encrypted)return!0}return!1}}]),o}(S),v=function(d){function o(t,n,u,f,h){var i;(i=d.call(this,u)||this).fragOffset=0,i.duration=0,i.gap=!1,i.independent=!1,i.relurl=void 0,i.fragment=void 0,i.index=void 0,i.stats=new k.LoadStats,i.duration=t.decimalFloatingPoint("DURATION"),i.gap=t.bool("GAP"),i.independent=t.bool("INDEPENDENT"),i.relurl=t.enumeratedString("URI"),i.fragment=n,i.index=f;var c=t.enumeratedString("BYTERANGE");return c&&i.setByteRange(c,h),h&&(i.fragOffset=h.fragOffset+h.duration),i}return I(o,d),p(o,[{key:"start",get:function(){return this.fragment.start+this.fragOffset}},{key:"end",get:function(){return this.start+this.duration}},{key:"loaded",get:function(){var t=this.elementaryStreams;return!!(t.audio||t.video||t.audiovideo)}}]),o}(S)},"./src/loader/key-loader.ts":(j,M,b)=>{b.r(M),b.d(M,{default:()=>P});var w=b("./src/errors.ts"),D=b("./src/loader/fragment-loader.ts"),P=function(){function k(T){this.config=void 0,this.keyUriToKeyInfo={},this.emeController=null,this.config=T}var I=k.prototype;return I.abort=function(){for(var T in this.keyUriToKeyInfo){var y=this.keyUriToKeyInfo[T].loader;y&&y.abort()}},I.detach=function(){for(var T in this.keyUriToKeyInfo){var y=this.keyUriToKeyInfo[T];(y.mediaKeySessionContext||y.decryptdata.isCommonEncryption)&&delete this.keyUriToKeyInfo[T]}},I.destroy=function(){for(var T in this.detach(),this.keyUriToKeyInfo){var y=this.keyUriToKeyInfo[T].loader;y&&y.destroy()}this.keyUriToKeyInfo={}},I.createKeyLoadError=function(T,y,p,S){return y===void 0&&(y=w.ErrorDetails.KEY_LOAD_ERROR),new D.LoadError({type:w.ErrorTypes.NETWORK_ERROR,details:y,fatal:!1,frag:T,networkDetails:p})},I.loadClear=function(T,y){var p=this;if(this.emeController&&this.config.emeEnabled)for(var S=T.sn,m=T.cc,v=function(o){var t=y[o];if(m<=t.cc&&(S==="initSegment"||S<t.sn))return p.emeController.selectKeySystemFormat(t).then(function(n){t.setKeyFormat(n)}),"break"},d=0;d<y.length&&v(d)!=="break";d++);},I.load=function(T){var y=this;return!T.decryptdata&&T.encrypted&&this.emeController?this.emeController.selectKeySystemFormat(T).then(function(p){return y.loadInternal(T,p)}):this.loadInternal(T)},I.loadInternal=function(T,y){var p,S;y&&T.setKeyFormat(y);var m=T.decryptdata;if(!m){var v=y?"Expected frag.decryptdata to be defined after setting format "+y:"Missing decryption data on fragment in onKeyLoading";return Promise.reject(this.createKeyLoadError(T,w.ErrorDetails.KEY_LOAD_ERROR,null,v))}var d=m.uri;if(!d)return Promise.reject(this.createKeyLoadError(T,w.ErrorDetails.KEY_LOAD_ERROR,null,'Invalid key URI: "'+d+'"'));var o,t=this.keyUriToKeyInfo[d];if((p=t)!==null&&p!==void 0&&p.decryptdata.key)return m.key=t.decryptdata.key,Promise.resolve({frag:T,keyInfo:t});if((S=t)!==null&&S!==void 0&&S.keyLoadPromise)switch((o=t.mediaKeySessionContext)===null||o===void 0?void 0:o.keyStatus){case void 0:case"status-pending":case"usable":case"usable-in-future":return t.keyLoadPromise.then(function(n){return m.key=n.keyInfo.decryptdata.key,{frag:T,keyInfo:t}})}switch(t=this.keyUriToKeyInfo[d]={decryptdata:m,keyLoadPromise:null,loader:null,mediaKeySessionContext:null},m.method){case"ISO-23001-7":case"SAMPLE-AES":case"SAMPLE-AES-CENC":case"SAMPLE-AES-CTR":return m.keyFormat==="identity"?this.loadKeyHTTP(t,T):this.loadKeyEME(t,T);case"AES-128":return this.loadKeyHTTP(t,T);default:return Promise.reject(this.createKeyLoadError(T,w.ErrorDetails.KEY_LOAD_ERROR,null,'Key supplied with unsupported METHOD: "'+m.method+'"'))}},I.loadKeyEME=function(T,y){var p={frag:y,keyInfo:T};if(this.emeController&&this.config.emeEnabled){var S=this.emeController.loadKey(p);if(S)return(T.keyLoadPromise=S.then(function(m){return T.mediaKeySessionContext=m,p})).catch(function(m){throw T.keyLoadPromise=null,m})}return Promise.resolve(p)},I.loadKeyHTTP=function(T,y){var p=this,S=this.config,m=new S.loader(S);return y.keyLoader=T.loader=m,T.keyLoadPromise=new Promise(function(v,d){var o={keyInfo:T,frag:y,responseType:"arraybuffer",url:T.decryptdata.uri},t={timeout:S.fragLoadingTimeOut,maxRetry:0,retryDelay:S.fragLoadingRetryDelay,maxRetryDelay:S.fragLoadingMaxRetryTimeout,highWaterMark:0},n={onSuccess:function(u,f,h,i){var c=h.frag,l=h.keyInfo,a=h.url;if(!c.decryptdata||l!==p.keyUriToKeyInfo[a])return d(p.createKeyLoadError(c,w.ErrorDetails.KEY_LOAD_ERROR,i,"after key load, decryptdata unset or changed"));l.decryptdata.key=c.decryptdata.key=new Uint8Array(u.data),c.keyLoader=null,l.loader=null,v({frag:c,keyInfo:l})},onError:function(u,f,h){p.resetLoader(f),d(p.createKeyLoadError(y,w.ErrorDetails.KEY_LOAD_ERROR,h))},onTimeout:function(u,f,h){p.resetLoader(f),d(p.createKeyLoadError(y,w.ErrorDetails.KEY_LOAD_TIMEOUT,h))},onAbort:function(u,f,h){p.resetLoader(f),d(p.createKeyLoadError(y,w.ErrorDetails.INTERNAL_ABORTED,h))}};m.load(o,t,n)})},I.resetLoader=function(T){var y=T.frag,p=T.keyInfo,S=T.url,m=p.loader;y.keyLoader===m&&(y.keyLoader=null,p.loader=null),delete this.keyUriToKeyInfo[S],m&&m.destroy()},k}()},"./src/loader/level-details.ts":(j,M,b)=>{b.r(M),b.d(M,{LevelDetails:()=>P});var w=b("./src/polyfills/number.ts");function D(k,I){for(var T=0;T<I.length;T++){var y=I[T];y.enumerable=y.enumerable||!1,y.configurable=!0,"value"in y&&(y.writable=!0),Object.defineProperty(k,(p=y.key,S=void 0,typeof(S=function(m,v){if(typeof m!="object"||m===null)return m;var d=m[Symbol.toPrimitive];if(d!==void 0){var o=d.call(m,v||"default");if(typeof o!="object")return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return(v==="string"?String:Number)(m)}(p,"string"))=="symbol"?S:String(S)),y)}var p,S}var P=function(){function k(p){this.PTSKnown=!1,this.alignedSliding=!1,this.averagetargetduration=void 0,this.endCC=0,this.endSN=0,this.fragments=void 0,this.fragmentHint=void 0,this.partList=null,this.dateRanges=void 0,this.live=!0,this.ageHeader=0,this.advancedDateTime=void 0,this.updated=!0,this.advanced=!0,this.availabilityDelay=void 0,this.misses=0,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.url=void 0,this.m3u8="",this.version=null,this.canBlockReload=!1,this.canSkipUntil=0,this.canSkipDateRanges=!1,this.skippedSegments=0,this.recentlyRemovedDateranges=void 0,this.partHoldBack=0,this.holdBack=0,this.partTarget=0,this.preloadHint=void 0,this.renditionReports=void 0,this.tuneInGoal=0,this.deltaUpdateFailed=void 0,this.driftStartTime=0,this.driftEndTime=0,this.driftStart=0,this.driftEnd=0,this.encryptedFragments=void 0,this.fragments=[],this.encryptedFragments=[],this.dateRanges={},this.url=p}var I,T,y;return k.prototype.reloaded=function(p){if(!p)return this.advanced=!0,void(this.updated=!0);var S=this.lastPartSn-p.lastPartSn,m=this.lastPartIndex-p.lastPartIndex;this.updated=this.endSN!==p.endSN||!!m||!!S,this.advanced=this.endSN>p.endSN||S>0||S===0&&m>0,this.updated||this.advanced?this.misses=Math.floor(.6*p.misses):this.misses=p.misses+1,this.availabilityDelay=p.availabilityDelay},I=k,(T=[{key:"hasProgramDateTime",get:function(){return!!this.fragments.length&&(0,w.isFiniteNumber)(this.fragments[this.fragments.length-1].programDateTime)}},{key:"levelTargetDuration",get:function(){return this.averagetargetduration||this.targetduration||10}},{key:"drift",get:function(){var p=this.driftEndTime-this.driftStartTime;return p>0?1e3*(this.driftEnd-this.driftStart)/p:1}},{key:"edge",get:function(){return this.partEnd||this.fragmentEnd}},{key:"partEnd",get:function(){var p;return(p=this.partList)!==null&&p!==void 0&&p.length?this.partList[this.partList.length-1].end:this.fragmentEnd}},{key:"fragmentEnd",get:function(){var p;return(p=this.fragments)!==null&&p!==void 0&&p.length?this.fragments[this.fragments.length-1].end:0}},{key:"age",get:function(){return this.advancedDateTime?Math.max(Date.now()-this.advancedDateTime,0)/1e3:0}},{key:"lastPartIndex",get:function(){var p;return(p=this.partList)!==null&&p!==void 0&&p.length?this.partList[this.partList.length-1].index:-1}},{key:"lastPartSn",get:function(){var p;return(p=this.partList)!==null&&p!==void 0&&p.length?this.partList[this.partList.length-1].fragment.sn:this.endSN}}])&&D(I.prototype,T),y&&D(I,y),Object.defineProperty(I,"prototype",{writable:!1}),k}()},"./src/loader/level-key.ts":(j,M,b)=>{b.r(M),b.d(M,{LevelKey:()=>y});var w=b("./src/utils/keysystem-util.ts"),D=b("./src/utils/mediakeys-helper.ts"),P=b("./src/utils/mp4-tools.ts"),k=b("./src/utils/logger.ts"),I=b("./src/utils/numeric-encoding-utils.ts"),T={},y=function(){function p(m,v,d,o,t){o===void 0&&(o=[1]),t===void 0&&(t=null),this.uri=void 0,this.method=void 0,this.keyFormat=void 0,this.keyFormatVersions=void 0,this.encrypted=void 0,this.isCommonEncryption=void 0,this.iv=null,this.key=null,this.keyId=null,this.pssh=null,this.method=m,this.uri=v,this.keyFormat=d,this.keyFormatVersions=o,this.iv=t,this.encrypted=!!m&&m!=="NONE",this.isCommonEncryption=this.encrypted&&m!=="AES-128"}p.clearKeyUriToKeyIdMap=function(){T={}};var S=p.prototype;return S.isSupported=function(){if(this.method){if(this.method==="AES-128"||this.method==="NONE")return!0;switch(this.keyFormat){case"identity":return this.method==="SAMPLE-AES";case D.KeySystemFormats.FAIRPLAY:case D.KeySystemFormats.WIDEVINE:case D.KeySystemFormats.PLAYREADY:case D.KeySystemFormats.CLEARKEY:return["ISO-23001-7","SAMPLE-AES","SAMPLE-AES-CENC","SAMPLE-AES-CTR"].indexOf(this.method)!==-1}}return!1},S.getDecryptData=function(m){if(!this.encrypted||!this.uri)return null;if(this.method==="AES-128"&&this.uri&&!this.iv){typeof m!="number"&&(this.method!=="AES-128"||this.iv||k.logger.warn('missing IV for initialization segment with method="'+this.method+'" - compliance issue'),m=0);var v=function(e){for(var r=new Uint8Array(16),g=12;g<16;g++)r[g]=e>>8*(15-g)&255;return r}(m);return new p(this.method,this.uri,"identity",this.keyFormatVersions,v)}var d=(0,w.convertDataUriToArrayBytes)(this.uri);if(d)switch(this.keyFormat){case D.KeySystemFormats.WIDEVINE:this.pssh=d,d.length>=22&&(this.keyId=d.subarray(d.length-22,d.length-6));break;case D.KeySystemFormats.PLAYREADY:var o=new Uint8Array([154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149]);this.pssh=(0,P.mp4pssh)(o,null,d);var t=new Uint16Array(d.buffer,d.byteOffset,d.byteLength/2),n=String.fromCharCode.apply(null,Array.from(t)),u=n.substring(n.indexOf("<"),n.length),f=new DOMParser().parseFromString(u,"text/xml").getElementsByTagName("KID")[0];if(f){var h=f.childNodes[0]?f.childNodes[0].nodeValue:f.getAttribute("VALUE");if(h){var i=(0,I.base64Decode)(h).subarray(0,16);(0,w.changeEndianness)(i),this.keyId=i}}break;default:var c=d.subarray(0,16);if(c.length!==16){var l=new Uint8Array(16);l.set(c,16-c.length),c=l}this.keyId=c}if(!this.keyId||this.keyId.byteLength!==16){var a=T[this.uri];if(!a){var s=Object.keys(T).length%Number.MAX_SAFE_INTEGER;a=new Uint8Array(16),new DataView(a.buffer,12,4).setUint32(0,s),T[this.uri]=a}this.keyId=a}return this},p}()},"./src/loader/load-stats.ts":(j,M,b)=>{b.r(M),b.d(M,{LoadStats:()=>w});var w=function(){this.aborted=!1,this.loaded=0,this.retry=0,this.total=0,this.chunkCount=0,this.bwEstimate=0,this.loading={start:0,first:0,end:0},this.parsing={start:0,end:0},this.buffering={start:0,first:0,end:0}}},"./src/loader/m3u8-parser.ts":(j,M,b)=>{b.r(M),b.d(M,{default:()=>n});var w=b("./src/polyfills/number.ts"),D=b("./node_modules/url-toolkit/src/url-toolkit.js"),P=b("./src/loader/date-range.ts"),k=b("./src/loader/fragment.ts"),I=b("./src/loader/level-details.ts"),T=b("./src/loader/level-key.ts"),y=b("./src/utils/attr-list.ts"),p=b("./src/utils/logger.ts"),S=b("./src/utils/codecs.ts");function m(){return m=Object.assign?Object.assign.bind():function(a){for(var s=1;s<arguments.length;s++){var e=arguments[s];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(a[r]=e[r])}return a},m.apply(this,arguments)}var v=/#EXT-X-STREAM-INF:([^\r\n]*)(?:[\r\n](?:#[^\r\n]*)?)*([^\r\n]+)|#EXT-X-SESSION-DATA:([^\r\n]*)[\r\n]+|#EXT-X-SESSION-KEY:([^\n\r]*)[\r\n]+/g,d=/#EXT-X-MEDIA:(.*)/g,o=new RegExp([/#EXTINF:\s*(\d*(?:\.\d+)?)(?:,(.*)\s+)?/.source,/(?!#) *(\S[\S ]*)/.source,/#EXT-X-BYTERANGE:*(.+)/.source,/#EXT-X-PROGRAM-DATE-TIME:(.+)/.source,/#.*/.source].join("|"),"g"),t=new RegExp([/#(EXTM3U)/.source,/#EXT-X-(DATERANGE|KEY|MAP|PART|PART-INF|PLAYLIST-TYPE|PRELOAD-HINT|RENDITION-REPORT|SERVER-CONTROL|SKIP|START):(.+)/.source,/#EXT-X-(BITRATE|DISCONTINUITY-SEQUENCE|MEDIA-SEQUENCE|TARGETDURATION|VERSION): *(\d+)/.source,/#EXT-X-(DISCONTINUITY|ENDLIST|GAP)/.source,/(#)([^:]*):(.*)/.source,/(#)(.*)(?:.*)\r?\n?/.source].join("|")),n=function(){function a(){}return a.findGroup=function(s,e){for(var r=0;r<s.length;r++){var g=s[r];if(g.id===e)return g}},a.convertAVC1ToAVCOTI=function(s){var e=s.split(".");if(e.length>2){var r=e.shift()+".";return r+=parseInt(e.shift()).toString(16),r+=("000"+parseInt(e.shift()).toString(16)).slice(-4)}return s},a.resolve=function(s,e){return(0,D.buildAbsoluteURL)(e,s,{alwaysNormalize:!0})},a.parseMasterPlaylist=function(s,e){var r,g=[],E=[],A={},L=[],_=!1;for(v.lastIndex=0;(r=v.exec(s))!=null;)if(r[1]){var R,x=new y.AttrList(r[1]),C={attrs:x,bitrate:x.decimalInteger("AVERAGE-BANDWIDTH")||x.decimalInteger("BANDWIDTH"),name:x.NAME,url:a.resolve(r[2],e)},F=x.decimalResolution("RESOLUTION");F&&(C.width=F.width,C.height=F.height),f((x.CODECS||"").split(/[ ,]+/).filter(function(G){return G}),C),C.videoCodec&&C.videoCodec.indexOf("avc1")!==-1&&(C.videoCodec=a.convertAVC1ToAVCOTI(C.videoCodec)),(R=C.unknownCodecs)!==null&&R!==void 0&&R.length||E.push(C),g.push(C)}else if(r[3]){var O=new y.AttrList(r[3]);O["DATA-ID"]&&(_=!0,A[O["DATA-ID"]]=O)}else if(r[4]){var N=r[4],U=u(N,e);U.encrypted&&U.isSupported()?L.push(U):p.logger.warn('[Keys] Ignoring invalid EXT-X-SESSION-KEY tag: "'+N+'"')}return{levels:E.length>0&&E.length<g.length?E:g,sessionData:_?A:null,sessionKeys:L.length?L:null}},a.parseMasterPlaylistMedia=function(s,e,r,g){var E;g===void 0&&(g=[]);var A=[],L=0;for(d.lastIndex=0;(E=d.exec(s))!==null;){var _=new y.AttrList(E[1]);if(_.TYPE===r){var R={attrs:_,bitrate:0,id:L++,groupId:_["GROUP-ID"],instreamId:_["INSTREAM-ID"],name:_.NAME||_.LANGUAGE||"",type:r,default:_.bool("DEFAULT"),autoselect:_.bool("AUTOSELECT"),forced:_.bool("FORCED"),lang:_.LANGUAGE,url:_.URI?a.resolve(_.URI,e):""};if(g.length){var x=a.findGroup(g,R.groupId)||g[0];h(R,x,"audioCodec"),h(R,x,"textCodec")}A.push(R)}}return A},a.parseLevelPlaylist=function(s,e,r,g,E){var A,L,_,R=new I.LevelDetails(e),x=R.fragments,C=null,F=0,O=0,N=0,U=0,G=null,B=new k.Fragment(g,e),H=-1,V=!1;for(o.lastIndex=0,R.m3u8=s;(A=o.exec(s))!==null;){V&&(V=!1,(B=new k.Fragment(g,e)).start=N,B.sn=F,B.cc=U,B.level=r,C&&(B.initSegment=C,B.rawProgramDateTime=C.rawProgramDateTime,C.rawProgramDateTime=null));var K=A[1];if(K){B.duration=parseFloat(K);var Y=(" "+A[2]).slice(1);B.title=Y||null,B.tagList.push(Y?["INF",K,Y]:["INF",K])}else if(A[3])(0,w.isFiniteNumber)(B.duration)&&(B.start=N,_&&l(B,_,R),B.sn=F,B.level=r,B.cc=U,B.urlId=E,x.push(B),B.relurl=(" "+A[3]).slice(1),i(B,G),G=B,N+=B.duration,F++,O=0,V=!0);else if(A[4]){var q=(" "+A[4]).slice(1);G?B.setByteRange(q,G):B.setByteRange(q)}else if(A[5])B.rawProgramDateTime=(" "+A[5]).slice(1),B.tagList.push(["PROGRAM-DATE-TIME",B.rawProgramDateTime]),H===-1&&(H=x.length);else{if(!(A=A[0].match(t))){p.logger.warn("No matches on slow regex match for level playlist!");continue}for(L=1;L<A.length&&A[L]===void 0;L++);var X=(" "+A[L]).slice(1),W=(" "+A[L+1]).slice(1),Q=A[L+2]?(" "+A[L+2]).slice(1):"";switch(X){case"PLAYLIST-TYPE":R.type=W.toUpperCase();break;case"MEDIA-SEQUENCE":F=R.startSN=parseInt(W);break;case"SKIP":var z=new y.AttrList(W),$=z.decimalInteger("SKIPPED-SEGMENTS");if((0,w.isFiniteNumber)($)){R.skippedSegments=$;for(var re=$;re--;)x.unshift(null);F+=$}var Z=z.enumeratedString("RECENTLY-REMOVED-DATERANGES");Z&&(R.recentlyRemovedDateranges=Z.split("	"));break;case"TARGETDURATION":R.targetduration=parseFloat(W);break;case"VERSION":R.version=parseInt(W);break;case"EXTM3U":break;case"ENDLIST":R.live=!1;break;case"#":(W||Q)&&B.tagList.push(Q?[W,Q]:[W]);break;case"DISCONTINUITY":U++,B.tagList.push(["DIS"]);break;case"GAP":B.tagList.push([X]);break;case"BITRATE":B.tagList.push([X,W]);break;case"DATERANGE":var J=new y.AttrList(W),ee=new P.DateRange(J,R.dateRanges[J.ID]);ee.isValid||R.skippedSegments?R.dateRanges[ee.id]=ee:p.logger.warn('Ignoring invalid DATERANGE tag: "'+W+'"'),B.tagList.push(["EXT-X-DATERANGE",W]);break;case"DISCONTINUITY-SEQUENCE":U=parseInt(W);break;case"KEY":var te=u(W,e);if(te.isSupported()){if(te.method==="NONE"){_=void 0;break}_||(_={}),_[te.keyFormat]&&(_=m({},_)),_[te.keyFormat]=te}else p.logger.warn('[Keys] Ignoring invalid EXT-X-KEY tag: "'+W+'"');break;case"START":var ie=new y.AttrList(W).decimalFloatingPoint("TIME-OFFSET");(0,w.isFiniteNumber)(ie)&&(R.startTimeOffset=ie);break;case"MAP":var ne=new y.AttrList(W);if(B.duration){var se=new k.Fragment(g,e);c(se,ne,r,_),C=se,B.initSegment=C,C.rawProgramDateTime&&!B.rawProgramDateTime&&(B.rawProgramDateTime=C.rawProgramDateTime)}else c(B,ne,r,_),C=B,V=!0;break;case"SERVER-CONTROL":var de=new y.AttrList(W);R.canBlockReload=de.bool("CAN-BLOCK-RELOAD"),R.canSkipUntil=de.optionalFloat("CAN-SKIP-UNTIL",0),R.canSkipDateRanges=R.canSkipUntil>0&&de.bool("CAN-SKIP-DATERANGES"),R.partHoldBack=de.optionalFloat("PART-HOLD-BACK",0),R.holdBack=de.optionalFloat("HOLD-BACK",0);break;case"PART-INF":var ce=new y.AttrList(W);R.partTarget=ce.decimalFloatingPoint("PART-TARGET");break;case"PART":var he=R.partList;he||(he=R.partList=[]);var ae=O>0?he[he.length-1]:void 0,le=O++,pe=new k.Part(new y.AttrList(W),B,e,le,ae);he.push(pe),B.duration+=pe.duration;break;case"PRELOAD-HINT":var ye=new y.AttrList(W);R.preloadHint=ye;break;case"RENDITION-REPORT":var fe=new y.AttrList(W);R.renditionReports=R.renditionReports||[],R.renditionReports.push(fe);break;default:p.logger.warn("line parsed but not handled: "+A)}}}G&&!G.relurl?(x.pop(),N-=G.duration,R.partList&&(R.fragmentHint=G)):R.partList&&(i(B,G),B.cc=U,R.fragmentHint=B,_&&l(B,_,R));var oe=x.length,ge=x[0],Se=x[oe-1];if((N+=R.skippedSegments*R.targetduration)>0&&oe&&Se){R.averagetargetduration=N/oe;var Ee=Se.sn;R.endSN=Ee!=="initSegment"?Ee:0,R.live||(Se.endList=!0),ge&&(R.startCC=ge.cc)}else R.endSN=0,R.startCC=0;return R.fragmentHint&&(N+=R.fragmentHint.duration),R.totalduration=N,R.endCC=U,H>0&&function(ve,ke){for(var Le=ve[ke],Ie=ke;Ie--;){var be=ve[Ie];if(!be)return;be.programDateTime=Le.programDateTime-1e3*be.duration,Le=be}}(x,H),R},a}();function u(a,s){var e,r,g=new y.AttrList(a),E=(e=g.enumeratedString("METHOD"))!=null?e:"",A=g.URI,L=g.hexadecimalInteger("IV"),_=g.enumeratedString("KEYFORMATVERSIONS"),R=(r=g.enumeratedString("KEYFORMAT"))!=null?r:"identity";A&&g.IV&&!L&&p.logger.error("Invalid IV: "+g.IV);var x=A?n.resolve(A,s):"",C=(_||"1").split("/").map(Number).filter(Number.isFinite);return new T.LevelKey(E,x,R,C,L)}function f(a,s){["video","audio","text"].forEach(function(e){var r=a.filter(function(E){return(0,S.isCodecType)(E,e)});if(r.length){var g=r.filter(function(E){return E.lastIndexOf("avc1",0)===0||E.lastIndexOf("mp4a",0)===0});s[e+"Codec"]=g.length>0?g[0]:r[0],a=a.filter(function(E){return r.indexOf(E)===-1})}}),s.unknownCodecs=a}function h(a,s,e){var r=s[e];r&&(a[e]=r)}function i(a,s){a.rawProgramDateTime?a.programDateTime=Date.parse(a.rawProgramDateTime):s!=null&&s.programDateTime&&(a.programDateTime=s.endProgramDateTime),(0,w.isFiniteNumber)(a.programDateTime)||(a.programDateTime=null,a.rawProgramDateTime=null)}function c(a,s,e,r){a.relurl=s.URI,s.BYTERANGE&&a.setByteRange(s.BYTERANGE),a.level=e,a.sn="initSegment",r&&(a.levelkeys=r),a.initSegment=null}function l(a,s,e){a.levelkeys=s;var r=e.encryptedFragments;r.length&&r[r.length-1].levelkeys===s||!Object.keys(s).some(function(g){return s[g].isCommonEncryption})||r.push(a)}},"./src/loader/playlist-loader.ts":(j,M,b)=>{b.r(M),b.d(M,{default:()=>m});var w=b("./src/polyfills/number.ts"),D=b("./src/events.ts"),P=b("./src/errors.ts"),k=b("./src/utils/logger.ts"),I=b("./src/loader/m3u8-parser.ts"),T=b("./src/types/loader.ts"),y=b("./src/utils/attr-list.ts");function p(v,d){var o=v.url;return o!==void 0&&o.indexOf("data:")!==0||(o=d.url),o}var S=function(){function v(o){this.hls=void 0,this.loaders=Object.create(null),this.hls=o,this.registerListeners()}var d=v.prototype;return d.startLoad=function(o){},d.stopLoad=function(){this.destroyInternalLoaders()},d.registerListeners=function(){var o=this.hls;o.on(D.Events.MANIFEST_LOADING,this.onManifestLoading,this),o.on(D.Events.LEVEL_LOADING,this.onLevelLoading,this),o.on(D.Events.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),o.on(D.Events.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)},d.unregisterListeners=function(){var o=this.hls;o.off(D.Events.MANIFEST_LOADING,this.onManifestLoading,this),o.off(D.Events.LEVEL_LOADING,this.onLevelLoading,this),o.off(D.Events.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),o.off(D.Events.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)},d.createInternalLoader=function(o){var t=this.hls.config,n=t.pLoader,u=t.loader,f=new(n||u)(t);return o.loader=f,this.loaders[o.type]=f,f},d.getInternalLoader=function(o){return this.loaders[o.type]},d.resetInternalLoader=function(o){this.loaders[o]&&delete this.loaders[o]},d.destroyInternalLoaders=function(){for(var o in this.loaders){var t=this.loaders[o];t&&t.destroy(),this.resetInternalLoader(o)}},d.destroy=function(){this.unregisterListeners(),this.destroyInternalLoaders()},d.onManifestLoading=function(o,t){var n=t.url;this.load({id:null,groupId:null,level:0,responseType:"text",type:T.PlaylistContextType.MANIFEST,url:n,deliveryDirectives:null})},d.onLevelLoading=function(o,t){var n=t.id,u=t.level,f=t.url,h=t.deliveryDirectives;this.load({id:n,groupId:null,level:u,responseType:"text",type:T.PlaylistContextType.LEVEL,url:f,deliveryDirectives:h})},d.onAudioTrackLoading=function(o,t){var n=t.id,u=t.groupId,f=t.url,h=t.deliveryDirectives;this.load({id:n,groupId:u,level:null,responseType:"text",type:T.PlaylistContextType.AUDIO_TRACK,url:f,deliveryDirectives:h})},d.onSubtitleTrackLoading=function(o,t){var n=t.id,u=t.groupId,f=t.url,h=t.deliveryDirectives;this.load({id:n,groupId:u,level:null,responseType:"text",type:T.PlaylistContextType.SUBTITLE_TRACK,url:f,deliveryDirectives:h})},d.load=function(o){var t,n,u,f,h,i,c=this.hls.config,l=this.getInternalLoader(o);if(l){var a=l.context;if(a&&a.url===o.url)return void k.logger.trace("[playlist-loader]: playlist request ongoing");k.logger.log("[playlist-loader]: aborting previous loader for type: "+o.type),l.abort()}switch(o.type){case T.PlaylistContextType.MANIFEST:n=c.manifestLoadingMaxRetry,u=c.manifestLoadingTimeOut,f=c.manifestLoadingRetryDelay,h=c.manifestLoadingMaxRetryTimeout;break;case T.PlaylistContextType.LEVEL:case T.PlaylistContextType.AUDIO_TRACK:case T.PlaylistContextType.SUBTITLE_TRACK:n=0,u=c.levelLoadingTimeOut;break;default:n=c.levelLoadingMaxRetry,u=c.levelLoadingTimeOut,f=c.levelLoadingRetryDelay,h=c.levelLoadingMaxRetryTimeout}if(l=this.createInternalLoader(o),(t=o.deliveryDirectives)!==null&&t!==void 0&&t.part&&(o.type===T.PlaylistContextType.LEVEL&&o.level!==null?i=this.hls.levels[o.level].details:o.type===T.PlaylistContextType.AUDIO_TRACK&&o.id!==null?i=this.hls.audioTracks[o.id].details:o.type===T.PlaylistContextType.SUBTITLE_TRACK&&o.id!==null&&(i=this.hls.subtitleTracks[o.id].details),i)){var s=i.partTarget,e=i.targetduration;s&&e&&(u=Math.min(1e3*Math.max(3*s,.8*e),u))}var r={timeout:u,maxRetry:n,retryDelay:f,maxRetryDelay:h,highWaterMark:0},g={onSuccess:this.loadsuccess.bind(this),onError:this.loaderror.bind(this),onTimeout:this.loadtimeout.bind(this)};l.load(o,r,g)},d.loadsuccess=function(o,t,n,u){u===void 0&&(u=null),this.resetInternalLoader(n.type);var f=o.data;f.indexOf("#EXTM3U")===0?(t.parsing.start=performance.now(),f.indexOf("#EXTINF:")>0||f.indexOf("#EXT-X-TARGETDURATION:")>0?this.handleTrackOrLevelPlaylist(o,t,n,u):this.handleMasterPlaylist(o,t,n,u)):this.handleManifestParsingError(o,n,"no EXTM3U delimiter",u)},d.loaderror=function(o,t,n){n===void 0&&(n=null),this.handleNetworkError(t,n,!1,o)},d.loadtimeout=function(o,t,n){n===void 0&&(n=null),this.handleNetworkError(t,n,!0)},d.handleMasterPlaylist=function(o,t,n,u){var f=this.hls,h=o.data,i=p(o,n),c=I.default.parseMasterPlaylist(h,i),l=c.levels,a=c.sessionData,s=c.sessionKeys;if(l.length){var e=l.map(function(L){return{id:L.attrs.AUDIO,audioCodec:L.audioCodec}}),r=l.map(function(L){return{id:L.attrs.SUBTITLES,textCodec:L.textCodec}}),g=I.default.parseMasterPlaylistMedia(h,i,"AUDIO",e),E=I.default.parseMasterPlaylistMedia(h,i,"SUBTITLES",r),A=I.default.parseMasterPlaylistMedia(h,i,"CLOSED-CAPTIONS");g.length&&(g.some(function(L){return!L.url})||!l[0].audioCodec||l[0].attrs.AUDIO||(k.logger.log("[playlist-loader]: audio codec signaled in quality level, but no embedded audio track signaled, create one"),g.unshift({type:"main",name:"main",default:!1,autoselect:!1,forced:!1,id:-1,attrs:new y.AttrList({}),bitrate:0,url:""}))),f.trigger(D.Events.MANIFEST_LOADED,{levels:l,audioTracks:g,subtitles:E,captions:A,url:i,stats:t,networkDetails:u,sessionData:a,sessionKeys:s})}else this.handleManifestParsingError(o,n,"no level found in manifest",u)},d.handleTrackOrLevelPlaylist=function(o,t,n,u){var f=this.hls,h=n.id,i=n.level,c=n.type,l=p(o,n),a=(0,w.isFiniteNumber)(h)?h:0,s=(0,w.isFiniteNumber)(i)?i:a,e=function(E){switch(E.type){case T.PlaylistContextType.AUDIO_TRACK:return T.PlaylistLevelType.AUDIO;case T.PlaylistContextType.SUBTITLE_TRACK:return T.PlaylistLevelType.SUBTITLE;default:return T.PlaylistLevelType.MAIN}}(n),r=I.default.parseLevelPlaylist(o.data,l,s,e,a);if(r.fragments.length){if(c===T.PlaylistContextType.MANIFEST){var g={attrs:new y.AttrList({}),bitrate:0,details:r,name:"",url:l};f.trigger(D.Events.MANIFEST_LOADED,{levels:[g],audioTracks:[],url:l,stats:t,networkDetails:u,sessionData:null,sessionKeys:null})}t.parsing.end=performance.now(),n.levelDetails=r,this.handlePlaylistLoaded(o,t,n,u)}else f.trigger(D.Events.ERROR,{type:P.ErrorTypes.NETWORK_ERROR,details:P.ErrorDetails.LEVEL_EMPTY_ERROR,fatal:!1,url:l,reason:"no fragments found in level",level:typeof n.level=="number"?n.level:void 0})},d.handleManifestParsingError=function(o,t,n,u){this.hls.trigger(D.Events.ERROR,{type:P.ErrorTypes.NETWORK_ERROR,details:P.ErrorDetails.MANIFEST_PARSING_ERROR,fatal:t.type===T.PlaylistContextType.MANIFEST,url:o.url,reason:n,response:o,context:t,networkDetails:u})},d.handleNetworkError=function(o,t,n,u){n===void 0&&(n=!1),k.logger.warn("[playlist-loader]: A network "+(n?"timeout":"error")+" occurred while loading "+o.type+" level: "+o.level+" id: "+o.id+' group-id: "'+o.groupId+'"');var f=P.ErrorDetails.UNKNOWN,h=!1,i=this.getInternalLoader(o);switch(o.type){case T.PlaylistContextType.MANIFEST:f=n?P.ErrorDetails.MANIFEST_LOAD_TIMEOUT:P.ErrorDetails.MANIFEST_LOAD_ERROR,h=!0;break;case T.PlaylistContextType.LEVEL:f=n?P.ErrorDetails.LEVEL_LOAD_TIMEOUT:P.ErrorDetails.LEVEL_LOAD_ERROR,h=!1;break;case T.PlaylistContextType.AUDIO_TRACK:f=n?P.ErrorDetails.AUDIO_TRACK_LOAD_TIMEOUT:P.ErrorDetails.AUDIO_TRACK_LOAD_ERROR,h=!1;break;case T.PlaylistContextType.SUBTITLE_TRACK:f=n?P.ErrorDetails.SUBTITLE_TRACK_LOAD_TIMEOUT:P.ErrorDetails.SUBTITLE_LOAD_ERROR,h=!1}i&&this.resetInternalLoader(o.type);var c={type:P.ErrorTypes.NETWORK_ERROR,details:f,fatal:h,url:o.url,loader:i,context:o,networkDetails:t};u&&(c.response=u),this.hls.trigger(D.Events.ERROR,c)},d.handlePlaylistLoaded=function(o,t,n,u){var f=n.type,h=n.level,i=n.id,c=n.groupId,l=n.loader,a=n.levelDetails,s=n.deliveryDirectives;if(a!=null&&a.targetduration){if(l)switch(a.live&&(l.getCacheAge&&(a.ageHeader=l.getCacheAge()||0),l.getCacheAge&&!isNaN(a.ageHeader)||(a.ageHeader=0)),f){case T.PlaylistContextType.MANIFEST:case T.PlaylistContextType.LEVEL:this.hls.trigger(D.Events.LEVEL_LOADED,{details:a,level:h||0,id:i||0,stats:t,networkDetails:u,deliveryDirectives:s});break;case T.PlaylistContextType.AUDIO_TRACK:this.hls.trigger(D.Events.AUDIO_TRACK_LOADED,{details:a,id:i||0,groupId:c||"",stats:t,networkDetails:u,deliveryDirectives:s});break;case T.PlaylistContextType.SUBTITLE_TRACK:this.hls.trigger(D.Events.SUBTITLE_TRACK_LOADED,{details:a,id:i||0,groupId:c||"",stats:t,networkDetails:u,deliveryDirectives:s})}}else this.handleManifestParsingError(o,n,"invalid target duration",u)},v}();const m=S},"./src/polyfills/number.ts":(j,M,b)=>{b.r(M),b.d(M,{MAX_SAFE_INTEGER:()=>D,isFiniteNumber:()=>w});var w=Number.isFinite||function(P){return typeof P=="number"&&isFinite(P)},D=Number.MAX_SAFE_INTEGER||9007199254740991},"./src/remux/aac-helper.ts":(j,M,b)=>{b.r(M),b.d(M,{default:()=>w});const w=function(){function D(){}return D.getSilentFrame=function(P,k){if(P==="mp4a.40.2"){if(k===1)return new Uint8Array([0,200,0,128,35,128]);if(k===2)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(k===3)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(k===4)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(k===5)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(k===6)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224])}else{if(k===1)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(k===2)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(k===3)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94])}},D}()},"./src/remux/mp4-generator.ts":(j,M,b)=>{b.r(M),b.d(M,{default:()=>P});var w=Math.pow(2,32)-1,D=function(){function k(){}return k.init=function(){var I;for(I in k.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]},k.types)k.types.hasOwnProperty(I)&&(k.types[I]=[I.charCodeAt(0),I.charCodeAt(1),I.charCodeAt(2),I.charCodeAt(3)]);var T=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),y=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);k.HDLR_TYPES={video:T,audio:y};var p=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),S=new Uint8Array([0,0,0,0,0,0,0,0]);k.STTS=k.STSC=k.STCO=S,k.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),k.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),k.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),k.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);var m=new Uint8Array([105,115,111,109]),v=new Uint8Array([97,118,99,49]),d=new Uint8Array([0,0,0,1]);k.FTYP=k.box(k.types.ftyp,m,d,m,v),k.DINF=k.box(k.types.dinf,k.box(k.types.dref,p))},k.box=function(I){for(var T=8,y=arguments.length,p=new Array(y>1?y-1:0),S=1;S<y;S++)p[S-1]=arguments[S];for(var m=p.length,v=m;m--;)T+=p[m].byteLength;var d=new Uint8Array(T);for(d[0]=T>>24&255,d[1]=T>>16&255,d[2]=T>>8&255,d[3]=255&T,d.set(I,4),m=0,T=8;m<v;m++)d.set(p[m],T),T+=p[m].byteLength;return d},k.hdlr=function(I){return k.box(k.types.hdlr,k.HDLR_TYPES[I])},k.mdat=function(I){return k.box(k.types.mdat,I)},k.mdhd=function(I,T){T*=I;var y=Math.floor(T/(w+1)),p=Math.floor(T%(w+1));return k.box(k.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,I>>24&255,I>>16&255,I>>8&255,255&I,y>>24,y>>16&255,y>>8&255,255&y,p>>24,p>>16&255,p>>8&255,255&p,85,196,0,0]))},k.mdia=function(I){return k.box(k.types.mdia,k.mdhd(I.timescale,I.duration),k.hdlr(I.type),k.minf(I))},k.mfhd=function(I){return k.box(k.types.mfhd,new Uint8Array([0,0,0,0,I>>24,I>>16&255,I>>8&255,255&I]))},k.minf=function(I){return I.type==="audio"?k.box(k.types.minf,k.box(k.types.smhd,k.SMHD),k.DINF,k.stbl(I)):k.box(k.types.minf,k.box(k.types.vmhd,k.VMHD),k.DINF,k.stbl(I))},k.moof=function(I,T,y){return k.box(k.types.moof,k.mfhd(I),k.traf(y,T))},k.moov=function(I){for(var T=I.length,y=[];T--;)y[T]=k.trak(I[T]);return k.box.apply(null,[k.types.moov,k.mvhd(I[0].timescale,I[0].duration)].concat(y).concat(k.mvex(I)))},k.mvex=function(I){for(var T=I.length,y=[];T--;)y[T]=k.trex(I[T]);return k.box.apply(null,[k.types.mvex].concat(y))},k.mvhd=function(I,T){T*=I;var y=Math.floor(T/(w+1)),p=Math.floor(T%(w+1)),S=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,I>>24&255,I>>16&255,I>>8&255,255&I,y>>24,y>>16&255,y>>8&255,255&y,p>>24,p>>16&255,p>>8&255,255&p,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return k.box(k.types.mvhd,S)},k.sdtp=function(I){var T,y,p=I.samples||[],S=new Uint8Array(4+p.length);for(T=0;T<p.length;T++)y=p[T].flags,S[T+4]=y.dependsOn<<4|y.isDependedOn<<2|y.hasRedundancy;return k.box(k.types.sdtp,S)},k.stbl=function(I){return k.box(k.types.stbl,k.stsd(I),k.box(k.types.stts,k.STTS),k.box(k.types.stsc,k.STSC),k.box(k.types.stsz,k.STSZ),k.box(k.types.stco,k.STCO))},k.avc1=function(I){var T,y,p,S=[],m=[];for(T=0;T<I.sps.length;T++)p=(y=I.sps[T]).byteLength,S.push(p>>>8&255),S.push(255&p),S=S.concat(Array.prototype.slice.call(y));for(T=0;T<I.pps.length;T++)p=(y=I.pps[T]).byteLength,m.push(p>>>8&255),m.push(255&p),m=m.concat(Array.prototype.slice.call(y));var v=k.box(k.types.avcC,new Uint8Array([1,S[3],S[4],S[5],255,224|I.sps.length].concat(S).concat([I.pps.length]).concat(m))),d=I.width,o=I.height,t=I.pixelRatio[0],n=I.pixelRatio[1];return k.box(k.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,d>>8&255,255&d,o>>8&255,255&o,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),v,k.box(k.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),k.box(k.types.pasp,new Uint8Array([t>>24,t>>16&255,t>>8&255,255&t,n>>24,n>>16&255,n>>8&255,255&n])))},k.esds=function(I){var T=I.config.length;return new Uint8Array([0,0,0,0,3,23+T,0,1,0,4,15+T,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([T]).concat(I.config).concat([6,1,2]))},k.mp4a=function(I){var T=I.samplerate;return k.box(k.types.mp4a,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,I.channelCount,0,16,0,0,0,0,T>>8&255,255&T,0,0]),k.box(k.types.esds,k.esds(I)))},k.mp3=function(I){var T=I.samplerate;return k.box(k.types[".mp3"],new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,I.channelCount,0,16,0,0,0,0,T>>8&255,255&T,0,0]))},k.stsd=function(I){return I.type==="audio"?I.segmentCodec==="mp3"&&I.codec==="mp3"?k.box(k.types.stsd,k.STSD,k.mp3(I)):k.box(k.types.stsd,k.STSD,k.mp4a(I)):k.box(k.types.stsd,k.STSD,k.avc1(I))},k.tkhd=function(I){var T=I.id,y=I.duration*I.timescale,p=I.width,S=I.height,m=Math.floor(y/(w+1)),v=Math.floor(y%(w+1));return k.box(k.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,T>>24&255,T>>16&255,T>>8&255,255&T,0,0,0,0,m>>24,m>>16&255,m>>8&255,255&m,v>>24,v>>16&255,v>>8&255,255&v,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,p>>8&255,255&p,0,0,S>>8&255,255&S,0,0]))},k.traf=function(I,T){var y=k.sdtp(I),p=I.id,S=Math.floor(T/(w+1)),m=Math.floor(T%(w+1));return k.box(k.types.traf,k.box(k.types.tfhd,new Uint8Array([0,0,0,0,p>>24,p>>16&255,p>>8&255,255&p])),k.box(k.types.tfdt,new Uint8Array([1,0,0,0,S>>24,S>>16&255,S>>8&255,255&S,m>>24,m>>16&255,m>>8&255,255&m])),k.trun(I,y.length+16+20+8+16+8+8),y)},k.trak=function(I){return I.duration=I.duration||4294967295,k.box(k.types.trak,k.tkhd(I),k.mdia(I))},k.trex=function(I){var T=I.id;return k.box(k.types.trex,new Uint8Array([0,0,0,0,T>>24,T>>16&255,T>>8&255,255&T,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))},k.trun=function(I,T){var y,p,S,m,v,d,o=I.samples||[],t=o.length,n=12+16*t,u=new Uint8Array(n);for(T+=8+n,u.set([I.type==="video"?1:0,0,15,1,t>>>24&255,t>>>16&255,t>>>8&255,255&t,T>>>24&255,T>>>16&255,T>>>8&255,255&T],0),y=0;y<t;y++)S=(p=o[y]).duration,m=p.size,v=p.flags,d=p.cts,u.set([S>>>24&255,S>>>16&255,S>>>8&255,255&S,m>>>24&255,m>>>16&255,m>>>8&255,255&m,v.isLeading<<2|v.dependsOn,v.isDependedOn<<6|v.hasRedundancy<<4|v.paddingValue<<1|v.isNonSync,61440&v.degradPrio,15&v.degradPrio,d>>>24&255,d>>>16&255,d>>>8&255,255&d],12+16*y);return k.box(k.types.trun,u)},k.initSegment=function(I){k.types||k.init();var T=k.moov(I),y=new Uint8Array(k.FTYP.byteLength+T.byteLength);return y.set(k.FTYP),y.set(T,k.FTYP.byteLength),y},k}();D.types=void 0,D.HDLR_TYPES=void 0,D.STTS=void 0,D.STSC=void 0,D.STCO=void 0,D.STSZ=void 0,D.VMHD=void 0,D.SMHD=void 0,D.STSD=void 0,D.FTYP=void 0,D.DINF=void 0;const P=D},"./src/remux/mp4-remuxer.ts":(j,M,b)=>{b.r(M),b.d(M,{default:()=>d,flushTextTrackMetadataCueSamples:()=>t,flushTextTrackUserdataCueSamples:()=>n,normalizePts:()=>o});var w=b("./src/polyfills/number.ts"),D=b("./src/remux/aac-helper.ts"),P=b("./src/remux/mp4-generator.ts"),k=b("./src/events.ts"),I=b("./src/errors.ts"),T=b("./src/utils/logger.ts"),y=b("./src/types/loader.ts"),p=b("./src/utils/timescale-conversion.ts");function S(){return S=Object.assign?Object.assign.bind():function(h){for(var i=1;i<arguments.length;i++){var c=arguments[i];for(var l in c)Object.prototype.hasOwnProperty.call(c,l)&&(h[l]=c[l])}return h},S.apply(this,arguments)}var m=null,v=null,d=function(){function h(c,l,a,s){if(this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.ISGenerated=!1,this._initPTS=void 0,this._initDTS=void 0,this.nextAvcDts=null,this.nextAudioPts=null,this.videoSampleDuration=null,this.isAudioContiguous=!1,this.isVideoContiguous=!1,this.observer=c,this.config=l,this.typeSupported=a,this.ISGenerated=!1,m===null){var e=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);m=e?parseInt(e[1]):0}if(v===null){var r=navigator.userAgent.match(/Safari\/(\d+)/i);v=r?parseInt(r[1]):0}}var i=h.prototype;return i.destroy=function(){},i.resetTimeStamp=function(c){T.logger.log("[mp4-remuxer]: initPTS & initDTS reset"),this._initPTS=this._initDTS=c},i.resetNextTimestamp=function(){T.logger.log("[mp4-remuxer]: reset next timestamp"),this.isVideoContiguous=!1,this.isAudioContiguous=!1},i.resetInitSegment=function(){T.logger.log("[mp4-remuxer]: ISGenerated flag reset"),this.ISGenerated=!1},i.getVideoStartPts=function(c){var l=!1,a=c.reduce(function(s,e){var r=e.pts-s;return r<-4294967296?(l=!0,o(s,e.pts)):r>0?s:e.pts},c[0].pts);return l&&T.logger.debug("PTS rollover detected"),a},i.remux=function(c,l,a,s,e,r,g,E){var A,L,_,R,x,C,F=e,O=e,N=c.pid>-1,U=l.pid>-1,G=l.samples.length,B=c.samples.length>0,H=g&&G>0||G>1;if((!N||B)&&(!U||H)||this.ISGenerated||g){this.ISGenerated||(_=this.generateIS(c,l,e));var V,K=this.isVideoContiguous,Y=-1;if(H&&(Y=function(z){for(var $=0;$<z.length;$++)if(z[$].key)return $;return-1}(l.samples),!K&&this.config.forceKeyFrameOnDiscontinuity))if(C=!0,Y>0){T.logger.warn("[mp4-remuxer]: Dropped "+Y+" out of "+G+" video samples due to a missing keyframe");var q=this.getVideoStartPts(l.samples);l.samples=l.samples.slice(Y),l.dropped+=Y,V=O+=(l.samples[0].pts-q)/l.inputTimeScale}else Y===-1&&(T.logger.warn("[mp4-remuxer]: No keyframe found out of "+G+" video samples"),C=!1);if(this.ISGenerated){if(B&&H){var X=this.getVideoStartPts(l.samples),W=(o(c.samples[0].pts,X)-X)/l.inputTimeScale;F+=Math.max(0,W),O+=Math.max(0,-W)}if(B){if(c.samplerate||(T.logger.warn("[mp4-remuxer]: regenerate InitSegment as audio detected"),_=this.generateIS(c,l,e)),L=this.remuxAudio(c,F,this.isAudioContiguous,r,U||H||E===y.PlaylistLevelType.AUDIO?O:void 0),H){var Q=L?L.endPTS-L.startPTS:0;l.inputTimeScale||(T.logger.warn("[mp4-remuxer]: regenerate InitSegment as video detected"),_=this.generateIS(c,l,e)),A=this.remuxVideo(l,O,K,Q)}}else H&&(A=this.remuxVideo(l,O,K,0));A&&(A.firstKeyFrame=Y,A.independent=Y!==-1,A.firstKeyFramePTS=V)}}return this.ISGenerated&&(a.samples.length&&(x=t(a,e,this._initPTS,this._initDTS)),s.samples.length&&(R=n(s,e,this._initPTS))),{audio:L,video:A,initSegment:_,independent:C,text:R,id3:x}},i.generateIS=function(c,l,a){var s,e,r,g=c.samples,E=l.samples,A=this.typeSupported,L={},_=!(0,w.isFiniteNumber)(this._initPTS),R="audio/mp4";if(_&&(s=e=1/0),c.config&&g.length&&(c.timescale=c.samplerate,c.segmentCodec==="mp3"&&(A.mpeg?(R="audio/mpeg",c.codec=""):A.mp3&&(c.codec="mp3")),L.audio={id:"audio",container:R,codec:c.codec,initSegment:c.segmentCodec==="mp3"&&A.mpeg?new Uint8Array(0):P.default.initSegment([c]),metadata:{channelCount:c.channelCount}},_&&(r=c.inputTimeScale,s=e=g[0].pts-Math.round(r*a))),l.sps&&l.pps&&E.length&&(l.timescale=l.inputTimeScale,L.video={id:"main",container:"video/mp4",codec:l.codec,initSegment:P.default.initSegment([l]),metadata:{width:l.width,height:l.height}},_)){r=l.inputTimeScale;var x=this.getVideoStartPts(E),C=Math.round(r*a);e=Math.min(e,o(E[0].dts,x)-C),s=Math.min(s,x-C)}if(Object.keys(L).length)return this.ISGenerated=!0,_&&(this._initPTS=s,this._initDTS=e),{tracks:L,initPTS:s,timescale:r}},i.remuxVideo=function(c,l,a,s){var e,r,g=c.inputTimeScale,E=c.samples,A=[],L=E.length,_=this._initPTS,R=this.nextAvcDts,x=8,C=this.videoSampleDuration,F=Number.POSITIVE_INFINITY,O=Number.NEGATIVE_INFINITY,N=!1;a&&R!==null||(R=l*g-(E[0].pts-o(E[0].dts,E[0].pts)));for(var U=0;U<L;U++){var G=E[U];G.pts=o(G.pts-_,R),G.dts=o(G.dts-_,R),G.dts<E[U>0?U-1:U].dts&&(N=!0)}N&&E.sort(function(Ce,Oe){var Ke=Ce.dts-Oe.dts,He=Ce.pts-Oe.pts;return Ke||He}),e=E[0].dts;var B=(r=E[E.length-1].dts)-e,H=B?Math.round(B/(L-1)):C||c.inputTimeScale/30;if(a){var V=e-R,K=V>H,Y=V<-1;if((K||Y)&&(K?T.logger.warn("AVC: "+(0,p.toMsFromMpegTsClock)(V,!0)+" ms ("+V+"dts) hole between fragments detected, filling it"):T.logger.warn("AVC: "+(0,p.toMsFromMpegTsClock)(-V,!0)+" ms ("+V+"dts) overlapping between fragments detected"),!Y||R>E[0].pts)){e=R;var q=E[0].pts-V;E[0].dts=e,E[0].pts=q,T.logger.log("Video: First PTS/DTS adjusted: "+(0,p.toMsFromMpegTsClock)(q,!0)+"/"+(0,p.toMsFromMpegTsClock)(e,!0)+", delta: "+(0,p.toMsFromMpegTsClock)(V,!0)+" ms")}}e=Math.max(0,e);for(var X=0,W=0,Q=0;Q<L;Q++){for(var z=E[Q],$=z.units,re=$.length,Z=0,J=0;J<re;J++)Z+=$[J].data.length;W+=Z,X+=re,z.length=Z,z.dts=Math.max(z.dts,e),F=Math.min(z.pts,F),O=Math.max(z.pts,O)}r=E[L-1].dts;var ee,te=W+4*X+8;try{ee=new Uint8Array(te)}catch{return void this.observer.emit(k.Events.ERROR,k.Events.ERROR,{type:I.ErrorTypes.MUX_ERROR,details:I.ErrorDetails.REMUX_ALLOC_ERROR,fatal:!1,bytes:te,reason:"fail allocating video mdat "+te})}var ie=new DataView(ee.buffer);ie.setUint32(0,te),ee.set(P.default.types.mdat,4);for(var ne=!1,se=Number.POSITIVE_INFINITY,de=Number.POSITIVE_INFINITY,ce=Number.NEGATIVE_INFINITY,he=Number.NEGATIVE_INFINITY,ae=0;ae<L;ae++){for(var le=E[ae],pe=le.units,ye=0,fe=0,oe=pe.length;fe<oe;fe++){var ge=pe[fe],Se=ge.data,Ee=ge.data.byteLength;ie.setUint32(x,Ee),x+=4,ee.set(Se,x),x+=Ee,ye+=4+Ee}var ve=void 0;if(ae<L-1)C=E[ae+1].dts-le.dts,ve=E[ae+1].pts-le.pts;else{var ke=this.config,Le=ae>0?le.dts-E[ae-1].dts:H;if(ve=ae>0?le.pts-E[ae-1].pts:H,ke.stretchShortVideoTrack&&this.nextAudioPts!==null){var Ie=Math.floor(ke.maxBufferHole*g),be=(s?F+s*g:this.nextAudioPts)-le.pts;be>Ie?((C=be-Le)<0?C=Le:ne=!0,T.logger.log("[mp4-remuxer]: It is approximately "+be/90+" ms to the next segment; using duration "+C/90+" ms for the last video frame.")):C=Le}else C=Le}var Ne=Math.round(le.pts-le.dts);se=Math.min(se,C),ce=Math.max(ce,C),de=Math.min(de,ve),he=Math.max(he,ve),A.push(new u(le.key,C,ye,Ne))}if(A.length){if(m){if(m<70){var _e=A[0].flags;_e.dependsOn=2,_e.isNonSync=0}}else if(v&&he-de<ce-se&&H/ce<.025&&A[0].cts===0){T.logger.warn("Found irregular gaps in sample duration. Using PTS instead of DTS to determine MP4 sample duration.");for(var Re=e,me=0,we=A.length;me<we;me++){var Pe=Re+A[me].duration,Ue=Re+A[me].cts;if(me<we-1){var Be=Pe+A[me+1].cts;A[me].duration=Be-Ue}else A[me].duration=me?A[me-1].duration:H;A[me].cts=0,Re=Pe}}}console.assert(C!==null,"mp4SampleDuration must be computed"),C=ne||!C?H:C,this.nextAvcDts=R=r+C,this.videoSampleDuration=C,this.isVideoContiguous=!0;var Ge={data1:P.default.moof(c.sequenceNumber++,e,S({},c,{samples:A})),data2:ee,startPTS:F/g,endPTS:(O+C)/g,startDTS:e/g,endDTS:R/g,type:"video",hasAudio:!1,hasVideo:!0,nb:A.length,dropped:c.dropped};return c.samples=[],c.dropped=0,console.assert(ee.length,"MDAT length must not be zero"),Ge},i.remuxAudio=function(c,l,a,s,e){var r=c.inputTimeScale,g=r/(c.samplerate?c.samplerate:r),E=c.segmentCodec==="aac"?1024:1152,A=E*g,L=this._initPTS,_=c.segmentCodec==="mp3"&&this.typeSupported.mpeg,R=[],x=e!==void 0,C=c.samples,F=_?0:8,O=this.nextAudioPts||-1,N=l*r;if(this.isAudioContiguous=a=a||C.length&&O>0&&(s&&Math.abs(N-O)<9e3||Math.abs(o(C[0].pts-L,N)-O)<20*A),C.forEach(function(fe){fe.pts=o(fe.pts-L,N)}),!a||O<0){if(C=C.filter(function(fe){return fe.pts>=0}),!C.length)return;O=e===0?0:s&&!x?Math.max(0,N):C[0].pts}if(c.segmentCodec==="aac")for(var U=this.config.maxAudioFramesDrift,G=0,B=O;G<C.length;G++){var H=C[G],V=H.pts,K=V-B,Y=Math.abs(1e3*K/r);if(K<=-U*A&&x)G===0&&(T.logger.warn("Audio frame @ "+(V/r).toFixed(3)+"s overlaps nextAudioPts by "+Math.round(1e3*K/r)+" ms."),this.nextAudioPts=O=B=V);else if(K>=U*A&&Y<1e4&&x){var q=Math.round(K/A);(B=V-q*A)<0&&(q--,B+=A),G===0&&(this.nextAudioPts=O=B),T.logger.warn("[mp4-remuxer]: Injecting "+q+" audio frame @ "+(B/r).toFixed(3)+"s due to "+Math.round(1e3*K/r)+" ms gap.");for(var X=0;X<q;X++){var W=Math.max(B,0),Q=D.default.getSilentFrame(c.manifestCodec||c.codec,c.channelCount);Q||(T.logger.log("[mp4-remuxer]: Unable to get silent frame for given audio codec; duplicating last frame instead."),Q=H.unit.subarray()),C.splice(G,0,{unit:Q,pts:W}),B+=A,G++}}H.pts=B,B+=A}for(var z,$=null,re=null,Z=0,J=C.length;J--;)Z+=C[J].unit.byteLength;for(var ee=0,te=C.length;ee<te;ee++){var ie=C[ee],ne=ie.unit,se=ie.pts;if(re!==null)R[ee-1].duration=Math.round((se-re)/g);else{if(a&&c.segmentCodec==="aac"&&(se=O),$=se,!(Z>0))return;Z+=F;try{z=new Uint8Array(Z)}catch{return void this.observer.emit(k.Events.ERROR,k.Events.ERROR,{type:I.ErrorTypes.MUX_ERROR,details:I.ErrorDetails.REMUX_ALLOC_ERROR,fatal:!1,bytes:Z,reason:"fail allocating audio mdat "+Z})}_||(new DataView(z.buffer).setUint32(0,Z),z.set(P.default.types.mdat,4))}z.set(ne,F);var de=ne.byteLength;F+=de,R.push(new u(!0,E,de,0)),re=se}var ce=R.length;if(ce){var he=R[R.length-1];this.nextAudioPts=O=re+g*he.duration;var ae=_?new Uint8Array(0):P.default.moof(c.sequenceNumber++,$/g,S({},c,{samples:R}));c.samples=[];var le=$/r,pe=O/r,ye={data1:ae,data2:z,startPTS:le,endPTS:pe,startDTS:le,endDTS:pe,type:"audio",hasAudio:!0,hasVideo:!1,nb:ce};return this.isAudioContiguous=!0,console.assert(z.length,"MDAT length must not be zero"),ye}},i.remuxEmptyAudio=function(c,l,a,s){var e=c.inputTimeScale,r=e/(c.samplerate?c.samplerate:e),g=this.nextAudioPts,E=(g!==null?g:s.startDTS*e)+this._initDTS,A=s.endDTS*e+this._initDTS,L=1024*r,_=Math.ceil((A-E)/L),R=D.default.getSilentFrame(c.manifestCodec||c.codec,c.channelCount);if(T.logger.warn("[mp4-remuxer]: remux empty Audio"),R){for(var x=[],C=0;C<_;C++){var F=E+C*L;x.push({unit:R,pts:F,dts:F})}return c.samples=x,this.remuxAudio(c,l,a,!1)}T.logger.trace("[mp4-remuxer]: Unable to remuxEmptyAudio since we were unable to get a silent frame for given audio codec")},h}();function o(h,i){var c;if(i===null)return h;for(c=i<h?-8589934592:8589934592;Math.abs(h-i)>4294967296;)h+=c;return h}function t(h,i,c,l){var a=h.samples.length;if(a){for(var s=h.inputTimeScale,e=0;e<a;e++){var r=h.samples[e];r.pts=o(r.pts-c,i*s)/s,r.dts=o(r.dts-l,i*s)/s}var g=h.samples;return h.samples=[],{samples:g}}}function n(h,i,c){var l=h.samples.length;if(l){for(var a=h.inputTimeScale,s=0;s<l;s++){var e=h.samples[s];e.pts=o(e.pts-c,i*a)/a}h.samples.sort(function(g,E){return g.pts-E.pts});var r=h.samples;return h.samples=[],{samples:r}}}var u=function(h,i,c,l){this.size=void 0,this.duration=void 0,this.cts=void 0,this.flags=void 0,this.duration=i,this.size=c,this.cts=l,this.flags=new f(h)},f=function(h){this.isLeading=0,this.isDependedOn=0,this.hasRedundancy=0,this.degradPrio=0,this.dependsOn=1,this.isNonSync=1,this.dependsOn=h?2:1,this.isNonSync=h?0:1}},"./src/remux/passthrough-remuxer.ts":(j,M,b)=>{b.r(M),b.d(M,{default:()=>y});var w=b("./src/polyfills/number.ts"),D=b("./src/remux/mp4-remuxer.ts"),P=b("./src/utils/mp4-tools.ts"),k=b("./src/loader/fragment.ts"),I=b("./src/utils/logger.ts");function T(p,S){var m=p==null?void 0:p.codec;return m&&m.length>4?m:m==="hvc1"||m==="hev1"?"hvc1.1.c.L120.90":m==="av01"?"av01.0.04M.08":m==="avc1"||S===k.ElementaryStreamTypes.VIDEO?"avc1.42e01e":"mp4a.40.5"}const y=function(){function p(){this.emitInitSegment=!1,this.audioCodec=void 0,this.videoCodec=void 0,this.initData=void 0,this.initPTS=void 0,this.initTracks=void 0,this.lastEndTime=null}var S=p.prototype;return S.destroy=function(){},S.resetTimeStamp=function(m){this.initPTS=m,this.lastEndTime=null},S.resetNextTimestamp=function(){this.lastEndTime=null},S.resetInitSegment=function(m,v,d,o){this.audioCodec=v,this.videoCodec=d,this.generateInitSegment((0,P.patchEncyptionData)(m,o)),this.emitInitSegment=!0},S.generateInitSegment=function(m){var v=this.audioCodec,d=this.videoCodec;if(!m||!m.byteLength)return this.initTracks=void 0,void(this.initData=void 0);var o=this.initData=(0,P.parseInitSegment)(m);v||(v=T(o.audio,k.ElementaryStreamTypes.AUDIO)),d||(d=T(o.video,k.ElementaryStreamTypes.VIDEO));var t={};o.audio&&o.video?t.audiovideo={container:"video/mp4",codec:v+","+d,initSegment:m,id:"main"}:o.audio?t.audio={container:"audio/mp4",codec:v,initSegment:m,id:"audio"}:o.video?t.video={container:"video/mp4",codec:d,initSegment:m,id:"main"}:I.logger.warn("[passthrough-remuxer.ts]: initSegment does not contain moov or trak boxes."),this.initTracks=t},S.remux=function(m,v,d,o,t){var n,u=this.initPTS,f=this.lastEndTime,h={audio:void 0,video:void 0,text:o,id3:d,initSegment:void 0};(0,w.isFiniteNumber)(f)||(f=this.lastEndTime=t||0);var i=v.samples;if(!i||!i.length)return h;var c={initPTS:void 0,timescale:1},l=this.initData;if(l&&l.length||(this.generateInitSegment(i),l=this.initData),!l||!l.length)return I.logger.warn("[passthrough-remuxer.ts]: Failed to generate initSegment."),h;this.emitInitSegment&&(c.tracks=this.initTracks,this.emitInitSegment=!1);var a=(0,P.getStartDTS)(l,i);(0,w.isFiniteNumber)(u)||(this.initPTS=c.initPTS=u=a-t);var s=(0,P.getDuration)(i,l),e=m?a-u:f,r=e+s;(0,P.offsetStartDTS)(l,i,u),s>0?this.lastEndTime=r:(I.logger.warn("Duration parsed from mp4 should be greater than zero"),this.resetNextTimestamp());var g=!!l.audio,E=!!l.video,A="";g&&(A+="audio"),E&&(A+="video");var L={data1:i,startPTS:e,startDTS:e,endPTS:r,endDTS:r,type:A,hasAudio:g,hasVideo:E,nb:1,dropped:0};h.audio=L.type==="audio"?L:void 0,h.video=L.type!=="audio"?L:void 0,h.initSegment=c;var _=(n=this.initPTS)!=null?n:0;return h.id3=(0,D.flushTextTrackMetadataCueSamples)(d,t,_,_),o.samples.length&&(h.text=(0,D.flushTextTrackUserdataCueSamples)(o,t,_)),h},p}()},"./src/task-loop.ts":(j,M,b)=>{b.r(M),b.d(M,{default:()=>w});var w=function(){function D(){this._boundTick=void 0,this._tickTimer=null,this._tickInterval=null,this._tickCallCount=0,this._boundTick=this.tick.bind(this)}var P=D.prototype;return P.destroy=function(){this.onHandlerDestroying(),this.onHandlerDestroyed()},P.onHandlerDestroying=function(){this.clearNextTick(),this.clearInterval()},P.onHandlerDestroyed=function(){},P.hasInterval=function(){return!!this._tickInterval},P.hasNextTick=function(){return!!this._tickTimer},P.setInterval=function(k){return!this._tickInterval&&(this._tickInterval=self.setInterval(this._boundTick,k),!0)},P.clearInterval=function(){return!!this._tickInterval&&(self.clearInterval(this._tickInterval),this._tickInterval=null,!0)},P.clearNextTick=function(){return!!this._tickTimer&&(self.clearTimeout(this._tickTimer),this._tickTimer=null,!0)},P.tick=function(){this._tickCallCount++,this._tickCallCount===1&&(this.doTick(),this._tickCallCount>1&&this.tickImmediate(),this._tickCallCount=0)},P.tickImmediate=function(){this.clearNextTick(),this._tickTimer=self.setTimeout(this._boundTick,0)},P.doTick=function(){},D}()},"./src/types/cmcd.ts":(j,M,b)=>{b.r(M),b.d(M,{CMCDObjectType:()=>w,CMCDStreamType:()=>P,CMCDStreamingFormat:()=>D,CMCDVersion:()=>k});var w,D,P,k=1;(function(I){I.MANIFEST="m",I.AUDIO="a",I.VIDEO="v",I.MUXED="av",I.INIT="i",I.CAPTION="c",I.TIMED_TEXT="tt",I.KEY="k",I.OTHER="o"})(w||(w={})),function(I){I.DASH="d",I.HLS="h",I.SMOOTH="s",I.OTHER="o"}(D||(D={})),function(I){I.VOD="v",I.LIVE="l"}(P||(P={}))},"./src/types/demuxer.ts":(j,M,b)=>{var w;b.r(M),b.d(M,{MetadataSchema:()=>w}),function(D){D.audioId3="org.id3",D.dateRange="com.apple.quicktime.HLS",D.emsg="https://aomedia.org/emsg/ID3"}(w||(w={}))},"./src/types/level.ts":(j,M,b)=>{function w(y,p){for(var S=0;S<p.length;S++){var m=p[S];m.enumerable=m.enumerable||!1,m.configurable=!0,"value"in m&&(m.writable=!0),Object.defineProperty(y,(v=m.key,d=void 0,typeof(d=function(o,t){if(typeof o!="object"||o===null)return o;var n=o[Symbol.toPrimitive];if(n!==void 0){var u=n.call(o,t||"default");if(typeof u!="object")return u;throw new TypeError("@@toPrimitive must return a primitive value.")}return(t==="string"?String:Number)(o)}(v,"string"))=="symbol"?d:String(d)),m)}var v,d}b.r(M),b.d(M,{HdcpLevels:()=>P,HlsSkip:()=>D,HlsUrlParameters:()=>I,Level:()=>T,getSkipValue:()=>k});var D,P=["NONE","TYPE-0","TYPE-1","TYPE-2",null];function k(y,p){var S=y.canSkipUntil,m=y.canSkipDateRanges,v=y.endSN;return S&&(p!==void 0?p-v:0)<S?m?D.v2:D.Yes:D.No}(function(y){y.No="",y.Yes="YES",y.v2="v2"})(D||(D={}));var I=function(){function y(p,S,m){this.msn=void 0,this.part=void 0,this.skip=void 0,this.msn=p,this.part=S,this.skip=m}return y.prototype.addDirectives=function(p){var S=new self.URL(p);return this.msn!==void 0&&S.searchParams.set("_HLS_msn",this.msn.toString()),this.part!==void 0&&S.searchParams.set("_HLS_part",this.part.toString()),this.skip&&S.searchParams.set("_HLS_skip",this.skip),S.href},y}(),T=function(){function y(v){this.attrs=void 0,this.audioCodec=void 0,this.bitrate=void 0,this.codecSet=void 0,this.height=void 0,this.id=void 0,this.name=void 0,this.videoCodec=void 0,this.width=void 0,this.unknownCodecs=void 0,this.audioGroupIds=void 0,this.details=void 0,this.fragmentError=0,this.loadError=0,this.loaded=void 0,this.realBitrate=0,this.textGroupIds=void 0,this.url=void 0,this._urlId=0,this.url=[v.url],this.attrs=v.attrs,this.bitrate=v.bitrate,v.details&&(this.details=v.details),this.id=v.id||0,this.name=v.name,this.width=v.width||0,this.height=v.height||0,this.audioCodec=v.audioCodec,this.videoCodec=v.videoCodec,this.unknownCodecs=v.unknownCodecs,this.codecSet=[v.videoCodec,v.audioCodec].filter(function(d){return d}).join(",").replace(/\.[^.,]+/g,"")}var p,S,m;return p=y,(S=[{key:"maxBitrate",get:function(){return Math.max(this.realBitrate,this.bitrate)}},{key:"uri",get:function(){return this.url[this._urlId]||""}},{key:"urlId",get:function(){return this._urlId},set:function(v){var d=v%this.url.length;this._urlId!==d&&(this.details=void 0,this._urlId=d)}}])&&w(p.prototype,S),m&&w(p,m),Object.defineProperty(p,"prototype",{writable:!1}),y}()},"./src/types/loader.ts":(j,M,b)=>{var w,D;b.r(M),b.d(M,{PlaylistContextType:()=>w,PlaylistLevelType:()=>D}),function(P){P.MANIFEST="manifest",P.LEVEL="level",P.AUDIO_TRACK="audioTrack",P.SUBTITLE_TRACK="subtitleTrack"}(w||(w={})),function(P){P.MAIN="main",P.AUDIO="audio",P.SUBTITLE="subtitle"}(D||(D={}))},"./src/types/transmuxer.ts":(j,M,b)=>{b.r(M),b.d(M,{ChunkMetadata:()=>w});var w=function(D,P,k,I,T,y){I===void 0&&(I=0),T===void 0&&(T=-1),y===void 0&&(y=!1),this.level=void 0,this.sn=void 0,this.part=void 0,this.id=void 0,this.size=void 0,this.partial=void 0,this.transmuxing={start:0,executeStart:0,executeEnd:0,end:0},this.buffering={audio:{start:0,executeStart:0,executeEnd:0,end:0},video:{start:0,executeStart:0,executeEnd:0,end:0},audiovideo:{start:0,executeStart:0,executeEnd:0,end:0}},this.level=D,this.sn=P,this.id=k,this.size=I,this.part=T,this.partial=y}},"./src/utils/attr-list.ts":(j,M,b)=>{b.r(M),b.d(M,{AttrList:()=>P});var w=/^(\d+)x(\d+)$/,D=/\s*(.+?)\s*=((?:\".*?\")|.*?)(?:,|$)/g,P=function(){function k(T){for(var y in typeof T=="string"&&(T=k.parseAttrList(T)),T)T.hasOwnProperty(y)&&(this[y]=T[y])}var I=k.prototype;return I.decimalInteger=function(T){var y=parseInt(this[T],10);return y>Number.MAX_SAFE_INTEGER?1/0:y},I.hexadecimalInteger=function(T){if(this[T]){var y=(this[T]||"0x").slice(2);y=(1&y.length?"0":"")+y;for(var p=new Uint8Array(y.length/2),S=0;S<y.length/2;S++)p[S]=parseInt(y.slice(2*S,2*S+2),16);return p}return null},I.hexadecimalIntegerAsNumber=function(T){var y=parseInt(this[T],16);return y>Number.MAX_SAFE_INTEGER?1/0:y},I.decimalFloatingPoint=function(T){return parseFloat(this[T])},I.optionalFloat=function(T,y){var p=this[T];return p?parseFloat(p):y},I.enumeratedString=function(T){return this[T]},I.bool=function(T){return this[T]==="YES"},I.decimalResolution=function(T){var y=w.exec(this[T]);if(y!==null)return{width:parseInt(y[1],10),height:parseInt(y[2],10)}},k.parseAttrList=function(T){var y,p={};for(D.lastIndex=0;(y=D.exec(T))!==null;){var S=y[2];S.indexOf('"')===0&&S.lastIndexOf('"')===S.length-1&&(S=S.slice(1,-1)),p[y[1]]=S}return p},k}()},"./src/utils/binary-search.ts":(j,M,b)=>{b.r(M),b.d(M,{default:()=>w});const w={search:function(D,P){for(var k=0,I=D.length-1,T=null,y=null;k<=I;){var p=P(y=D[T=(k+I)/2|0]);if(p>0)k=T+1;else{if(!(p<0))return y;I=T-1}}return null}}},"./src/utils/buffer-helper.ts":(j,M,b)=>{b.r(M),b.d(M,{BufferHelper:()=>P});var w=b("./src/utils/logger.ts"),D={length:0,start:function(){return 0},end:function(){return 0}},P=function(){function k(){}return k.isBuffered=function(I,T){try{if(I){for(var y=k.getBuffered(I),p=0;p<y.length;p++)if(T>=y.start(p)&&T<=y.end(p))return!0}}catch{}return!1},k.bufferInfo=function(I,T,y){try{if(I){var p,S=k.getBuffered(I),m=[];for(p=0;p<S.length;p++)m.push({start:S.start(p),end:S.end(p)});return this.bufferedInfo(m,T,y)}}catch{}return{len:0,start:T,end:T,nextStart:void 0}},k.bufferedInfo=function(I,T,y){T=Math.max(0,T),I.sort(function(i,c){var l=i.start-c.start;return l||c.end-i.end});var p=[];if(y)for(var S=0;S<I.length;S++){var m=p.length;if(m){var v=p[m-1].end;I[S].start-v<y?I[S].end>v&&(p[m-1].end=I[S].end):p.push(I[S])}else p.push(I[S])}else p=I;for(var d,o=0,t=T,n=T,u=0;u<p.length;u++){var f=p[u].start,h=p[u].end;if(T+y>=f&&T<h)t=f,o=(n=h)-T;else if(T+y<f){d=f;break}}return{len:o,start:t||0,end:n||0,nextStart:d}},k.getBuffered=function(I){try{return I.buffered}catch(T){return w.logger.log("failed to get media.buffered",T),D}},k}()},"./src/utils/cea-608-parser.ts":(j,M,b)=>{b.r(M),b.d(M,{CaptionScreen:()=>f,Row:()=>u,default:()=>l});var w,D=b("./src/utils/logger.ts"),P={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},k=function(a){var s=a;return P.hasOwnProperty(a)&&(s=P[a]),String.fromCharCode(s)},I=15,T=100,y={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},p={17:2,18:4,21:6,22:8,23:10,19:13,20:15},S={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},m={25:2,26:4,29:6,30:8,31:10,27:13,28:15},v=["white","green","blue","cyan","red","yellow","magenta","black","transparent"];(function(a){a[a.ERROR=0]="ERROR",a[a.TEXT=1]="TEXT",a[a.WARNING=2]="WARNING",a[a.INFO=2]="INFO",a[a.DEBUG=3]="DEBUG",a[a.DATA=3]="DATA"})(w||(w={}));var d=function(){function a(){this.time=null,this.verboseLevel=w.ERROR}return a.prototype.log=function(s,e){if(this.verboseLevel>=s){var r=typeof e=="function"?e():e;D.logger.log(this.time+" ["+s+"] "+r)}},a}(),o=function(a){for(var s=[],e=0;e<a.length;e++)s.push(a[e].toString(16));return s},t=function(){function a(e,r,g,E,A){this.foreground=void 0,this.underline=void 0,this.italics=void 0,this.background=void 0,this.flash=void 0,this.foreground=e||"white",this.underline=r||!1,this.italics=g||!1,this.background=E||"black",this.flash=A||!1}var s=a.prototype;return s.reset=function(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1},s.setStyles=function(e){for(var r=["foreground","underline","italics","background","flash"],g=0;g<r.length;g++){var E=r[g];e.hasOwnProperty(E)&&(this[E]=e[E])}},s.isDefault=function(){return this.foreground==="white"&&!this.underline&&!this.italics&&this.background==="black"&&!this.flash},s.equals=function(e){return this.foreground===e.foreground&&this.underline===e.underline&&this.italics===e.italics&&this.background===e.background&&this.flash===e.flash},s.copy=function(e){this.foreground=e.foreground,this.underline=e.underline,this.italics=e.italics,this.background=e.background,this.flash=e.flash},s.toString=function(){return"color="+this.foreground+", underline="+this.underline+", italics="+this.italics+", background="+this.background+", flash="+this.flash},a}(),n=function(){function a(e,r,g,E,A,L){this.uchar=void 0,this.penState=void 0,this.uchar=e||" ",this.penState=new t(r,g,E,A,L)}var s=a.prototype;return s.reset=function(){this.uchar=" ",this.penState.reset()},s.setChar=function(e,r){this.uchar=e,this.penState.copy(r)},s.setPenState=function(e){this.penState.copy(e)},s.equals=function(e){return this.uchar===e.uchar&&this.penState.equals(e.penState)},s.copy=function(e){this.uchar=e.uchar,this.penState.copy(e.penState)},s.isEmpty=function(){return this.uchar===" "&&this.penState.isDefault()},a}(),u=function(){function a(e){this.chars=void 0,this.pos=void 0,this.currPenState=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chars=[];for(var r=0;r<T;r++)this.chars.push(new n);this.logger=e,this.pos=0,this.currPenState=new t}var s=a.prototype;return s.equals=function(e){for(var r=!0,g=0;g<T;g++)if(!this.chars[g].equals(e.chars[g])){r=!1;break}return r},s.copy=function(e){for(var r=0;r<T;r++)this.chars[r].copy(e.chars[r])},s.isEmpty=function(){for(var e=!0,r=0;r<T;r++)if(!this.chars[r].isEmpty()){e=!1;break}return e},s.setCursor=function(e){this.pos!==e&&(this.pos=e),this.pos<0?(this.logger.log(w.DEBUG,"Negative cursor position "+this.pos),this.pos=0):this.pos>T&&(this.logger.log(w.DEBUG,"Too large cursor position "+this.pos),this.pos=T)},s.moveCursor=function(e){var r=this.pos+e;if(e>1)for(var g=this.pos+1;g<r+1;g++)this.chars[g].setPenState(this.currPenState);this.setCursor(r)},s.backSpace=function(){this.moveCursor(-1),this.chars[this.pos].setChar(" ",this.currPenState)},s.insertChar=function(e){var r=this;e>=144&&this.backSpace();var g=k(e);this.pos>=T?this.logger.log(w.ERROR,function(){return"Cannot insert "+e.toString(16)+" ("+g+") at position "+r.pos+". Skipping it!"}):(this.chars[this.pos].setChar(g,this.currPenState),this.moveCursor(1))},s.clearFromPos=function(e){var r;for(r=e;r<T;r++)this.chars[r].reset()},s.clear=function(){this.clearFromPos(0),this.pos=0,this.currPenState.reset()},s.clearToEndOfRow=function(){this.clearFromPos(this.pos)},s.getTextString=function(){for(var e=[],r=!0,g=0;g<T;g++){var E=this.chars[g].uchar;E!==" "&&(r=!1),e.push(E)}return r?"":e.join("")},s.setPenStyles=function(e){this.currPenState.setStyles(e),this.chars[this.pos].setPenState(this.currPenState)},a}(),f=function(){function a(e){this.rows=void 0,this.currRow=void 0,this.nrRollUpRows=void 0,this.lastOutputScreen=void 0,this.logger=void 0,this.rows=[];for(var r=0;r<I;r++)this.rows.push(new u(e));this.logger=e,this.currRow=14,this.nrRollUpRows=null,this.lastOutputScreen=null,this.reset()}var s=a.prototype;return s.reset=function(){for(var e=0;e<I;e++)this.rows[e].clear();this.currRow=14},s.equals=function(e){for(var r=!0,g=0;g<I;g++)if(!this.rows[g].equals(e.rows[g])){r=!1;break}return r},s.copy=function(e){for(var r=0;r<I;r++)this.rows[r].copy(e.rows[r])},s.isEmpty=function(){for(var e=!0,r=0;r<I;r++)if(!this.rows[r].isEmpty()){e=!1;break}return e},s.backSpace=function(){this.rows[this.currRow].backSpace()},s.clearToEndOfRow=function(){this.rows[this.currRow].clearToEndOfRow()},s.insertChar=function(e){this.rows[this.currRow].insertChar(e)},s.setPen=function(e){this.rows[this.currRow].setPenStyles(e)},s.moveCursor=function(e){this.rows[this.currRow].moveCursor(e)},s.setCursor=function(e){this.logger.log(w.INFO,"setCursor: "+e),this.rows[this.currRow].setCursor(e)},s.setPAC=function(e){this.logger.log(w.INFO,function(){return"pacData = "+JSON.stringify(e)});var r=e.row-1;if(this.nrRollUpRows&&r<this.nrRollUpRows-1&&(r=this.nrRollUpRows-1),this.nrRollUpRows&&this.currRow!==r){for(var g=0;g<I;g++)this.rows[g].clear();var E=this.currRow+1-this.nrRollUpRows,A=this.lastOutputScreen;if(A){var L=A.rows[E].cueStartTime,_=this.logger.time;if(L&&_!==null&&L<_)for(var R=0;R<this.nrRollUpRows;R++)this.rows[r-this.nrRollUpRows+R+1].copy(A.rows[E+R])}}this.currRow=r;var x=this.rows[this.currRow];if(e.indent!==null){var C=e.indent,F=Math.max(C-1,0);x.setCursor(e.indent),e.color=x.chars[F].penState.foreground}var O={foreground:e.color,underline:e.underline,italics:e.italics,background:"black",flash:!1};this.setPen(O)},s.setBkgData=function(e){this.logger.log(w.INFO,function(){return"bkgData = "+JSON.stringify(e)}),this.backSpace(),this.setPen(e),this.insertChar(32)},s.setRollUpRows=function(e){this.nrRollUpRows=e},s.rollUp=function(){var e=this;if(this.nrRollUpRows!==null){this.logger.log(w.TEXT,function(){return e.getDisplayText()});var r=this.currRow+1-this.nrRollUpRows,g=this.rows.splice(r,1)[0];g.clear(),this.rows.splice(this.currRow,0,g),this.logger.log(w.INFO,"Rolling up")}else this.logger.log(w.DEBUG,"roll_up but nrRollUpRows not set yet")},s.getDisplayText=function(e){e=e||!1;for(var r=[],g="",E=-1,A=0;A<I;A++){var L=this.rows[A].getTextString();L&&(E=A+1,e?r.push("Row "+E+": '"+L+"'"):r.push(L.trim()))}return r.length>0&&(g=e?"["+r.join(" | ")+"]":r.join(`
`)),g},s.getTextAndFormat=function(){return this.rows},a}(),h=function(){function a(e,r,g){this.chNr=void 0,this.outputFilter=void 0,this.mode=void 0,this.verbose=void 0,this.displayedMemory=void 0,this.nonDisplayedMemory=void 0,this.lastOutputScreen=void 0,this.currRollUpRow=void 0,this.writeScreen=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chNr=e,this.outputFilter=r,this.mode=null,this.verbose=0,this.displayedMemory=new f(g),this.nonDisplayedMemory=new f(g),this.lastOutputScreen=new f(g),this.currRollUpRow=this.displayedMemory.rows[14],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.logger=g}var s=a.prototype;return s.reset=function(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.outputFilter.reset(),this.currRollUpRow=this.displayedMemory.rows[14],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null},s.getHandler=function(){return this.outputFilter},s.setHandler=function(e){this.outputFilter=e},s.setPAC=function(e){this.writeScreen.setPAC(e)},s.setBkgData=function(e){this.writeScreen.setBkgData(e)},s.setMode=function(e){e!==this.mode&&(this.mode=e,this.logger.log(w.INFO,function(){return"MODE="+e}),this.mode==="MODE_POP-ON"?this.writeScreen=this.nonDisplayedMemory:(this.writeScreen=this.displayedMemory,this.writeScreen.reset()),this.mode!=="MODE_ROLL-UP"&&(this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null),this.mode=e)},s.insertChars=function(e){for(var r=this,g=0;g<e.length;g++)this.writeScreen.insertChar(e[g]);var E=this.writeScreen===this.displayedMemory?"DISP":"NON_DISP";this.logger.log(w.INFO,function(){return E+": "+r.writeScreen.getDisplayText(!0)}),this.mode!=="MODE_PAINT-ON"&&this.mode!=="MODE_ROLL-UP"||(this.logger.log(w.TEXT,function(){return"DISPLAYED: "+r.displayedMemory.getDisplayText(!0)}),this.outputDataUpdate())},s.ccRCL=function(){this.logger.log(w.INFO,"RCL - Resume Caption Loading"),this.setMode("MODE_POP-ON")},s.ccBS=function(){this.logger.log(w.INFO,"BS - BackSpace"),this.mode!=="MODE_TEXT"&&(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory&&this.outputDataUpdate())},s.ccAOF=function(){},s.ccAON=function(){},s.ccDER=function(){this.logger.log(w.INFO,"DER- Delete to End of Row"),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate()},s.ccRU=function(e){this.logger.log(w.INFO,"RU("+e+") - Roll Up"),this.writeScreen=this.displayedMemory,this.setMode("MODE_ROLL-UP"),this.writeScreen.setRollUpRows(e)},s.ccFON=function(){this.logger.log(w.INFO,"FON - Flash On"),this.writeScreen.setPen({flash:!0})},s.ccRDC=function(){this.logger.log(w.INFO,"RDC - Resume Direct Captioning"),this.setMode("MODE_PAINT-ON")},s.ccTR=function(){this.logger.log(w.INFO,"TR"),this.setMode("MODE_TEXT")},s.ccRTD=function(){this.logger.log(w.INFO,"RTD"),this.setMode("MODE_TEXT")},s.ccEDM=function(){this.logger.log(w.INFO,"EDM - Erase Displayed Memory"),this.displayedMemory.reset(),this.outputDataUpdate(!0)},s.ccCR=function(){this.logger.log(w.INFO,"CR - Carriage Return"),this.writeScreen.rollUp(),this.outputDataUpdate(!0)},s.ccENM=function(){this.logger.log(w.INFO,"ENM - Erase Non-displayed Memory"),this.nonDisplayedMemory.reset()},s.ccEOC=function(){var e=this;if(this.logger.log(w.INFO,"EOC - End Of Caption"),this.mode==="MODE_POP-ON"){var r=this.displayedMemory;this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=r,this.writeScreen=this.nonDisplayedMemory,this.logger.log(w.TEXT,function(){return"DISP: "+e.displayedMemory.getDisplayText()})}this.outputDataUpdate(!0)},s.ccTO=function(e){this.logger.log(w.INFO,"TO("+e+") - Tab Offset"),this.writeScreen.moveCursor(e)},s.ccMIDROW=function(e){var r={flash:!1};if(r.underline=e%2==1,r.italics=e>=46,r.italics)r.foreground="white";else{var g=Math.floor(e/2)-16;r.foreground=["white","green","blue","cyan","red","yellow","magenta"][g]}this.logger.log(w.INFO,"MIDROW: "+JSON.stringify(r)),this.writeScreen.setPen(r)},s.outputDataUpdate=function(e){e===void 0&&(e=!1);var r=this.logger.time;r!==null&&this.outputFilter&&(this.cueStartTime!==null||this.displayedMemory.isEmpty()?this.displayedMemory.equals(this.lastOutputScreen)||(this.outputFilter.newCue(this.cueStartTime,r,this.lastOutputScreen),e&&this.outputFilter.dispatchCue&&this.outputFilter.dispatchCue(),this.cueStartTime=this.displayedMemory.isEmpty()?null:r):this.cueStartTime=r,this.lastOutputScreen.copy(this.displayedMemory))},s.cueSplitAtTime=function(e){this.outputFilter&&(this.displayedMemory.isEmpty()||(this.outputFilter.newCue&&this.outputFilter.newCue(this.cueStartTime,e,this.displayedMemory),this.cueStartTime=e))},a}();function i(a,s,e){e.a=a,e.b=s}function c(a,s,e){return e.a===a&&e.b===s}const l=function(){function a(e,r,g){this.channels=void 0,this.currentChannel=0,this.cmdHistory=void 0,this.logger=void 0;var E=new d;this.channels=[null,new h(e,r,E),new h(e+1,g,E)],this.cmdHistory={a:null,b:null},this.logger=E}var s=a.prototype;return s.getHandler=function(e){return this.channels[e].getHandler()},s.setHandler=function(e,r){this.channels[e].setHandler(r)},s.addData=function(e,r){var g,E,A,L=!1;this.logger.time=e;for(var _=0;_<r.length;_+=2)if(E=127&r[_],A=127&r[_+1],E!==0||A!==0){if(this.logger.log(w.DATA,"["+o([r[_],r[_+1]])+"] -> ("+o([E,A])+")"),(g=this.parseCmd(E,A))||(g=this.parseMidrow(E,A)),g||(g=this.parsePAC(E,A)),g||(g=this.parseBackgroundAttributes(E,A)),!g&&(L=this.parseChars(E,A))){var R=this.currentChannel;R&&R>0?this.channels[R].insertChars(L):this.logger.log(w.WARNING,"No channel found yet. TEXT-MODE?")}g||L||this.logger.log(w.WARNING,"Couldn't parse cleaned data "+o([E,A])+" orig: "+o([r[_],r[_+1]]))}},s.parseCmd=function(e,r){var g=this.cmdHistory;if(!((e===20||e===28||e===21||e===29)&&r>=32&&r<=47||(e===23||e===31)&&r>=33&&r<=35))return!1;if(c(e,r,g))return i(null,null,g),this.logger.log(w.DEBUG,"Repeated command ("+o([e,r])+") is dropped"),!0;var E=e===20||e===21||e===23?1:2,A=this.channels[E];return e===20||e===21||e===28||e===29?r===32?A.ccRCL():r===33?A.ccBS():r===34?A.ccAOF():r===35?A.ccAON():r===36?A.ccDER():r===37?A.ccRU(2):r===38?A.ccRU(3):r===39?A.ccRU(4):r===40?A.ccFON():r===41?A.ccRDC():r===42?A.ccTR():r===43?A.ccRTD():r===44?A.ccEDM():r===45?A.ccCR():r===46?A.ccENM():r===47&&A.ccEOC():A.ccTO(r-32),i(e,r,g),this.currentChannel=E,!0},s.parseMidrow=function(e,r){var g=0;if((e===17||e===25)&&r>=32&&r<=47){if((g=e===17?1:2)!==this.currentChannel)return this.logger.log(w.ERROR,"Mismatch channel in midrow parsing"),!1;var E=this.channels[g];return!!E&&(E.ccMIDROW(r),this.logger.log(w.DEBUG,"MIDROW ("+o([e,r])+")"),!0)}return!1},s.parsePAC=function(e,r){var g,E=this.cmdHistory;if(!((e>=17&&e<=23||e>=25&&e<=31)&&r>=64&&r<=127||(e===16||e===24)&&r>=64&&r<=95))return!1;if(c(e,r,E))return i(null,null,E),!0;var A=e<=23?1:2;g=r>=64&&r<=95?A===1?y[e]:S[e]:A===1?p[e]:m[e];var L=this.channels[A];return!!L&&(L.setPAC(this.interpretPAC(g,r)),i(e,r,E),this.currentChannel=A,!0)},s.interpretPAC=function(e,r){var g,E={color:null,italics:!1,indent:null,underline:!1,row:e};return g=r>95?r-96:r-64,E.underline=!(1&~g),g<=13?E.color=["white","green","blue","cyan","red","yellow","magenta","white"][Math.floor(g/2)]:g<=15?(E.italics=!0,E.color="white"):E.indent=4*Math.floor((g-16)/2),E},s.parseChars=function(e,r){var g,E,A=null,L=null;if(e>=25?(g=2,L=e-8):(g=1,L=e),L>=17&&L<=19?(E=L===17?r+80:L===18?r+112:r+144,this.logger.log(w.INFO,"Special char '"+k(E)+"' in channel "+g),A=[E]):e>=32&&e<=127&&(A=r===0?[e]:[e,r]),A){var _=o(A);this.logger.log(w.DEBUG,"Char codes =  "+_.join(",")),i(e,r,this.cmdHistory)}return A},s.parseBackgroundAttributes=function(e,r){var g;if(!((e===16||e===24)&&r>=32&&r<=47||(e===23||e===31)&&r>=45&&r<=47))return!1;var E={};e===16||e===24?(g=Math.floor((r-32)/2),E.background=v[g],r%2==1&&(E.background=E.background+"_semi")):r===45?E.background="transparent":(E.foreground="black",r===47&&(E.underline=!0));var A=e<=23?1:2;return this.channels[A].setBkgData(E),i(e,r,this.cmdHistory),!0},s.reset=function(){for(var e=0;e<Object.keys(this.channels).length;e++){var r=this.channels[e];r&&r.reset()}this.cmdHistory={a:null,b:null}},s.cueSplitAtTime=function(e){for(var r=0;r<this.channels.length;r++){var g=this.channels[r];g&&g.cueSplitAtTime(e)}},a}()},"./src/utils/codecs.ts":(j,M,b)=>{b.r(M),b.d(M,{isCodecSupportedInMp4:()=>P,isCodecType:()=>D});var w={audio:{a3ds:!0,"ac-3":!0,"ac-4":!0,alac:!0,alaw:!0,dra1:!0,"dts+":!0,"dts-":!0,dtsc:!0,dtse:!0,dtsh:!0,"ec-3":!0,enca:!0,g719:!0,g726:!0,m4ae:!0,mha1:!0,mha2:!0,mhm1:!0,mhm2:!0,mlpa:!0,mp4a:!0,"raw ":!0,Opus:!0,opus:!0,samr:!0,sawb:!0,sawp:!0,sevc:!0,sqcp:!0,ssmv:!0,twos:!0,ulaw:!0},video:{avc1:!0,avc2:!0,avc3:!0,avc4:!0,avcp:!0,av01:!0,drac:!0,dva1:!0,dvav:!0,dvh1:!0,dvhe:!0,encv:!0,hev1:!0,hvc1:!0,mjp2:!0,mp4v:!0,mvc1:!0,mvc2:!0,mvc3:!0,mvc4:!0,resv:!0,rv60:!0,s263:!0,svc1:!0,svc2:!0,"vc-1":!0,vp08:!0,vp09:!0},text:{stpp:!0,wvtt:!0}};function D(k,I){var T=w[I];return!!T&&T[k.slice(0,4)]===!0}function P(k,I){return MediaSource.isTypeSupported((I||"video")+'/mp4;codecs="'+k+'"')}},"./src/utils/cues.ts":(j,M,b)=>{b.r(M),b.d(M,{default:()=>I});var w=b("./src/utils/vttparser.ts"),D=b("./src/utils/webvtt-parser.ts"),P=b("./src/utils/texttrack-utils.ts"),k=/\s/;const I={newCue:function(T,y,p,S){for(var m,v,d,o,t,n=[],u=self.VTTCue||self.TextTrackCue,f=0;f<S.rows.length;f++)if(d=!0,o=0,t="",!(m=S.rows[f]).isEmpty()){for(var h=0;h<m.chars.length;h++)k.test(m.chars[h].uchar)&&d?o++:(t+=m.chars[h].uchar,d=!1);m.cueStartTime=y,y===p&&(p+=1e-4),o>=16?o--:o++;var i=(0,w.fixLineBreaks)(t.trim()),c=(0,D.generateCueId)(y,p,i);T&&T.cues&&T.cues.getCueById(c)||((v=new u(y,p,i)).id=c,v.line=f+1,v.align="left",v.position=10+Math.min(80,10*Math.floor(8*o/32)),n.push(v))}return T&&n.length&&(n.sort(function(l,a){return l.line==="auto"||a.line==="auto"?0:l.line>8&&a.line>8?a.line-l.line:l.line-a.line}),n.forEach(function(l){return(0,P.addCueToTrack)(T,l)})),n}}},"./src/utils/discontinuities.ts":(j,M,b)=>{b.r(M),b.d(M,{adjustSlidingStart:()=>p,alignMediaPlaylistByPDT:()=>v,alignPDT:()=>m,alignStream:()=>S,findDiscontinuousReferenceFrag:()=>T,findFirstFragWithCC:()=>k,shouldAlignOnDiscontinuities:()=>I});var w=b("./src/polyfills/number.ts"),D=b("./src/utils/logger.ts"),P=b("./src/controller/level-helper.ts");function k(d,o){for(var t=null,n=0,u=d.length;n<u;n++){var f=d[n];if(f&&f.cc===o){t=f;break}}return t}function I(d,o,t){return!(!o.details||!(t.endCC>t.startCC||d&&d.cc<t.startCC))}function T(d,o,t){var n=d.fragments,u=o.fragments;if(u.length&&n.length){var f=k(n,u[0].cc);if(f&&(!f||f.startPTS))return f;D.logger.log("No frag in previous level to align on")}else D.logger.log("No fragments to align")}function y(d,o){if(d){var t=d.start+o;d.start=d.startPTS=t,d.endPTS=t+d.duration}}function p(d,o){for(var t=o.fragments,n=0,u=t.length;n<u;n++)y(t[n],d);o.fragmentHint&&y(o.fragmentHint,d),o.alignedSliding=!0}function S(d,o,t){o&&(function(n,u,f){if(I(n,f,u)){var h=T(f.details,u);h&&(0,w.isFiniteNumber)(h.start)&&(D.logger.log("Adjusting PTS using last level due to CC increase within current level "+u.url),p(h.start,u))}}(d,t,o),!t.alignedSliding&&o.details&&m(t,o.details),t.alignedSliding||!o.details||t.skippedSegments||(0,P.adjustSliding)(o.details,t))}function m(d,o){if(o.fragments.length&&d.hasProgramDateTime&&o.hasProgramDateTime){var t=o.fragments[0].programDateTime,n=d.fragments[0].programDateTime,u=(n-t)/1e3+o.fragments[0].start;u&&(0,w.isFiniteNumber)(u)&&(D.logger.log("Adjusting PTS using programDateTime delta "+(n-t)+"ms, sliding:"+u.toFixed(3)+" "+d.url+" "),p(u,d))}}function v(d,o){if(d.hasProgramDateTime&&o.hasProgramDateTime){var t=d.fragments,n=o.fragments;if(t.length&&n.length){var u=n[Math.round(n.length/2)-1],f=k(t,u.cc)||t[Math.round(t.length/2)-1],h=u.programDateTime,i=f.programDateTime;h!==null&&i!==null&&p((i-h)/1e3-(f.start-u.start),d)}}}},"./src/utils/ewma-bandwidth-estimator.ts":(j,M,b)=>{b.r(M),b.d(M,{default:()=>D});var w=b("./src/utils/ewma.ts");const D=function(){function P(I,T,y){this.defaultEstimate_=void 0,this.minWeight_=void 0,this.minDelayMs_=void 0,this.slow_=void 0,this.fast_=void 0,this.defaultEstimate_=y,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new w.default(I),this.fast_=new w.default(T)}var k=P.prototype;return k.update=function(I,T){var y=this.slow_,p=this.fast_;this.slow_.halfLife!==I&&(this.slow_=new w.default(I,y.getEstimate(),y.getTotalWeight())),this.fast_.halfLife!==T&&(this.fast_=new w.default(T,p.getEstimate(),p.getTotalWeight()))},k.sample=function(I,T){var y=(I=Math.max(I,this.minDelayMs_))/1e3,p=8*T/y;this.fast_.sample(y,p),this.slow_.sample(y,p)},k.canEstimate=function(){var I=this.fast_;return I&&I.getTotalWeight()>=this.minWeight_},k.getEstimate=function(){return this.canEstimate()?Math.min(this.fast_.getEstimate(),this.slow_.getEstimate()):this.defaultEstimate_},k.destroy=function(){},P}()},"./src/utils/ewma.ts":(j,M,b)=>{b.r(M),b.d(M,{default:()=>w});const w=function(){function D(k,I,T){I===void 0&&(I=0),T===void 0&&(T=0),this.halfLife=void 0,this.alpha_=void 0,this.estimate_=void 0,this.totalWeight_=void 0,this.halfLife=k,this.alpha_=k?Math.exp(Math.log(.5)/k):0,this.estimate_=I,this.totalWeight_=T}var P=D.prototype;return P.sample=function(k,I){var T=Math.pow(this.alpha_,k);this.estimate_=I*(1-T)+T*this.estimate_,this.totalWeight_+=k},P.getTotalWeight=function(){return this.totalWeight_},P.getEstimate=function(){if(this.alpha_){var k=1-Math.pow(this.alpha_,this.totalWeight_);if(k)return this.estimate_/k}return this.estimate_},D}()},"./src/utils/fetch-loader.ts":(j,M,b)=>{b.r(M),b.d(M,{default:()=>o,fetchSupported:()=>S});var w=b("./src/polyfills/number.ts"),D=b("./src/loader/load-stats.ts"),P=b("./src/demux/chunk-cache.ts");function k(t){var n=typeof Map=="function"?new Map:void 0;return k=function(u){if(u===null||(f=u,Function.toString.call(f).indexOf("[native code]")===-1))return u;var f;if(typeof u!="function")throw new TypeError("Super expression must either be null or a function");if(n!==void 0){if(n.has(u))return n.get(u);n.set(u,h)}function h(){return I(u,arguments,y(this).constructor)}return h.prototype=Object.create(u.prototype,{constructor:{value:h,enumerable:!1,writable:!0,configurable:!0}}),T(h,u)},k(t)}function I(t,n,u){return I=function(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}()?Reflect.construct.bind():function(f,h,i){var c=[null];c.push.apply(c,h);var l=new(Function.bind.apply(f,c));return i&&T(l,i.prototype),l},I.apply(null,arguments)}function T(t,n){return T=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(u,f){return u.__proto__=f,u},T(t,n)}function y(t){return y=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(n){return n.__proto__||Object.getPrototypeOf(n)},y(t)}function p(){return p=Object.assign?Object.assign.bind():function(t){for(var n=1;n<arguments.length;n++){var u=arguments[n];for(var f in u)Object.prototype.hasOwnProperty.call(u,f)&&(t[f]=u[f])}return t},p.apply(this,arguments)}function S(){if(self.fetch&&self.AbortController&&self.ReadableStream&&self.Request)try{return new self.ReadableStream({}),!0}catch{}return!1}var m=function(){function t(u){this.fetchSetup=void 0,this.requestTimeout=void 0,this.request=void 0,this.response=void 0,this.controller=void 0,this.context=void 0,this.config=null,this.callbacks=null,this.stats=void 0,this.loader=null,this.fetchSetup=u.fetchSetup||v,this.controller=new self.AbortController,this.stats=new D.LoadStats}var n=t.prototype;return n.destroy=function(){this.loader=this.callbacks=null,this.abortInternal()},n.abortInternal=function(){var u=this.response;u&&u.ok||(this.stats.aborted=!0,this.controller.abort())},n.abort=function(){var u;this.abortInternal(),(u=this.callbacks)!==null&&u!==void 0&&u.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.response)},n.load=function(u,f,h){var i=this,c=this.stats;if(c.loading.start)throw new Error("Loader can only be used once.");c.loading.start=self.performance.now();var l=function(r,g){var E={method:"GET",mode:"cors",credentials:"same-origin",signal:g,headers:new self.Headers(p({},r.headers))};return r.rangeEnd&&E.headers.set("Range","bytes="+r.rangeStart+"-"+String(r.rangeEnd-1)),E}(u,this.controller.signal),a=h.onProgress,s=u.responseType==="arraybuffer",e=s?"byteLength":"length";this.context=u,this.config=f,this.callbacks=h,this.request=this.fetchSetup(u,l),self.clearTimeout(this.requestTimeout),this.requestTimeout=self.setTimeout(function(){i.abortInternal(),h.onTimeout(c,u,i.response)},f.timeout),self.fetch(this.request).then(function(r){if(i.response=i.loader=r,!r.ok){var g=r.status,E=r.statusText;throw new d(E||"fetch, bad network response",g,r)}return c.loading.first=Math.max(self.performance.now(),c.loading.start),c.total=parseInt(r.headers.get("Content-Length")||"0"),a&&(0,w.isFiniteNumber)(f.highWaterMark)?i.loadProgressively(r,c,u,f.highWaterMark,a):s?r.arrayBuffer():r.text()}).then(function(r){var g=i.response;self.clearTimeout(i.requestTimeout),c.loading.end=Math.max(self.performance.now(),c.loading.first);var E=r[e];E&&(c.loaded=c.total=E);var A={url:g.url,data:r};a&&!(0,w.isFiniteNumber)(f.highWaterMark)&&a(c,u,r,g),h.onSuccess(A,c,u,g)}).catch(function(r){if(self.clearTimeout(i.requestTimeout),!c.aborted){var g=r&&r.code||0,E=r?r.message:null;h.onError({code:g,text:E},u,r?r.details:null)}})},n.getCacheAge=function(){var u=null;if(this.response){var f=this.response.headers.get("age");u=f?parseFloat(f):null}return u},n.loadProgressively=function(u,f,h,i,c){i===void 0&&(i=0);var l=new P.default,a=u.body.getReader();return function s(){return a.read().then(function(e){if(e.done)return l.dataLength&&c(f,h,l.flush(),u),Promise.resolve(new ArrayBuffer(0));var r=e.value,g=r.length;return f.loaded+=g,g<i||l.dataLength?(l.push(r),l.dataLength>=i&&c(f,h,l.flush(),u)):c(f,h,r,u),s()}).catch(function(){return Promise.reject()})}()},t}();function v(t,n){return new self.Request(t.url,n)}var d=function(t){var n,u;function f(h,i,c){var l;return(l=t.call(this,h)||this).code=void 0,l.details=void 0,l.code=i,l.details=c,l}return u=t,(n=f).prototype=Object.create(u.prototype),n.prototype.constructor=n,T(n,u),f}(k(Error));const o=m},"./src/utils/hex.ts":(j,M,b)=>{b.r(M),b.d(M,{default:()=>w});const w={hexDump:function(D){for(var P="",k=0;k<D.length;k++){var I=D[k].toString(16);I.length<2&&(I="0"+I),P+=I}return P}}},"./src/utils/imsc1-ttml-parser.ts":(j,M,b)=>{b.r(M),b.d(M,{IMSC1_CODEC:()=>p,parseIMSC1:()=>d});var w=b("./src/utils/mp4-tools.ts"),D=b("./src/utils/vttparser.ts"),P=b("./src/utils/vttcue.ts"),k=b("./src/demux/id3.ts"),I=b("./src/utils/timescale-conversion.ts"),T=b("./src/utils/webvtt-parser.ts");function y(){return y=Object.assign?Object.assign.bind():function(i){for(var c=1;c<arguments.length;c++){var l=arguments[c];for(var a in l)Object.prototype.hasOwnProperty.call(l,a)&&(i[a]=l[a])}return i},y.apply(this,arguments)}var p="stpp.ttml.im1t",S=/^(\d{2,}):(\d{2}):(\d{2}):(\d{2})\.?(\d+)?$/,m=/^(\d*(?:\.\d*)?)(h|m|s|ms|f|t)$/,v={left:"start",center:"center",right:"end",start:"start",end:"end"};function d(i,c,l,a,s){var e=(0,w.findBox)(new Uint8Array(i),["mdat"]);if(e.length!==0){var r=e.map(function(E){return(0,k.utf8ArrayToStr)(E)}),g=(0,I.toTimescaleFromScale)(c,1,l);try{r.forEach(function(E){return a(function(A,L){var _=new DOMParser().parseFromString(A,"text/xml"),R=_.getElementsByTagName("tt")[0];if(!R)throw new Error("Invalid ttml");var x={frameRate:30,subFrameRate:1,frameRateMultiplier:0,tickRate:0},C=Object.keys(x).reduce(function(G,B){return G[B]=R.getAttribute("ttp:"+B)||x[B],G},{}),F=R.getAttribute("xml:space")!=="preserve",O=t(o(R,"styling","style")),N=t(o(R,"layout","region")),U=o(R,"body","[begin]");return[].map.call(U,function(G){var B=n(G,F);if(!B||!G.hasAttribute("begin"))return null;var H=h(G.getAttribute("begin"),C),V=h(G.getAttribute("dur"),C),K=h(G.getAttribute("end"),C);if(H===null)throw f(G);if(K===null){if(V===null)throw f(G);K=H+V}var Y=new P.default(H-L,K-L,B);Y.id=(0,T.generateCueId)(Y.startTime,Y.endTime,Y.text);var q=function(Q,z,$){var re="http://www.w3.org/ns/ttml#styling",Z=null,J=["displayAlign","textAlign","color","backgroundColor","fontSize","fontFamily"],ee=Q!=null&&Q.hasAttribute("style")?Q.getAttribute("style"):null;return ee&&$.hasOwnProperty(ee)&&(Z=$[ee]),J.reduce(function(te,ie){var ne=u(z,re,ie)||u(Q,re,ie)||u(Z,re,ie);return ne&&(te[ie]=ne),te},{})}(N[G.getAttribute("region")],O[G.getAttribute("style")],O),X=q.textAlign;if(X){var W=v[X];W&&(Y.lineAlign=W),Y.align=X}return y(Y,q),Y}).filter(function(G){return G!==null})}(E,g))})}catch(E){s(E)}}else s(new Error("Could not parse IMSC1 mdat"))}function o(i,c,l){var a=i.getElementsByTagName(c)[0];return a?[].slice.call(a.querySelectorAll(l)):[]}function t(i){return i.reduce(function(c,l){var a=l.getAttribute("xml:id");return a&&(c[a]=l),c},{})}function n(i,c){return[].slice.call(i.childNodes).reduce(function(l,a,s){var e;return a.nodeName==="br"&&s?l+`
`:(e=a.childNodes)!==null&&e!==void 0&&e.length?n(a,c):c?l+a.textContent.trim().replace(/\s+/g," "):l+a.textContent},"")}function u(i,c,l){return i&&i.hasAttributeNS(c,l)?i.getAttributeNS(c,l):null}function f(i){return new Error("Could not parse ttml timestamp "+i)}function h(i,c){if(!i)return null;var l=(0,D.parseTimeStamp)(i);return l===null&&(S.test(i)?l=function(a,s){var e=S.exec(a),r=(0|e[4])+(0|e[5])/s.subFrameRate;return 3600*(0|e[1])+60*(0|e[2])+(0|e[3])+r/s.frameRate}(i,c):m.test(i)&&(l=function(a,s){var e=m.exec(a),r=Number(e[1]);switch(e[2]){case"h":return 3600*r;case"m":return 60*r;case"ms":return 1e3*r;case"f":return r/s.frameRate;case"t":return r/s.tickRate}return r}(i,c))),l}},"./src/utils/keysystem-util.ts":(j,M,b)=>{b.r(M),b.d(M,{changeEndianness:()=>D,convertDataUriToArrayBytes:()=>P,strToUtf8array:()=>k});var w=b("./src/utils/numeric-encoding-utils.ts");function D(I){var T=function(y,p,S){var m=y[p];y[p]=y[S],y[S]=m};T(I,0,3),T(I,1,2),T(I,4,5),T(I,6,7)}function P(I){var T,y,p=I.split(":"),S=null;if(p[0]==="data"&&p.length===2){var m=p[1].split(";"),v=m[m.length-1].split(",");if(v.length===2){var d=v[0]==="base64",o=v[1];d?(m.splice(-1,1),S=(0,w.base64Decode)(o)):(T=k(o).subarray(0,16),(y=new Uint8Array(16)).set(T,16-T.length),S=y)}}return S}function k(I){return Uint8Array.from(unescape(encodeURIComponent(I)),function(T){return T.charCodeAt(0)})}},"./src/utils/logger.ts":(j,M,b)=>{b.r(M),b.d(M,{enableLogs:()=>I,logger:()=>T});var w=function(){},D={trace:w,debug:w,log:w,warn:w,info:w,error:w},P=D;function k(y){for(var p=arguments.length,S=new Array(p>1?p-1:0),m=1;m<p;m++)S[m-1]=arguments[m];S.forEach(function(v){P[v]=y[v]?y[v].bind(y):function(d){var o=self.console[d];return o?o.bind(self.console,"["+d+"] >"):w}(v)})}function I(y,p){if(self.console&&y===!0||typeof y=="object"){k(y,"debug","log","info","warn","error");try{P.log('Debug logs enabled for "'+p+'"')}catch{P=D}}else P=D}var T=D},"./src/utils/mediakeys-helper.ts":(j,M,b)=>{var w,D,P;function k(m){switch(m){case D.FAIRPLAY:return w.FAIRPLAY;case D.PLAYREADY:return w.PLAYREADY;case D.WIDEVINE:return w.WIDEVINE;case D.CLEARKEY:return w.CLEARKEY}}function I(m){if(m===P.WIDEVINE)return w.WIDEVINE}function T(m){switch(m){case w.FAIRPLAY:return D.FAIRPLAY;case w.PLAYREADY:return D.PLAYREADY;case w.WIDEVINE:return D.WIDEVINE;case w.CLEARKEY:return D.CLEARKEY}}function y(m){var v=m.drmSystems,d=m.widevineLicenseUrl,o=v?[w.FAIRPLAY,w.WIDEVINE,w.PLAYREADY,w.CLEARKEY].filter(function(t){return!!v[t]}):[];return!o[w.WIDEVINE]&&d&&o.push(w.WIDEVINE),o}b.r(M),b.d(M,{KeySystemFormats:()=>D,KeySystemIds:()=>P,KeySystems:()=>w,getKeySystemsForConfig:()=>y,getSupportedMediaKeySystemConfigurations:()=>S,keySystemDomainToKeySystemFormat:()=>T,keySystemFormatToKeySystemDomain:()=>k,keySystemIdToKeySystemDomain:()=>I,requestMediaKeySystemAccess:()=>p}),function(m){m.CLEARKEY="org.w3.clearkey",m.FAIRPLAY="com.apple.fps",m.PLAYREADY="com.microsoft.playready",m.WIDEVINE="com.widevine.alpha"}(w||(w={})),function(m){m.CLEARKEY="org.w3.clearkey",m.FAIRPLAY="com.apple.streamingkeydelivery",m.PLAYREADY="com.microsoft.playready",m.WIDEVINE="urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed"}(D||(D={})),function(m){m.WIDEVINE="edef8ba979d64acea3c827dcd51d21ed"}(P||(P={}));var p=typeof self<"u"&&self.navigator&&self.navigator.requestMediaKeySystemAccess?self.navigator.requestMediaKeySystemAccess.bind(self.navigator):null;function S(m,v,d,o){var t;switch(m){case w.FAIRPLAY:t=["cenc","sinf"];break;case w.WIDEVINE:case w.PLAYREADY:t=["cenc"];break;case w.CLEARKEY:t=["cenc","keyids"];break;default:throw new Error("Unknown key-system: "+m)}return function(n,u,f,h){var i={initDataTypes:n,persistentState:h.persistentState||"not-allowed",distinctiveIdentifier:h.distinctiveIdentifier||"not-allowed",sessionTypes:h.sessionTypes||[h.sessionType||"temporary"],audioCapabilities:u.map(function(c){return{contentType:'audio/mp4; codecs="'+c+'"',robustness:h.audioRobustness||"",encryptionScheme:h.audioEncryptionScheme||null}}),videoCapabilities:f.map(function(c){return{contentType:'video/mp4; codecs="'+c+'"',robustness:h.videoRobustness||"",encryptionScheme:h.videoEncryptionScheme||null}})};return[i]}(t,v,d,o)}},"./src/utils/mediasource-helper.ts":(j,M,b)=>{function w(){return self.MediaSource||self.WebKitMediaSource}b.r(M),b.d(M,{getMediaSource:()=>w})},"./src/utils/mp4-tools.ts":(j,M,b)=>{b.r(M),b.d(M,{RemuxerTrackIdConfig:()=>p,appendUint8Array:()=>e,bin2str:()=>S,computeRawDurationFromSamples:()=>l,discardEPB:()=>A,findBox:()=>t,getDuration:()=>c,getStartDTS:()=>i,mp4Box:()=>_,mp4pssh:()=>R,offsetStartDTS:()=>a,parseEmsg:()=>L,parseInitSegment:()=>u,parsePssh:()=>x,parseSEIMessageFromNALu:()=>E,parseSamples:()=>r,parseSegmentIndex:()=>n,parseSinf:()=>h,patchEncyptionData:()=>f,readSint32:()=>d,readUint16:()=>m,readUint32:()=>v,segmentValidRange:()=>s,writeUint32:()=>o});var w=b("./src/loader/fragment.ts"),D=b("./src/utils/typed-array.ts"),P=b("./src/demux/id3.ts"),k=b("./src/utils/logger.ts"),I=b("./src/utils/hex.ts"),T=Math.pow(2,32)-1,y=[].push,p={video:1,audio:2,id3:3,text:4};function S(C){return String.fromCharCode.apply(null,C)}function m(C,F){var O=C[F]<<8|C[F+1];return O<0?65536+O:O}function v(C,F){var O=d(C,F);return O<0?4294967296+O:O}function d(C,F){return C[F]<<24|C[F+1]<<16|C[F+2]<<8|C[F+3]}function o(C,F,O){C[F]=O>>24,C[F+1]=O>>16&255,C[F+2]=O>>8&255,C[F+3]=255&O}function t(C,F){var O=[];if(!F.length)return O;for(var N=C.byteLength,U=0;U<N;){var G=v(C,U),B=G>1?U+G:N;if(S(C.subarray(U+4,U+8))===F[0])if(F.length===1)O.push(C.subarray(U+8,B));else{var H=t(C.subarray(U+8,B),F.slice(1));H.length&&y.apply(O,H)}U=B}return O}function n(C){var F=[],O=C[0],N=8,U=v(C,N);N+=4,N+=O===0?8:16,N+=2;var G=C.length+0,B=m(C,N);N+=2;for(var H=0;H<B;H++){var V=N,K=v(C,V);V+=4;var Y=2147483647&K;if((2147483648&K)>>>31==1)return console.warn("SIDX has hierarchical references (not supported)"),null;var q=v(C,V);V+=4,F.push({referenceSize:Y,subsegmentDuration:q,info:{duration:q/U,start:G,end:G+Y-1}}),G+=Y,N=V+=4}return{earliestPresentationTime:0,timescale:U,version:O,referencesCount:B,references:F}}function u(C){for(var F=[],O=t(C,["moov","trak"]),N=0;N<O.length;N++){var U=O[N],G=t(U,["tkhd"])[0];if(G){var B=G[0],H=B===0?12:20,V=v(G,H),K=t(U,["mdia","mdhd"])[0];if(K){var Y=v(K,H=(B=K[0])===0?12:20),q=t(U,["mdia","hdlr"])[0];if(q){var X=S(q.subarray(8,12)),W={soun:w.ElementaryStreamTypes.AUDIO,vide:w.ElementaryStreamTypes.VIDEO}[X];if(W){var Q=t(U,["mdia","minf","stbl","stsd"])[0],z=void 0;Q&&(z=S(Q.subarray(12,16))),F[V]={timescale:Y,type:W},F[W]={timescale:Y,id:V,codec:z}}}}}}return t(C,["moov","mvex","trex"]).forEach(function($){var re=v($,4),Z=F[re];Z&&(Z.default={duration:v($,12),flags:v($,20)})}),F}function f(C,F){if(!C||!F)return C;var O=F.keyId;return O&&F.isCommonEncryption&&t(C,["moov","trak"]).forEach(function(N){var U=t(N,["mdia","minf","stbl","stsd"])[0].subarray(8),G=t(U,["enca"]),B=G.length>0;B||(G=t(U,["encv"])),G.forEach(function(H){t(B?H.subarray(28):H.subarray(78),["sinf"]).forEach(function(V){var K=h(V);if(K){var Y=K.subarray(8,24);Y.some(function(q){return q!==0})||(k.logger.log("[eme] Patching keyId in 'enc"+(B?"a":"v")+">sinf>>tenc' box: "+I.default.hexDump(Y)+" -> "+I.default.hexDump(O)),K.set(O,8))}})})}),C}function h(C){var F=t(C,["schm"])[0];if(F){var O=S(F.subarray(4,8));if(O==="cbcs"||O==="cenc")return t(C,["schi","tenc"])[0]}return k.logger.error("[eme] missing 'schm' box"),null}function i(C,F){return t(F,["moof","traf"]).reduce(function(O,N){var U=t(N,["tfdt"])[0],G=U[0],B=t(N,["tfhd"]).reduce(function(H,V){var K=v(V,4),Y=C[K];if(Y){var q=v(U,4);G===1&&(q*=Math.pow(2,32),q+=v(U,8));var X=q/(Y.timescale||9e4);if(isFinite(X)&&(H===null||X<H))return X}return H},null);return B!==null&&isFinite(B)&&(O===null||B<O)?B:O},null)||0}function c(C,F){for(var O=0,N=0,U=0,G=t(C,["moof","traf"]),B=0;B<G.length;B++){var H=G[B],V=t(H,["tfhd"])[0],K=F[v(V,4)];if(K){var Y=K.default,q=v(V,0)|(Y==null?void 0:Y.flags),X=Y==null?void 0:Y.duration;8&q&&(X=v(V,2&q?12:8));for(var W=K.timescale||9e4,Q=t(H,["trun"]),z=0;z<Q.length;z++)!(O=l(Q[z]))&&X&&(O=X*v(Q[z],4)),K.type===w.ElementaryStreamTypes.VIDEO?N+=O/W:K.type===w.ElementaryStreamTypes.AUDIO&&(U+=O/W)}}if(N===0&&U===0){for(var $=0,re=t(C,["sidx"]),Z=0;Z<re.length;Z++){var J=n(re[Z]);J!=null&&J.references&&($+=J.references.reduce(function(ee,te){return ee+te.info.duration||0},0))}return $}return N||U}function l(C){var F=v(C,0),O=8;1&F&&(O+=4),4&F&&(O+=4);for(var N=0,U=v(C,4),G=0;G<U;G++)256&F&&(N+=v(C,O),O+=4),512&F&&(O+=4),1024&F&&(O+=4),2048&F&&(O+=4);return N}function a(C,F,O){t(F,["moof","traf"]).forEach(function(N){t(N,["tfhd"]).forEach(function(U){var G=v(U,4),B=C[G];if(B){var H=B.timescale||9e4;t(N,["tfdt"]).forEach(function(V){var K=V[0],Y=v(V,4);if(K===0)Y-=O*H,o(V,4,Y=Math.max(Y,0));else{Y*=Math.pow(2,32),Y+=v(V,8),Y-=O*H,Y=Math.max(Y,0);var q=Math.floor(Y/(T+1)),X=Math.floor(Y%(T+1));o(V,4,q),o(V,8,X)}})}})})}function s(C){var F={valid:null,remainder:null},O=t(C,["moof"]);if(!O)return F;if(O.length<2)return F.remainder=C,F;var N=O[O.length-1];return F.valid=(0,D.sliceUint8)(C,0,N.byteOffset-8),F.remainder=(0,D.sliceUint8)(C,N.byteOffset-8),F}function e(C,F){var O=new Uint8Array(C.length+F.length);return O.set(C),O.set(F,C.length),O}function r(C,F){var O=[],N=F.samples,U=F.timescale,G=F.id,B=!1;return t(N,["moof"]).map(function(H){var V=H.byteOffset-8;t(H,["traf"]).map(function(K){var Y=t(K,["tfdt"]).map(function(q){var X=q[0],W=v(q,4);return X===1&&(W*=Math.pow(2,32),W+=v(q,8)),W/U})[0];return Y!==void 0&&(C=Y),t(K,["tfhd"]).map(function(q){var X=v(q,4),W=16777215&v(q,0),Q=0,z=!!(16&W),$=0,re=!!(32&W),Z=8;X===G&&(1&W&&(Z+=8),2&W&&(Z+=4),8&W&&(Q=v(q,Z),Z+=4),z&&($=v(q,Z),Z+=4),re&&(Z+=4),F.type==="video"&&(B=function(J){if(!J)return!1;var ee=J.indexOf("."),te=ee<0?J:J.substring(0,ee);return te==="hvc1"||te==="hev1"||te==="dvh1"||te==="dvhe"}(F.codec)),t(K,["trun"]).map(function(J){var ee=J[0],te=16777215&v(J,0),ie=!!(1&te),ne=0,se=!!(4&te),de=!!(256&te),ce=0,he=!!(512&te),ae=0,le=!!(1024&te),pe=!!(2048&te),ye=0,fe=v(J,4),oe=8;ie&&(ne=v(J,oe),oe+=4),se&&(oe+=4);for(var ge=ne+V,Se=0;Se<fe;Se++){if(de?(ce=v(J,oe),oe+=4):ce=Q,he?(ae=v(J,oe),oe+=4):ae=$,le&&(oe+=4),pe&&(ye=ee===0?v(J,oe):d(J,oe),oe+=4),F.type===w.ElementaryStreamTypes.VIDEO)for(var Ee=0;Ee<ae;){var ve=v(N,ge);g(B,N[ge+=4])&&E(N.subarray(ge,ge+ve),B?2:1,C+ye/U,O),ge+=ve,Ee+=ve+4}C+=ce/U}}))})})}),O}function g(C,F){if(C){var O=F>>1&63;return O===39||O===40}return(31&F)==6}function E(C,F,O,N){var U=A(C),G=0;G+=F;for(var B=0,H=0,V=!1,K=0;G<U.length;){B=0;do{if(G>=U.length)break;B+=K=U[G++]}while(K===255);H=0;do{if(G>=U.length)break;H+=K=U[G++]}while(K===255);var Y=U.length-G;if(!V&&B===4&&G<U.length){if(V=!0,U[G++]===181){var q=m(U,G);if(G+=2,q===49){var X=v(U,G);if(G+=4,X===1195456820){var W=U[G++];if(W===3){var Q=U[G++],z=64&Q,$=z?2+3*(31&Q):0,re=new Uint8Array($);if(z){re[0]=Q;for(var Z=1;Z<$;Z++)re[Z]=U[G++]}N.push({type:W,payloadType:B,pts:O,bytes:re})}}}}}else if(B===5&&H<Y){if(V=!0,H>16){for(var J=[],ee=0;ee<16;ee++){var te=U[G++].toString(16);J.push(te.length==1?"0"+te:te),ee!==3&&ee!==5&&ee!==7&&ee!==9||J.push("-")}for(var ie=H-16,ne=new Uint8Array(ie),se=0;se<ie;se++)ne[se]=U[G++];N.push({payloadType:B,pts:O,uuid:J.join(""),userData:(0,P.utf8ArrayToStr)(ne),userDataBytes:ne})}}else if(H<Y)G+=H;else if(H>Y)break}}function A(C){for(var F=C.byteLength,O=[],N=1;N<F-2;)C[N]===0&&C[N+1]===0&&C[N+2]===3?(O.push(N+2),N+=2):N++;if(O.length===0)return C;var U=F-O.length,G=new Uint8Array(U),B=0;for(N=0;N<U;B++,N++)B===O[0]&&(B++,O.shift()),G[N]=C[B];return G}function L(C){var F=C[0],O="",N="",U=0,G=0,B=0,H=0,V=0,K=0;if(F===0){for(;S(C.subarray(K,K+1))!=="\0";)O+=S(C.subarray(K,K+1)),K+=1;for(O+=S(C.subarray(K,K+1)),K+=1;S(C.subarray(K,K+1))!=="\0";)N+=S(C.subarray(K,K+1)),K+=1;N+=S(C.subarray(K,K+1)),K+=1,U=v(C,12),G=v(C,16),H=v(C,20),V=v(C,24),K=28}else if(F===1){U=v(C,K+=4);var Y=v(C,K+=4),q=v(C,K+=4);for(K+=4,B=Math.pow(2,32)*Y+q,Number.isSafeInteger(B)||(B=Number.MAX_SAFE_INTEGER,console.warn("Presentation time exceeds safe integer limit and wrapped to max safe integer in parsing emsg box")),H=v(C,K),V=v(C,K+=4),K+=4;S(C.subarray(K,K+1))!=="\0";)O+=S(C.subarray(K,K+1)),K+=1;for(O+=S(C.subarray(K,K+1)),K+=1;S(C.subarray(K,K+1))!=="\0";)N+=S(C.subarray(K,K+1)),K+=1;N+=S(C.subarray(K,K+1)),K+=1}return{schemeIdUri:O,value:N,timeScale:U,presentationTime:B,presentationTimeDelta:G,eventDuration:H,id:V,payload:C.subarray(K,C.byteLength)}}function _(C){for(var F=arguments.length,O=new Array(F>1?F-1:0),N=1;N<F;N++)O[N-1]=arguments[N];for(var U=O.length,G=8,B=U;B--;)G+=O[B].byteLength;var H=new Uint8Array(G);for(H[0]=G>>24&255,H[1]=G>>16&255,H[2]=G>>8&255,H[3]=255&G,H.set(C,4),B=0,G=8;B<U;B++)H.set(O[B],G),G+=O[B].byteLength;return H}function R(C,F,O){if(C.byteLength!==16)throw new RangeError("Invalid system id");var N,U,G;if(F){N=1,U=new Uint8Array(16*F.length);for(var B=0;B<F.length;B++){var H=F[B];if(H.byteLength!==16)throw new RangeError("Invalid key");U.set(H,16*B)}}else N=0,U=new Uint8Array;N>0?(G=new Uint8Array(4),F.length>0&&new DataView(G.buffer).setUint32(0,F.length,!1)):G=new Uint8Array;var V=new Uint8Array(4);return O&&O.byteLength>0&&new DataView(V.buffer).setUint32(0,O.byteLength,!1),_([112,115,115,104],new Uint8Array([N,0,0,0]),C,G,U,V,O||new Uint8Array)}function x(C){if(!(C instanceof ArrayBuffer)||C.byteLength<32)return null;var F={version:0,systemId:"",kids:null,data:null},O=new DataView(C),N=O.getUint32(0);if(C.byteLength!==N&&N>44||O.getUint32(4)!==1886614376||(F.version=O.getUint32(8)>>>24,F.version>1))return null;F.systemId=I.default.hexDump(new Uint8Array(C,12,16));var U=O.getUint32(28);if(F.version===0){if(N-32<U)return null;F.data=new Uint8Array(C,32,U)}else if(F.version===1){F.kids=[];for(var G=0;G<U;G++)F.kids.push(new Uint8Array(C,32+16*G,16))}return F}},"./src/utils/numeric-encoding-utils.ts":(j,M,b)=>{function w(y){return y.replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function D(y){return btoa(y)}function P(y){return atob(y)}function k(y){return btoa(String.fromCharCode.apply(String,y))}function I(y){return w(k(y))}function T(y){return Uint8Array.from(atob(y),function(p){return p.charCodeAt(0)})}b.r(M),b.d(M,{base64Decode:()=>T,base64DecodeToStr:()=>P,base64Encode:()=>k,base64ToBase64Url:()=>w,base64UrlEncode:()=>I,strToBase64Encode:()=>D})},"./src/utils/output-filter.ts":(j,M,b)=>{b.r(M),b.d(M,{default:()=>w});var w=function(){function D(k,I){this.timelineController=void 0,this.cueRanges=[],this.trackName=void 0,this.startTime=null,this.endTime=null,this.screen=null,this.timelineController=k,this.trackName=I}var P=D.prototype;return P.dispatchCue=function(){this.startTime!==null&&(this.timelineController.addCues(this.trackName,this.startTime,this.endTime,this.screen,this.cueRanges),this.startTime=null)},P.newCue=function(k,I,T){(this.startTime===null||this.startTime>k)&&(this.startTime=k),this.endTime=I,this.screen=T,this.timelineController.createCaptionsTrack(this.trackName)},P.reset=function(){this.cueRanges=[],this.startTime=null},D}()},"./src/utils/texttrack-utils.ts":(j,M,b)=>{b.r(M),b.d(M,{addCueToTrack:()=>P,clearCurrentCues:()=>k,getCuesInRange:()=>T,removeCuesInRange:()=>I,sendAddTrackEvent:()=>D});var w=b("./src/utils/logger.ts");function D(y,p){var S;try{S=new Event("addtrack")}catch{(S=document.createEvent("Event")).initEvent("addtrack",!1,!1)}S.track=y,p.dispatchEvent(S)}function P(y,p){var S=y.mode;if(S==="disabled"&&(y.mode="hidden"),y.cues&&!y.cues.getCueById(p.id))try{if(y.addCue(p),!y.cues.getCueById(p.id))throw new Error("addCue is failed for: "+p)}catch(v){w.logger.debug("[texttrack-utils]: "+v);var m=new self.TextTrackCue(p.startTime,p.endTime,p.text);m.id=p.id,y.addCue(m)}S==="disabled"&&(y.mode=S)}function k(y){var p=y.mode;if(p==="disabled"&&(y.mode="hidden"),y.cues)for(var S=y.cues.length;S--;)y.removeCue(y.cues[S]);p==="disabled"&&(y.mode=p)}function I(y,p,S,m){var v=y.mode;if(v==="disabled"&&(y.mode="hidden"),y.cues&&y.cues.length>0)for(var d=T(y.cues,p,S),o=0;o<d.length;o++)m&&!m(d[o])||y.removeCue(d[o]);v==="disabled"&&(y.mode=v)}function T(y,p,S){var m=[],v=function(n,u){if(u<n[0].startTime)return 0;var f=n.length-1;if(u>n[f].endTime)return-1;for(var h=0,i=f;h<=i;){var c=Math.floor((i+h)/2);if(u<n[c].startTime)i=c-1;else{if(!(u>n[c].startTime&&h<f))return c;h=c+1}}return n[h].startTime-u<u-n[i].startTime?h:i}(y,p);if(v>-1)for(var d=v,o=y.length;d<o;d++){var t=y[d];if(t.startTime>=p&&t.endTime<=S)m.push(t);else if(t.startTime>S)return m}return m}},"./src/utils/time-ranges.ts":(j,M,b)=>{b.r(M),b.d(M,{default:()=>w});const w={toString:function(D){for(var P="",k=D.length,I=0;I<k;I++)P+="["+D.start(I).toFixed(3)+"-"+D.end(I).toFixed(3)+"]";return P}}},"./src/utils/timescale-conversion.ts":(j,M,b)=>{b.r(M),b.d(M,{toMpegTsClockFromTimescale:()=>I,toMsFromMpegTsClock:()=>k,toTimescaleFromBase:()=>D,toTimescaleFromScale:()=>P});var w=9e4;function D(T,y,p,S){p===void 0&&(p=1),S===void 0&&(S=!1);var m=T*y*p;return S?Math.round(m):m}function P(T,y,p,S){return p===void 0&&(p=1),S===void 0&&(S=!1),D(T,y,1/p,S)}function k(T,y){return y===void 0&&(y=!1),D(T,1e3,1/w,y)}function I(T,y){return y===void 0&&(y=1),D(T,w,1/y)}},"./src/utils/typed-array.ts":(j,M,b)=>{function w(D,P,k){return Uint8Array.prototype.slice?D.slice(P,k):new Uint8Array(Array.prototype.slice.call(D,P,k))}b.r(M),b.d(M,{sliceUint8:()=>w})},"./src/utils/vttcue.ts":(j,M,b)=>{b.r(M),b.d(M,{default:()=>w});const w=function(){if(typeof self<"u"&&self.VTTCue)return self.VTTCue;var D=["","lr","rl"],P=["start","middle","end","left","right"];function k(p,S){if(typeof S!="string"||!Array.isArray(p))return!1;var m=S.toLowerCase();return!!~p.indexOf(m)&&m}function I(p){return k(P,p)}function T(p){for(var S=arguments.length,m=new Array(S>1?S-1:0),v=1;v<S;v++)m[v-1]=arguments[v];for(var d=1;d<arguments.length;d++){var o=arguments[d];for(var t in o)p[t]=o[t]}return p}function y(p,S,m){var v=this,d={enumerable:!0};v.hasBeenReset=!1;var o="",t=!1,n=p,u=S,f=m,h=null,i="",c=!0,l="auto",a="start",s=50,e="middle",r=50,g="middle";Object.defineProperty(v,"id",T({},d,{get:function(){return o},set:function(E){o=""+E}})),Object.defineProperty(v,"pauseOnExit",T({},d,{get:function(){return t},set:function(E){t=!!E}})),Object.defineProperty(v,"startTime",T({},d,{get:function(){return n},set:function(E){if(typeof E!="number")throw new TypeError("Start time must be set to a number.");n=E,this.hasBeenReset=!0}})),Object.defineProperty(v,"endTime",T({},d,{get:function(){return u},set:function(E){if(typeof E!="number")throw new TypeError("End time must be set to a number.");u=E,this.hasBeenReset=!0}})),Object.defineProperty(v,"text",T({},d,{get:function(){return f},set:function(E){f=""+E,this.hasBeenReset=!0}})),Object.defineProperty(v,"region",T({},d,{get:function(){return h},set:function(E){h=E,this.hasBeenReset=!0}})),Object.defineProperty(v,"vertical",T({},d,{get:function(){return i},set:function(E){var A=function(L){return k(D,L)}(E);if(A===!1)throw new SyntaxError("An invalid or illegal string was specified.");i=A,this.hasBeenReset=!0}})),Object.defineProperty(v,"snapToLines",T({},d,{get:function(){return c},set:function(E){c=!!E,this.hasBeenReset=!0}})),Object.defineProperty(v,"line",T({},d,{get:function(){return l},set:function(E){if(typeof E!="number"&&E!=="auto")throw new SyntaxError("An invalid number or illegal string was specified.");l=E,this.hasBeenReset=!0}})),Object.defineProperty(v,"lineAlign",T({},d,{get:function(){return a},set:function(E){var A=I(E);if(!A)throw new SyntaxError("An invalid or illegal string was specified.");a=A,this.hasBeenReset=!0}})),Object.defineProperty(v,"position",T({},d,{get:function(){return s},set:function(E){if(E<0||E>100)throw new Error("Position must be between 0 and 100.");s=E,this.hasBeenReset=!0}})),Object.defineProperty(v,"positionAlign",T({},d,{get:function(){return e},set:function(E){var A=I(E);if(!A)throw new SyntaxError("An invalid or illegal string was specified.");e=A,this.hasBeenReset=!0}})),Object.defineProperty(v,"size",T({},d,{get:function(){return r},set:function(E){if(E<0||E>100)throw new Error("Size must be between 0 and 100.");r=E,this.hasBeenReset=!0}})),Object.defineProperty(v,"align",T({},d,{get:function(){return g},set:function(E){var A=I(E);if(!A)throw new SyntaxError("An invalid or illegal string was specified.");g=A,this.hasBeenReset=!0}})),v.displayState=void 0}return y.prototype.getCueAsHTML=function(){return self.WebVTT.convertCueToDOMTree(self,this.text)},y}()},"./src/utils/vttparser.ts":(j,M,b)=>{b.r(M),b.d(M,{VTTParser:()=>m,fixLineBreaks:()=>S,parseTimeStamp:()=>P});var w=b("./src/utils/vttcue.ts"),D=function(){function v(){}return v.prototype.decode=function(d,o){if(!d)return"";if(typeof d!="string")throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(d))},v}();function P(v){function d(t,n,u,f){return 3600*(0|t)+60*(0|n)+(0|u)+parseFloat(f||0)}var o=v.match(/^(?:(\d+):)?(\d{2}):(\d{2})(\.\d+)?/);return o?parseFloat(o[2])>59?d(o[2],o[3],0,o[4]):d(o[1],o[2],o[3],o[4]):null}var k=function(){function v(){this.values=Object.create(null)}var d=v.prototype;return d.set=function(o,t){this.get(o)||t===""||(this.values[o]=t)},d.get=function(o,t,n){return n?this.has(o)?this.values[o]:t[n]:this.has(o)?this.values[o]:t},d.has=function(o){return o in this.values},d.alt=function(o,t,n){for(var u=0;u<n.length;++u)if(t===n[u]){this.set(o,t);break}},d.integer=function(o,t){/^-?\d+$/.test(t)&&this.set(o,parseInt(t,10))},d.percent=function(o,t){if(/^([\d]{1,3})(\.[\d]*)?%$/.test(t)){var n=parseFloat(t);if(n>=0&&n<=100)return this.set(o,n),!0}return!1},v}();function I(v,d,o,t){var n=t?v.split(t):[v];for(var u in n)if(typeof n[u]=="string"){var f=n[u].split(o);f.length===2&&d(f[0],f[1])}}var T=new w.default(0,0,""),y=T.align==="middle"?"middle":"center";function p(v,d,o){var t=v;function n(){var f=P(v);if(f===null)throw new Error("Malformed timestamp: "+t);return v=v.replace(/^[^\sa-zA-Z-]+/,""),f}function u(){v=v.replace(/^\s+/,"")}if(u(),d.startTime=n(),u(),v.slice(0,3)!=="-->")throw new Error("Malformed time stamp (time stamps must be separated by '-->'): "+t);v=v.slice(3),u(),d.endTime=n(),u(),function(f,h){var i=new k;I(f,function(a,s){var e;switch(a){case"region":for(var r=o.length-1;r>=0;r--)if(o[r].id===s){i.set(a,o[r].region);break}break;case"vertical":i.alt(a,s,["rl","lr"]);break;case"line":e=s.split(","),i.integer(a,e[0]),i.percent(a,e[0])&&i.set("snapToLines",!1),i.alt(a,e[0],["auto"]),e.length===2&&i.alt("lineAlign",e[1],["start",y,"end"]);break;case"position":e=s.split(","),i.percent(a,e[0]),e.length===2&&i.alt("positionAlign",e[1],["start",y,"end","line-left","line-right","auto"]);break;case"size":i.percent(a,s);break;case"align":i.alt(a,s,["start",y,"end","left","right"])}},/:/,/\s/),h.region=i.get("region",null),h.vertical=i.get("vertical","");var c=i.get("line","auto");c==="auto"&&T.line===-1&&(c=-1),h.line=c,h.lineAlign=i.get("lineAlign","start"),h.snapToLines=i.get("snapToLines",!0),h.size=i.get("size",100),h.align=i.get("align",y);var l=i.get("position","auto");l==="auto"&&T.position===50&&(l=h.align==="start"||h.align==="left"?0:h.align==="end"||h.align==="right"?100:50),h.position=l}(v,d)}function S(v){return v.replace(/<br(?: \/)?>/gi,`
`)}var m=function(){function v(){this.state="INITIAL",this.buffer="",this.decoder=new D,this.regionList=[],this.cue=null,this.oncue=void 0,this.onparsingerror=void 0,this.onflush=void 0}var d=v.prototype;return d.parse=function(o){var t=this;function n(){var c=t.buffer,l=0;for(c=S(c);l<c.length&&c[l]!=="\r"&&c[l]!==`
`;)++l;var a=c.slice(0,l);return c[l]==="\r"&&++l,c[l]===`
`&&++l,t.buffer=c.slice(l),a}o&&(t.buffer+=t.decoder.decode(o,{stream:!0}));try{var u="";if(t.state==="INITIAL"){if(!/\r\n|\n/.test(t.buffer))return this;var f=(u=n()).match(/^()?WEBVTT([ \t].*)?$/);if(!f||!f[0])throw new Error("Malformed WebVTT signature.");t.state="HEADER"}for(var h=!1;t.buffer;){if(!/\r\n|\n/.test(t.buffer))return this;switch(h?h=!1:u=n(),t.state){case"HEADER":/:/.test(u)?I(u,function(c,l){},/:/):u||(t.state="ID");continue;case"NOTE":u||(t.state="ID");continue;case"ID":if(/^NOTE($|[ \t])/.test(u)){t.state="NOTE";break}if(!u)continue;if(t.cue=new w.default(0,0,""),t.state="CUE",u.indexOf("-->")===-1){t.cue.id=u;continue}case"CUE":if(!t.cue){t.state="BADCUE";continue}try{p(u,t.cue,t.regionList)}catch{t.cue=null,t.state="BADCUE";continue}t.state="CUETEXT";continue;case"CUETEXT":var i=u.indexOf("-->")!==-1;if(!u||i&&(h=!0)){t.oncue&&t.cue&&t.oncue(t.cue),t.cue=null,t.state="ID";continue}if(t.cue===null)continue;t.cue.text&&(t.cue.text+=`
`),t.cue.text+=u;continue;case"BADCUE":u||(t.state="ID")}}}catch{t.state==="CUETEXT"&&t.cue&&t.oncue&&t.oncue(t.cue),t.cue=null,t.state=t.state==="INITIAL"?"BADWEBVTT":"BADCUE"}return this},d.flush=function(){var o=this;try{if((o.cue||o.state==="HEADER")&&(o.buffer+=`

`,o.parse()),o.state==="INITIAL"||o.state==="BADWEBVTT")throw new Error("Malformed WebVTT signature.")}catch(t){o.onparsingerror&&o.onparsingerror(t)}return o.onflush&&o.onflush(),this},v}()},"./src/utils/webvtt-parser.ts":(j,M,b)=>{b.r(M),b.d(M,{generateCueId:()=>m,parseWebVTT:()=>d});var w=b("./src/polyfills/number.ts"),D=b("./src/utils/vttparser.ts"),P=b("./src/demux/id3.ts"),k=b("./src/utils/timescale-conversion.ts"),I=b("./src/remux/mp4-remuxer.ts"),T=/\r\n|\n\r|\n|\r/g,y=function(o,t,n){return n===void 0&&(n=0),o.slice(n,n+t.length)===t},p=function(o){var t=parseInt(o.slice(-3)),n=parseInt(o.slice(-6,-4)),u=parseInt(o.slice(-9,-7)),f=o.length>9?parseInt(o.substring(0,o.indexOf(":"))):0;if(!((0,w.isFiniteNumber)(t)&&(0,w.isFiniteNumber)(n)&&(0,w.isFiniteNumber)(u)&&(0,w.isFiniteNumber)(f)))throw Error("Malformed X-TIMESTAMP-MAP: Local:"+o);return t+=1e3*n,t+=6e4*u,t+=36e5*f},S=function(o){for(var t=5381,n=o.length;n;)t=33*t^o.charCodeAt(--n);return(t>>>0).toString()};function m(o,t,n){return S(o.toString())+S(t.toString())+S(n)}var v=function(o,t,n){var u=o[t],f=o[u.prevCC];if(!f||!f.new&&u.new)return o.ccOffset=o.presentationOffset=u.start,void(u.new=!1);for(;(h=f)!==null&&h!==void 0&&h.new;){var h;o.ccOffset+=u.start-f.start,u.new=!1,f=o[(u=f).prevCC]}o.presentationOffset=n};function d(o,t,n,u,f,h,i,c){var l,a=new D.VTTParser,s=(0,P.utf8ArrayToStr)(new Uint8Array(o)).trim().replace(T,`
`).split(`
`),e=[],r=(0,k.toMpegTsClockFromTimescale)(t,n),g="00:00.000",E=0,A=0,L=!0;a.oncue=function(_){var R=u[f],x=u.ccOffset,C=(E-r)/9e4;R!=null&&R.new&&(A!==void 0?x=u.ccOffset=R.start:v(u,f,C)),C&&(x=C-u.presentationOffset);var F=_.endTime-_.startTime,O=(0,I.normalizePts)(9e4*(_.startTime+x-A),9e4*h)/9e4;_.startTime=Math.max(O,0),_.endTime=Math.max(O+F,0);var N=_.text.trim();_.text=decodeURIComponent(encodeURIComponent(N)),_.id||(_.id=m(_.startTime,_.endTime,N)),_.endTime>0&&e.push(_)},a.onparsingerror=function(_){l=_},a.onflush=function(){l?c(l):i(e)},s.forEach(function(_){if(L){if(y(_,"X-TIMESTAMP-MAP=")){L=!1,_.slice(16).split(",").forEach(function(R){y(R,"LOCAL:")?g=R.slice(6):y(R,"MPEGTS:")&&(E=parseInt(R.slice(7)))});try{A=p(g)/1e3}catch(R){l=R}return}_===""&&(L=!1)}a.parse(_+`
`)}),a.flush()}},"./src/utils/xhr-loader.ts":(j,M,b)=>{b.r(M),b.d(M,{default:()=>k});var w=b("./src/utils/logger.ts"),D=b("./src/loader/load-stats.ts"),P=/^age:\s*[\d.]+\s*$/m;const k=function(){function I(y){this.xhrSetup=void 0,this.requestTimeout=void 0,this.retryTimeout=void 0,this.retryDelay=void 0,this.config=null,this.callbacks=null,this.context=void 0,this.loader=null,this.stats=void 0,this.xhrSetup=y?y.xhrSetup:null,this.stats=new D.LoadStats,this.retryDelay=0}var T=I.prototype;return T.destroy=function(){this.callbacks=null,this.abortInternal(),this.loader=null,this.config=null},T.abortInternal=function(){var y=this.loader;self.clearTimeout(this.requestTimeout),self.clearTimeout(this.retryTimeout),y&&(y.onreadystatechange=null,y.onprogress=null,y.readyState!==4&&(this.stats.aborted=!0,y.abort()))},T.abort=function(){var y;this.abortInternal(),(y=this.callbacks)!==null&&y!==void 0&&y.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.loader)},T.load=function(y,p,S){if(this.stats.loading.start)throw new Error("Loader can only be used once.");this.stats.loading.start=self.performance.now(),this.context=y,this.config=p,this.callbacks=S,this.retryDelay=p.retryDelay,this.loadInternal()},T.loadInternal=function(){var y=this.config,p=this.context;if(y){var S=this.loader=new self.XMLHttpRequest,m=this.stats;m.loading.first=0,m.loaded=0;var v=this.xhrSetup;try{if(v)try{v(S,p.url)}catch{S.open("GET",p.url,!0),v(S,p.url)}S.readyState||S.open("GET",p.url,!0);var d=this.context.headers;if(d)for(var o in d)S.setRequestHeader(o,d[o])}catch(t){return void this.callbacks.onError({code:S.status,text:t.message},p,S)}p.rangeEnd&&S.setRequestHeader("Range","bytes="+p.rangeStart+"-"+(p.rangeEnd-1)),S.onreadystatechange=this.readystatechange.bind(this),S.onprogress=this.loadprogress.bind(this),S.responseType=p.responseType,self.clearTimeout(this.requestTimeout),this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),y.timeout),S.send()}},T.readystatechange=function(){var y=this.context,p=this.loader,S=this.stats;if(y&&p){var m=p.readyState,v=this.config;if(!S.aborted&&m>=2)if(self.clearTimeout(this.requestTimeout),S.loading.first===0&&(S.loading.first=Math.max(self.performance.now(),S.loading.start)),m===4){p.onreadystatechange=null,p.onprogress=null;var d=p.status,o=p.responseType==="arraybuffer";if(d>=200&&d<300&&(o&&p.response||p.responseText!==null)){var t,n;if(S.loading.end=Math.max(self.performance.now(),S.loading.first),n=o?(t=p.response).byteLength:(t=p.responseText).length,S.loaded=S.total=n,!this.callbacks)return;var u=this.callbacks.onProgress;if(u&&u(S,y,t,p),!this.callbacks)return;var f={url:p.responseURL,data:t};this.callbacks.onSuccess(f,S,y,p)}else S.retry>=v.maxRetry||d>=400&&d<499?(w.logger.error(d+" while loading "+y.url),this.callbacks.onError({code:d,text:p.statusText},y,p)):(w.logger.warn(d+" while loading "+y.url+", retrying in "+this.retryDelay+"..."),this.abortInternal(),this.loader=null,self.clearTimeout(this.retryTimeout),this.retryTimeout=self.setTimeout(this.loadInternal.bind(this),this.retryDelay),this.retryDelay=Math.min(2*this.retryDelay,v.maxRetryDelay),S.retry++)}else self.clearTimeout(this.requestTimeout),this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),v.timeout)}},T.loadtimeout=function(){w.logger.warn("timeout while loading "+this.context.url);var y=this.callbacks;y&&(this.abortInternal(),y.onTimeout(this.stats,this.context,this.loader))},T.loadprogress=function(y){var p=this.stats;p.loaded=y.loaded,y.lengthComputable&&(p.total=y.total)},T.getCacheAge=function(){var y=null;if(this.loader&&P.test(this.loader.getAllResponseHeaders())){var p=this.loader.getResponseHeader("age");y=p?parseFloat(p):null}return y},I}()},"./node_modules/eventemitter3/index.js":j=>{var M=Object.prototype.hasOwnProperty,b="~";function w(){}function D(T,y,p){this.fn=T,this.context=y,this.once=p||!1}function P(T,y,p,S,m){if(typeof p!="function")throw new TypeError("The listener must be a function");var v=new D(p,S||T,m),d=b?b+y:y;return T._events[d]?T._events[d].fn?T._events[d]=[T._events[d],v]:T._events[d].push(v):(T._events[d]=v,T._eventsCount++),T}function k(T,y){--T._eventsCount==0?T._events=new w:delete T._events[y]}function I(){this._events=new w,this._eventsCount=0}Object.create&&(w.prototype=Object.create(null),new w().__proto__||(b=!1)),I.prototype.eventNames=function(){var T,y,p=[];if(this._eventsCount===0)return p;for(y in T=this._events)M.call(T,y)&&p.push(b?y.slice(1):y);return Object.getOwnPropertySymbols?p.concat(Object.getOwnPropertySymbols(T)):p},I.prototype.listeners=function(T){var y=b?b+T:T,p=this._events[y];if(!p)return[];if(p.fn)return[p.fn];for(var S=0,m=p.length,v=new Array(m);S<m;S++)v[S]=p[S].fn;return v},I.prototype.listenerCount=function(T){var y=b?b+T:T,p=this._events[y];return p?p.fn?1:p.length:0},I.prototype.emit=function(T,y,p,S,m,v){var d=b?b+T:T;if(!this._events[d])return!1;var o,t,n=this._events[d],u=arguments.length;if(n.fn){switch(n.once&&this.removeListener(T,n.fn,void 0,!0),u){case 1:return n.fn.call(n.context),!0;case 2:return n.fn.call(n.context,y),!0;case 3:return n.fn.call(n.context,y,p),!0;case 4:return n.fn.call(n.context,y,p,S),!0;case 5:return n.fn.call(n.context,y,p,S,m),!0;case 6:return n.fn.call(n.context,y,p,S,m,v),!0}for(t=1,o=new Array(u-1);t<u;t++)o[t-1]=arguments[t];n.fn.apply(n.context,o)}else{var f,h=n.length;for(t=0;t<h;t++)switch(n[t].once&&this.removeListener(T,n[t].fn,void 0,!0),u){case 1:n[t].fn.call(n[t].context);break;case 2:n[t].fn.call(n[t].context,y);break;case 3:n[t].fn.call(n[t].context,y,p);break;case 4:n[t].fn.call(n[t].context,y,p,S);break;default:if(!o)for(f=1,o=new Array(u-1);f<u;f++)o[f-1]=arguments[f];n[t].fn.apply(n[t].context,o)}}return!0},I.prototype.on=function(T,y,p){return P(this,T,y,p,!1)},I.prototype.once=function(T,y,p){return P(this,T,y,p,!0)},I.prototype.removeListener=function(T,y,p,S){var m=b?b+T:T;if(!this._events[m])return this;if(!y)return k(this,m),this;var v=this._events[m];if(v.fn)v.fn!==y||S&&!v.once||p&&v.context!==p||k(this,m);else{for(var d=0,o=[],t=v.length;d<t;d++)(v[d].fn!==y||S&&!v[d].once||p&&v[d].context!==p)&&o.push(v[d]);o.length?this._events[m]=o.length===1?o[0]:o:k(this,m)}return this},I.prototype.removeAllListeners=function(T){var y;return T?(y=b?b+T:T,this._events[y]&&k(this,y)):(this._events=new w,this._eventsCount=0),this},I.prototype.off=I.prototype.removeListener,I.prototype.addListener=I.prototype.on,I.prefixed=b,I.EventEmitter=I,j.exports=I},"./node_modules/url-toolkit/src/url-toolkit.js":function(j){var M,b,w,D,P;M=/^(?=((?:[a-zA-Z0-9+\-.]+:)?))\1(?=((?:\/\/[^\/?#]*)?))\2(?=((?:(?:[^?#\/]*\/)*[^;?#\/]*)?))\3((?:;[^?#]*)?)(\?[^#]*)?(#[^]*)?$/,b=/^(?=([^\/?#]*))\1([^]*)$/,w=/(?:\/|^)\.(?=\/)/g,D=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,P={buildAbsoluteURL:function(k,I,T){if(T=T||{},k=k.trim(),!(I=I.trim())){if(!T.alwaysNormalize)return k;var y=P.parseURL(k);if(!y)throw new Error("Error trying to parse base URL.");return y.path=P.normalizePath(y.path),P.buildURLFromParts(y)}var p=P.parseURL(I);if(!p)throw new Error("Error trying to parse relative URL.");if(p.scheme)return T.alwaysNormalize?(p.path=P.normalizePath(p.path),P.buildURLFromParts(p)):I;var S=P.parseURL(k);if(!S)throw new Error("Error trying to parse base URL.");if(!S.netLoc&&S.path&&S.path[0]!=="/"){var m=b.exec(S.path);S.netLoc=m[1],S.path=m[2]}S.netLoc&&!S.path&&(S.path="/");var v={scheme:S.scheme,netLoc:p.netLoc,path:null,params:p.params,query:p.query,fragment:p.fragment};if(!p.netLoc&&(v.netLoc=S.netLoc,p.path[0]!=="/"))if(p.path){var d=S.path,o=d.substring(0,d.lastIndexOf("/")+1)+p.path;v.path=P.normalizePath(o)}else v.path=S.path,p.params||(v.params=S.params,p.query||(v.query=S.query));return v.path===null&&(v.path=T.alwaysNormalize?P.normalizePath(p.path):p.path),P.buildURLFromParts(v)},parseURL:function(k){var I=M.exec(k);return I?{scheme:I[1]||"",netLoc:I[2]||"",path:I[3]||"",params:I[4]||"",query:I[5]||"",fragment:I[6]||""}:null},normalizePath:function(k){for(k=k.split("").reverse().join("").replace(w,"");k.length!==(k=k.replace(D,"")).length;);return k.split("").reverse().join("")},buildURLFromParts:function(k){return k.scheme+k.netLoc+k.path+k.params+k.query+k.fragment}},j.exports=P}},Ae={};function ue(j){var M=Ae[j];if(M!==void 0)return M.exports;var b=Ae[j]={exports:{}};return De[j].call(b.exports,b,b.exports,ue),b.exports}ue.m=De,ue.n=j=>{var M=j&&j.__esModule?()=>j.default:()=>j;return ue.d(M,{a:M}),M},ue.d=(j,M)=>{for(var b in M)ue.o(M,b)&&!ue.o(j,b)&&Object.defineProperty(j,b,{enumerable:!0,get:M[b]})},ue.o=(j,M)=>Object.prototype.hasOwnProperty.call(j,M),ue.r=j=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(j,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(j,"__esModule",{value:!0})};var Te=ue("./src/hls.ts");return Te=Te.default})(),Me.exports=xe());var Fe=Me.exports;const qe=Ve({__proto__:null,default:je(Fe)},[Fe]);export{qe as h};
